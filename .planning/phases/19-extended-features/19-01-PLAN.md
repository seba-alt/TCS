---
phase: 19-extended-features
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/suggest.py
  - app/main.py
autonomous: true
requirements: [ROBUST-02]

must_haves:
  truths:
    - "GET /api/suggest?q=marke returns a JSON array of up to 8 string suggestions"
    - "Suggestions come from FTS5 prefix search on job_title and first_name/last_name fields"
    - "Query must be at least 2 characters long — returns [] for shorter inputs"
    - "FTS5 prefix query uses safe prefix-only sanitization (does NOT use _safe_fts_query which strips *)"
    - "Endpoint uses run_in_executor async wrapper (same pattern as explore.py)"
  artifacts:
    - path: "app/routers/suggest.py"
      provides: "GET /api/suggest endpoint returning list[str]"
      contains: "api/suggest"
    - path: "app/main.py"
      provides: "suggest router registered"
      contains: "suggest"
  key_links:
    - from: "app/routers/suggest.py"
      to: "app/database (SQLite FTS5)"
      via: "FTS5 MATCH with prefix * operator"
      pattern: "MATCH"
    - from: "app/main.py"
      to: "app/routers/suggest.py"
      via: "include_router(suggest.router)"
      pattern: "suggest"
---

<objective>
Build the backend search suggestions endpoint using FTS5 prefix matching.

Purpose: ROBUST-02 requires live prefix suggestions below the search bar. The frontend `SearchInput` will call `GET /api/suggest?q={typed}` on each keystroke (2+ chars). FTS5 prefix queries (`word*`) return fast sub-10ms results against expert job_title and name fields. This is a thin router — no service file needed for this simple query.

Output: `suggest.py` router (GET /api/suggest) + registered in `main.py`.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/19-extended-features/19-RESEARCH.md
@app/routers/explore.py
@app/routers/pilot.py
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggest.py router with GET /api/suggest</name>
  <files>app/routers/suggest.py</files>
  <action>
Create `app/routers/suggest.py` with a `GET /api/suggest` endpoint.

The endpoint:
- Accepts `q: str` query param (min 2 chars for suggestions)
- Returns `list[str]` — up to 8 unique suggestions from FTS5 prefix search
- Queries `experts_fts` using FTS5 MATCH with `*` suffix for prefix matching
- Collects distinct values from `job_title` field (most useful for search suggestions)
- Uses `run_in_executor` async wrapper (same pattern as explore.py)
- Sanitizes input: only keep alphanumeric + spaces, strip FTS5 special chars, append `*`

```python
"""
GET /api/suggest — search suggestions via FTS5 prefix matching.

Returns up to 8 string suggestions from job_title prefix search.
Called by the frontend SearchInput on each keystroke (2+ chars).
"""
import asyncio
import re

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from sqlalchemy import text

from app.database import get_db

router = APIRouter()


def _safe_prefix_query(q: str) -> str:
    """
    Sanitize user input for FTS5 prefix matching.
    Unlike _safe_fts_query in explorer.py, this PRESERVES the ability
    to do prefix search by appending * to the last word.
    """
    # Strip FTS5 special chars
    cleaned = re.sub(r'[()"\+\-]', ' ', q)
    # Strip boolean operators
    cleaned = re.sub(r'\b(AND|OR|NOT)\b', ' ', cleaned, flags=re.IGNORECASE)
    words = cleaned.split()[:5]  # limit to 5 terms
    if not words:
        return ""
    # Append * to last word for prefix matching
    words[-1] = words[-1] + "*"
    return " ".join(words)


def _run_suggest(q: str, db: Session) -> list[str]:
    if len(q.strip()) < 2:
        return []

    prefix_q = _safe_prefix_query(q.strip())
    if not prefix_q:
        return []

    try:
        rows = db.execute(
            text(
                "SELECT DISTINCT job_title FROM experts_fts "
                "WHERE experts_fts MATCH :q "
                "ORDER BY rank "
                "LIMIT 8"
            ),
            {"q": prefix_q},
        ).fetchall()
        # Filter out None/empty values
        return [row[0] for row in rows if row[0] and row[0].strip()]
    except Exception:
        # FTS5 MATCH can raise on malformed queries — return empty list
        return []


@router.get("/api/suggest", response_model=list[str])
async def suggest(
    q: str = Query(default="", max_length=200),
    db: Session = Depends(get_db),
) -> list[str]:
    """
    Search suggestions from FTS5 prefix matching on job_title.
    Returns empty list if q is less than 2 characters.
    """
    if len(q.strip()) < 2:
        return []
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, lambda: _run_suggest(q, db))
```

After creating the file, verify imports work:
```bash
python3 -c "from app.routers.suggest import router; print('OK')"
```
  </action>
  <verify>
    python3 -c "from app.routers.suggest import router; print('OK')" — prints OK.
    grep -n "api/suggest\|_safe_prefix_query\|_run_suggest" app/routers/suggest.py — all three present.
  </verify>
  <done>
    suggest.py created with GET /api/suggest endpoint.
    _safe_prefix_query sanitizes input and appends * for FTS5 prefix matching.
    run_in_executor async wrapper used.
    Returns list[str] of up to 8 job_title suggestions.
    Imports without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register suggest router in main.py</name>
  <files>app/main.py</files>
  <action>
Read app/main.py. Add `suggest` to the router import line and register `suggest.router`.

1. Find the import line:
   `from app.routers import admin, chat, email_capture, feedback, health, explore, pilot`
   Change to:
   `from app.routers import admin, chat, email_capture, feedback, health, explore, pilot, suggest`

2. After `app.include_router(pilot.router)`, add:
   `app.include_router(suggest.router)`

After editing, verify:
```bash
python3 -c "from app.routers.suggest import router; from app.main import app; print('OK')"
```
  </action>
  <verify>
    grep -n "suggest" app/main.py — returns both the import and include_router lines.
    python3 -c "from app.main import app; print('OK')" — imports without error.
  </verify>
  <done>
    suggest imported in main.py.
    app.include_router(suggest.router) registered.
    App imports without error.
  </done>
</task>

</tasks>

<verification>
python3 -c "from app.routers.suggest import router; from app.main import app; print('imports OK')"
grep -n "suggest" app/main.py — both import and include_router present.
grep -n "api/suggest" app/routers/suggest.py — route declaration present.
</verification>

<success_criteria>
- GET /api/suggest endpoint created and registered
- Returns list[str] of up to 8 FTS5 prefix-matched job_title suggestions
- Minimum 2-character query requirement enforced
- _safe_prefix_query appends * for prefix matching (separate from _safe_fts_query which strips *)
- run_in_executor async wrapper used (consistent with explore.py and pilot.py)
- app imports without error
</success_criteria>

<output>
After completion, create `.planning/phases/19-extended-features/19-01-SUMMARY.md`
</output>
