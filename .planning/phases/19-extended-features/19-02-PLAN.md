---
phase: 19-extended-features
plan: "02"
type: execute
wave: 2
depends_on: []
files_modified:
  - frontend/src/constants/tags.ts
  - frontend/src/hooks/useUrlSync.ts
  - frontend/src/components/sidebar/FilterSidebar.tsx
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/src/components/sidebar/TagMultiSelect.tsx
autonomous: true
requirements: [ROBUST-01]

must_haves:
  truths:
    - "Changing any filter updates the URL query params (q, rate_min, rate_max, tags) via replace — no history push"
    - "Loading a URL with pre-set params silently restores filter state — no banner, sidebar shows active filters"
    - "FilterSidebar has a Copy link button that copies the current window.location.href to clipboard"
    - "Default filter values (rateMin=0, rateMax=5000, empty query, empty tags) are NOT encoded in URL"
    - "URL sync hook uses replace:true to prevent history spam on every filter change"
  artifacts:
    - path: "frontend/src/constants/tags.ts"
      provides: "Shared TOP_TAGS constant extracted from TagMultiSelect"
      contains: "TOP_TAGS"
    - path: "frontend/src/hooks/useUrlSync.ts"
      provides: "Bidirectional URL ↔ Zustand filter sync hook"
      contains: "useUrlSync"
    - path: "frontend/src/components/sidebar/FilterSidebar.tsx"
      provides: "Copy link button at bottom of sidebar"
      contains: "Copy link"
  key_links:
    - from: "frontend/src/hooks/useUrlSync.ts"
      to: "frontend/src/store/filterSlice.ts"
      via: "individual Zustand selectors + setQuery/setRateRange/setTags"
      pattern: "setQuery|setTags|setRateRange"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/hooks/useUrlSync.ts"
      via: "useUrlSync() call"
      pattern: "useUrlSync"
---

<objective>
Implement shareable filter URLs and the "Copy link" button.

Purpose: ROBUST-01 requires filter state encoded in URL so views can be bookmarked or shared. Active filters (query, rate range, tags) encode as query params. Loading a URL with params silently restores the filter state. A "Copy link" button in FilterSidebar makes sharing one-click.

Output: `constants/tags.ts` (shared tags constant), `useUrlSync.ts` hook (bidirectional sync), FilterSidebar updated with Copy link, MarketplacePage wires the hook. TagMultiSelect updated to import from constants.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/19-extended-features/19-RESEARCH.md
@frontend/src/store/filterSlice.ts
@frontend/src/hooks/useExplore.ts
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/components/sidebar/FilterSidebar.tsx
@frontend/src/components/sidebar/TagMultiSelect.tsx
@frontend/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract TOP_TAGS to constants/tags.ts and update TagMultiSelect import</name>
  <files>
    frontend/src/constants/tags.ts
    frontend/src/components/sidebar/TagMultiSelect.tsx
  </files>
  <action>
**Part A:** Create `frontend/src/constants/tags.ts`:

```typescript
// Top-30 tags by frequency from metadata.json (stable — hardcoded per Phase 16 RESEARCH.md)
// Shared constant used by TagMultiSelect and EmptyState
export const TOP_TAGS = [
  'fundraising',
  'real estate',
  'entrepreneurship',
  'digital marketing',
  'marketing strategy',
  'saas',
  'digital transformation',
  'go-to-market strategy',
  'brand strategy',
  'venture capital',
  'artificial intelligence',
  'supply chain',
  'business development',
  'private equity',
  'change management',
  'business scaling',
  'sales strategy',
  'mergers & acquisitions',
  'web development',
  'product development',
  'e-commerce',
  'ai strategy',
  'corporate finance',
  'event management',
  'growth marketing',
  'process optimization',
  'startup scaling',
  'commercial strategy',
  'leadership coaching',
  'financial planning',
]
```

**Part B:** Read `frontend/src/components/sidebar/TagMultiSelect.tsx`. Remove the inline `const TOP_TAGS = [...]` array and replace with:
```typescript
import { TOP_TAGS } from '../../constants/tags'
```

Keep everything else in TagMultiSelect identical.

After editing, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "TOP_TAGS" frontend/src/constants/tags.ts — exported constant present.
    grep -n "import.*TOP_TAGS" frontend/src/components/sidebar/TagMultiSelect.tsx — import updated.
  </verify>
  <done>
    TOP_TAGS extracted to frontend/src/constants/tags.ts.
    TagMultiSelect imports from constants/tags.ts.
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useUrlSync hook + wire into MarketplacePage</name>
  <files>
    frontend/src/hooks/useUrlSync.ts
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
**Part A:** Create `frontend/src/hooks/useUrlSync.ts`:

```typescript
/**
 * useUrlSync — bidirectional sync between URL query params and Zustand filter store.
 *
 * Store → URL: fires on every filter change, uses replace:true (no history push).
 * URL → Store: fires once on mount, URL params WIN over localStorage-rehydrated state.
 *
 * URL param naming:
 *   q         — text query
 *   rate_min  — minimum hourly rate (omitted if 0)
 *   rate_max  — maximum hourly rate (omitted if 5000)
 *   tags      — repeated param: ?tags=seo&tags=marketing
 *
 * IMPORTANT: Must be used inside a React Router RouterProvider (needs useSearchParams).
 */
import { useEffect, useRef } from 'react'
import { useSearchParams } from 'react-router-dom'
import { useExplorerStore } from '../store'

const DEFAULT_RATE_MIN = 0
const DEFAULT_RATE_MAX = 5000

export function useUrlSync() {
  const [searchParams, setSearchParams] = useSearchParams()

  // Read filter state for URL → store direction
  const query = useExplorerStore((s) => s.query)
  const rateMin = useExplorerStore((s) => s.rateMin)
  const rateMax = useExplorerStore((s) => s.rateMax)
  const tags = useExplorerStore((s) => s.tags)

  // Actions for URL → store direction
  const setQuery = useExplorerStore((s) => s.setQuery)
  const setRateRange = useExplorerStore((s) => s.setRateRange)
  const setTags = useExplorerStore((s) => s.setTags)

  // Step 1: URL → Store (one-time on mount — URL params WIN over localStorage rehydration)
  const initialized = useRef(false)
  useEffect(() => {
    if (initialized.current) return
    initialized.current = true

    const urlQuery = searchParams.get('q') ?? ''
    const urlRateMin = Number(searchParams.get('rate_min') ?? DEFAULT_RATE_MIN)
    const urlRateMax = Number(searchParams.get('rate_max') ?? DEFAULT_RATE_MAX)
    const urlTags = searchParams.getAll('tags')

    // Only override store if URL has meaningful params (not default/empty values)
    if (urlQuery) setQuery(urlQuery)
    if (urlRateMin !== DEFAULT_RATE_MIN || urlRateMax !== DEFAULT_RATE_MAX) {
      setRateRange(urlRateMin, urlRateMax)
    }
    if (urlTags.length > 0) setTags(urlTags)
  }, []) // eslint-disable-line react-hooks/exhaustive-deps — intentionally runs once

  // Step 2: Store → URL (reactive, fires on every filter change)
  // Skip the first render cycle to avoid overwriting URL with localStorage state before
  // the URL → Store effect runs
  const skipFirst = useRef(true)
  useEffect(() => {
    if (skipFirst.current) {
      skipFirst.current = false
      return
    }

    const params = new URLSearchParams()
    if (query) params.set('q', query)
    if (rateMin !== DEFAULT_RATE_MIN) params.set('rate_min', String(rateMin))
    if (rateMax !== DEFAULT_RATE_MAX) params.set('rate_max', String(rateMax))
    tags.forEach((t) => params.append('tags', t))

    // replace:true — no history push on every keystroke/filter change
    setSearchParams(params, { replace: true })
  }, [query, rateMin, rateMax, tags, setSearchParams])
}
```

**Part B:** Read `frontend/src/pages/MarketplacePage.tsx`. Add `useUrlSync` import and call:

1. Add import:
```typescript
import { useUrlSync } from '../hooks/useUrlSync'
```

2. Inside `MarketplacePage` function body (near the top, after other hooks):
```typescript
// Sync filter state to/from URL query params (ROBUST-01)
useUrlSync()
```

After editing, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "useUrlSync\|useSearchParams" frontend/src/hooks/useUrlSync.ts — both present.
    grep -n "useUrlSync" frontend/src/pages/MarketplacePage.tsx — hook called.
    grep -n "replace.*true\|replace: true" frontend/src/hooks/useUrlSync.ts — replace mode confirmed.
  </verify>
  <done>
    useUrlSync.ts created with bidirectional URL ↔ store sync.
    URL → Store runs once on mount (initialized ref guards against double-run).
    Store → URL skips first render cycle to avoid URL-before-init race.
    Default values omitted from URL (clean URLs).
    MarketplacePage wires useUrlSync().
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Copy link button to FilterSidebar</name>
  <files>frontend/src/components/sidebar/FilterSidebar.tsx</files>
  <action>
Read `frontend/src/components/sidebar/FilterSidebar.tsx`. Add a "Copy link" button at the bottom of the sidebar panel.

The button:
- Copies `window.location.href` to clipboard via `navigator.clipboard.writeText`
- Shows brief "Copied!" feedback (useState toggle, 2s timeout)
- Uses `useState` for the copied state

Changes:
1. Add `import { useState } from 'react'` if not already imported, or add `useState` to existing import
2. Add `Link` or `LinkIcon` from lucide-react for the icon (or use `Copy` icon — use whichever exists in existing lucide imports in the project)
3. Inside `FilterSidebar` component, add:
   ```typescript
   const [copied, setCopied] = useState(false)

   function handleCopyLink() {
     navigator.clipboard.writeText(window.location.href).then(() => {
       setCopied(true)
       setTimeout(() => setCopied(false), 2000)
     }).catch(() => {
       // Clipboard API unavailable (e.g., HTTP) — silently ignore
     })
   }
   ```
4. At the bottom of the sidebar's inner div (after all filter controls), add:
   ```tsx
   <div className="pt-4 border-t border-gray-100">
     <button
       onClick={handleCopyLink}
       className="w-full text-xs text-gray-500 flex items-center justify-center gap-1.5 py-2 hover:text-brand-purple transition-colors"
     >
       <Link size={12} />
       {copied ? 'Copied!' : 'Copy link'}
     </button>
   </div>
   ```

Read the CURRENT FilterSidebar.tsx carefully first to understand its structure. Place the Copy link button at the very bottom of the sidebar scroll area, after the "Reset filters" button if one exists, or after the TagMultiSelect section.

After editing, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "Copy link\|handleCopyLink\|clipboard" frontend/src/components/sidebar/FilterSidebar.tsx — all present.
  </verify>
  <done>
    Copy link button added to FilterSidebar bottom.
    Copies window.location.href to clipboard.
    Shows 2s "Copied!" feedback.
    Build passes.
  </done>
</task>

</tasks>

<verification>
npm run build from frontend/ — must exit 0 with no TypeScript errors.
grep -n "TOP_TAGS" frontend/src/constants/tags.ts — exported.
grep -n "import.*TOP_TAGS.*constants" frontend/src/components/sidebar/TagMultiSelect.tsx — updated import.
grep -n "useUrlSync" frontend/src/pages/MarketplacePage.tsx — hook wired.
grep -n "replace.*true" frontend/src/hooks/useUrlSync.ts — no history spam.
grep -n "Copy link" frontend/src/components/sidebar/FilterSidebar.tsx — button present.
</verification>

<success_criteria>
- TOP_TAGS extracted to frontend/src/constants/tags.ts, TagMultiSelect imports from there
- useUrlSync hook: Store → URL on filter change (replace:true), URL → Store on mount (URL params win)
- Default values (rateMin=0, rateMax=5000, empty query, empty tags) NOT encoded in URL
- FilterSidebar has "Copy link" button that copies window.location.href + shows 2s "Copied!" feedback
- MarketplacePage calls useUrlSync()
- npm run build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-extended-features/19-02-SUMMARY.md`
</output>
