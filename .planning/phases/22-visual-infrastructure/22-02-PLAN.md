---
phase: 22-visual-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/src/components/sidebar/FilterSidebar.tsx
  - frontend/src/components/sidebar/SearchInput.tsx
  - frontend/src/components/pilot/SagePanel.tsx
autonomous: false
requirements:
  - VIS-01
  - VIS-02
  - VIS-03
  - VIS-04
  - VIS-05

must_haves:
  truths:
    - "The marketplace page background is the aurora gradient — not white"
    - "FilterSidebar renders with a frosted-glass appearance over the aurora (translucent, blurred)"
    - "SearchInput renders with a frosted-glass appearance matching the sidebar"
    - "SagePanel renders with a frosted-glass appearance over the aurora when open"
    - "All text on glass surfaces is legible (contrast >= 4.5:1 measured over the actual aurora surface)"
    - "On a browser without backdrop-filter support, glass surfaces show an opaque dark background (not invisible)"
  artifacts:
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Page wrapped in AuroraBackground; root div background changed from bg-white to transparent"
      contains: "AuroraBackground"
    - path: "frontend/src/components/sidebar/FilterSidebar.tsx"
      provides: "FilterSidebar <aside> uses glass-surface class; bg-gray-50 removed"
      contains: "glass-surface"
    - path: "frontend/src/components/sidebar/SearchInput.tsx"
      provides: "SearchInput wrapper uses glass-surface; input border updated; dropdown uses fallback-safe bg"
      contains: "glass-surface"
    - path: "frontend/src/components/pilot/SagePanel.tsx"
      provides: "SagePanel motion.div uses glass-surface; bg-white removed; shadow-2xl kept"
      contains: "glass-surface"
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/components/AuroraBackground.tsx"
      via: "import and JSX wrap of page layout"
      pattern: "AuroraBackground"
    - from: "frontend/src/components/sidebar/FilterSidebar.tsx"
      to: "frontend/src/index.css"
      via: "glass-surface className applied to <aside>"
      pattern: "glass-surface"
    - from: "frontend/src/components/pilot/SagePanel.tsx"
      to: "frontend/src/index.css"
      via: "glass-surface className applied to motion.div"
      pattern: "glass-surface"
---

<objective>
Activate the aurora aesthetic across the marketplace: wrap the page with AuroraBackground, change the root background from white to transparent (letting aurora show), and apply the .glass-surface class to FilterSidebar, SearchInput, and SagePanel. Verify contrast and fallback behavior.

Purpose: Plan 01 created the CSS foundation — this plan wires it to actual components so the aurora and glass effects are visible to users.
Output: MarketplacePage (aurora active), FilterSidebar (glass), SearchInput (glass), SagePanel (glass), human visual verification of the complete aesthetic.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-visual-infrastructure/22-CONTEXT.md
@.planning/phases/22-visual-infrastructure/22-RESEARCH.md
@.planning/phases/22-visual-infrastructure/22-01-SUMMARY.md
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/components/sidebar/FilterSidebar.tsx
@frontend/src/components/sidebar/SearchInput.tsx
@frontend/src/components/pilot/SagePanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap MarketplacePage with AuroraBackground and apply glass to FilterSidebar + SearchInput</name>
  <files>
    frontend/src/pages/MarketplacePage.tsx
    frontend/src/components/sidebar/FilterSidebar.tsx
    frontend/src/components/sidebar/SearchInput.tsx
  </files>
  <action>
**MarketplacePage.tsx changes:**

1. Add import at top: `import { AuroraBackground } from '../components/AuroraBackground'`
2. Replace the root `<div className="flex min-h-screen bg-white">` with `<AuroraBackground>` wrapping the entire return content, then change the inner layout div to not use bg-white. The outer AuroraBackground renders `<div className="relative min-h-screen">` with the aurora behind it, so the layout div inside must be transparent.

New return structure:
```tsx
return (
  <AuroraBackground>
    <div className="flex min-h-screen">
      {/* Desktop sticky sidebar */}
      <FilterSidebar />
      ...rest unchanged...
    </div>
  </AuroraBackground>
)
```

Note: Remove `bg-white` from the outer layout div only. All inner element backgrounds (header borders, mobile toolbar) may keep their existing styles unless they fight the aurora. The existing CRITICAL comment about `No overflow wrapper around FilterSidebar` remains valid — AuroraBackground's root div does NOT add overflow:hidden.

**FilterSidebar.tsx changes:**

Ancestor audit: The `<aside>` has `sticky top-0 h-screen` and `overflow-y-auto` is on the INNER `FilterControls` div (not the aside itself). This means applying .glass-surface directly to the `<aside>` is safe — no overflow:hidden on the aside ancestor chain.

1. Replace `bg-gray-50 border-r border-gray-200` with `glass-surface border-r border-[var(--glass-border)]` in the `<aside>` className.
2. Keep all other classes: `hidden md:flex flex-col sticky top-0 h-screen transition-all duration-200 ${collapsed ? 'w-16' : 'w-64'}`.
3. Update the toggle button border: change `border-b border-gray-200` to `border-b border-white/10` (consistent with glass border).
4. Update label text colors: change `text-gray-500` spans (Search, Hourly Rate, Domain Tags) to `text-white/60` for legibility over the dark glass surface.
5. The "Copy link" button: change `text-gray-500` to `text-white/50` and `hover:text-brand-purple` stays (brand purple is legible on dark surface).
6. The `border-t border-gray-100` at the bottom of FilterControls: change to `border-t border-white/10`.

**SearchInput.tsx changes:**

SearchInput currently renders as `<div className="relative">` containing an `<input>`. The input itself has the border styling. We need glass on the wrapper container that holds the input.

1. Change outer div from `<div className="relative">` to `<div className="glass-surface relative rounded-md">`.
2. Remove from the input's className: `border border-gray-300` and `rounded-md`. The glass surface border on the container div handles this. Keep `w-full px-3 py-2 text-sm focus:ring-1 focus:ring-brand-purple focus:border-transparent`. Add `bg-transparent text-white placeholder-white/50` to the input (text is white on dark glass).
3. The suggestions dropdown `<ul>`: change `bg-white border border-gray-200` to `bg-[var(--glass-fallback-bg)] border border-white/10`. Change `text-gray-700` on `<button>` to `text-white/80`. Change `hover:bg-gray-50 hover:text-brand-purple` to `hover:bg-white/10 hover:text-white`.

Note on overflow: The suggestions dropdown is a sibling positioned with `top-full`, not a child of the glass div — so its absolute positioning is fine. The `z-20` keeps it above the glass layer.
  </action>
  <verify>
1. `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20` — exits 0, no TypeScript errors.
2. Check that AuroraBackground import exists in MarketplacePage.tsx: `grep "AuroraBackground" /Users/sebastianhamers/Documents/TCS/frontend/src/pages/MarketplacePage.tsx`.
3. Check glass-surface applied to aside: `grep "glass-surface" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/FilterSidebar.tsx`.
4. Check glass-surface applied to SearchInput wrapper: `grep "glass-surface" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/SearchInput.tsx`.
  </verify>
  <done>
Build passes. MarketplacePage imports and renders AuroraBackground with bg-white removed from layout root. FilterSidebar aside uses glass-surface class. SearchInput wrapper div uses glass-surface class. All text colors updated for dark glass surface legibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply glass to SagePanel</name>
  <files>frontend/src/components/pilot/SagePanel.tsx</files>
  <action>
SagePanel is `position: fixed` — this creates its own stacking context. Fixed elements' backdrop-filter blurs content behind the panel, which is correct behavior. The AnimatePresence wrapper does NOT set overflow, so the direct glass application should work without the pseudo-element hack. However, the ::before pattern in .glass-surface already handles this correctly regardless.

**Changes to SagePanel.tsx:**

1. On the `<motion.div>`, replace `bg-white` with `glass-surface` in the className. Keep all other classes: `fixed bottom-0 right-0 z-40 h-full w-full md:w-[380px] shadow-2xl flex flex-col`.
2. The header's `border-b border-gray-100`: change to `border-b border-white/10`.
3. Header text `text-gray-900` (Sage label) → `text-white`. `text-gray-400` (AI assistant) → `text-white/50`.
4. The close button: `text-gray-400` → `text-white/40`, `hover:text-gray-600` → `hover:text-white/80`, `hover:bg-gray-100` → `hover:bg-white/10`.
5. The typing indicator dots container: `bg-gray-100` → `bg-white/10`. Dot color `bg-gray-400` → `bg-white/40`.
6. SageMessage component is NOT modified in this plan (its styling is internal — check if it has `text-gray-900` that may need updating, but if SageMessage has its own background, leave it — only surface-level SagePanel changes here).

Note: The existing SageInput component's internal styles are left unchanged in this plan — its container is rendered inside SagePanel's flex layout and may have its own background. Only the top-level motion.div and header elements are updated.

IMPORTANT: Do NOT import Framer Motion anew. The existing `motion` import from `motion/react` at line 2 is sufficient. The glass-surface class is purely CSS — no new dependencies.
  </action>
  <verify>
1. `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20` — exits 0.
2. `grep "glass-surface" /Users/sebastianhamers/Documents/TCS/frontend/src/components/pilot/SagePanel.tsx` — confirms class applied to motion.div.
3. `grep "bg-white" /Users/sebastianhamers/Documents/TCS/frontend/src/components/pilot/SagePanel.tsx` — should return nothing (bg-white removed from motion.div; inner elements may retain their own backgrounds).
  </verify>
  <done>
SagePanel motion.div uses glass-surface class instead of bg-white. Header and button text colors updated to white-tinted values for dark glass surface. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of aurora aesthetic and glass surfaces</name>
  <action>Human verifies the aurora aesthetic is complete and all glass surfaces pass contrast and fallback requirements.</action>
  <what-built>
    Full aurora aesthetic is now active:
    - Animated aurora mesh gradient background (5 radial gradient blobs, 20s drift cycle)
    - FilterSidebar with frosted glass appearance
    - SearchInput with glass wrapper
    - SagePanel with glass appearance when open
    - OKLCH tokens in CSS custom properties
    - prefers-reduced-motion: aurora freezes
    - Tab visibility: aurora pauses when hidden
    - Fallback: opaque dark surface on unsupported browsers
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173 (or whichever port the dev server uses). You should see the aurora gradient background — a dark purple-tinted near-black base with drifting colored blobs (blues, cyans, teals, violet).

2. FilterSidebar: The left sidebar should appear translucent/frosted over the aurora — you should be able to see aurora colors bleeding through. Labels (Search, Hourly Rate, Domain Tags) should be readable in white/off-white against the dark glass.

3. SearchInput: The search input inside the sidebar should have a glass wrapper. Text typed in the input should be white or near-white. Suggestions dropdown (type 2+ characters) should use dark glass styling.

4. Sage panel: Click the Sage FAB (bottom right). The Sage panel should slide in with a glass appearance over the aurora. The header should show "Sage" in white text. The close button should be visible.

5. Aurora subtlety check: The aurora should feel like ambiance, not a feature — content (cards, text, filters) should dominate. If the aurora is overwhelming, the blob alphas (0.20-0.35 in OKLCH values) may need reducing.

6. Contrast check: Sidebar label text (SEARCH, HOURLY RATE, DOMAIN TAGS) should be clearly legible against the dark glass surface. In Chrome DevTools: Inspect any label, Accessibility panel, check Contrast ratio (target >= 4.5:1).

7. Fallback test (DevTools): In Elements panel, temporarily add `backdrop-filter: none !important` to .glass-surface::before — glass surfaces should show the opaque dark --glass-fallback-bg background, not become transparent.

8. Reduced motion: In Chrome DevTools, Rendering tab, Emulate CSS prefers-reduced-motion: reduce — the aurora gradient should be static (frozen), not animating.
  </how-to-verify>
  <verify>Human approves visual result via resume-signal.</verify>
  <done>Human types "approved" confirming aurora is visible, glass surfaces are frosted, text is legible, and fallback behavior is correct.</done>
  <resume-signal>Type "approved" if the aurora aesthetic looks correct, or describe specific issues (e.g., "aurora too bright", "sidebar text unreadable", "Sage panel background still white")</resume-signal>
</task>

</tasks>

<verification>
1. `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build` — exits 0.
2. All four files modified: MarketplacePage.tsx, FilterSidebar.tsx, SearchInput.tsx, SagePanel.tsx.
3. grep confirms: AuroraBackground imported in MarketplacePage, glass-surface in all three component files.
4. bg-white removed from MarketplacePage root div and SagePanel motion.div.
5. Human verifies aurora visible, glass surfaces frosted, text legible, fallback correct.
</verification>

<success_criteria>
- Aurora mesh gradient fills the viewport behind all content on the marketplace page
- FilterSidebar, SearchInput, and SagePanel each render with frosted-glass appearance (translucent + blur over aurora)
- All glass surface text passes 4.5:1 contrast over the rendered dark aurora
- Unsupported browser fallback: glass surfaces render opaque dark (not broken/transparent)
- prefers-reduced-motion: aurora is static
- Tab hidden: aurora animation pauses
- Build compiles cleanly; no TypeScript errors
- Human approves visual result
</success_criteria>

<output>
After completion, create `.planning/phases/22-visual-infrastructure/22-02-SUMMARY.md` documenting:
- Which components received glass-surface class and how
- Any ancestor-chain issues found during FilterSidebar or SagePanel application
- Text color changes made for glass surface legibility
- Human verification outcome (approved / issues found and resolved)
- Contrast measurements if taken
- Any visual tuning done during checkpoint (blob alpha adjustments, etc.)
</output>
