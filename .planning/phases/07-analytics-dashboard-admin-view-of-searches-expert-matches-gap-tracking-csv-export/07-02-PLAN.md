---
phase: 07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/main.tsx
  - frontend/src/vite-env.d.ts
  - frontend/src/admin/AdminApp.tsx
  - frontend/src/admin/components/AdminSidebar.tsx
  - frontend/src/admin/hooks/useAdminData.ts
  - frontend/src/admin/hooks/useAdminExport.ts
  - frontend/src/admin/types.ts
autonomous: true
requirements: [ANAL-01]

must_haves:
  truths:
    - "Navigating to /admin in the browser renders the AdminApp layout with sidebar and content area"
    - "Navigating to / still renders the original chat App unchanged"
    - "useAdminData hooks fetch from /api/admin/* with X-Admin-Key header injected automatically"
    - "useAdminExport triggers a browser file download from the backend CSV endpoint"
    - "The AdminSidebar has nav links for Overview, Searches, and Gaps sections"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "react-router-dom router with / → App and /admin/* → AdminApp"
      contains: "createBrowserRouter"
    - path: "frontend/src/admin/AdminApp.tsx"
      provides: "Admin layout with sidebar + Outlet"
      exports: ["default AdminApp"]
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useAdminStats, useAdminSearches, useAdminGaps hooks"
      exports: ["useAdminStats", "useAdminSearches", "useAdminGaps", "adminFetch"]
    - path: "frontend/src/admin/hooks/useAdminExport.ts"
      provides: "useAdminExport hook that triggers CSV download"
      exports: ["useAdminExport"]
    - path: "frontend/src/admin/types.ts"
      provides: "TypeScript interfaces for all admin API response shapes"
      exports: ["AdminStats", "SearchRow", "GapRow"]
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/admin/AdminApp.tsx"
      via: "element: <AdminApp /> in router config"
      pattern: "AdminApp"
    - from: "frontend/src/admin/hooks/useAdminData.ts"
      to: "/api/admin/*"
      via: "fetch with X-Admin-Key header from VITE_ADMIN_KEY"
      pattern: "VITE_ADMIN_KEY"
---

<objective>
Install react-router-dom and @tanstack/react-table, wire the existing chat App into a browser router at /, mount AdminApp at /admin/*, and build the admin data layer: shared TypeScript types, useAdminData hooks, useAdminExport hook, AdminApp layout, and AdminSidebar component.

Purpose: Establishes the structural foundation (routing, types, data fetching) that the admin pages in Plan 03 will build on. Running parallel to Plan 01 (backend) since no backend calls are needed to build the client-side shell.
Output: Routed app, admin layout, data hooks — all ready for pages to plug in.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export/07-RESEARCH.md
@frontend/src/main.tsx
@frontend/src/vite-env.d.ts
@frontend/src/App.tsx
@frontend/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install libraries, wire router in main.tsx, add env var to vite-env.d.ts, and build admin types + layout</name>
  <files>
    frontend/package.json
    frontend/src/main.tsx
    frontend/src/vite-env.d.ts
    frontend/src/admin/AdminApp.tsx
    frontend/src/admin/components/AdminSidebar.tsx
    frontend/src/admin/types.ts
  </files>
  <action>
**Step 1 — Install libraries:**
```bash
cd /Users/sebastianhamers/Documents/TCS/frontend && npm install react-router-dom @tanstack/react-table
```
Verify both appear in package.json dependencies after install.

**Step 2 — frontend/src/vite-env.d.ts:**
Add `VITE_ADMIN_KEY` to the `ImportMetaEnv` interface:
```typescript
interface ImportMetaEnv {
  readonly VITE_API_URL: string
  readonly VITE_SENTRY_DSN: string
  readonly VITE_ADMIN_KEY: string
}
```

**Step 3 — frontend/src/main.tsx:**
Replace the current content (which renders `<App />` directly via `createRoot`) with a router-based setup. Keep `import "./instrument"` as the FIRST import (Sentry requirement). The new main.tsx:

```typescript
import "./instrument";
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { createBrowserRouter, RouterProvider } from 'react-router-dom'
import './index.css'
import App from './App.tsx'
import AdminApp from './admin/AdminApp.tsx'
import OverviewPage from './admin/pages/OverviewPage.tsx'
import SearchesPage from './admin/pages/SearchesPage.tsx'
import GapsPage from './admin/pages/GapsPage.tsx'

const router = createBrowserRouter([
  {
    path: '/',
    element: <App />,
  },
  {
    path: '/admin',
    element: <AdminApp />,
    children: [
      { index: true, element: <OverviewPage /> },
      { path: 'searches', element: <SearchesPage /> },
      { path: 'gaps', element: <GapsPage /> },
    ],
  },
])

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <RouterProvider router={router} />
  </StrictMode>,
)
```

The page imports (OverviewPage, SearchesPage, GapsPage) will be created in Plan 03. TypeScript will complain about missing modules until then — this is expected and will be resolved in Plan 03's task. The executor should create stub files for these pages now to satisfy TypeScript during this plan's build:

Create `frontend/src/admin/pages/OverviewPage.tsx`:
```typescript
export default function OverviewPage() { return <div>Overview</div> }
```
Create `frontend/src/admin/pages/SearchesPage.tsx`:
```typescript
export default function SearchesPage() { return <div>Searches</div> }
```
Create `frontend/src/admin/pages/GapsPage.tsx`:
```typescript
export default function GapsPage() { return <div>Gaps</div> }
```
These stubs will be replaced by Plan 03.

**Step 4 — frontend/src/admin/types.ts:**
Create this file with all TypeScript interfaces for admin API responses:

```typescript
// Admin API TypeScript interfaces
// These shapes mirror the backend /api/admin/* response schemas

export interface AdminStats {
  total_searches: number
  match_count: number
  match_rate: number
  gap_count: number
}

export interface SearchRow {
  id: number
  email: string
  query: string
  created_at: string       // ISO datetime string
  response_type: string    // "match" | "clarification"
  match_count: number
  top_match_score: number | null
  is_gap: boolean
  gap_resolved: boolean
}

export interface SearchesResponse {
  rows: SearchRow[]
  total: number
  page: number
  page_size: number
}

export interface GapRow {
  id: number
  query: string
  frequency: number
  best_score: number | null
  resolved: boolean
}

export interface GapsResponse {
  gaps: GapRow[]
}

// Filter state shape for searches table and CSV export
export interface SearchFilters {
  email?: string
  gap_flag?: boolean
  score_min?: number
  score_max?: number
  date_from?: string   // ISO date string YYYY-MM-DD
  date_to?: string     // ISO date string YYYY-MM-DD
  page?: number
  page_size?: number
}
```

**Step 5 — frontend/src/admin/AdminApp.tsx:**
Create the root admin layout component with sidebar + Outlet:

```typescript
import { Outlet } from 'react-router-dom'
import AdminSidebar from './components/AdminSidebar'

export default function AdminApp() {
  return (
    <div className="flex h-screen bg-gray-50">
      <AdminSidebar />
      <main className="flex-1 overflow-y-auto p-8">
        <Outlet />
      </main>
    </div>
  )
}
```

**Step 6 — frontend/src/admin/components/AdminSidebar.tsx:**
Create the sidebar with nav links using react-router-dom NavLink. Active links get a highlighted style:

```typescript
import { NavLink } from 'react-router-dom'

const NAV_ITEMS = [
  { to: '/admin', label: 'Overview', end: true },
  { to: '/admin/searches', label: 'Searches', end: false },
  { to: '/admin/gaps', label: 'Gaps', end: false },
]

export default function AdminSidebar() {
  return (
    <aside className="w-56 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col">
      <div className="px-6 py-5 border-b border-gray-200">
        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider">Admin</p>
        <p className="text-sm font-bold text-gray-900 mt-0.5">Tinrate Analytics</p>
      </div>
      <nav className="flex-1 px-3 py-4 space-y-1">
        {NAV_ITEMS.map(({ to, label, end }) => (
          <NavLink
            key={to}
            to={to}
            end={end}
            className={({ isActive }) =>
              `block px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                isActive
                  ? 'bg-brand-purple text-white'
                  : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
              }`
            }
          >
            {label}
          </NavLink>
        ))}
      </nav>
    </aside>
  )
}
```

Note: `bg-brand-purple` uses the existing Tailwind brand color token configured in Phase 3. Verify the token name in `tailwind.config.js` if the build fails — the existing codebase uses `brand-purple` as the token name.
  </action>
  <verify>
Run TypeScript build check:
`cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit`
Expected: No errors (stub pages satisfy the imports in main.tsx).

Run Vite dev build:
`cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build`
Expected: Build succeeds with no errors. May show warnings about unused stubs — acceptable.

Check packages installed:
`cd /Users/sebastianhamers/Documents/TCS/frontend && cat package.json | grep -E "react-router-dom|tanstack"`
Expected: Both packages listed in dependencies.
  </verify>
  <done>npm install succeeds, both new packages in package.json. tsc --noEmit passes. Vite build succeeds. Router configured with / → App and /admin → AdminApp. AdminSidebar has Overview/Searches/Gaps NavLinks. Admin types defined. Stub pages present.</done>
</task>

<task type="auto">
  <name>Task 2: Build useAdminData and useAdminExport hooks</name>
  <files>
    frontend/src/admin/hooks/useAdminData.ts
    frontend/src/admin/hooks/useAdminExport.ts
  </files>
  <action>
**frontend/src/admin/hooks/useAdminData.ts:**

Build the `adminFetch` base function and three hooks: `useAdminStats`, `useAdminSearches`, `useAdminGaps`.

```typescript
import { useState, useEffect, useCallback } from 'react'
import type { AdminStats, SearchesResponse, GapsResponse, SearchFilters } from '../types'

const ADMIN_KEY = import.meta.env.VITE_ADMIN_KEY ?? ''
const API_URL = import.meta.env.VITE_API_URL ?? 'http://localhost:8000'

export async function adminFetch<T>(path: string, params?: Record<string, string | number | boolean | undefined>): Promise<T> {
  const url = new URL(`${API_URL}/api/admin${path}`)
  if (params) {
    Object.entries(params).forEach(([k, v]) => {
      if (v !== undefined && v !== null && v !== '') {
        url.searchParams.set(k, String(v))
      }
    })
  }
  const res = await fetch(url.toString(), {
    headers: { 'X-Admin-Key': ADMIN_KEY },
  })
  if (!res.ok) throw new Error(`Admin API error ${res.status}: ${await res.text()}`)
  return res.json() as Promise<T>
}

export function useAdminStats() {
  const [stats, setStats] = useState<AdminStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    setLoading(true)
    adminFetch<AdminStats>('/stats')
      .then(setStats)
      .catch(e => setError(e.message))
      .finally(() => setLoading(false))
  }, [])

  return { stats, loading, error }
}

export function useAdminSearches(filters: SearchFilters = {}) {
  const [data, setData] = useState<SearchesResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<SearchesResponse>('/searches', filters as Record<string, string | number | boolean | undefined>)
      .then(setData)
      .catch(e => setError(e.message))
      .finally(() => setLoading(false))
  }, [JSON.stringify(filters)])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}

export function useAdminGaps() {
  const [data, setData] = useState<GapsResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<GapsResponse>('/gaps')
      .then(setData)
      .catch(e => setError(e.message))
      .finally(() => setLoading(false))
  }, [])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}
```

Note on `JSON.stringify(filters)` as useCallback dep: This is the simplest way to get value-equality for object deps without importing a deep-equal library. It is a known pattern for simple filter objects — acceptable for an admin tool.

**frontend/src/admin/hooks/useAdminExport.ts:**

Build `useAdminExport` hook that handles the fetch-and-download flow for both searches and gaps CSVs. Because the export endpoint requires an `X-Admin-Key` header, a plain `<a href>` cannot be used — must fetch and create a Blob URL.

```typescript
import { useState } from 'react'
import type { SearchFilters } from '../types'

const ADMIN_KEY = import.meta.env.VITE_ADMIN_KEY ?? ''
const API_URL = import.meta.env.VITE_API_URL ?? 'http://localhost:8000'

export type ExportSection = 'searches' | 'gaps'

export function useAdminExport() {
  const [exporting, setExporting] = useState(false)
  const [exportError, setExportError] = useState<string | null>(null)

  async function downloadCsv(section: ExportSection, filtered: boolean, filters?: SearchFilters) {
    setExporting(true)
    setExportError(null)

    try {
      const url = new URL(`${API_URL}/api/admin/export/${section}.csv`)
      url.searchParams.set('filtered', String(filtered))
      if (filtered && filters) {
        Object.entries(filters).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== '') {
            url.searchParams.set(k, String(v))
          }
        })
      }

      const res = await fetch(url.toString(), {
        headers: { 'X-Admin-Key': ADMIN_KEY },
      })
      if (!res.ok) throw new Error(`Export failed: ${res.status}`)

      const blob = await res.blob()
      const blobUrl = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = blobUrl
      a.download = `${section}-${new Date().toISOString().slice(0, 10)}.csv`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(blobUrl)
    } catch (e) {
      setExportError(e instanceof Error ? e.message : 'Export failed')
    } finally {
      setExporting(false)
    }
  }

  return { downloadCsv, exporting, exportError }
}
```
  </action>
  <verify>
Run TypeScript check:
`cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit`
Expected: No errors.

Grep for correct import patterns:
`grep -r "VITE_ADMIN_KEY" /Users/sebastianhamers/Documents/TCS/frontend/src/admin/`
Expected: Found in both hooks files.

`grep -r "X-Admin-Key" /Users/sebastianhamers/Documents/TCS/frontend/src/admin/`
Expected: Found in both hooks files.
  </verify>
  <done>useAdminData.ts exports adminFetch, useAdminStats, useAdminSearches, useAdminGaps with loading/error state. useAdminExport.ts exports useAdminExport with downloadCsv function that fetches with auth header and triggers browser download. tsc passes clean.</done>
</task>

</tasks>

<verification>
- `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build` — succeeds
- `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit` — no errors
- `grep "createBrowserRouter" /Users/sebastianhamers/Documents/TCS/frontend/src/main.tsx` — found
- `grep "VITE_ADMIN_KEY" /Users/sebastianhamers/Documents/TCS/frontend/src/vite-env.d.ts` — found
- `cat /Users/sebastianhamers/Documents/TCS/frontend/package.json | grep react-router-dom` — version present
</verification>

<success_criteria>
- react-router-dom and @tanstack/react-table installed in frontend/package.json
- main.tsx uses createBrowserRouter — chat App at /, AdminApp at /admin/*
- Admin TypeScript types fully defined in admin/types.ts
- AdminApp renders sidebar + Outlet layout
- AdminSidebar has Overview/Searches/Gaps NavLinks with active state styling using brand-purple
- useAdminData hooks provide stats/searches/gaps with loading and error state
- useAdminExport handles authenticated CSV download via Blob URL pattern
- tsc --noEmit and npm run build both succeed
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export/07-02-SUMMARY.md`
</output>
