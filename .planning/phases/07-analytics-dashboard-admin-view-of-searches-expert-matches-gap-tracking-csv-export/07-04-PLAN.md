---
phase: 07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export
plan: 04
type: execute
wave: 3
depends_on: ["07-01", "07-03"]
files_modified: []
autonomous: false
requirements: [ANAL-01]
user_setup:
  - service: admin-secret
    why: "Admin dashboard authentication — X-Admin-Key header guards all /api/admin/* endpoints"
    env_vars:
      - name: ADMIN_SECRET
        source: "Generate a strong random secret: openssl rand -hex 32 — set in Railway Dashboard → Variables"
      - name: VITE_ADMIN_KEY
        source: "Same value as ADMIN_SECRET — set in Vercel Dashboard → Project Settings → Environment Variables"
    dashboard_config:
      - task: "Set ADMIN_SECRET in Railway"
        location: "railway.com → project → service → Variables tab → Add Variable"
      - task: "Set VITE_ADMIN_KEY in Vercel"
        location: "vercel.com → project → Settings → Environment Variables → Add"
      - task: "Redeploy both Railway and Vercel after setting env vars"
        location: "Railway: auto-redeploys on variable change. Vercel: trigger new deployment."

must_haves:
  truths:
    - "Visiting https://tcs-three-sigma.vercel.app/ still loads the chat UI correctly"
    - "Visiting https://tcs-three-sigma.vercel.app/admin loads the admin dashboard with sidebar"
    - "Overview page shows non-zero total_searches count (from existing DB conversations)"
    - "Searches table shows rows with query text, timestamp, user email, match count, top score, and gap badges"
    - "Clicking a searches row expands it to show expert names"
    - "Export Searches CSV button opens ExportDialog, selecting an option triggers a file download named searches-YYYY-MM-DD.csv"
    - "Gaps page shows gap queries ranked by frequency with Open/Resolved badges"
    - "Mark Resolved on a gap row updates it to Resolved status after page refresh"
    - "Export Gaps CSV downloads a file named gaps-YYYY-MM-DD.csv"
    - "Requests to /api/admin/stats without X-Admin-Key return 401"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "Live admin endpoints accessible on Railway"
    - path: "frontend/src/admin/pages/OverviewPage.tsx"
      provides: "Live overview stats from production DB"
  key_links:
    - from: "https://tcs-three-sigma.vercel.app/admin"
      to: "https://web-production-fdbf9.up.railway.app/api/admin/stats"
      via: "fetch with X-Admin-Key: VITE_ADMIN_KEY header"
      pattern: "X-Admin-Key"
---

<objective>
Set environment variables in Railway and Vercel, deploy both, and human-verify the full analytics dashboard end-to-end: stats, searches table, expandable rows, gap tracking, resolve action, and CSV exports.

Purpose: Confirms the complete Phase 7 feature works in production with real data from the existing conversation database.
Output: Working admin dashboard at /admin on the production Vercel URL.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export/07-01-SUMMARY.md
@.planning/phases/07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export/07-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit and push all Phase 7 changes to main, then verify deployments</name>
  <files></files>
  <action>
**Step 1 — Commit all Phase 7 changes:**
```bash
cd /Users/sebastianhamers/Documents/TCS
git add app/models.py app/main.py app/routers/chat.py app/routers/admin.py
git add frontend/src/main.tsx frontend/src/vite-env.d.ts
git add frontend/src/admin/
git add frontend/package.json frontend/package-lock.json
git commit -m "feat(07): analytics dashboard — admin view of searches, gaps, and CSV export

- Add top_match_score + gap_resolved columns to Conversation model (ALT TABLE migration in lifespan)
- Capture top FAISS score in chat.py before DB commit for accurate gap detection
- New /api/admin/* router: stats, searches (paginated+filtered), gaps (frequency-ranked), resolve, CSV export
- X-Admin-Key header auth on all admin endpoints (ADMIN_SECRET env var)
- CORS updated to allow X-Admin-Key header from Vercel origin
- Frontend: react-router-dom v7 + @tanstack/react-table v8 installed
- Admin subtree at /admin: AdminApp layout, sidebar, Overview/Searches/Gaps pages
- SearchesTable with TanStack Table pagination (25/50 rows), expandable expert rows
- GapsTable with frequency ranking and Mark Resolved action
- ExportDialog for filtered-vs-all CSV download choice per section
- useAdminData hooks + useAdminExport for authenticated API access"
git push origin main
```

**Step 2 — Wait for deployments:**
- Railway auto-deploys on push to main. Wait for it to complete (check railway.com dashboard or run `railway status` if CLI installed).
- Vercel auto-deploys on push. Check vercel.com dashboard or wait ~2 minutes.

**Step 3 — Verify backend health:**
```bash
curl -s https://web-production-fdbf9.up.railway.app/api/health
```
Expected: `{"status": "ok", "index_size": 530}` (or similar non-zero index_size).

**Step 4 — Verify admin auth:**
```bash
# Without key — should return 401
curl -s -o /dev/null -w "%{http_code}" https://web-production-fdbf9.up.railway.app/api/admin/stats
```
Expected: `401`

Note: ADMIN_SECRET must be set in Railway before step 4 works correctly. The checkpoint task below handles env var setup instructions for the user.
  </action>
  <verify>
`git log --oneline -1` — shows Phase 7 commit.
`curl -s https://web-production-fdbf9.up.railway.app/api/health` — returns 200 JSON with status ok.
`curl -s -o /dev/null -w "%{http_code}" https://web-production-fdbf9.up.railway.app/api/admin/stats` — returns 401.
  </verify>
  <done>Phase 7 code committed and pushed. Railway and Vercel deployments complete. Health endpoint confirmed up. Admin endpoint returns 401 without key.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — admin dashboard end-to-end in production</name>
  <what-built>
Complete analytics dashboard at /admin — stats overview, searches table with filters/pagination/expandable rows, gaps frequency table with resolve action, CSV export for both sections. Backend guarded by X-Admin-Key header auth.
  </what-built>
  <how-to-verify>
**Before verifying, complete these setup steps (Claude cannot do these):**

1. Generate a strong admin secret:
   ```
   openssl rand -hex 32
   ```
   Copy the output — this is your ADMIN_SECRET.

2. Set in Railway:
   - Go to railway.com → your project → service → Variables tab
   - Add: `ADMIN_SECRET` = (your secret)
   - Railway will auto-redeploy — wait for it to complete (~1-2 min)

3. Set in Vercel:
   - Go to vercel.com → project → Settings → Environment Variables
   - Add: `VITE_ADMIN_KEY` = (same secret as above)
   - Trigger a new Vercel deployment (either push a small commit or use Vercel dashboard Redeploy)

**Verification checklist (test in browser):**

1. **Chat still works** — Visit https://tcs-three-sigma.vercel.app/ — chat UI loads, submit a test query, receive expert results.

2. **Admin route loads** — Visit https://tcs-three-sigma.vercel.app/admin — should see admin layout with "Tinrate Analytics" sidebar and Overview page.

3. **Overview stats** — Total searches should show a number > 0 (existing conversations from prior phases). Match rate and gap count should be visible.

4. **Searches table** — Click "Searches" in sidebar:
   - Table shows rows with columns: Query, Timestamp, User, Matches, Top Score, Gap
   - Pagination controls visible (← / → buttons, rows per page selector)
   - At least one row present with data from prior test queries

5. **Expandable rows** — Click any row in the Searches table — row expands to show expert names inline. Click again to collapse.

6. **Filter panel** — Enter an email in the "User email" filter, click Apply Filters — table updates.

7. **Export Searches CSV** — Click "Export CSV" button on Searches page — ExportDialog appears with "Filtered results only" and "All data" options. Select "All data" — a file named `searches-YYYY-MM-DD.csv` downloads. Open it — contains metadata header rows (# Export date, # Total rows) followed by data columns.

8. **Gaps page** — Click "Gaps" in sidebar — page loads with frequency-ranked gap queries (may be empty if all queries were confident matches). If gaps exist: rows show query text, frequency count, best score, and Open/Resolved badge.

9. **Mark Resolved** (if gaps exist) — Click "Mark Resolved" on a gap row — row should update to "Resolved" status after page refresh.

10. **Export Gaps CSV** — Click "Export CSV" on Gaps page — `gaps-YYYY-MM-DD.csv` downloads.

11. **Auth protection** — Test in browser console or curl:
    ```
    curl -s -o /dev/null -w "%{http_code}" https://web-production-fdbf9.up.railway.app/api/admin/stats
    ```
    Should return 401.
  </how-to-verify>
  <resume-signal>Type "approved" when all checks pass, or describe any issues found.</resume-signal>
  <files></files>
  <action>Human verification — follow the how-to-verify checklist above. Set ADMIN_SECRET in Railway and VITE_ADMIN_KEY in Vercel first, then test all 11 checklist items in the browser.</action>
  <verify>All 11 verification checklist items pass (chat works at /, admin dashboard loads at /admin, stats show real data, searches table paginated and expandable, CSV downloads work, gaps page works, auth returns 401 without key).</verify>
  <done>Human confirmed "approved" after verifying all 11 checklist items pass in production.</done>
</task>

</tasks>

<verification>
All checklist items in the human verification task pass — chat still works at /, admin dashboard loads at /admin, stats show real data, searches table is paginated and expandable, CSV exports download correctly with metadata headers, gaps page works, auth returns 401 without key.
</verification>

<success_criteria>
- Production chat UI at / is unaffected by Phase 7 changes
- Admin dashboard at /admin is accessible with real production data
- All 11 verification checklist items confirmed by human
- ADMIN_SECRET set in Railway, VITE_ADMIN_KEY set in Vercel
- Phase 7 complete — ready for Phase 8 (Test Lab)
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-dashboard-admin-view-of-searches-expert-matches-gap-tracking-csv-export/07-04-SUMMARY.md`
</output>
