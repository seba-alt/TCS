---
phase: 42-backend-error-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/browse.py
  - app/services/explorer.py
  - app/services/pilot_service.py
  - app/routers/suggest.py
autonomous: true
requirements: [ERR-01, ERR-03, ERR-04]

must_haves:
  truths:
    - "A broken expert photo URL returns 404 (not 502) and the frontend shows the card without a photo"
    - "Submitting an empty or whitespace-only string to /api/explore does not produce a 500 error"
    - "FTS5 MATCH queries in suggest and explore are wrapped with try/except safety nets"
    - "Dutch text submitted to Sage is detected and translated using gemini-2.5-flash-lite"
    - "Translation failure falls back to original text without surfacing an error"
  artifacts:
    - path: "app/routers/browse.py"
      provides: "Photo proxy returning 404 on upstream failure"
      contains: "status_code=404"
    - path: "app/services/explorer.py"
      provides: "FTS5 MATCH with try/except safety net"
      contains: "explore.fts5_match_failed"
    - path: "app/services/pilot_service.py"
      provides: "Updated Gemini model for language detection"
      contains: "gemini-2.5-flash-lite"
    - path: "app/routers/suggest.py"
      provides: "FTS5 MATCH with try/except safety net in suggest path"
      contains: "suggest.fts5_match_failed"
  key_links:
    - from: "app/routers/browse.py"
      to: "frontend ExpertCard.tsx onError handler"
      via: "HTTP 404 triggers img onError which sets imgError=true"
      pattern: "status_code=404"
    - from: "app/services/pilot_service.py"
      to: "Gemini API"
      via: "model parameter in generate_content call"
      pattern: "gemini-2.5-flash-lite"
---

<objective>
Fix three backend error sources visible in Sentry: photo proxy 502 errors, FTS5 empty-string 500 errors, and deprecated Gemini model failures.

Purpose: Eliminate all backend Sentry noise from these three error categories before public launch.
Output: Clean backend with graceful degradation on all three error paths.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/42-backend-error-hardening/42-RESEARCH.md
@.planning/phases/42-backend-error-hardening/42-CONTEXT.md
@app/routers/browse.py
@app/services/explorer.py
@app/services/pilot_service.py
@app/routers/suggest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix photo proxy 502→404 and harden FTS5 MATCH paths</name>
  <files>app/routers/browse.py, app/services/explorer.py, app/routers/suggest.py</files>
  <action>
**Photo proxy (browse.py):**
Change both HTTPException raises in the `photo_proxy()` endpoint from `status_code=502` to `status_code=404`:
1. Line ~183: The `except httpx.RequestError:` handler — change to `raise HTTPException(status_code=404, detail="Photo not found")`
2. Line ~186: The `if upstream_resp.status_code != 200:` handler — change to `raise HTTPException(status_code=404, detail="Photo not found")`

The frontend `ExpertCard.tsx` already handles any non-200 response by setting `imgError=true` via the `onError` callback, which hides the photo element silently. No frontend changes needed.

**FTS5 safety net in explorer.py:**
In `run_explore()`, wrap the existing FTS5 MATCH block (the `if safe_q:` section around line 224-242) in a try/except. On exception, log a warning with structlog and continue without BM25 scores — FAISS-only results are still valid. The existing `_safe_fts_query()` function already sanitizes input, but this is the belt-and-suspenders guard per CONTEXT.md.

```python
bm25_scores: dict[int, float] = {}
if safe_q:
    try:
        fts_rows = db.execute(...)  # existing code
        # ... existing processing
    except Exception as exc:
        log.warning("explore.fts5_match_failed", error=str(exc), query=safe_q)
        # Continue without BM25 — FAISS results still valid
```

**FTS5 safety net in suggest.py:**
In `_run_suggest_multi()`, the existing `try/except` around each column's FTS5 MATCH (line ~53-66) already catches exceptions and continues. This is already correct. However, add a log.warning inside the except block for observability:

```python
except Exception as exc:
    log.warning("suggest.fts5_match_failed", column=column, error=str(exc))
    continue
```

Add `import structlog` at the top of suggest.py and create a module-level logger: `log = structlog.get_logger()`.
  </action>
  <verify>
    grep -n "status_code=404" app/routers/browse.py | grep -c "404" should show 2 occurrences.
    grep -n "fts5_match_failed" app/services/explorer.py should show the new warning log.
    grep -n "fts5_match_failed" app/routers/suggest.py should show the new warning log.
    python -c "from app.routers.browse import router; print('browse imports OK')"
    python -c "from app.services.explorer import run_explore; print('explorer imports OK')"
    python -c "from app.routers.suggest import router; print('suggest imports OK')"
  </verify>
  <done>Photo proxy returns 404 on upstream failure. FTS5 MATCH in both explore and suggest paths has try/except safety nets with structlog warnings. All modules import cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Replace deprecated gemini-2.0-flash-lite with gemini-2.5-flash-lite</name>
  <files>app/services/pilot_service.py</files>
  <action>
In `app/services/pilot_service.py`, find the `_detect_and_translate()` function (around line 99-129).

Change the model parameter in the `client.models.generate_content()` call from `"gemini-2.0-flash-lite"` to `"gemini-2.5-flash-lite"`.

Update the docstring comment above the model call to reflect the change:
- Old: `Uses gemini-2.0-flash-lite for speed -- this is a structured JSON extraction,`
- New: `Uses gemini-2.5-flash-lite for speed -- this is a structured JSON extraction,`

The rest of the function stays identical — the `response_mime_type="application/json"` config, the JSON parsing, and the fallback behavior are all model-agnostic.

Also update the comment at the top of the function docstring if it mentions the old model name.

Per CONTEXT.md decision: translation failure must show original untranslated text rather than an error message. The existing fallback `return "en", message` already does this correctly — no change needed to the error handling.
  </action>
  <verify>
    grep -n "gemini-2.0-flash-lite" app/services/pilot_service.py should return NO results (old model fully removed).
    grep -n "gemini-2.5-flash-lite" app/services/pilot_service.py should return at least 1 result.
    python -c "from app.services.pilot_service import run_pilot; print('pilot_service imports OK')"
  </verify>
  <done>The deprecated gemini-2.0-flash-lite model string is replaced with gemini-2.5-flash-lite. The function's fallback behavior (return original text on failure) is preserved. No other Gemini model references are affected (llm.py and search_intelligence.py already use gemini-2.5-flash).</done>
</task>

</tasks>

<verification>
1. `grep -rn "status_code=502" app/routers/browse.py` returns no results (all 502s replaced with 404s)
2. `grep -rn "gemini-2.0-flash-lite" app/` returns no results (deprecated model fully removed)
3. `grep -rn "fts5_match_failed" app/` returns results in both explorer.py and suggest.py
4. All Python modules import without errors
</verification>

<success_criteria>
- Photo proxy endpoint returns 404 (not 502) when upstream photo is unavailable or returns non-200
- FTS5 MATCH queries in explore and suggest paths have try/except safety nets that log warnings and degrade gracefully
- The deprecated gemini-2.0-flash-lite model is replaced with gemini-2.5-flash-lite in pilot_service.py
- No new dependencies added; all changes use existing libraries
</success_criteria>

<output>
After completion, create `.planning/phases/42-backend-error-hardening/42-01-SUMMARY.md`
</output>
