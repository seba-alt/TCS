---
phase: 06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/types.ts
  - frontend/src/hooks/useChat.ts
  - frontend/src/hooks/useFeedback.ts
  - frontend/src/components/FeedbackBar.tsx
  - frontend/src/components/DownvoteModal.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "FeedbackBar renders thumb-up and thumb-down SVG buttons with a label above them"
    - "Clicking a thumb calls submitVote which fires a POST to /api/feedback (fire-and-forget)"
    - "The clicked thumb stays highlighted (filled); clicking the same thumb again does nothing"
    - "Clicking thumbs-down opens DownvoteModal on top of the page"
    - "DownvoteModal shows 4 checkboxes and an optional free-text field; closing without submitting is fine"
    - "The Message type carries conversationId and useChat stores it from the SSE result event"
  artifacts:
    - path: "frontend/src/types.ts"
      provides: "conversationId field on Message, FeedbackVote type, SSEResultEvent with conversation_id"
      contains: "conversationId"
    - path: "frontend/src/hooks/useChat.ts"
      provides: "conversationId parsed from SSE result event and stored on message"
      contains: "conversationId"
    - path: "frontend/src/hooks/useFeedback.ts"
      provides: "vote state management + API POST + modal open/close"
      exports: ["useFeedback", "FeedbackVote"]
    - path: "frontend/src/components/FeedbackBar.tsx"
      provides: "Thumb buttons + label, delegates state to useFeedback"
      min_lines: 40
    - path: "frontend/src/components/DownvoteModal.tsx"
      provides: "Centered modal overlay with checkboxes and free text"
      min_lines: 60
  key_links:
    - from: "frontend/src/components/FeedbackBar.tsx"
      to: "frontend/src/hooks/useFeedback.ts"
      via: "useFeedback hook call"
      pattern: "useFeedback"
    - from: "frontend/src/hooks/useFeedback.ts"
      to: "/api/feedback"
      via: "fetch POST in submitVote"
      pattern: "fetch.*api/feedback"
    - from: "frontend/src/hooks/useChat.ts"
      to: "message.conversationId"
      via: "SSE result event parsing"
      pattern: "conversationId.*conversation_id"
---

<objective>
Frontend feedback data layer and UI components: types extension, useChat SSE parsing update, useFeedback hook, FeedbackBar component, and DownvoteModal dialog.

Purpose: Build every feedback UI piece as new files, plus minimal changes to types.ts and useChat.ts so the conversation_id flows from the SSE stream into the message, and from the message into FeedbackBar.
Output: useFeedback hook, FeedbackBar, DownvoteModal as standalone new files; types.ts and useChat.ts extended with conversationId support.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types.ts and useChat.ts with conversationId support</name>
  <files>frontend/src/types.ts, frontend/src/hooks/useChat.ts</files>
  <action>
    **In frontend/src/types.ts** — add two changes:

    1. Add `conversationId?: number` to the `Message` interface (after `experts?`):
    ```typescript
    export interface Message {
      id: string
      role: MessageRole
      content: string
      experts?: Expert[]
      conversationId?: number   // from SSE result event; only on assistant recommendation messages
      isStreaming?: boolean
    }
    ```

    2. Add `FeedbackVote` type (after the existing types):
    ```typescript
    export type FeedbackVote = 'up' | 'down' | null
    ```

    3. Extend `SSEResultEvent` to include `conversation_id`:
    ```typescript
    export interface SSEResultEvent {
      event: 'result'
      type: 'recommendation' | 'clarification'
      narrative: string
      experts: Expert[]
      conversation_id?: number
    }
    ```

    **In frontend/src/hooks/useChat.ts** — in the `result` event branch (currently lines 117–133), read `conversation_id` from the event and store it on the message:

    Change:
    ```typescript
    } else if (event.event === 'result') {
      const narrative = event.narrative as string
      const experts = (event.experts ?? []) as Expert[]

      setStatus('streaming')
      updateLastAssistantMessage((msg) => ({
        ...msg,
        content: narrative,
        experts: experts.length > 0 ? experts : undefined,
        isStreaming: true,
      }))
    ```

    To:
    ```typescript
    } else if (event.event === 'result') {
      const narrative = event.narrative as string
      const experts = (event.experts ?? []) as Expert[]
      const conversationId = event.conversation_id as number | undefined

      setStatus('streaming')
      updateLastAssistantMessage((msg) => ({
        ...msg,
        content: narrative,
        experts: experts.length > 0 ? experts : undefined,
        conversationId,
        isStreaming: true,
      }))
    ```

    IMPORTANT: `tsconfig.app.json` sets `verbatimModuleSyntax: true`. All type-only imports must use `import type { ... }`. Do not change existing imports in useChat.ts (they already use `import type`). The `FeedbackVote` type import in new files must also use `import type`.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30`
    Expected: no TypeScript errors relating to types.ts or useChat.ts
    Run: `grep -n "conversationId" frontend/src/types.ts` — should show the new field
    Run: `grep -n "conversationId" frontend/src/hooks/useChat.ts` — should show the new assignment
  </verify>
  <done>Message interface has conversationId?: number; FeedbackVote type exported; useChat stores conversationId from SSE result event; tsc --noEmit passes</done>
</task>

<task type="auto">
  <name>Task 2: Create useFeedback hook, FeedbackBar, and DownvoteModal components</name>
  <files>frontend/src/hooks/useFeedback.ts, frontend/src/components/FeedbackBar.tsx, frontend/src/components/DownvoteModal.tsx</files>
  <action>
    **Create frontend/src/hooks/useFeedback.ts:**

    ```typescript
    import { useState, useCallback } from 'react'
    import type { FeedbackVote } from '../types'

    const API_URL = import.meta.env.VITE_API_URL ?? 'http://localhost:8000'

    interface UseFeedbackOptions {
      conversationId: number
      expertIds: string[]
      email: string | null
    }

    interface UseFeedbackReturn {
      vote: FeedbackVote
      submitVote: (v: 'up' | 'down') => void
      modalOpen: boolean
      closeModal: () => void
      submitDownvoteDetail: (reasons: string[], comment: string) => Promise<void>
    }

    export function useFeedback({ conversationId, expertIds, email }: UseFeedbackOptions): UseFeedbackReturn {
      const [vote, setVote] = useState<FeedbackVote>(null)
      const [modalOpen, setModalOpen] = useState(false)

      const postFeedback = useCallback(
        async (payload: Record<string, unknown>) => {
          try {
            await fetch(`${API_URL}/api/feedback`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            })
          } catch {
            // Intentional: backend failure is silent. UI state already updated.
          }
        },
        []
      )

      const submitVote = useCallback(
        (v: 'up' | 'down') => {
          if (vote === v) return // clicking already-selected thumb does nothing
          setVote(v)
          // Fire-and-forget — UI updates immediately; backend failure is silent
          void postFeedback({
            conversation_id: conversationId,
            vote: v,
            email: email ?? undefined,
            expert_ids: expertIds,
          })
          if (v === 'down') {
            setModalOpen(true)
          }
        },
        [vote, conversationId, expertIds, email, postFeedback]
      )

      const closeModal = useCallback(() => {
        setModalOpen(false)
      }, [])

      const submitDownvoteDetail = useCallback(
        async (reasons: string[], comment: string) => {
          await postFeedback({
            conversation_id: conversationId,
            vote: 'down',
            email: email ?? undefined,
            expert_ids: expertIds,
            reasons,
            comment: comment || undefined,
          })
          setModalOpen(false)
        },
        [conversationId, expertIds, email, postFeedback]
      )

      return { vote, submitVote, modalOpen, closeModal, submitDownvoteDetail }
    }
    ```

    **Create frontend/src/components/FeedbackBar.tsx:**

    Small, unobtrusive thumb buttons below expert cards. Always visible; fill/color on hover and when selected. Use inline SVG Heroicons-style paths (same approach as ExpertCard's external-link SVG). Brand color `brand-purple` (#5128F2) for selected/hover state.

    ```typescript
    import { useFeedback } from '../hooks/useFeedback'
    import DownvoteModal from './DownvoteModal'

    interface Props {
      conversationId: number
      expertIds: string[]
      email: string | null
    }

    export default function FeedbackBar({ conversationId, expertIds, email }: Props) {
      const { vote, submitVote, modalOpen, closeModal, submitDownvoteDetail } = useFeedback({
        conversationId,
        expertIds,
        email,
      })

      return (
        <div className="mt-4 flex flex-col items-start gap-1.5">
          <p className="text-xs text-neutral-400">Were these results helpful?</p>
          <div className="flex items-center gap-2">
            {/* Thumbs up */}
            <button
              onClick={() => submitVote('up')}
              aria-label="Thumbs up"
              aria-pressed={vote === 'up'}
              className={`p-1.5 rounded-lg transition-colors ${
                vote === 'up'
                  ? 'text-brand-purple'
                  : 'text-neutral-400 hover:text-brand-purple'
              }`}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill={vote === 'up' ? 'currentColor' : 'none'}
                stroke="currentColor"
                strokeWidth={1.5}
                className="w-5 h-5"
              >
                <path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 0 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0 1 14 3c0 .995-.182 1.948-.514 2.826L12.5 8h2.396a2 2 0 0 1 1.966 2.337l-1.053 6A2 2 0 0 1 13.843 18H9.828a2 2 0 0 1-1.414-.586l-1.914-1.914A1 1 0 0 1 6.5 15V8.86a1 1 0 0 1 .293-.707L10 4.5 11 3Z" />
              </svg>
            </button>

            {/* Thumbs down */}
            <button
              onClick={() => submitVote('down')}
              aria-label="Thumbs down"
              aria-pressed={vote === 'down'}
              className={`p-1.5 rounded-lg transition-colors ${
                vote === 'down'
                  ? 'text-red-500'
                  : 'text-neutral-400 hover:text-red-400'
              }`}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill={vote === 'down' ? 'currentColor' : 'none'}
                stroke="currentColor"
                strokeWidth={1.5}
                className="w-5 h-5"
              >
                <path d="M19 11.75a1.25 1.25 0 1 1-2.5 0v-7.5a1.25 1.25 0 0 1 2.5 0v7.5ZM9 17v1.3c0 .268-.14.526-.395.607A2 2 0 0 1 6 17c0-.995.182-1.948.514-2.826L7.5 12H5.104a2 2 0 0 1-1.966-2.337l1.053-6A2 2 0 0 1 6.157 2h4.015a2 2 0 0 1 1.414.586l1.914 1.914A1 1 0 0 1 13.5 5v6.14a1 1 0 0 1-.293.707L10 15.5 9 17Z" />
              </svg>
            </button>
          </div>

          {modalOpen && (
            <DownvoteModal
              onClose={closeModal}
              onSubmit={submitDownvoteDetail}
            />
          )}
        </div>
      )
    }
    ```

    **Create frontend/src/components/DownvoteModal.tsx:**

    Centered modal overlay. No library — Tailwind `fixed inset-0 z-50` pattern. Header uses `z-10` so `z-50` is safe. Backdrop click closes. Escape key closes. Four preset checkboxes; "Other" reveals free-text field.

    ```typescript
    import { useState, useEffect, useCallback } from 'react'

    const REASONS = [
      'Wrong experts shown',
      'Experts not relevant to my problem',
      'Experts seem unavailable or too expensive',
      'Other',
    ]

    interface Props {
      onClose: () => void
      onSubmit: (reasons: string[], comment: string) => Promise<void>
    }

    export default function DownvoteModal({ onClose, onSubmit }: Props) {
      const [selected, setSelected] = useState<Set<string>>(new Set())
      const [comment, setComment] = useState('')
      const [submitting, setSubmitting] = useState(false)

      const showCommentField = selected.has('Other')

      // Close on Escape key
      const handleKeyDown = useCallback(
        (e: KeyboardEvent) => {
          if (e.key === 'Escape') onClose()
        },
        [onClose]
      )

      useEffect(() => {
        document.addEventListener('keydown', handleKeyDown)
        return () => document.removeEventListener('keydown', handleKeyDown)
      }, [handleKeyDown])

      const toggleReason = (reason: string) => {
        setSelected((prev) => {
          const next = new Set(prev)
          if (next.has(reason)) {
            next.delete(reason)
          } else {
            next.add(reason)
          }
          return next
        })
      }

      const handleSubmit = async () => {
        setSubmitting(true)
        await onSubmit(Array.from(selected), comment)
        // onSubmit closes the modal via closeModal()
      }

      return (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
          onClick={onClose}
        >
          <div
            className="bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-xl"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="flex items-start justify-between mb-4">
              <h2 className="text-sm font-semibold text-neutral-800">
                Help us improve
              </h2>
              <button
                onClick={onClose}
                aria-label="Close"
                className="text-neutral-400 hover:text-neutral-600 transition-colors -mt-0.5 ml-4"
              >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5">
                  <path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
                </svg>
              </button>
            </div>

            <p className="text-xs text-neutral-500 mb-4">
              What went wrong? (optional — your vote is already recorded)
            </p>

            {/* Checkboxes */}
            <div className="space-y-2.5 mb-4">
              {REASONS.map((reason) => (
                <label key={reason} className="flex items-center gap-2.5 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={selected.has(reason)}
                    onChange={() => toggleReason(reason)}
                    className="w-4 h-4 rounded border-neutral-300 text-brand-purple focus:ring-brand-purple accent-brand-purple"
                  />
                  <span className="text-sm text-neutral-700">{reason}</span>
                </label>
              ))}
            </div>

            {/* Free-text field — only visible when "Other" is checked */}
            {showCommentField && (
              <textarea
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                placeholder="Tell us more…"
                maxLength={1000}
                rows={3}
                className="w-full text-sm border border-neutral-200 rounded-xl px-3 py-2 mb-4 resize-none focus:outline-none focus:ring-2 focus:ring-brand-purple/30 focus:border-brand-purple"
              />
            )}

            {/* Actions */}
            <div className="flex justify-end gap-2">
              <button
                onClick={onClose}
                className="text-sm px-4 py-2 rounded-xl text-neutral-500 hover:text-neutral-700 transition-colors"
              >
                Skip
              </button>
              <button
                onClick={handleSubmit}
                disabled={submitting || (selected.size === 0 && !comment.trim())}
                className="text-sm px-4 py-2 rounded-xl bg-brand-purple text-white hover:bg-purple-700 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
              >
                {submitting ? 'Sending…' : 'Send feedback'}
              </button>
            </div>
          </div>
        </div>
      )
    }
    ```

    IMPORTANT for all new files:
    - Use `import type { ... }` for any type-only imports (verbatimModuleSyntax: true)
    - Brand color token is `brand-purple` (already in tailwind.config.ts as `#5128F2`)
    - No new npm packages — only React hooks and Tailwind
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -40`
    Expected: 0 TypeScript errors
    Run: `ls frontend/src/hooks/useFeedback.ts frontend/src/components/FeedbackBar.tsx frontend/src/components/DownvoteModal.tsx`
    Expected: all three files exist
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20`
    Expected: build succeeds
  </verify>
  <done>useFeedback.ts, FeedbackBar.tsx, DownvoteModal.tsx created; tsc --noEmit passes; npm run build succeeds</done>
</task>

</tasks>

<verification>
1. `grep -n "conversationId" frontend/src/types.ts` — confirms field on Message
2. `grep -n "FeedbackVote" frontend/src/types.ts` — confirms type exported
3. `grep -n "conversationId" frontend/src/hooks/useChat.ts` — confirms SSE parsing
4. `ls frontend/src/hooks/useFeedback.ts frontend/src/components/FeedbackBar.tsx frontend/src/components/DownvoteModal.tsx` — all exist
5. `cd frontend && npx tsc --noEmit` — zero errors
6. `cd frontend && npm run build` — succeeds
</verification>

<success_criteria>
- Message type carries conversationId?: number
- FeedbackVote = 'up' | 'down' | null exported from types.ts
- useChat.ts stores conversationId from SSE result event on the message
- useFeedback hook manages vote state, fires POST /api/feedback on submitVote, opens modal on downvote
- FeedbackBar renders label + two SVG thumb buttons, fills on selection, uses brand-purple for up / red-500 for down
- DownvoteModal renders as centered overlay (z-50), 4 checkboxes, free text when "Other" selected, closes on backdrop click or Escape
- TypeScript build passes (tsc --noEmit, npm run build)
</success_criteria>

<output>
After completion, create `.planning/phases/06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db/06-02-SUMMARY.md`
</output>
