---
phase: 06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/models.py
  - app/routers/feedback.py
  - app/routers/chat.py
  - app/main.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "POST /api/feedback accepts a valid request and returns {status: ok} with 200"
    - "A Feedback row is written to the SQLite DB on each feedback POST"
    - "The SSE result event includes conversation_id so the frontend can link feedback to a conversation"
    - "The feedback router is registered in main.py and inherits CORS middleware automatically"
  artifacts:
    - path: "app/routers/feedback.py"
      provides: "POST /api/feedback endpoint with Pydantic validation"
      exports: ["router"]
    - path: "app/models.py"
      provides: "Feedback ORM model auto-created by Base.metadata.create_all"
      contains: "class Feedback"
    - path: "app/routers/chat.py"
      provides: "SSE result event with conversation_id field"
      contains: "conversation_id"
    - path: "app/main.py"
      provides: "feedback router registered"
      contains: "include_router(feedback.router)"
  key_links:
    - from: "app/routers/feedback.py"
      to: "app/models.py"
      via: "Feedback ORM model import"
      pattern: "from app\\.models import Feedback"
    - from: "app/main.py"
      to: "app/routers/feedback.py"
      via: "include_router"
      pattern: "include_router\\(feedback\\.router\\)"
    - from: "app/routers/chat.py"
      to: "conversation.id"
      via: "SSE result event payload"
      pattern: "conversation_id.*conversation\\.id"
---

<objective>
Backend feedback infrastructure: Feedback SQLAlchemy model, POST /api/feedback endpoint, and conversation_id surfaced in SSE result events.

Purpose: The frontend needs (a) a DB-backed endpoint to record thumbs up/down votes and optional downvote detail, and (b) the conversation_id in the SSE stream so it can link feedback to the right conversation.
Output: New Feedback table auto-created at startup, POST /api/feedback router, conversation_id in SSE result event.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Feedback model to models.py and extend chat.py SSE result event</name>
  <files>app/models.py, app/routers/chat.py</files>
  <action>
    **In app/models.py** — add the Feedback class after EmailLead, following the exact same Mapped/mapped_column SQLAlchemy 2.0 pattern already used by Conversation and EmailLead:

    ```python
    class Feedback(Base):
        """
        Records thumbs up/down votes on expert result sets.
        Linked to a Conversation via conversation_id (no FK — consistent with schema style).
        Switching votes creates a new record (latest wins for analytics; history preserved).
        Auto-created by Base.metadata.create_all at startup — no migration script needed.
        """
        __tablename__ = "feedback"

        id: Mapped[int] = mapped_column(primary_key=True, index=True)
        conversation_id: Mapped[int] = mapped_column(index=True, nullable=False)
        vote: Mapped[str] = mapped_column(String(4), nullable=False)           # "up" | "down"
        email: Mapped[str | None] = mapped_column(String(320), nullable=True)  # from email gate if provided
        expert_ids: Mapped[str] = mapped_column(Text, nullable=False, default="[]")  # JSON list of profile_url|name
        reasons: Mapped[str | None] = mapped_column(Text, nullable=True)       # JSON list of checkbox labels
        comment: Mapped[str | None] = mapped_column(Text, nullable=True)       # free-text from modal
        created_at: Mapped[datetime.datetime] = mapped_column(
            DateTime, default=datetime.datetime.utcnow, nullable=False
        )
    ```

    No FK on conversation_id — consistent with existing schema (no FK relationships in this project).
    No unique constraint — switching votes creates a new row, preserving vote history.

    **In app/routers/chat.py** — add `conversation_id` to the result SSE event. The conversation object is already committed to DB before the yield on line 120. Change:

    ```python
    yield _sse({
        "event": "result",
        "type": llm_response.type,
        "narrative": llm_response.narrative,
        "experts": experts_payload,
    })
    ```

    to:

    ```python
    yield _sse({
        "event": "result",
        "type": llm_response.type,
        "narrative": llm_response.narrative,
        "experts": experts_payload,
        "conversation_id": conversation.id,
    })
    ```

    This is a one-line addition. The conversation is already committed (`db.commit()` called on line 118) so `conversation.id` is populated.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS && python -c "from app.models import Feedback; print('Feedback model OK')"`
    Run: `grep -n "conversation_id" app/routers/chat.py` — should show the new line in the result event
    Run: `grep -n "class Feedback" app/models.py` — should confirm the class exists
  </verify>
  <done>Feedback class exists in models.py with all 8 columns; chat.py result SSE event contains conversation_id key</done>
</task>

<task type="auto">
  <name>Task 2: Create POST /api/feedback router and register it in main.py</name>
  <files>app/routers/feedback.py, app/main.py</files>
  <action>
    **Create app/routers/feedback.py** — new file, following the exact same router pattern as email_capture.py:

    ```python
    """
    POST /api/feedback — Record thumbs up/down feedback on expert result sets.

    The vote is recorded immediately on thumb click (fire-and-forget from frontend).
    The same endpoint accepts optional downvote detail (reasons + comment) sent when
    the user submits the DownvoteModal form.

    Switching votes: frontend sends a new POST — backend inserts a new row.
    Latest record per conversation_id is authoritative for analytics.
    """
    import json

    import structlog
    from fastapi import APIRouter, Depends
    from pydantic import BaseModel, EmailStr, Field
    from sqlalchemy.orm import Session
    from typing import Literal

    from app.database import get_db
    from app.models import Feedback

    log = structlog.get_logger()
    router = APIRouter()


    class FeedbackRequest(BaseModel):
        conversation_id: int
        vote: Literal["up", "down"]
        email: EmailStr | None = None
        expert_ids: list[str] = Field(default_factory=list)
        reasons: list[str] = Field(default_factory=list)        # checkbox labels (downvote detail)
        comment: str | None = Field(None, max_length=1000)      # free-text (downvote detail)


    @router.post("/api/feedback", status_code=200)
    def submit_feedback(body: FeedbackRequest, db: Session = Depends(get_db)):
        """
        Insert a feedback record. Returns {status: ok} for both new votes and vote switches.
        Vote switch: frontend sends another POST — new row inserted, latest row wins for analytics.
        """
        record = Feedback(
            conversation_id=body.conversation_id,
            vote=body.vote,
            email=str(body.email) if body.email else None,
            expert_ids=json.dumps(body.expert_ids),
            reasons=json.dumps(body.reasons),
            comment=body.comment,
        )
        db.add(record)
        db.commit()
        log.info("feedback.recorded", conversation_id=body.conversation_id, vote=body.vote)
        return {"status": "ok"}
    ```

    **In app/main.py** — import the feedback router and register it. Following the exact pattern used for email_capture:

    Add to the imports:
    ```python
    from app.routers import chat, email_capture, feedback, health
    ```

    Add after the existing `app.include_router(email_capture.router)` line:
    ```python
    app.include_router(feedback.router)
    ```

    The CORS middleware in main.py applies at the middleware level to ALL routes, so no CORS changes are needed — the new route automatically inherits `allow_methods=["GET", "POST"]`.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS && uvicorn app.main:app --port 8001 &amp; sleep 3 &amp;&amp; curl -s -X POST http://localhost:8001/api/feedback -H "Content-Type: application/json" -d '{"conversation_id": 999, "vote": "up", "expert_ids": ["https://example.com"]}' &amp;&amp; kill %1`
    Expected: `{"status":"ok"}`
    Also verify: `curl -s http://localhost:8001/openapi.json | python3 -c "import sys,json; paths=json.load(sys.stdin)['paths']; print(list(paths.keys()))"` should include `/api/feedback`
  </verify>
  <done>POST /api/feedback returns {"status":"ok"} with 200; endpoint appears in OpenAPI schema; feedback router imported and registered in main.py</done>
</task>

</tasks>

<verification>
1. `python -c "from app.models import Feedback; print('Feedback model OK')"` — imports without error
2. `grep -n "class Feedback" app/models.py` — confirms model present
3. `grep -n "conversation_id" app/routers/chat.py` — confirms SSE event extended
4. `grep -n "feedback" app/main.py` — confirms router imported and registered
5. Start server and POST to /api/feedback with a test payload — returns `{"status":"ok"}`
</verification>

<success_criteria>
- Feedback SQLAlchemy model exists with 8 columns (id, conversation_id, vote, email, expert_ids, reasons, comment, created_at)
- POST /api/feedback accepts FeedbackRequest and returns {"status": "ok"}
- SSE result event in chat.py includes "conversation_id" key
- feedback router registered in main.py alongside existing routers
- Base.metadata.create_all auto-creates feedback table at next server startup (no manual migration)
</success_criteria>

<output>
After completion, create `.planning/phases/06-thumbs-up-down-feedback-rate-results-downvote-opens-suggestion-sheet-feedback-stored-in-db/06-01-SUMMARY.md`
</output>
