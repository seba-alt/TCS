---
phase: 05-email-gate-ux-show-expert-results-immediately-but-require-email-before-clicking-through-to-a-profile
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified: []
autonomous: false
requirements: [EMAIL-GATE-01]

must_haves:
  truths:
    - "New user sees greyed-out expert cards immediately after a chat response"
    - "Inline EmailGate form appears below the cards with Unlock profiles button and privacy note"
    - "Submitting a valid email instantly unlocks all cards (no animation)"
    - "Clicking an unlocked card opens the expert profile URL in a new tab"
    - "Hard refreshing after unlock shows fully unlocked cards with no gate (localStorage persists)"
    - "email_leads table in the SQLite DB contains the submitted email"
  artifacts:
    - path: "frontend/src/hooks/useEmailGate.ts"
      provides: "localStorage-backed email gate hook"
    - path: "frontend/src/components/EmailGate.tsx"
      provides: "Inline unlock form"
    - path: "app/routers/email_capture.py"
      provides: "Lead capture endpoint"
  key_links:
    - from: "EmailGate form submit"
      to: "expert cards unlocked"
      via: "useEmailGate.submitEmail → localStorage write → isUnlocked=true → ExpertCard locked=false"
      pattern: "end-to-end gate flow"
---

<objective>
Human verification of the complete email gate flow across all user states: new visitor, returning visitor, invalid email, backend capture.

Purpose: Confirm the gated UX works as intended in a real browser — greyed cards tease results, email form unlocks instantly, localStorage persists across refresh, backend stores the lead.

Output: Confirmed working email gate flow in production-like dev environment.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-email-gate-ux-show-expert-results-immediately-but-require-email-before-clicking-through-to-a-profile/05-01-SUMMARY.md
@.planning/phases/05-email-gate-ux-show-expert-results-immediately-but-require-email-before-clicking-through-to-a-profile/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start dev environment for verification</name>
  <files></files>
  <action>
    Start both backend and frontend dev servers so the user can verify the full flow.

    1. Start backend:
       `cd /Users/sebastianhamers/Documents/TCS && uvicorn app.main:app --reload --port 8000`
       (Run in background or separate terminal)

    2. Start frontend:
       `cd /Users/sebastianhamers/Documents/TCS/frontend && npx vite --port 5173`
       (Run in background or separate terminal)

    3. Confirm both are up:
       - Backend: `curl -s http://localhost:8000/api/health | python3 -m json.tool` — should return health JSON with index_size
       - Frontend: `curl -s -o /dev/null -w "%{http_code}" http://localhost:5173` — should return 200

    4. Print the local URL for the user: http://localhost:5173
  </action>
  <verify>
    Backend responds to GET /api/health with 200.
    Frontend dev server responds with 200 at http://localhost:5173.
  </verify>
  <done>Both servers running; http://localhost:5173 is accessible.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of full email gate flow</name>
  <files></files>
  <action>Human verifies the complete email gate UX in a browser using the dev servers started in Task 1.</action>
  <what-built>
    Complete email gate UX:
    - Expert cards appear greyed-out (desaturated, muted) immediately on a new visit
    - Inline EmailGate form appears below cards with "Unlock profiles" button and "We'll never spam you." privacy note
    - Valid email submission instantly unlocks all cards (no animation, form disappears)
    - Unlocked cards are clickable and navigate to expert profiles in a new tab
    - Returning users (localStorage persists) see unlocked cards on page load with no gate
    - Backend stores submitted email in email_leads SQLite table
  </what-built>
  <how-to-verify>
    Open http://localhost:5173 in your browser.

    **Test 1: New visitor — gate appears**
    1. Open DevTools → Application → Local Storage → clear any existing `tcs_gate_email` key
    2. Hard refresh the page (Cmd+Shift+R)
    3. Send a chat query (e.g., "I need help with my startup pitch")
    4. Confirm: Expert cards appear immediately but are visibly greyed-out/muted
    5. Confirm: EmailGate form appears below the cards with "Unlock expert profiles" heading, email input, "Unlock profiles" button, and "We'll never spam you." text
    6. Confirm: Clicking on a greyed-out card does nothing (pointer-events-none)

    **Test 2: Invalid email — shows error**
    7. Type "notanemail" in the email field and click "Unlock profiles"
    8. Confirm: Inline error message "Please enter a valid email address." appears below the input

    **Test 3: Valid email — instant unlock**
    9. Type a valid email (e.g., test@example.com) and click "Unlock profiles"
    10. Confirm: Button shows spinner briefly ("Unlocking…")
    11. Confirm: Cards instantly become fully styled (colors restored, no grayscale) — no animation
    12. Confirm: EmailGate form disappears immediately
    13. Confirm: Clicking an expert card opens the Tinrate profile URL in a new tab

    **Test 4: Returning visitor — no gate on reload**
    14. Hard refresh the page (Cmd+Shift+R)
    15. Send a new chat query
    16. Confirm: Expert cards appear immediately as fully unlocked (no greyed state, no gate form)
    17. Confirm: DevTools → Local Storage → `tcs_gate_email` contains the email you submitted

    **Test 5: Backend lead capture**
    18. In terminal, check the SQLite DB:
        `cd /Users/sebastianhamers/Documents/TCS && python3 -c "from app.database import engine; from app.models import EmailLead; from sqlalchemy.orm import Session; s = Session(engine); leads = s.query(EmailLead).all(); print([(l.email, l.created_at) for l in leads])"`
    19. Confirm: Your submitted email appears in the list with a timestamp

    **Test 6: Multi-turn — gate only on last message**
    20. Send a second chat query (with the gate cleared — DevTools → clear tcs_gate_email → hard refresh)
    21. After second response with experts, confirm the EmailGate form appears only below the most recent expert message, not under older messages (older messages show greyed cards without a duplicate form)

    Type "approved" if all 6 tests pass, or describe any issues found.
  </how-to-verify>
  <verify>Human has approved all 6 test scenarios by typing "approved".</verify>
  <done>All 6 verification tests pass: new visitor gate, invalid email error, valid email unlock, returning visitor no gate, backend lead capture, multi-turn gate placement.</done>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Human has confirmed all 6 test scenarios pass:
1. New visitor sees greyed-out cards and gate form
2. Invalid email shows inline error
3. Valid email instantly unlocks cards and hides form
4. Hard refresh shows unlocked cards (localStorage persists)
5. SQLite email_leads table contains submitted email
6. Gate form appears only on last expert message in multi-turn chat
</verification>

<success_criteria>
- New visitor: greyed cards + gate form visible immediately after expert response
- Invalid email: inline error message shown without page reload
- Valid email: instant unlock (cards go full color, form disappears, cards clickable)
- Page refresh: returning user sees fully unlocked cards with no gate
- Backend: email stored in email_leads table after submission
- Multi-turn: gate appears only on the most recent expert message
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-gate-ux-show-expert-results-immediately-but-require-email-before-clicking-through-to-a-profile/05-03-SUMMARY.md`
</output>
