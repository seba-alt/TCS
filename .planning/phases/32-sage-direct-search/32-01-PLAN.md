---
phase: 32-sage-direct-search
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/pilot_service.py
autonomous: true
requirements:
  - SAGE-DX-01
  - SAGE-DX-02

must_haves:
  truths:
    - "When search_experts runs, the pilot API response includes a populated `experts` array of ExpertCard dicts"
    - "Zero-result paths return `experts: []` and `total: 0` in the response"
    - "The `apply_filters` path is unaffected — its response still has `experts: None`"
  artifacts:
    - path: "app/services/pilot_service.py"
      provides: "Populated experts array in _handle_search_experts return dict"
      contains: "model_dump()"
  key_links:
    - from: "app/services/pilot_service.py"
      to: "app/services/explorer.py"
      via: "result.experts from run_explore()"
      pattern: "model_dump"
---

<objective>
Populate the `experts` field in the pilot API response when `search_experts` is called.

Purpose: The frontend currently receives `experts: null` from the pilot API after a Sage discovery query. This plan adds one surgical line to `_handle_search_experts` so the FAISS-ranked ExpertCard objects are serialized and included in the response. The existing `PilotResponse.experts: list[dict] | None = None` field in `pilot.py` already accepts this — no schema changes needed.

Output: `app/services/pilot_service.py` updated so `_handle_search_experts` returns `"experts": [e.model_dump() for e in result.experts]`.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-sage-direct-search/32-CONTEXT.md
@.planning/phases/32-sage-direct-search/32-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate experts array in _handle_search_experts</name>
  <files>app/services/pilot_service.py</files>
  <action>
In `_handle_search_experts`, update the final return dict (currently at line 231) to include the serialized expert list.

Current return (success path, after Turn 2 narration):
```python
return {
    "filters": filters_to_apply,
    "message": narration,
    "search_performed": True,
    "total": result.total,
}
```

New return:
```python
return {
    "filters": filters_to_apply,
    "message": narration,
    "search_performed": True,
    "total": result.total,
    "experts": [e.model_dump() for e in result.experts],
}
```

ONLY change the return dict at the bottom of `_handle_search_experts` (after the Turn 2 narration call). Do NOT modify `_handle_apply_filters` — its response correctly stays `experts: None` (not included in its dict).

Zero-result paths: Both fallback paths (absolute zero and zero-with-fallback) set `result.experts = []` from `run_explore()`, so `[e.model_dump() for e in result.experts]` will correctly produce `[]` automatically — no extra handling needed.

The `PilotResponse` schema in `app/routers/pilot.py` already has `experts: list[dict] | None = None` — no changes needed there.

Note: `result` here is the original (primary) result from the first `run_explore()` call. The `fallback` variable is only used for narration context — its experts are NOT included in the response (only primary result experts are injected into the grid).
  </action>
  <verify>
    Run the backend locally or check logs after deploy: make a Sage query that triggers `search_experts` and confirm the pilot response JSON includes an `experts` array (not null).

    Quick manual test: `curl -X POST https://web-production-fdbf9.up.railway.app/api/pilot -H "Content-Type: application/json" -d '{"message":"find me a fintech expert","history":[],"current_filters":{"query":"","rate_min":0,"rate_max":5000,"tags":[]}}' | python3 -m json.tool | grep -A2 '"experts"'`

    Expected: `"experts": [{ "username": "...", ... }]` with one or more expert objects.
  </verify>
  <done>
    The pilot API response for a `search_experts` query includes `experts: [{username, first_name, last_name, job_title, company, hourly_rate, currency, profile_url, tags, findability_score, category, faiss_score, bm25_score, final_score, match_reason}]`.
    A zero-result query returns `experts: []`.
    The `apply_filters` path returns `experts: null` (unchanged).
  </done>
</task>

</tasks>

<verification>
1. `grep -n "model_dump" app/services/pilot_service.py` — confirms the new line exists.
2. The file has exactly one occurrence of `model_dump` (in `_handle_search_experts` return only).
3. `_handle_apply_filters` return dict does NOT contain an `experts` key.
</verification>

<success_criteria>
`_handle_search_experts` returns `"experts": [e.model_dump() for e in result.experts]` — a list of dicts (empty list on zero results, populated list on success). The apply_filters path is unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/32-sage-direct-search/32-01-SUMMARY.md` following the summary template.
</output>
