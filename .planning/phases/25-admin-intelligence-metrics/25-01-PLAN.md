---
phase: 25-admin-intelligence-metrics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/main.py
  - app/models.py
  - app/routers/chat.py
  - app/routers/admin.py
autonomous: true
requirements:
  - INTEL-01
  - INTEL-03

must_haves:
  truths:
    - "Every Sage chat query that returns candidates writes a non-null otr_at_k value to the conversations table"
    - "Queries that return zero candidates write NULL for otr_at_k (no ZeroDivisionError)"
    - "GET /api/admin/intelligence returns rolling_avg_7d (float 0-1 or null) and query_count_7d (int)"
    - "GET /api/admin/intelligence returns index_drift with last_rebuild_at, expert_count_at_rebuild, current_expert_count, and expert_delta"
    - "The otr_at_k column migration is idempotent — safe to run on every startup"
  artifacts:
    - path: "app/main.py"
      provides: "otr_at_k REAL column migration in lifespan startup"
      contains: "ALTER TABLE conversations ADD COLUMN otr_at_k REAL"
    - path: "app/models.py"
      provides: "otr_at_k ORM field on Conversation model"
      contains: "otr_at_k"
    - path: "app/routers/chat.py"
      provides: "OTR@K computation from top-10 candidates and persistence to conversation row"
      contains: "otr_at_k"
    - path: "app/routers/admin.py"
      provides: "GET /api/admin/intelligence endpoint with OTR@K rolling avg and Index Drift"
      contains: "/intelligence"
  key_links:
    - from: "app/routers/chat.py"
      to: "conversations.otr_at_k"
      via: "SQLAlchemy conversation.otr_at_k = otr_at_k before db.commit()"
      pattern: "conversation\\.otr_at_k"
    - from: "app/routers/admin.py"
      to: "conversations.otr_at_k"
      via: "SQL AVG(otr_at_k) WHERE date(created_at) >= :cutoff AND otr_at_k IS NOT NULL"
      pattern: "AVG\\(otr_at_k\\)"
    - from: "app/routers/admin.py"
      to: "_ingest dict"
      via: "_ingest.get('last_rebuild_at') and _ingest.get('expert_count_at_rebuild')"
      pattern: "_ingest\\.get\\(['\"]last_rebuild_at"
---

<objective>
Add OTR@K computation and persistence to the chat pipeline, add the otr_at_k column migration, and expose a new /api/admin/intelligence endpoint that returns the 7-day rolling average OTR@K and Index Drift data.

Purpose: Gives operators a quantitative signal on retrieval health — what fraction of top-10 results score above 0.60 — and surfaces index staleness from the Phase 24 _ingest dict.
Output: otr_at_k column in conversations table, OTR@K written per chat query, GET /api/admin/intelligence endpoint ready for frontend consumption.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-admin-intelligence-metrics/25-RESEARCH.md
@app/main.py
@app/models.py
@app/routers/chat.py
@app/routers/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB Migration + ORM Field — otr_at_k column</name>
  <files>app/main.py, app/models.py</files>
  <action>
In app/main.py, add "ALTER TABLE conversations ADD COLUMN otr_at_k REAL" to the existing inline migration block in the lifespan function. The existing block already uses a try/except per DDL statement pattern — add the new DDL to the same list. Follow the exact pattern of lines 117-121 (existing ALTER TABLE statements). Add a log.info call after: `log.info("startup: Phase 25 otr_at_k column migrated/verified")`.

In app/models.py, add the otr_at_k field to the Conversation ORM class. Follow the existing pattern for nullable float fields. The field is: `otr_at_k: Mapped[float | None] = mapped_column(Float, nullable=True)`. Place it near the other analytics fields (top_match_score, gap_resolved, hyde_triggered, feedback_applied).

Do NOT add otr_at_k to any Pydantic response schema or ExploreResponse — admin-only field, never exposed in public contracts.
  </action>
  <verify>
Run `cd /Users/sebastianhamers/Documents/TCS && python -c "from app.models import Conversation; print(hasattr(Conversation, 'otr_at_k'))"` — must print True.
Search main.py for "otr_at_k": `grep -n "otr_at_k" app/main.py` — must find the ALTER TABLE line.
  </verify>
  <done>Conversation ORM has otr_at_k: Mapped[float | None] field. main.py lifespan has the ALTER TABLE DDL in the migration block. Both changes are syntactically valid Python.</done>
</task>

<task type="auto">
  <name>Task 2: OTR@K Computation in Chat Router</name>
  <files>app/routers/chat.py</files>
  <action>
In app/routers/chat.py, after the line `top_score = candidates[0].score if candidates else None` (around line 94), compute otr_at_k from the top-10 candidates using the same .score attribute:

```python
# OTR@K: fraction of top-10 candidates with score >= 0.60 (admin-only, not in response)
top_k = candidates[:10]
otr_at_k: float | None = (
    sum(1 for c in top_k if c.score >= 0.60) / len(top_k)
    if top_k else None
)
```

Then, where the Conversation row is created (around line 128, where top_match_score=top_score is set), add `otr_at_k=otr_at_k` to the Conversation constructor call or set it as an attribute before db.commit().

CRITICAL: otr_at_k MUST NOT appear in any response payload. It is only written to the DB. Do NOT add it to the chat response dict.

CRITICAL: Use `c.score` — the same score field used for `top_score` — not a FAISS raw score. The threshold 0.60 aligns with GAP_THRESHOLD already used in the codebase.

Guard: `if top_k else None` prevents ZeroDivisionError when no candidates are returned.
  </action>
  <verify>
Run `grep -n "otr_at_k" app/routers/chat.py` — must find both the computation block and the Conversation assignment.
Run `python -c "import ast; ast.parse(open('app/routers/chat.py').read()); print('syntax OK')"` from project root.
  </verify>
  <done>chat.py computes otr_at_k after retrieval (None when 0 candidates), assigns it to the Conversation row before commit, and does NOT include it in any response payload.</done>
</task>

<task type="auto">
  <name>Task 3: GET /api/admin/intelligence Endpoint</name>
  <files>app/routers/admin.py</files>
  <action>
In app/routers/admin.py, add a new endpoint `@router.get("/intelligence")` (not auth_router — router has _require_admin dependency). Place it after the existing get_intelligence_stats function or near other stats endpoints.

Implementation:
```python
@router.get("/intelligence")
def get_intelligence_metrics(request: Request, db: Session = Depends(get_db)):
    """OTR@K 7-day rolling average + Index Drift from _ingest dict."""
    from sqlalchemy import text as _text
    from datetime import datetime, timedelta

    cutoff = (datetime.utcnow() - timedelta(days=7)).strftime("%Y-%m-%d")
    row = db.execute(_text("""
        SELECT AVG(otr_at_k) AS rolling_avg, COUNT(*) AS query_count
        FROM conversations
        WHERE otr_at_k IS NOT NULL
          AND date(created_at) >= :cutoff
    """), {"cutoff": cutoff}).one_or_none()

    otr_rolling_avg = round(float(row.rolling_avg), 4) if row and row.rolling_avg is not None else None
    otr_query_count = int(row.query_count) if row else 0

    # Index Drift — reads from Phase 24 _ingest dict (in-memory, resets on deploy)
    current_expert_count = len(request.app.state.metadata)
    last_rebuild_at = _ingest.get("last_rebuild_at")
    expert_count_at_rebuild = _ingest.get("expert_count_at_rebuild")

    return {
        "otr": {
            "rolling_avg_7d": otr_rolling_avg,
            "query_count_7d": otr_query_count,
        },
        "index_drift": {
            "last_rebuild_at": last_rebuild_at,
            "expert_count_at_rebuild": expert_count_at_rebuild,
            "current_expert_count": current_expert_count,
            "expert_delta": (
                current_expert_count - expert_count_at_rebuild
                if expert_count_at_rebuild is not None else None
            ),
        },
    }
```

Note: datetime and timedelta may already be imported — check existing imports first and only add if missing. `_text` is already imported as `from sqlalchemy import text as _text` — verify before adding.

Verify the endpoint path will be `/api/admin/intelligence` — the router is included in main.py with prefix `/api/admin`.
  </action>
  <verify>
Run `grep -n "def get_intelligence_metrics\|/intelligence" app/routers/admin.py` — must find the endpoint definition.
Run `python -c "import ast; ast.parse(open('app/routers/admin.py').read()); print('syntax OK')"` from project root.
Start the server locally: `cd /Users/sebastianhamers/Documents/TCS && uvicorn app.main:app --port 8001 &amp;&amp; sleep 3 &amp;&amp; curl -s -H "X-Admin-Key: test" http://localhost:8001/api/admin/intelligence | python -m json.tool` — response must contain `otr` and `index_drift` keys (rolling_avg_7d may be null if no data yet).
  </verify>
  <done>GET /api/admin/intelligence returns JSON with `otr.rolling_avg_7d` (float or null), `otr.query_count_7d` (int), `index_drift.last_rebuild_at` (float or null), `index_drift.expert_count_at_rebuild` (int or null), `index_drift.current_expert_count` (int), `index_drift.expert_delta` (int or null). Endpoint is protected by _require_admin dependency via the `router` object.</done>
</task>

</tasks>

<verification>
1. `grep -n "otr_at_k" app/main.py` — finds ALTER TABLE line in migration block
2. `grep -n "otr_at_k" app/models.py` — finds Mapped[float | None] field on Conversation
3. `grep -n "otr_at_k" app/routers/chat.py` — finds computation block AND Conversation assignment; NOT in any response
4. `grep -n "get_intelligence_metrics\|rolling_avg\|index_drift" app/routers/admin.py` — finds new endpoint
5. `python -c "import ast; ast.parse(open('app/routers/admin.py').read()); print('OK')"` passes
6. `python -c "import ast; ast.parse(open('app/routers/chat.py').read()); print('OK')"` passes
</verification>

<success_criteria>
- otr_at_k column migration is in main.py lifespan startup block (idempotent try/except)
- Conversation ORM model has otr_at_k: Mapped[float | None] field
- chat.py computes otr_at_k (None on zero results, float 0.0-1.0 otherwise) and writes to conversation row
- GET /api/admin/intelligence endpoint exists on the admin router with _require_admin dependency
- Endpoint returns correct JSON shape with otr and index_drift keys
- No otr_at_k value exposed in any public API response
- All modified Python files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/25-admin-intelligence-metrics/25-01-SUMMARY.md`
</output>
