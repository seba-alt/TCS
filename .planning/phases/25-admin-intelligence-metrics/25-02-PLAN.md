---
phase: 25-admin-intelligence-metrics
plan: 02
type: execute
wave: 2
depends_on:
  - "25-01"
files_modified:
  - frontend/src/admin/types.ts
  - frontend/src/admin/hooks/useAdminData.ts
  - frontend/src/admin/pages/IntelligenceDashboardPage.tsx
autonomous: false
requirements:
  - INTEL-02
  - INTEL-04

must_haves:
  truths:
    - "The admin Intelligence page shows an OTR@K 7-day rolling average displayed as a percentage (e.g. '82%') with green/amber/red color coding"
    - "The admin Intelligence page shows how long ago the FAISS index was last rebuilt (e.g. '3 days ago' or '—' if never rebuilt)"
    - "The admin Intelligence page shows the expert count at rebuild and the delta since rebuild (e.g. '+12 experts added since rebuild' or '—' if unknown)"
    - "When no queries exist yet, OTR@K shows '—' (em dash) rather than crashing or showing 0%"
    - "Existing Intelligence settings panel (toggles, numeric inputs) remains fully functional after changes"
  artifacts:
    - path: "frontend/src/admin/types.ts"
      provides: "IntelligenceMetrics TypeScript interface"
      contains: "IntelligenceMetrics"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useIntelligenceMetrics hook fetching from /api/admin/intelligence"
      contains: "useIntelligenceMetrics"
    - path: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      provides: "OTR@K and Index Drift metric panels added as new sections"
      contains: "otr|index_drift|rolling_avg"
  key_links:
    - from: "frontend/src/admin/hooks/useAdminData.ts"
      to: "/api/admin/intelligence"
      via: "adminFetch<IntelligenceMetrics>('/intelligence')"
      pattern: "adminFetch.*intelligence"
    - from: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      to: "useIntelligenceMetrics"
      via: "import and call at component top level"
      pattern: "useIntelligenceMetrics"
---

<objective>
Add the IntelligenceMetrics TypeScript interface, useIntelligenceMetrics fetch hook, and two metric panels (OTR@K + Index Drift) to the existing IntelligenceDashboardPage — without breaking the existing settings controls on that page.

Purpose: Surfaces actionable retrieval health signal to admins: OTR@K as a color-coded percentage and Index Drift as time-since-rebuild + expert count delta.
Output: IntelligenceMetrics type, useIntelligenceMetrics hook, two metric card sections at the top of IntelligenceDashboardPage.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-admin-intelligence-metrics/25-RESEARCH.md
@.planning/phases/25-admin-intelligence-metrics/25-01-SUMMARY.md
@frontend/src/admin/types.ts
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/pages/IntelligenceDashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: IntelligenceMetrics Type + useIntelligenceMetrics Hook</name>
  <files>frontend/src/admin/types.ts, frontend/src/admin/hooks/useAdminData.ts</files>
  <action>
In frontend/src/admin/types.ts, add the IntelligenceMetrics interface. Place it after the existing IntelligenceStats interface (search for that to find the right location):

```typescript
export interface IntelligenceMetrics {
  otr: {
    rolling_avg_7d: number | null
    query_count_7d: number
  }
  index_drift: {
    last_rebuild_at: number | null           // Unix timestamp seconds
    expert_count_at_rebuild: number | null
    current_expert_count: number
    expert_delta: number | null
  }
}
```

In frontend/src/admin/hooks/useAdminData.ts, add the useIntelligenceMetrics hook. Import IntelligenceMetrics from types.ts (check existing imports — it may already import from '../types' or './types'). Follow the exact pattern of the existing useIntelligenceStats hook (or whichever hook uses adminFetch — the pattern is: useState, useCallback with adminFetch, useEffect calling fetchData, return { data, loading, error, refetch }):

```typescript
export function useIntelligenceMetrics() {
  const [data, setData] = useState<IntelligenceMetrics | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<IntelligenceMetrics>('/intelligence')
      .then(setData)
      .catch((e: Error) => setError(e.message))
      .finally(() => setLoading(false))
  }, [])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}
```

Check the existing adminFetch call pattern — the path argument is relative to /api/admin (so '/intelligence' resolves to /api/admin/intelligence). Confirm by looking at how other hooks call adminFetch in the same file.
  </action>
  <verify>
Run `grep -n "IntelligenceMetrics" frontend/src/admin/types.ts` — must find the interface.
Run `grep -n "useIntelligenceMetrics" frontend/src/admin/hooks/useAdminData.ts` — must find the hook export.
Run `cd /Users/sebastianhamers/Documents/TCS && npx tsc --noEmit --project frontend/tsconfig.json 2>&1 | head -20` — must show no TypeScript errors in the new code.
  </verify>
  <done>IntelligenceMetrics interface exported from types.ts. useIntelligenceMetrics hook exported from useAdminData.ts. TypeScript compilation produces no errors for the new additions.</done>
</task>

<task type="auto">
  <name>Task 2: OTR@K + Index Drift Metric Panels in IntelligenceDashboardPage</name>
  <files>frontend/src/admin/pages/IntelligenceDashboardPage.tsx</files>
  <action>
In IntelligenceDashboardPage.tsx, add import for useIntelligenceMetrics from the hooks file (follow existing import patterns — likely '../hooks/useAdminData' or similar relative path).

At the component top level (after existing hooks), call:
```typescript
const { data: metrics, loading: metricsLoading } = useIntelligenceMetrics()
```

Add two helper functions as module-level pure functions before the component:

```typescript
function otrColor(avg: number | null): string {
  if (avg === null) return 'text-slate-400'
  if (avg >= 0.75) return 'text-green-400'
  if (avg >= 0.60) return 'text-yellow-400'
  return 'text-red-400'
}

function timeAgo(unixTs: number | null): string {
  if (unixTs === null) return '—'
  const diffSec = Math.floor(Date.now() / 1000 - unixTs)
  if (diffSec < 60) return 'just now'
  if (diffSec < 3600) return `${Math.floor(diffSec / 60)} min ago`
  if (diffSec < 86400) return `${Math.floor(diffSec / 3600)} hr ago`
  return `${Math.floor(diffSec / 86400)} days ago`
}
```

At the TOP of the JSX return (before the existing settings panel), add a metrics section with two cards side-by-side using a CSS grid or flex row. Use Tailwind classes consistent with the existing admin page styling (dark background, subtle borders, text-slate-*). The existing page likely uses a div.space-y-* or similar wrapper — insert the metrics section inside that wrapper, above the settings content.

OTR@K card content:
- Label: "On-Topic Rate (7-day)" in text-slate-400 small text
- Value: metrics?.otr.rolling_avg_7d !== null and not undefined ? Math.round((metrics.otr.rolling_avg_7d) * 100) + '%' : '—'
- Color class derived from otrColor(metrics?.otr.rolling_avg_7d ?? null)
- Sub-label: "based on N queries" in text-slate-500 text-xs when query_count_7d > 0; "no data yet" when 0
- Loading state: show "—" during metricsLoading

Index Drift card content:
- Label: "Index Drift" in text-slate-400 small text
- Rebuilt row: "Last rebuilt: " + timeAgo(metrics?.index_drift.last_rebuild_at ?? null) in text-slate-200
- Expert count row when expert_delta is not null: show current_expert_count experts, then delta formatted as "+N" (text-green-400) or "-N" (text-red-400) or "no change" since rebuild
- When expert_delta is null: show current_expert_count and "— no rebuild recorded" note
- Loading state: show "—" during metricsLoading

Card styling: Use a dark card with bg-slate-800 border border-slate-700 rounded-lg p-4 or match the existing card pattern on this page. Keep it visually consistent with existing admin panels — do NOT apply Phase 22 glassmorphism (admin pages use flat dark styling, not aurora glass).

CRITICAL: Do NOT modify or remove any existing JSX, hooks, or handlers for the settings panel. The existing controls (toggles, numeric inputs, save buttons) must remain fully intact. Only ADD a new section at the top of the render output.
  </action>
  <verify>
Run `cd /Users/sebastianhamers/Documents/TCS && npx tsc --noEmit --project frontend/tsconfig.json 2>&1 | head -30` — must pass with no errors.
Run `cd /Users/sebastianhamers/Documents/TCS && npm --prefix frontend run build 2>&1 | tail -20` — must complete without errors.
Run `grep -n "useIntelligenceMetrics\|otrColor\|timeAgo\|index_drift\|rolling_avg" frontend/src/admin/pages/IntelligenceDashboardPage.tsx | head -20` — must find all patterns.
  </verify>
  <done>IntelligenceDashboardPage renders two metric cards above the existing settings panel. OTR@K card shows percentage (or '—') with correct color class. Index Drift card shows time-ago for last rebuild and expert count delta. Both cards show '—' gracefully when data is null. TypeScript build passes. Existing settings controls are unchanged.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human Verification — Admin Intelligence Dashboard</name>
  <action>Pause for human visual verification of the Intelligence page in the deployed admin at https://tcs-three-sigma.vercel.app/admin. All automated work is complete — push to main triggers auto-deploy before verifying.</action>
  <verify>Human approval received via resume-signal after confirming all items in how-to-verify are correct.</verify>
  <done>Human types "approved" confirming both metric cards render above existing settings controls and the settings controls remain functional.</done>
  <what-built>
    OTR@K and Index Drift metric panels on the admin Intelligence page. Backend endpoint GET /api/admin/intelligence serving rolling average and index drift data. Full pipeline from chat query to otr_at_k DB write to admin dashboard display.
  </what-built>
  <how-to-verify>
    1. Open https://tcs-three-sigma.vercel.app/admin and log in with your admin key
    2. Navigate to the Intelligence tab in the sidebar
    3. Verify: Two metric cards appear ABOVE the existing settings toggles
    4. Verify: "On-Topic Rate (7-day)" card shows either a percentage with color (green/amber/red) or '—' if no queries exist yet
    5. Verify: "Index Drift" card shows last rebuild time (or '—') and expert count info
    6. Verify: Existing Intelligence settings (QUERY_EXPANSION_ENABLED toggle, SIMILARITY_THRESHOLD input, etc.) are still present and functional below the metric cards
    7. Optional: Run a chat query at https://tcs-three-sigma.vercel.app, then refresh Intelligence tab — OTR@K query count should increment
  </how-to-verify>
  <resume-signal>Type "approved" if both metric cards render correctly and existing settings are intact. Describe any issues if not.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project frontend/tsconfig.json` — no TypeScript errors
2. `npm --prefix frontend run build` — vite build exits 0
3. IntelligenceMetrics interface in types.ts, useIntelligenceMetrics in useAdminData.ts, both metric panels in IntelligenceDashboardPage.tsx
4. Human-verified: metric cards visible, color coding correct, existing settings intact
</verification>

<success_criteria>
- IntelligenceMetrics TypeScript interface exported from types.ts
- useIntelligenceMetrics hook exported from useAdminData.ts, fetches from /api/admin/intelligence
- IntelligenceDashboardPage shows OTR@K as percentage with green/amber/red color coding
- IntelligenceDashboardPage shows Index Drift: time-ago for rebuild and expert count delta
- Null/missing states display '—' (em dash), no crashes or 0% misleads
- Existing settings panel controls unchanged and functional
- TypeScript + Vite build passes
- Human verified on deployed URL
</success_criteria>

<output>
After completion, create `.planning/phases/25-admin-intelligence-metrics/25-02-SUMMARY.md`
</output>
