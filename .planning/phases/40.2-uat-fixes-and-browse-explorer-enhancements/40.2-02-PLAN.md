---
phase: 40.2-uat-fixes-and-browse-explorer-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/explorer.py
  - frontend/src/store/resultsSlice.ts
  - frontend/src/components/marketplace/ExpertCard.tsx
  - frontend/src/components/marketplace/FilterChips.tsx
  - frontend/src/components/marketplace/ExpertGrid.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: [UAT-EXPLORER-PHOTOS, UAT-CLEAR-ALL-PILL, UAT-SAVE-BOOKMARK]

must_haves:
  truths:
    - "Explorer ExpertCard shows a small circle avatar (32-36px) to the left of the expert name when photo exists"
    - "ExpertCard hides the photo circle entirely when no photo — name shifts left with no placeholder"
    - "Clear All button in FilterChips is styled as a pill matching existing filter tag pills"
    - "User can bookmark an expert via a bookmark icon at the right edge of each ExpertCard"
    - "Bookmarked experts are persisted in localStorage and survive page refresh"
    - "User can filter Explorer to show only saved experts via a 'Saved' pill/toggle"
  artifacts:
    - path: "app/services/explorer.py"
      provides: "photo_url field in ExpertCard response model"
    - path: "frontend/src/store/resultsSlice.ts"
      provides: "photo_url field in Expert interface"
    - path: "frontend/src/components/marketplace/ExpertCard.tsx"
      provides: "Profile photo avatar + bookmark icon"
    - path: "frontend/src/components/marketplace/FilterChips.tsx"
      provides: "Clear All pill styling + Saved filter toggle"
  key_links:
    - from: "frontend/src/components/marketplace/ExpertCard.tsx"
      to: "/api/photos/{username}"
      via: "img src with API_BASE prefix"
      pattern: "API_BASE.*photo"
    - from: "frontend/src/components/marketplace/ExpertCard.tsx"
      to: "localStorage"
      via: "bookmark toggle writes tcs_saved_experts"
      pattern: "tcs_saved_experts"
    - from: "frontend/src/components/marketplace/FilterChips.tsx"
      to: "localStorage"
      via: "Saved pill reads tcs_saved_experts"
      pattern: "tcs_saved_experts"
---

<objective>
Add Explorer enhancements: profile pictures on ExpertCards, Clear All pill styling, and save/bookmark feature.

Purpose: Three Explorer improvements from UAT — profile photos for expert recognition, consistent pill styling for Clear All, and a bookmark feature for saving interesting experts.
Output: ExpertCards with photo avatars and bookmark icons, pill-styled Clear All button, "Saved" filter in Explorer.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-CONTEXT.md
@.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-RESEARCH.md
@app/services/explorer.py
@frontend/src/store/resultsSlice.ts
@frontend/src/components/marketplace/ExpertCard.tsx
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/components/marketplace/FilterChips.tsx
@frontend/src/pages/MarketplacePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add photo_url to backend ExpertCard + frontend Expert type + ExpertCard avatar</name>
  <files>app/services/explorer.py, frontend/src/store/resultsSlice.ts, frontend/src/components/marketplace/ExpertCard.tsx</files>
  <action>
**app/services/explorer.py — Add photo_url to ExpertCard model:**
1. Add `photo_url: str | None` field to the `ExpertCard` Pydantic model (after `profile_url`).
2. In the `_build_card` function, add `photo_url=expert.photo_url` to the ExpertCard constructor. The `Expert` ORM model already has `photo_url` (added in Phase 36).

**frontend/src/store/resultsSlice.ts — Add photo_url to Expert interface:**
1. Add `photo_url: string | null` to the `Expert` interface (after `profile_url`).

**frontend/src/components/marketplace/ExpertCard.tsx — Add profile photo avatar:**
1. Add `const API_BASE = import.meta.env.VITE_API_URL ?? ''` at the top of the file.
2. Add a `const [imgError, setImgError] = useState(false)` state inside the component (import useState).
3. Compute `const showPhoto = Boolean(expert.photo_url) && !imgError`.
4. In Zone A (the name/role/company section), wrap the content in a flex row:

Before:
```tsx
<div className="flex-shrink-0 min-w-0">
  <h3 className="font-semibold text-gray-900 text-sm leading-snug truncate">
    {expert.first_name} {expert.last_name}
  </h3>
  ...
</div>
```

After:
```tsx
<div className="flex-shrink-0 min-w-0 flex items-start gap-2">
  {showPhoto && (
    <img
      src={`${API_BASE}${expert.photo_url!}`}
      alt=""
      className="w-8 h-8 rounded-full object-cover shrink-0"
      loading="lazy"
      onError={() => setImgError(true)}
    />
  )}
  <div className="min-w-0">
    <h3 className="font-semibold text-gray-900 text-sm leading-snug truncate">
      {expert.first_name} {expert.last_name}
    </h3>
    <p className="text-xs text-gray-500 truncate">{expert.job_title}</p>
    <p className="text-xs text-gray-400 truncate">{expert.company}</p>
  </div>
</div>
```

Per CONTEXT.md: "If no profile photo: hide the circle entirely — no placeholder, name shifts left." This is handled by the `showPhoto` conditional — when false, no img renders and the flex row collapses to just the text div.

The avatar is 32px (`w-8 h-8`) which is within the 32-36px range from CONTEXT.md.
  </action>
  <verify>Run `cd frontend && npx tsc --noEmit` — zero type errors. Backend: Run `cd /Users/sebastianhamers/Documents/TCS && python -c "from app.services.explorer import ExpertCard; print(ExpertCard.model_fields.keys())"` — should include 'photo_url'.</verify>
  <done>Backend ExpertCard includes photo_url. Frontend Expert type has photo_url. ExpertCard renders 32px circle avatar when photo exists, hides entirely when no photo.</done>
</task>

<task type="auto">
  <name>Task 2: Clear All pill styling + Save/Bookmark feature</name>
  <files>frontend/src/components/marketplace/ExpertCard.tsx, frontend/src/components/marketplace/FilterChips.tsx, frontend/src/components/marketplace/ExpertGrid.tsx, frontend/src/pages/MarketplacePage.tsx</files>
  <action>
**FilterChips.tsx — Style Clear All as a pill:**
Currently the "Clear all" button is styled as a text link: `text-xs text-brand-purple hover:underline ml-1`. Change it to match the existing chip pill styling.

Replace:
```tsx
<button
  onClick={resetFilters}
  className="text-xs text-brand-purple hover:underline ml-1"
>
  Clear all
</button>
```

With:
```tsx
<button
  onClick={resetFilters}
  className="inline-flex items-center text-xs bg-red-50 text-red-600 rounded-full px-2.5 py-0.5 hover:bg-red-100 transition-colors"
>
  Clear all
</button>
```

This uses the same `rounded-full px-2.5 py-0.5 text-xs` pattern as the existing filter chips, but with a subtle red tint to distinguish it as a destructive action.

**FilterChips.tsx — Add "Saved" filter toggle:**
1. Add state for saved filter: read from localStorage `tcs_saved_experts`.
2. Add a `savedFilter` state: `const [savedFilter, setSavedFilter] = useState(false)`.
3. Add a helper to get saved usernames from localStorage:
```typescript
function getSavedUsernames(): Set<string> {
  try {
    const raw = localStorage.getItem('tcs_saved_experts')
    return raw ? new Set(JSON.parse(raw)) : new Set()
  } catch { return new Set() }
}
```
4. Add a `savedCount` that reads the count: `const savedCount = getSavedUsernames().size`.
5. Before the chips, render a "Saved" pill/toggle (only if savedCount > 0):
```tsx
{savedCount > 0 && (
  <button
    onClick={() => setSavedFilter(!savedFilter)}
    className={`inline-flex items-center gap-1 text-xs rounded-full px-2.5 py-0.5 transition-colors ${
      savedFilter
        ? 'bg-brand-purple text-white'
        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
    }`}
  >
    <Bookmark size={12} className={savedFilter ? 'fill-current' : ''} />
    Saved ({savedCount})
  </button>
)}
```
6. Import `Bookmark` from `lucide-react`.
7. Export `savedFilter` state so ExpertGrid/MarketplacePage can consume it. The simplest approach: lift savedFilter into the Zustand store OR use a custom event. But since FilterChips is a consumer-only component, the cleanest approach is to add a `savedFilter` boolean to the filterSlice in the store.

ACTUALLY, simpler approach — avoid store changes. Instead:
- Add `savedFilter` and `setSavedFilter` as state in FilterChips
- When `savedFilter` is true, call a new `onSavedFilter` callback prop to notify the parent
- OR: Use a simpler approach — add `savedFilter` to the URL search params or use a lightweight context

SIMPLEST approach: Add `savedFilter` to the Zustand filterSlice. This is the cleanest integration.

In `frontend/src/store/filterSlice.ts`:
1. Add `savedFilter: boolean` to FilterSlice interface (default false)
2. Add `setSavedFilter: (v: boolean) => void` to FilterSlice interface
3. Add to defaults: `savedFilter: false`
4. Add action: `setSavedFilter: (v) => set({ savedFilter: v })`
5. Add to useFilterSlice hook in `store/index.ts`

In `frontend/src/components/marketplace/FilterChips.tsx`:
- Read `savedFilter` and `setSavedFilter` from `useFilterSlice()`
- Render the "Saved" pill toggle as described above
- Import `Bookmark` from lucide-react

**ExpertCard.tsx — Add bookmark icon:**
1. Import `Bookmark` from `lucide-react` and `useState` (already imported for photo).
2. Add localStorage helpers at module level:
```typescript
const SAVED_KEY = 'tcs_saved_experts'

function getSavedSet(): Set<string> {
  try {
    const raw = localStorage.getItem(SAVED_KEY)
    return raw ? new Set(JSON.parse(raw)) : new Set()
  } catch { return new Set() }
}

function toggleSaved(username: string): boolean {
  const saved = getSavedSet()
  const nowSaved = !saved.has(username)
  if (nowSaved) saved.add(username)
  else saved.delete(username)
  localStorage.setItem(SAVED_KEY, JSON.stringify([...saved]))
  return nowSaved
}
```
3. Add state: `const [isSaved, setIsSaved] = useState(() => getSavedSet().has(expert.username))`
4. Add handler:
```typescript
function handleBookmark(e: React.MouseEvent) {
  e.stopPropagation()
  const nowSaved = toggleSaved(expert.username)
  setIsSaved(nowSaved)
}
```
5. Position the bookmark icon at the right edge of the card. Add it INSIDE the Zone A flex container (top right corner). Restructure Zone A to have the bookmark at the far right:

```tsx
<div className="flex-shrink-0 min-w-0 flex items-start gap-2">
  {showPhoto && (
    <img ... />
  )}
  <div className="min-w-0 flex-1">
    <h3>...</h3>
    <p>...</p>
    <p>...</p>
  </div>
  <button
    onClick={handleBookmark}
    className="shrink-0 p-0.5 text-gray-300 hover:text-brand-purple transition-colors"
    aria-label={isSaved ? 'Remove bookmark' : 'Bookmark expert'}
  >
    <Bookmark size={16} className={isSaved ? 'fill-brand-purple text-brand-purple' : ''} />
  </button>
</div>
```

The icon uses outline by default (lucide Bookmark is outline), and fills with brand-purple when saved (`fill-brand-purple text-brand-purple`). The `fill-brand-purple` class may need to be `fill-current` if the custom color doesn't work with fill. Use `className={isSaved ? 'fill-current text-brand-purple' : ''}` as a safe fallback.

**ExpertGrid.tsx — Filter by saved when savedFilter is active:**
1. Import `useFilterSlice` from the store.
2. Read `savedFilter` from the filter slice.
3. When `savedFilter` is true, filter the `experts` array before passing to VirtuosoGrid:
```typescript
const { savedFilter } = useFilterSlice()

const displayExperts = useMemo(() => {
  if (!savedFilter) return experts
  const saved = getSavedSet()
  return experts.filter(e => saved.has(e.username))
}, [experts, savedFilter])
```
4. Import `useMemo` from React and the `getSavedSet` helper (import or redefine).
5. Pass `displayExperts` instead of `experts` to VirtuosoGrid and the empty/loading checks.
6. Update the `total` display: when savedFilter is active, the count should reflect filtered count.

**MarketplacePage.tsx — No changes needed** (email gate already exists here).

**frontend/src/store/filterSlice.ts — Add savedFilter:**
1. Add `savedFilter: boolean` to FilterSlice interface
2. Add `setSavedFilter: (v: boolean) => void` action
3. Add defaults: `savedFilter: false`
4. Add implementation: `setSavedFilter: (v) => set({ savedFilter: v })`
5. In resetFilters, also reset savedFilter: add `savedFilter: false` to the reset spread

**frontend/src/store/index.ts — Expose savedFilter in useFilterSlice:**
Add `savedFilter` and `setSavedFilter` to the useFilterSlice hook's useShallow selector.
  </action>
  <verify>Run `cd frontend && npx tsc --noEmit` — zero type errors. Check: Clear All button appears as a pill. Bookmark icon appears on ExpertCards. Clicking bookmark toggles fill state. "Saved" pill appears in FilterChips when bookmarks exist. Toggling "Saved" filter shows only bookmarked experts.</verify>
  <done>Clear All is styled as a pill matching filter tags. ExpertCards have bookmark icons that persist to localStorage. "Saved" filter toggle in FilterChips shows only bookmarked experts in the grid.</done>
</task>

</tasks>

<verification>
- [ ] Backend ExpertCard includes photo_url field
- [ ] Frontend Expert type has photo_url: string | null
- [ ] ExpertCard shows 32px circle avatar when photo exists
- [ ] ExpertCard hides avatar entirely when no photo (no placeholder)
- [ ] Clear All button is styled as a rounded pill (not a text link)
- [ ] Bookmark icon (outline) appears at right edge of each ExpertCard
- [ ] Clicking bookmark fills the icon and persists to localStorage
- [ ] "Saved" pill appears in FilterChips when bookmarked experts exist
- [ ] Toggling "Saved" filter shows only bookmarked experts in the grid
- [ ] Bookmarks persist across page refresh
- [ ] TypeScript compilation passes with zero errors
</verification>

<success_criteria>
Explorer shows profile photos, has pill-styled Clear All, and supports bookmark/save feature with localStorage persistence and "Saved" filter toggle. All TypeScript compiles. No regressions in existing Explorer functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-02-SUMMARY.md`
</output>
