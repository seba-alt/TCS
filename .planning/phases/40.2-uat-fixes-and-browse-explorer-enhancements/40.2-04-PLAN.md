---
phase: 40.2-uat-fixes-and-browse-explorer-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["40.2-03"]
files_modified:
  - frontend/src/store/filterSlice.ts
  - frontend/src/store/index.ts
  - frontend/src/components/marketplace/ExpertCard.tsx
  - frontend/src/components/marketplace/FilterChips.tsx
  - frontend/src/components/marketplace/ExpertGrid.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "After bookmarking an expert, the saved count updates immediately everywhere without page refresh"
    - "A dedicated Saved button is visible in the top-right area of the Explorer on both mobile and desktop"
    - "Clicking the Saved button filters the grid to show only bookmarked experts"
    - "Clicking the Saved button again shows all experts"
    - "The Saved button disappears when no experts are bookmarked"
  artifacts:
    - path: "frontend/src/store/filterSlice.ts"
      provides: "Reactive savedExperts Set and savedCount in Zustand"
      contains: "savedExperts"
    - path: "frontend/src/store/index.ts"
      provides: "Exported savedExperts and toggleSavedExpert in store hooks"
      contains: "toggleSavedExpert"
    - path: "frontend/src/components/marketplace/ExpertCard.tsx"
      provides: "Bookmark toggle dispatches to Zustand store"
      contains: "toggleSavedExpert"
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Dedicated Saved button in mobile toolbar and desktop header area"
      contains: "Saved"
  key_links:
    - from: "ExpertCard.tsx handleBookmark"
      to: "filterSlice.ts toggleSavedExpert"
      via: "Zustand store action"
      pattern: "toggleSavedExpert"
    - from: "MarketplacePage.tsx Saved button"
      to: "filterSlice.ts savedExperts"
      via: "Zustand useFilterSlice subscription"
      pattern: "savedExperts\\.size"
    - from: "ExpertGrid.tsx displayExperts"
      to: "filterSlice.ts savedExperts"
      via: "Zustand store subscription for filtering"
      pattern: "savedExperts\\.has"
---

<objective>
Move saved bookmarks from localStorage-only into reactive Zustand state, and add a dedicated Saved button in the Explorer toolbar (visible on both mobile and desktop, top-right area) that toggles the saved-experts filter.

Purpose: Close UAT gap 4 — user reported "no do not see it but must be a dedicated saved expert button on the top right so it is very clear also in mobile."
Output: Reactive bookmark state in Zustand, dedicated Saved button in Explorer toolbar, localStorage persistence via store hydration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-02-SUMMARY.md
@.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-03-SUMMARY.md
@.planning/debug/saved-pill-not-visible.md
@frontend/src/store/filterSlice.ts
@frontend/src/store/index.ts
@frontend/src/components/marketplace/ExpertCard.tsx
@frontend/src/components/marketplace/FilterChips.tsx
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/pages/MarketplacePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move saved bookmarks into Zustand store for reactivity</name>
  <files>
    frontend/src/store/filterSlice.ts
    frontend/src/store/index.ts
    frontend/src/components/marketplace/ExpertCard.tsx
    frontend/src/components/marketplace/ExpertGrid.tsx
    frontend/src/components/marketplace/FilterChips.tsx
  </files>
  <action>
    **Root cause (from debug session):** savedCount in FilterChips is a plain function call (`getSavedCount()`) — not reactive. ExpertCard writes to localStorage directly without any global signal. FilterChips never re-renders when bookmarks change.

    **filterSlice.ts — Add savedExperts state:**
    1. Add `savedExperts: string[]` to the `FilterSlice` interface (array, not Set — Zustand state must be serializable).
    2. Add `toggleSavedExpert: (username: string) => void` action to the interface.
    3. In `filterDefaults`, add `savedExperts: [] as string[]`.
    4. Implement `toggleSavedExpert`: toggle username in the array, then sync to localStorage under key `tcs_saved_experts` (same key as before, so existing bookmarks are preserved).
    5. Add a hydration initializer: In the slice creator function, immediately after spreading filterDefaults, read `tcs_saved_experts` from localStorage to initialize `savedExperts`. Use a try/catch: `try { const raw = localStorage.getItem('tcs_saved_experts'); if (raw) return JSON.parse(raw) as string[] } catch { return [] }`.
    6. Update `resetFilters` to also set `savedFilter: false` (already does this via `...filterDefaults`) but do NOT clear `savedExperts` — resetting filters should not un-bookmark experts.
    7. Do NOT add `savedExperts` to the persist `partialize` in index.ts — we manage localStorage manually for this field to keep the key name `tcs_saved_experts` (not inside the `explorer-filters` persist envelope).

    **store/index.ts — Expose in useFilterSlice:**
    1. Add `savedExperts` and `toggleSavedExpert` to the `useFilterSlice` useShallow selector object.

    **ExpertCard.tsx — Use store instead of local localStorage:**
    1. Remove the standalone `getSavedSet()` and `toggleSavedExpert()` helper functions at top of file.
    2. Remove `SAVED_KEY` constant.
    3. Read `savedExperts` and `toggleSavedExpert` from `useExplorerStore` (or `useFilterSlice`).
    4. Replace `const [isSaved, setIsSaved] = useState(...)` with a derived value: `const isSaved = savedExperts.includes(expert.username)`.
    5. Replace `handleBookmark` body: call the store's `toggleSavedExpert(expert.username)` — no local state management needed.

    **ExpertGrid.tsx — Use store instead of local localStorage:**
    1. Remove the standalone `getSavedSet()` helper and `SAVED_KEY` constant.
    2. Read `savedExperts` from `useFilterSlice()` (already imports it).
    3. In the `displayExperts` useMemo, replace `getSavedSet()` call with creating a Set from the store's `savedExperts` array: `const saved = new Set(savedExperts)`. Include `savedExperts` in the dependency array (replace the current dependency array).

    **FilterChips.tsx — Use store instead of local localStorage:**
    1. Remove the standalone `getSavedCount()` helper function and `SAVED_KEY` constant.
    2. Read `savedExperts` from `useFilterSlice()` (already has the destructured import).
    3. Replace `const savedCount = getSavedCount()` with `const savedCount = savedExperts.length`.
    4. The Saved pill condition (`savedCount > 0`) now works reactively — when ExpertCard calls `toggleSavedExpert`, Zustand triggers re-render in FilterChips.
    5. Fix the early-return guard (line 47): Change `if (chips.length === 0 && total === 0) return null` to `if (chips.length === 0 && total === 0 && savedCount === 0) return null`. This ensures the strip renders when bookmarks exist even if no chips/results are shown yet.

    **localStorage hydration for filterSlice:**
    The simplest approach: In the filterSlice creator function, initialize `savedExperts` by reading from localStorage at store creation time. This is NOT inside `partialize` (which is for the persist middleware). Instead, replace the `savedExperts: [] as string[]` default with a self-invoking function:
    ```ts
    savedExperts: (() => {
      try {
        const raw = localStorage.getItem('tcs_saved_experts')
        return raw ? (JSON.parse(raw) as string[]) : []
      } catch { return [] }
    })(),
    ```
    And in `toggleSavedExpert`, after updating state, also write to localStorage:
    ```ts
    toggleSavedExpert: (username) => set((state) => {
      const next = state.savedExperts.includes(username)
        ? state.savedExperts.filter(u => u !== username)
        : [...state.savedExperts, username]
      localStorage.setItem('tcs_saved_experts', JSON.stringify(next))
      return { savedExperts: next }
    }),
    ```
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && npx tsc --noEmit --project frontend/tsconfig.json 2>&1 | head -20</automated>
    <manual>Bookmark an expert in Explorer. Without refreshing, check that the "Saved (N)" pill appears immediately. Refresh page — bookmarked expert is still marked.</manual>
  </verify>
  <done>Bookmarking an expert triggers immediate reactive updates across ExpertCard (icon fills), FilterChips (Saved pill count), and ExpertGrid (filtered view). State persists across page refreshes via localStorage hydration.</done>
</task>

<task type="auto">
  <name>Task 2: Add dedicated Saved button in Explorer toolbar</name>
  <files>
    frontend/src/pages/MarketplacePage.tsx
    frontend/src/components/marketplace/FilterChips.tsx
  </files>
  <action>
    **User requirement:** "must be a dedicated saved expert button on the top right so it is very clear also in mobile"

    **MarketplacePage.tsx — Add dedicated Saved button:**

    1. Import `Bookmark` from `lucide-react`.
    2. Import `savedExperts`, `savedFilter`, `setSavedFilter` from `useFilterSlice()`. (Destructure alongside existing `tags`, `query`.)
    3. Derive `savedCount = savedExperts.length`.

    4. **Mobile toolbar** (line 111-125, the `md:hidden` div): Add a Saved button to the right side, NEXT TO the Filters button. The toolbar currently has `flex items-center justify-between` with "Experts" title on the left and Filters on the right. Change the right side to a flex row containing the Saved button + Filters button:
       ```tsx
       <div className="flex items-center gap-2">
         {savedCount > 0 && (
           <button
             onClick={() => setSavedFilter(!savedFilter)}
             className={`flex items-center gap-1 text-sm rounded-md px-2.5 py-1.5 transition-colors ${
               savedFilter
                 ? 'bg-brand-purple text-white'
                 : 'border border-gray-300 text-gray-700'
             }`}
           >
             <Bookmark size={16} className={savedFilter ? 'fill-current' : ''} />
             {savedCount}
           </button>
         )}
         <button onClick={() => setSheetOpen(true)} ...existing Filters button...>
           ...
         </button>
       </div>
       ```

    5. **Desktop** — Add the same Saved button above the FilterChips strip, in the main content area. Add a small toolbar row that is visible on `hidden md:flex` (desktop only) between the mobile toolbar div and the FilterChips component:
       ```tsx
       {savedCount > 0 && (
         <div className="hidden md:flex items-center justify-end px-4 py-2">
           <button
             onClick={() => setSavedFilter(!savedFilter)}
             className={`flex items-center gap-1.5 text-sm rounded-full px-3 py-1.5 transition-colors ${
               savedFilter
                 ? 'bg-brand-purple text-white'
                 : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
             }`}
           >
             <Bookmark size={16} className={savedFilter ? 'fill-current' : ''} />
             Saved ({savedCount})
           </button>
         </div>
       )}
       ```

    **FilterChips.tsx — Remove the Saved pill from the chip strip:**
    Since the Saved button now lives in the MarketplacePage toolbar (more prominent, top-right), remove the Saved pill from FilterChips to avoid duplication:
    1. Remove the entire `{savedCount > 0 && (...)}` block (lines 64-76) that renders the Saved toggle button inside the chip strip.
    2. Keep the `savedCount` variable (from `savedExperts.length`) — still needed for the early-return guard.
    3. Keep the early-return guard that includes `savedCount === 0` (from Task 1).

    **Styling notes:**
    - Mobile: compact button with just icon + count (no "Saved" text — space constrained)
    - Desktop: rounded-full pill with "Saved (N)" text, positioned at right edge above the chip strip
    - Active state (savedFilter=true): brand-purple background, white text, filled bookmark icon
    - Inactive state: gray border/background, matching existing filter button style
    - Button disappears entirely when savedCount === 0 (no empty state shown)
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && npx tsc --noEmit --project frontend/tsconfig.json 2>&1 | head -20</automated>
    <manual>
      Mobile: Bookmark an expert. Saved button appears in top-right toolbar next to Filters. Tap it — grid filters to saved only. Tap again — full grid returns.
      Desktop: Saved button appears above chip strip at right edge. Same toggle behavior.
      Un-bookmark all experts — button disappears on both breakpoints.
    </manual>
  </verify>
  <done>Dedicated Saved button is visible in top-right of Explorer toolbar on both mobile and desktop. Toggles savedFilter on click. Shows count. Disappears when no experts are bookmarked.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit --project frontend/tsconfig.json`
2. Dev server starts: `cd frontend && npx vite --port 5173`
3. Bookmark an expert → Saved button appears immediately (reactive, no refresh)
4. Click Saved button → grid shows only bookmarked experts
5. Click again → full grid returns
6. Mobile: Saved button is in the top-right toolbar row, clearly visible
7. Desktop: Saved button is above filter chips strip, right-aligned
8. Refresh page → bookmarked state persists, button shows correct count
9. Un-bookmark all → button disappears on both breakpoints
</verification>

<success_criteria>
- UAT Test 9 (Saved experts): Dedicated Saved button in top-right, visible on mobile, reactive count, toggles filter, disappears when empty
- No duplicate Saved UI — pill removed from FilterChips, button is the single entry point
- localStorage persistence maintained under same `tcs_saved_experts` key
</success_criteria>

<output>
After completion, create `.planning/phases/40.2-uat-fixes-and-browse-explorer-enhancements/40.2-04-SUMMARY.md`
</output>
