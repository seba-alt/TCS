---
phase: 48-admin-features-and-industry-tags
plan: 03
type: execute
wave: 2
depends_on:
  - 48-01
  - 48-02
files_modified:
  - app/routers/admin.py
  - frontend/src/admin/pages/ExpertsPage.tsx
  - frontend/src/admin/components/CsvImportModal.tsx
autonomous: true
requirements:
  - ADM-05

must_haves:
  truths:
    - "Admin can drag-and-drop a CSV file or click to browse for upload"
    - "After upload, a preview of the first 5 rows is shown before confirming"
    - "Admin can map CSV columns to expected expert fields before import"
    - "After confirmed import, FAISS index rebuild is auto-triggered"
    - "Import results show count of inserted/updated/skipped experts"
  artifacts:
    - path: "frontend/src/admin/components/CsvImportModal.tsx"
      provides: "Multi-step CSV import modal with drag-drop, preview, column mapping, and confirm"
      contains: "CsvImportModal"
    - path: "frontend/src/admin/pages/ExpertsPage.tsx"
      provides: "Updated import trigger opening CsvImportModal instead of hidden file input"
      contains: "CsvImportModal"
    - path: "app/routers/admin.py"
      provides: "POST /api/admin/experts/preview-csv endpoint returning parsed preview rows"
      contains: "preview_csv"
  key_links:
    - from: "frontend/src/admin/components/CsvImportModal.tsx"
      to: "/api/admin/experts/preview-csv"
      via: "fetch POST with FormData"
      pattern: "preview-csv"
    - from: "frontend/src/admin/components/CsvImportModal.tsx"
      to: "/api/admin/experts/import-csv"
      via: "fetch POST with FormData + column mapping"
      pattern: "import-csv"
    - from: "frontend/src/admin/components/CsvImportModal.tsx"
      to: "/api/admin/ingest/run"
      via: "triggerRun after successful import"
      pattern: "ingest/run"
---

<objective>
Replace the hidden file input CSV import with a multi-step modal: drag-drop upload, row preview, column mapping, confirm import with FAISS rebuild.

Purpose: ADM-05 requires an improved bulk expert CSV import flow without touching the Railway terminal. The current flow is a hidden file input with immediate upload and no preview.
Output: New CsvImportModal component + backend preview endpoint + updated ExpertsPage trigger.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-admin-features-and-industry-tags/48-01-SUMMARY.md
@.planning/phases/48-admin-features-and-industry-tags/48-02-SUMMARY.md
@app/routers/admin.py
@frontend/src/admin/pages/ExpertsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSV preview endpoint and build multi-step import modal</name>
  <files>app/routers/admin.py, frontend/src/admin/components/CsvImportModal.tsx, frontend/src/admin/pages/ExpertsPage.tsx</files>
  <action>
**Backend — `app/routers/admin.py`:**

Add a new `POST /api/admin/experts/preview-csv` endpoint that accepts a CSV file upload and returns the first 5 rows as JSON for preview, plus the detected column headers:

```python
@router.post("/experts/preview-csv")
async def preview_csv(file: UploadFile = File(...)):
    content = (await file.read()).decode("utf-8-sig")
    reader = csv.DictReader(io.StringIO(content))
    headers = reader.fieldnames or []
    rows = []
    for i, row in enumerate(reader):
        if i >= 5:
            break
        rows.append(dict(row))
    total_rows = content.count('\n') - 1  # approximate
    return {"headers": headers, "preview_rows": rows, "total_rows": max(total_rows, len(rows))}
```

The existing `POST /api/admin/experts/import-csv` endpoint should be left as-is — the modal will POST to it with a column_mapping JSON field that the endpoint can optionally use. If the existing endpoint does NOT accept column_mapping, add an optional `column_mapping: str = Form(default="")` parameter. When provided, parse it as JSON dict mapping `{csv_column: expected_field}` and remap CSV headers accordingly before processing.

**Frontend — `frontend/src/admin/components/CsvImportModal.tsx` (NEW FILE):**

Create a multi-step modal component with state machine: `'idle' | 'preview' | 'mapping' | 'importing' | 'done' | 'error'`.

Props: `isOpen: boolean, onClose: () => void, onImportComplete: () => void`

**Step 1 — Upload (idle state):**
- Full-width drag-and-drop zone using HTML5 drag events (NO react-dropzone library).
- `<div onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave}>` styled as a dashed border area.
- Also include a hidden `<input type="file" accept=".csv">` triggered by a "Browse" button inside the drop zone.
- On file select: parse CSV client-side with `FileReader` + basic `text.split('\n')` for row count display.
- ALSO send file to `POST /api/admin/experts/preview-csv` to get server-parsed preview rows.

**Step 2 — Preview (preview state):**
- Show a table with the first 5 rows from the server response.
- Display total row count: "Previewing 5 of {total_rows} rows".
- "Next" button to proceed to mapping, "Cancel" to close.

**Step 3 — Column Mapping (mapping state):**
- Expected fields: `Username, First Name, Last Name, Job Title, Company, Bio, Hourly Rate` (matching metadata.json capital+spaced field names).
- For each expected field, show a `<select>` dropdown populated with the CSV's detected headers.
- Auto-detect: if a CSV header matches an expected field name (case-insensitive), pre-select it.
- "Import" button to proceed, "Back" to return to preview.

**Step 4 — Importing (importing state):**
- POST the file + column mapping JSON to `/api/admin/experts/import-csv`.
- Show a spinner/progress indicator.
- On success: auto-trigger `POST /api/admin/ingest/run` (FAISS rebuild) using the existing `triggerRun` pattern from ExpertsPage.
- Transition to 'done' state showing results: "{N} experts imported".

**Step 5 — Done (done state):**
- Show success message with import count.
- Show "FAISS rebuild started" indicator.
- "Close" button calls `onImportComplete()` then `onClose()`.

**Error state:** Show error message with "Try Again" button that resets to idle.

Styling: Use the existing admin dark theme (bg-slate-800, border-slate-700, text-white/slate patterns). Modal overlay with `fixed inset-0 bg-black/50 z-50` backdrop.

**Frontend — `frontend/src/admin/pages/ExpertsPage.tsx`:**

1. Import the new `CsvImportModal` component.
2. Add state: `const [importModalOpen, setImportModalOpen] = useState(false)`.
3. Replace the existing hidden `<input type="file">` CSV upload pattern with a button that opens the modal: `<button onClick={() => setImportModalOpen(true)}>Import CSV</button>`.
4. Render `<CsvImportModal isOpen={importModalOpen} onClose={() => setImportModalOpen(false)} onImportComplete={() => refetch()} />`.
5. Keep the existing `triggerRun` and `ingest` state management — the modal will use `fetch` directly for the ingest trigger, or you can pass `triggerRun` as a prop.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.admin import router; routes = [r.path for r in router.routes]; assert '/experts/preview-csv' in routes, f'Missing route. Found: {routes}'" && grep -q "CsvImportModal" frontend/src/admin/components/CsvImportModal.tsx && grep -q "CsvImportModal" frontend/src/admin/pages/ExpertsPage.tsx && echo "PASS"</automated>
    <manual>Open admin Experts page, click Import CSV, verify drag-drop zone appears, upload a test CSV, verify preview rows display, map columns, confirm import triggers successfully</manual>
  </verify>
  <done>Admin can import experts via a multi-step flow: drag-drop CSV upload, preview first 5 rows, map columns to expected fields, confirm import, and FAISS rebuild auto-triggers. No Railway terminal access needed.</done>
</task>

</tasks>

<verification>
- POST /api/admin/experts/preview-csv returns headers + preview_rows + total_rows
- CsvImportModal renders with drag-drop zone, preview table, column mapping selects
- ExpertsPage opens modal instead of using hidden file input
- After import, /api/admin/ingest/run is auto-triggered
</verification>

<success_criteria>
Admin can bulk import experts via a multi-step CSV upload flow with drag-drop, preview, column mapping, and automatic FAISS rebuild.
</success_criteria>

<output>
After completion, create `.planning/phases/48-admin-features-and-industry-tags/48-03-SUMMARY.md`
</output>
