---
phase: 27-newsletter-gate-easter-egg
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/models.py
  - app/routers/newsletter.py
  - app/routers/admin.py
  - app/main.py
  - frontend/src/store/nltrStore.ts
autonomous: true
requirements:
  - NLTR-02
  - NLTR-03
  - NLTR-04

must_haves:
  truths:
    - "Submitting a valid email to POST /api/newsletter/subscribe returns 200 {status: ok} and writes a row to newsletter_subscribers"
    - "Duplicate emails to the subscribe endpoint return 200 without error (idempotent)"
    - "GET /api/admin/newsletter-subscribers returns {count, subscribers[]} guarded by X-Admin-Key"
    - "GET /api/admin/export/newsletter.csv returns a CSV file download guarded by X-Admin-Key"
    - "useNltrStore persists subscribed + email to localStorage under key 'tinrate-newsletter-v1'"
    - "spinTrigger field in useNltrStore is excluded from localStorage (partialize)"
  artifacts:
    - path: "app/models.py"
      provides: "NewsletterSubscriber SQLAlchemy model"
      contains: "class NewsletterSubscriber"
    - path: "app/routers/newsletter.py"
      provides: "POST /api/newsletter/subscribe public endpoint"
      exports: ["router"]
    - path: "app/routers/admin.py"
      provides: "GET /api/admin/newsletter-subscribers and GET /api/admin/export/newsletter.csv"
    - path: "app/main.py"
      provides: "newsletter.router included in app"
    - path: "frontend/src/store/nltrStore.ts"
      provides: "useNltrStore with persist"
      exports: ["useNltrStore"]
  key_links:
    - from: "app/routers/newsletter.py"
      to: "app/models.py NewsletterSubscriber"
      via: "SQLAlchemy INSERT OR IGNORE"
      pattern: "on_conflict_do_nothing"
    - from: "app/main.py"
      to: "app/routers/newsletter.py"
      via: "app.include_router"
      pattern: "include_router.*newsletter"
    - from: "frontend/src/store/nltrStore.ts"
      to: "localStorage"
      via: "zustand persist middleware"
      pattern: "tinrate-newsletter-v1"
---

<objective>
Build the backend foundation and Zustand store for the Phase 27 newsletter gate.

Purpose: All other Phase 27 plans depend on this — the subscribe endpoint must exist before the modal can call it, and the admin endpoints + useNltrStore must exist before the Leads page and barrel roll can consume them.

Output:
- `app/models.py` extended with `NewsletterSubscriber` ORM model
- `app/routers/newsletter.py` new public router with `POST /api/newsletter/subscribe`
- `app/routers/admin.py` extended with two newsletter admin endpoints
- `app/main.py` updated to include newsletter router
- `frontend/src/store/nltrStore.ts` new standalone Zustand persist store
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-newsletter-gate-easter-egg/27-RESEARCH.md
@app/models.py
@app/routers/email_capture.py
@app/routers/admin.py
@app/main.py
@frontend/src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NewsletterSubscriber model + public subscribe endpoint + main.py wiring</name>
  <files>
    app/models.py
    app/routers/newsletter.py
    app/main.py
  </files>
  <action>
**app/models.py** — Add `NewsletterSubscriber` class after `EmailLead`, following the identical `mapped_column` pattern:

```python
class NewsletterSubscriber(Base):
    __tablename__ = "newsletter_subscribers"
    id: Mapped[int] = mapped_column(primary_key=True, index=True)
    email: Mapped[str] = mapped_column(String(320), unique=True, nullable=False, index=True)
    source: Mapped[str] = mapped_column(String(50), nullable=False, default="gate")
    created_at: Mapped[datetime.datetime] = mapped_column(
        DateTime, default=datetime.datetime.utcnow, nullable=False
    )
```
No ALTER TABLE needed — `Base.metadata.create_all()` in main.py creates this table at startup.

**app/routers/newsletter.py** — Create new file. Follow `email_capture.py` exactly. Public router (no `_require_admin` dependency):

```python
from fastapi import APIRouter, Depends
from pydantic import BaseModel, EmailStr
from sqlalchemy.dialects.sqlite import insert
from sqlalchemy.orm import Session
from app.database import get_db
from app.models import NewsletterSubscriber

router = APIRouter()

class NewsletterSubscribeRequest(BaseModel):
    email: EmailStr
    source: str = "gate"

@router.post("/api/newsletter/subscribe", status_code=200)
def subscribe(body: NewsletterSubscribeRequest, db: Session = Depends(get_db)):
    stmt = (
        insert(NewsletterSubscriber)
        .values(email=str(body.email), source=body.source)
        .on_conflict_do_nothing(index_elements=["email"])
    )
    db.execute(stmt)
    db.commit()
    return {"status": "ok"}
```

**app/main.py** — Add after existing router imports:
```python
from app.routers import newsletter
```
And after existing `app.include_router(...)` calls:
```python
app.include_router(newsletter.router)
```
Place this near the other public routers (email_capture, explore, chat) — not with the admin router.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.newsletter import router; print('OK')"` — must print OK with no import errors.
    Run: `python -c "from app.models import NewsletterSubscriber; print(NewsletterSubscriber.__tablename__)"` — must print `newsletter_subscribers`.
  </verify>
  <done>
    - `newsletter_subscribers` table name confirmed
    - `router` importable from `app.routers.newsletter` without error
    - `main.py` includes `newsletter.router`
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin newsletter endpoints (subscriber list + CSV export)</name>
  <files>
    app/routers/admin.py
  </files>
  <action>
Add two endpoints to `app/routers/admin.py` on the `router` (with `_require_admin` dependency), following the existing `get_leads` and `export_searches_csv` patterns exactly.

Add these imports at the top of admin.py if not already present:
```python
import csv
import io
from datetime import date
```
Also add `NewsletterSubscriber` to the models import line.

**Endpoint 1 — GET /api/admin/newsletter-subscribers:**
```python
@router.get("/newsletter-subscribers")
def get_newsletter_subscribers(db: Session = Depends(get_db)):
    rows = db.scalars(
        select(NewsletterSubscriber).order_by(NewsletterSubscriber.created_at.desc())
    ).all()
    return {
        "count": len(rows),
        "subscribers": [
            {
                "email": r.email,
                "created_at": r.created_at.isoformat(),
                "source": r.source,
            }
            for r in rows
        ],
    }
```

**Endpoint 2 — GET /api/admin/export/newsletter.csv:**
```python
@router.get("/export/newsletter.csv")
def export_newsletter_csv(db: Session = Depends(get_db)):
    rows = db.scalars(
        select(NewsletterSubscriber).order_by(NewsletterSubscriber.created_at.desc())
    ).all()
    buf = io.StringIO()
    writer = csv.writer(buf)
    writer.writerow(["# Export date", date.today().isoformat()])
    writer.writerow(["# Total subscribers", len(rows)])
    writer.writerow([])
    writer.writerow(["email", "created_at", "source"])
    for r in rows:
        writer.writerow([r.email, r.created_at.isoformat(), r.source])
    filename = f"newsletter-subscribers-{date.today().isoformat()}.csv"
    return StreamingResponse(
        iter([buf.getvalue()]),
        media_type="text/csv",
        headers={"Content-Disposition": f"attachment; filename={filename}"},
    )
```

Note: `StreamingResponse` is already imported in admin.py. Verify and add if missing.
  </action>
  <verify>
    Run: `python -c "from app.routers.admin import router; routes = [r.path for r in router.routes]; print([r for r in routes if 'newsletter' in r])"` in /Users/sebastianhamers/Documents/TCS — must show both `/newsletter-subscribers` and `/export/newsletter.csv`.
  </verify>
  <done>
    - Both admin newsletter endpoints registered on the admin router (with _require_admin dep inherited from router)
    - CSV export returns correct Content-Disposition header
    - No import errors in admin.py
  </done>
</task>

<task type="auto">
  <name>Task 3: useNltrStore — standalone Zustand persist store</name>
  <files>
    frontend/src/store/nltrStore.ts
  </files>
  <action>
Create `frontend/src/store/nltrStore.ts` as a standalone Zustand persist store. Do NOT touch `frontend/src/store/index.ts` or `useExplorerStore`.

```typescript
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

interface NltrState {
  subscribed: boolean
  email: string | null
  spinTrigger: boolean        // ephemeral — NOT persisted (see partialize)
  setSubscribed: (email: string) => void
  triggerSpin: () => void
  resetSpin: () => void
}

export const useNltrStore = create<NltrState>()(
  persist(
    (set) => ({
      subscribed: false,
      email: null,
      spinTrigger: false,
      setSubscribed: (email: string) => set({ subscribed: true, email }),
      triggerSpin: () => set({ spinTrigger: true }),
      resetSpin: () => set({ spinTrigger: false }),
    }),
    {
      name: 'tinrate-newsletter-v1',  // LOCKED — do NOT change
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        subscribed: state.subscribed,
        email: state.email,
        // spinTrigger intentionally excluded — ephemeral UI state only
      }),
    }
  )
)
```

Key constraints:
- Persist key MUST be `'tinrate-newsletter-v1'` (locked in planning notes)
- `spinTrigger` MUST be excluded from `partialize` (ephemeral UI state, must reset on page load)
- Do NOT use `useEffect` — Zustand persist hydrates synchronously before first render
- `setSubscribed` sets both `subscribed: true` and stores the email for potential future use
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit --project tsconfig.json 2>&1 | grep nltrStore` — should produce no TypeScript errors for nltrStore.ts.
    Alternatively: `node -e "require('./src/store/nltrStore.ts')"` won't work (TypeScript), so verify by checking the file compiles in the next plan's TypeScript build step.
  </verify>
  <done>
    - `frontend/src/store/nltrStore.ts` exists with correct interface and persist config
    - Persist key is exactly `'tinrate-newsletter-v1'`
    - `partialize` excludes `spinTrigger`
    - Exports `useNltrStore`
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.routers.newsletter import router; from app.routers.admin import router as ar; print('imports ok')"` — no errors
2. `python -c "from app.models import NewsletterSubscriber; print(NewsletterSubscriber.__tablename__)"` — prints `newsletter_subscribers`
3. `python -c "from app.main import app; print('app ok')"` — no startup errors (confirms router inclusion)
4. File `frontend/src/store/nltrStore.ts` exists and contains `tinrate-newsletter-v1` and `partialize`
</verification>

<success_criteria>
- Backend: `newsletter_subscribers` table auto-created at startup, subscribe endpoint accepts valid email, returns 200 for duplicates
- Backend: Admin endpoints return subscriber list + CSV download, both under admin auth
- Frontend: `useNltrStore` stores subscription state in localStorage under `tinrate-newsletter-v1`, with `spinTrigger` excluded from persistence
- No modifications to `useExplorerStore`, `store/index.ts`, or existing store slices
</success_criteria>

<output>
After completion, create `.planning/phases/27-newsletter-gate-easter-egg/27-01-SUMMARY.md`
</output>
