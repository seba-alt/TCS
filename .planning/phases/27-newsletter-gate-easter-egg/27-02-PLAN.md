---
phase: 27-newsletter-gate-easter-egg
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - frontend/src/components/marketplace/NewsletterGateModal.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: false
requirements:
  - NLTR-01
  - NLTR-03

must_haves:
  truths:
    - "First-time visitors clicking 'View Full Profile' see a newsletter CTA modal with exclusive/aspirational tone and a value-forward submit button (e.g. 'Unlock Profiles')"
    - "The modal has an X dismiss button; after dismiss, it re-appears on the next 'View Full Profile' click (not persisted per-session)"
    - "Submitting a valid email closes the modal, unlocks profiles permanently, and sends a fire-and-forget POST to /api/newsletter/subscribe"
    - "Invalid email format keeps the submit button disabled"
    - "Returning v2.0 users (localStorage key 'tcs_gate_email' OR 'tcs_email_unlocked') bypass the modal automatically"
    - "After subscribing, the modal does not re-appear on subsequent page visits"
    - "No toast or badge appears post-subscribe — profiles simply work"
  artifacts:
    - path: "frontend/src/components/marketplace/NewsletterGateModal.tsx"
      provides: "Newsletter subscription modal with glassmorphism styling and exclusive copy"
      min_lines: 60
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Gate logic using useNltrStore instead of useEmailGate"
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/store/nltrStore.ts"
      via: "useNltrStore() hook"
      pattern: "useNltrStore"
    - from: "frontend/src/components/marketplace/NewsletterGateModal.tsx"
      to: "POST /api/newsletter/subscribe"
      via: "fetch in handleSubmit"
      pattern: "newsletter/subscribe"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "localStorage"
      via: "legacy bypass check"
      pattern: "tcs_gate_email|tcs_email_unlocked"
---

<objective>
Redesign the email gate as a newsletter subscription CTA with exclusive/aspirational framing, integrated with useNltrStore for persistent unlock state.

Purpose: NLTR-01 and NLTR-03 — the modal is the user-facing surface of the newsletter gate, and MarketplacePage is where gate logic lives. These must be updated together in one plan since they are tightly coupled (MarketplacePage renders the modal and controls gate state).

Output:
- `frontend/src/components/marketplace/NewsletterGateModal.tsx` — new component (replaces ProfileGateModal content)
- `frontend/src/pages/MarketplacePage.tsx` — gate logic migrated from useEmailGate to useNltrStore
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-newsletter-gate-easter-egg/27-RESEARCH.md
@.planning/phases/27-newsletter-gate-easter-egg/27-CONTEXT.md
@.planning/phases/27-newsletter-gate-easter-egg/27-01-SUMMARY.md
@frontend/src/components/marketplace/ProfileGateModal.tsx
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/hooks/useEmailGate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NewsletterGateModal — exclusive/aspirational newsletter CTA modal</name>
  <files>
    frontend/src/components/marketplace/NewsletterGateModal.tsx
  </files>
  <action>
Create `frontend/src/components/marketplace/NewsletterGateModal.tsx`. This is a new file — do NOT modify `ProfileGateModal.tsx` (leave it in place as reference, it may be used elsewhere).

The modal must:
- Use `AnimatePresence` + `motion.div` from `motion/react` (same as ProfileGateModal.tsx — check that file for the exact animation pattern used)
- Have glassmorphism styling (backdrop blur, translucent dark background, subtle border — use `before:` pseudo-element hack pattern from Phase 22 if needed; alternatively use `bg-white/10 backdrop-blur-md` as Tailwind classes, which works on a modal overlay positioned over the aurora)
- Tone: **exclusive & aspirational** — "Get access" feel, slightly premium
- Headline: Claude's discretion — something like "Get Expert Insights First" or "Unlock the Full Expert Pool" — aspirational, not utility-focused
- Supporting copy: Brief, include an anti-spam reassurance, e.g. "Curated insights delivered to your inbox. No spam, ever."
- Input: Email input with `type="email"`, `placeholder="your@email.com"`
- Submit button: Value-forward label — use "Unlock Profiles" (not "Subscribe", not "Sign Up")
- Submit button is **disabled** when email does not match basic format validation: `/.+@.+\..+/.test(email)` — enable only when this passes
- X button (dismiss): top-right corner, calls `onDismiss` prop
- No toast or badge on success — the parent handles the unlock; modal simply calls `onSubscribe(email)` and closes

Props interface:
```typescript
interface NewsletterGateModalProps {
  isOpen: boolean
  onSubscribe: (email: string) => void
  onDismiss: () => void
}
```

Internal state: `email` string (controlled input), no other local state needed.

On form submit: call `onSubscribe(email)` (parent handles backend call + Zustand write).

Wrap the modal content in an overlay (`fixed inset-0 z-50 flex items-center justify-center`) with a semi-transparent dark backdrop (`bg-black/60`). The modal card itself should be styled with glassmorphism: `bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl`. Text in white/near-white for legibility.
  </action>
  <verify>
    `grep -n "onSubscribe\|onDismiss\|Unlock Profiles\|backdrop-blur" /Users/sebastianhamers/Documents/TCS/frontend/src/components/marketplace/NewsletterGateModal.tsx` — all four must appear.
  </verify>
  <done>
    - NewsletterGateModal.tsx exists with correct props interface
    - Submit button is disabled for invalid email format
    - Dismiss X button calls onDismiss
    - Glassmorphism styling applied
    - Tone is exclusive/aspirational, submit label is value-forward
  </done>
</task>

<task type="auto">
  <name>Task 2: MarketplacePage — migrate gate logic from useEmailGate to useNltrStore</name>
  <files>
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
Update `frontend/src/pages/MarketplacePage.tsx` to use `useNltrStore` instead of `useEmailGate`. Read the current MarketplacePage.tsx first to understand all the gate-related state and handlers.

**Changes to make:**

1. **Remove** the `useEmailGate` import and hook call. Do NOT delete `useEmailGate.ts` — just stop using it in MarketplacePage.

2. **Add** import: `import { useNltrStore } from '../store/nltrStore'`

3. **Add** import: `import { NewsletterGateModal } from '../components/marketplace/NewsletterGateModal'`

4. **Replace** the gate state with:
```typescript
const { subscribed, setSubscribed } = useNltrStore()

// Legacy bypass: check BOTH possible keys from v2.0 returning users
const legacyUnlocked =
  localStorage.getItem('tcs_gate_email') !== null ||
  localStorage.getItem('tcs_email_unlocked') !== null

const isUnlocked = subscribed || legacyUnlocked
```

5. **Gate modal state:** Keep a local `showGate: boolean` state (not persisted — show modal = triggered by clicking View Full Profile while not unlocked). Keep `pendingProfileUrl: string | null` state for the URL to open after subscribe.

6. **handleViewProfile logic** (the function called when user clicks "View Full Profile"):
```typescript
function handleViewProfile(url: string) {
  if (isUnlocked) {
    window.open(url, '_blank', 'noopener,noreferrer')
  } else {
    setPendingProfileUrl(url)
    setShowGate(true)
  }
}
```

7. **handleSubscribe** (called by NewsletterGateModal.onSubscribe):
```typescript
async function handleSubscribe(email: string) {
  // Write Zustand store FIRST — this is the source of truth for unlock
  setSubscribed(email)
  setShowGate(false)

  // Fire-and-forget backend call (silent failure — user already unlocked via Zustand)
  fetch(`${API_URL}/api/newsletter/subscribe`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email }),
  }).catch(() => {})

  // Open the pending profile
  if (pendingProfileUrl) {
    window.open(pendingProfileUrl, '_blank', 'noopener,noreferrer')
    setPendingProfileUrl(null)
  }
}
```

8. **handleDismiss** (called by NewsletterGateModal.onDismiss):
```typescript
function handleDismiss() {
  setShowGate(false)
  // DO NOT clear pendingProfileUrl here — next click will re-open modal
  // DO NOT set any session storage — modal re-appears on next "View Full Profile" click
}
```

9. **Render** `<NewsletterGateModal>` instead of `<ProfileGateModal>` (or whatever the existing gate component is):
```typescript
<NewsletterGateModal
  isOpen={showGate}
  onSubscribe={handleSubscribe}
  onDismiss={handleDismiss}
/>
```

Note on `API_URL`: Use whatever constant is currently used in MarketplacePage for API calls (check existing file for the import/definition pattern).

Note on ProfileGateModal: After this change, `ProfileGateModal.tsx` is no longer imported in MarketplacePage. Leave the file in place — do not delete it.
  </action>
  <verify>
    `grep -n "useNltrStore\|NewsletterGateModal\|tcs_gate_email\|isUnlocked" /Users/sebastianhamers/Documents/TCS/frontend/src/pages/MarketplacePage.tsx` — all four must appear.
    `grep -n "useEmailGate" /Users/sebastianhamers/Documents/TCS/frontend/src/pages/MarketplacePage.tsx` — must return nothing (import removed).
  </verify>
  <done>
    - MarketplacePage uses useNltrStore (not useEmailGate) for gate state
    - Legacy bypass checks both 'tcs_gate_email' and 'tcs_email_unlocked'
    - isUnlocked = subscribed || legacyUnlocked
    - Modal shows on View Full Profile click when not unlocked; dismiss re-arms for next click
    - Subscribe: Zustand write first, then fire-and-forget fetch, then open profile
    - No toast, no badge on subscribe
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — newsletter gate flow end to end</name>
  <action>Human checkpoint — verify newsletter gate modal and unlock flow as described in how-to-verify.</action>
  <what-built>
    Newsletter gate redesign — exclusive/aspirational CTA modal replacing old email gate. MarketplacePage now uses useNltrStore for persistent unlock state. Legacy v2.0 users (tcs_gate_email / tcs_email_unlocked localStorage keys) bypass automatically. Modal dismisses without locking out; re-appears on next "View Full Profile" click. Submit unlocks permanently.
  </what-built>
  <how-to-verify>
    1. Open https://tcs-three-sigma.vercel.app (after Vercel deploys via git push)
    2. Open DevTools → Application → Local Storage → clear all `tinrate-newsletter-v1`, `tcs_gate_email`, `tcs_email_unlocked` keys to simulate a fresh user
    3. Click "View Full Profile" on any expert — newsletter CTA modal should appear with aspirational headline and "Unlock Profiles" button (or equivalent value-forward label)
    4. Click the X button to dismiss — modal closes. Click another "View Full Profile" — modal re-appears (not once-per-session)
    5. Enter an invalid email (e.g. "notanemail") — submit button must remain disabled
    6. Enter a valid email (e.g. "test@example.com") — submit button enables
    7. Submit — modal closes, profile opens in new tab. Reload the page — modal does NOT re-appear. Profiles open directly.
    8. In DevTools → Network, check for POST to /api/newsletter/subscribe — should show 200 response
    9. In DevTools → Local Storage, confirm `tinrate-newsletter-v1` key exists with `subscribed: true`
    10. Legacy bypass test: Clear `tinrate-newsletter-v1`, set `tcs_gate_email` = "anything" in localStorage. Reload. Click "View Full Profile" — should open directly without modal.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `frontend/src/components/marketplace/NewsletterGateModal.tsx` exists and renders with correct props
2. `frontend/src/pages/MarketplacePage.tsx` imports useNltrStore and NewsletterGateModal; no useEmailGate import
3. Human visual verification passes (checkpoint task)
</verification>

<success_criteria>
- First-time visitors see the newsletter CTA modal when clicking "View Full Profile"
- Modal is dismissible; re-appears on next click (not once-per-session lock-out)
- Valid email submission unlocks profiles permanently via Zustand persist
- Legacy v2.0 users with 'tcs_gate_email' or 'tcs_email_unlocked' bypass automatically
- No post-subscribe toast or badge
- Submit button disabled for invalid email format
</success_criteria>

<output>
After completion, create `.planning/phases/27-newsletter-gate-easter-egg/27-02-SUMMARY.md`
</output>
