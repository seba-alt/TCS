---
phase: 27-newsletter-gate-easter-egg
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - frontend/src/components/marketplace/ExpertGrid.tsx
  - frontend/src/hooks/useSage.ts
  - frontend/src/components/sidebar/SearchInput.tsx
  - frontend/src/admin/hooks/useAdminData.ts
  - frontend/src/admin/types.ts
  - frontend/src/admin/pages/LeadsPage.tsx
autonomous: false
requirements:
  - FUN-01
  - NLTR-04

must_haves:
  truths:
    - "Typing 'barrel roll' or 'do a flip' in the Sage input causes the ExpertGrid container to spin 360 degrees"
    - "Typing 'barrel roll' or 'do a flip' in the SearchInput causes the ExpertGrid container to spin 360 degrees without triggering a real search re-fetch"
    - "The barrel roll animation completes cleanly (no snap to 0, no additive rotation on second trigger)"
    - "The Admin Leads page shows a newsletter subscriber count and full subscriber list with email + signup date"
    - "A CSV download button on the Leads page triggers download of all newsletter subscribers"
  artifacts:
    - path: "frontend/src/components/marketplace/ExpertGrid.tsx"
      provides: "VirtuosoGrid wrapped in ref-able div, animated via animate() from motion/react"
    - path: "frontend/src/hooks/useSage.ts"
      provides: "Barrel roll trigger detection in handleSend"
    - path: "frontend/src/components/sidebar/SearchInput.tsx"
      provides: "Barrel roll trigger detection in handleChange/handleKeyDown, no setQuery() fired for trigger phrases"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useNewsletterSubscribers hook"
    - path: "frontend/src/admin/types.ts"
      provides: "NewsletterSubscriber type and NewsletterSubscribersResponse type"
    - path: "frontend/src/admin/pages/LeadsPage.tsx"
      provides: "Newsletter subscriber section with count, list, and CSV download button"
  key_links:
    - from: "frontend/src/hooks/useSage.ts"
      to: "frontend/src/store/nltrStore.ts"
      via: "useNltrStore().triggerSpin()"
      pattern: "triggerSpin"
    - from: "frontend/src/components/sidebar/SearchInput.tsx"
      to: "frontend/src/store/nltrStore.ts"
      via: "useNltrStore().triggerSpin()"
      pattern: "triggerSpin"
    - from: "frontend/src/components/marketplace/ExpertGrid.tsx"
      to: "frontend/src/store/nltrStore.ts"
      via: "useNltrStore().spinTrigger + resetSpin()"
      pattern: "spinTrigger.*resetSpin"
    - from: "frontend/src/admin/pages/LeadsPage.tsx"
      to: "GET /api/admin/newsletter-subscribers"
      via: "useNewsletterSubscribers hook"
      pattern: "newsletter-subscribers"
    - from: "frontend/src/admin/pages/LeadsPage.tsx"
      to: "GET /api/admin/export/newsletter.csv"
      via: "anchor download click"
      pattern: "export/newsletter.csv"
---

<objective>
Implement the barrel roll easter egg (FUN-01) and admin newsletter subscriber visibility (NLTR-04).

Purpose: These two features share only the Plan 01 dependency (useNltrStore + backend endpoints). They touch different files and can be executed in the same plan. Barrel roll wires the Framer Motion container animation to trigger detection in Sage and SearchInput. Admin Leads wires the new backend subscriber endpoint to the admin UI.

Output:
- ExpertGrid wraps VirtuosoGrid in an animatable div, watches spinTrigger from useNltrStore
- useSage detects trigger phrases and calls triggerSpin(), intercepts barrel roll queries before API call
- SearchInput detects trigger phrases and calls triggerSpin(), does NOT fire setQuery() for trigger phrases
- Admin Leads page shows newsletter subscriber count, list, and CSV download
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-newsletter-gate-easter-egg/27-RESEARCH.md
@.planning/phases/27-newsletter-gate-easter-egg/27-CONTEXT.md
@.planning/phases/27-newsletter-gate-easter-egg/27-01-SUMMARY.md
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/hooks/useSage.ts
@frontend/src/components/sidebar/SearchInput.tsx
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/types.ts
@frontend/src/admin/pages/LeadsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Barrel roll â€” ExpertGrid container animation + trigger detection in Sage and SearchInput</name>
  <files>
    frontend/src/components/marketplace/ExpertGrid.tsx
    frontend/src/hooks/useSage.ts
    frontend/src/components/sidebar/SearchInput.tsx
  </files>
  <action>
**ExpertGrid.tsx â€” Wrap VirtuosoGrid and animate on spinTrigger:**

Read the current ExpertGrid.tsx first. The existing VirtuosoGrid is rendered inside some container. Make the following surgical change:

1. Add imports:
```typescript
import { useRef, useEffect } from 'react'
import { animate } from 'motion/react'
import { useNltrStore } from '../../store/nltrStore'
```
(Adjust import path depth based on actual file location.)

2. Inside the component, add:
```typescript
const containerRef = useRef<HTMLDivElement>(null)
const { spinTrigger, resetSpin } = useNltrStore()
```

3. Add a `useEffect` that fires when `spinTrigger` becomes true:
```typescript
useEffect(() => {
  if (!spinTrigger || !containerRef.current) return
  animate(
    containerRef.current,
    { rotate: 360 },
    { duration: 0.7, ease: 'easeInOut' }
  ).then(() => {
    // Reset rotation to 0 without visual transition (prevents additive rotation on next trigger)
    animate(containerRef.current!, { rotate: 0 }, { duration: 0 })
    resetSpin()
  })
}, [spinTrigger, resetSpin])
```

4. Wrap the existing VirtuosoGrid in a `div` with `ref={containerRef}` and `style={{ height: '100%' }}`:
```typescript
<div ref={containerRef} style={{ height: '100%' }}>
  <VirtuosoGrid ... />
</div>
```
CRITICAL: VirtuosoGrid must keep its own `style={{ height: '100%' }}` (or equivalent). The wrapper div inherits the same height so VirtuosoGrid still fills its container. Verify the wrapper div does not break scroll by checking the existing height setup.

---

**useSage.ts â€” Detect barrel roll in handleSend, intercept before API call:**

Read useSage.ts to find `handleSend` (or equivalent send function). Add:

1. Add import at top:
```typescript
import { useNltrStore } from '../store/nltrStore'
```
(Adjust path based on file location.)

2. Inside the hook, get `triggerSpin` from the store:
```typescript
const { triggerSpin } = useNltrStore()
```

3. Define the detector (add as a module-level constant or inside the hook):
```typescript
const BARREL_ROLL_PHRASES = ['barrel roll', 'do a flip']
function isBarrelRoll(text: string): boolean {
  const lower = text.toLowerCase().trim()
  return BARREL_ROLL_PHRASES.some(p => lower.includes(p))
}
```

4. At the start of `handleSend` (before any API call or state update), add:
```typescript
if (isBarrelRoll(text)) {
  triggerSpin()
  // Add a playful canned response to Sage messages instead of hitting the API
  // Append to Sage messages: { role: 'assistant', content: 'Wheee! ðŸŽ¡ Now searching for real experts...' }
  // Then return early â€” do NOT hit the API for barrel roll queries
  return
}
```
Note: Look at how Sage messages are stored/appended in useSage.ts and use the same pattern for the canned response. If messages are stored in local state array, push a new assistant message. The canned message text is Claude's discretion â€” something playful and short.

---

**SearchInput.tsx â€” Detect barrel roll in handleChange, suppress setQuery:**

Read SearchInput.tsx to find how `handleChange` (or the debounced query setter) works. Add:

1. Add import at top:
```typescript
import { useNltrStore } from '../../store/nltrStore'
```
(Adjust path depth based on file location.)

2. Inside the component, get `triggerSpin`:
```typescript
const { triggerSpin } = useNltrStore()
```

3. In `handleChange` (or wherever `localValue` / `setQuery` is updated), intercept before the debounce fires:
```typescript
const BARREL_ROLL_PHRASES = ['barrel roll', 'do a flip']

function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
  const value = e.target.value
  const lower = value.toLowerCase().trim()
  if (BARREL_ROLL_PHRASES.some(p => lower.includes(p))) {
    triggerSpin()
    // Clear the input â€” barrel roll in search should not pollute the search state
    // Do NOT call setQuery() â€” no grid re-fetch for trigger phrases
    setLocalValue('')  // or whatever the local input state setter is named
    return
  }
  // ... existing logic (update localValue, debounce setQuery, etc.)
}
```
CRITICAL: Do NOT call `setQuery('barrel roll')` â€” this would trigger a real semantic search for "barrel roll" and return confused results. The input is cleared after trigger so the grid state is unaffected.
  </action>
  <verify>
    1. `grep -n "spinTrigger\|resetSpin\|containerRef" /Users/sebastianhamers/Documents/TCS/frontend/src/components/marketplace/ExpertGrid.tsx` â€” all three must appear
    2. `grep -n "triggerSpin\|isBarrelRoll\|barrel roll" /Users/sebastianhamers/Documents/TCS/frontend/src/hooks/useSage.ts` â€” all three must appear
    3. `grep -n "triggerSpin\|barrel roll" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/SearchInput.tsx` â€” both must appear
  </verify>
  <done>
    - ExpertGrid wraps VirtuosoGrid in a ref-able div with `animate()` on spinTrigger
    - Rotation resets to 0 after completion (no additive rotation on repeat)
    - useSage intercepts barrel roll before API call; appends playful canned message; calls triggerSpin()
    - SearchInput intercepts barrel roll before debounce/setQuery; clears input; calls triggerSpin()
    - VirtuosoGrid scroll still works (wrapper div has correct height)
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin Leads â€” newsletter subscriber count, list, and CSV export</name>
  <files>
    frontend/src/admin/types.ts
    frontend/src/admin/hooks/useAdminData.ts
    frontend/src/admin/pages/LeadsPage.tsx
  </files>
  <action>
**frontend/src/admin/types.ts â€” Add newsletter types:**

Add after existing type definitions:
```typescript
export interface NewsletterSubscriber {
  email: string
  created_at: string  // ISO string
  source: string
}

export interface NewsletterSubscribersResponse {
  count: number
  subscribers: NewsletterSubscriber[]
}
```

---

**frontend/src/admin/hooks/useAdminData.ts â€” Add useNewsletterSubscribers hook:**

Read the existing file to understand the `adminFetch` import and the `useAdminLeads` pattern. Add a new hook following the identical pattern:

```typescript
import type { NewsletterSubscribersResponse } from '../types'

export function useNewsletterSubscribers() {
  const [data, setData] = useState<NewsletterSubscribersResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    setLoading(true)
    adminFetch<NewsletterSubscribersResponse>('/newsletter-subscribers')
      .then(setData)
      .catch((e: Error) => setError(e.message))
      .finally(() => setLoading(false))
  }, [])

  return { data, loading, error }
}
```

Note: `adminFetch` adds the `/api/admin` prefix and the `X-Admin-Key` header automatically. Confirm this by reading the existing file â€” do not duplicate the prefix.

---

**frontend/src/admin/pages/LeadsPage.tsx â€” Add newsletter subscriber section:**

Read the current LeadsPage.tsx to understand the layout. Add a newsletter subscriber section **above** the existing leads table (as a distinct stats/list block). It should include:

1. Import `useNewsletterSubscribers` from the hooks file and `NewsletterSubscriber` type from types.
2. Call the hook: `const { data: nltrData, loading: nltrLoading } = useNewsletterSubscribers()`
3. Get `API_URL` (same constant used elsewhere in admin pages).

**Section layout (at the top of the page content, before existing leads):**

A card/panel with:
- **Header row**: Title "Newsletter Subscribers" + subscriber count badge (e.g. `{nltrData?.count ?? 0} subscribers`) + "Export CSV" button on the right
- **CSV export button** behavior:
```typescript
function downloadNewsletterCsv() {
  const adminKey = sessionStorage.getItem('adminKey') || ''
  // The admin CSV endpoint requires X-Admin-Key header â€” use fetch with header, create blob URL
  fetch(`${API_URL}/api/admin/export/newsletter.csv`, {
    headers: { 'X-Admin-Key': adminKey },
  })
    .then(r => r.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `newsletter-subscribers-${new Date().toISOString().slice(0, 10)}.csv`
      a.click()
      URL.revokeObjectURL(url)
    })
}
```
Note: A simple `<a href={url}>` won't work for the CSV endpoint because it needs the `X-Admin-Key` header. Use the fetch+blob pattern above.

- **Subscriber list**: A simple table or list showing `email` and `created_at` (formatted as locale date string). If `nltrLoading`, show a loading indicator. If no subscribers, show "No subscribers yet."

Visual weight is Claude's discretion â€” match the existing admin card/table style used on the page.
  </action>
  <verify>
    1. `grep -n "NewsletterSubscriber\|useNewsletterSubscribers" /Users/sebastianhamers/Documents/TCS/frontend/src/admin/types.ts` â€” both must appear
    2. `grep -n "useNewsletterSubscribers\|newsletter-subscribers" /Users/sebastianhamers/Documents/TCS/frontend/src/admin/hooks/useAdminData.ts` â€” both must appear
    3. `grep -n "useNewsletterSubscribers\|downloadNewsletterCsv\|export/newsletter" /Users/sebastianhamers/Documents/TCS/frontend/src/admin/pages/LeadsPage.tsx` â€” all three must appear
  </verify>
  <done>
    - Admin types include NewsletterSubscriber and NewsletterSubscribersResponse
    - useNewsletterSubscribers hook fetches from /newsletter-subscribers with adminFetch
    - LeadsPage shows subscriber count, email list with dates, and CSV download button
    - CSV download uses fetch+blob pattern (to send X-Admin-Key header)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification â€” barrel roll and admin newsletter subscriber view</name>
  <action>Human checkpoint â€” verify barrel roll animation and admin Leads newsletter section as described in how-to-verify.</action>
  <what-built>
    Barrel roll easter egg: typing "barrel roll" or "do a flip" in Sage input or search bar spins the ExpertGrid 360 degrees via Framer Motion on the container div. Search input does not fire a real query for trigger phrases. Sage shows a playful canned response instead of hitting the API. Admin Leads page now shows newsletter subscriber count, list, and a working CSV export button.
  </what-built>
  <how-to-verify>
    **Barrel roll â€” Sage:**
    1. Open https://tcs-three-sigma.vercel.app
    2. Open the Sage panel (floating AI co-pilot)
    3. Type "barrel roll" and press Enter
    4. The ExpertGrid should spin 360Â° smoothly (0.7s, ease-in-out)
    5. Sage should show a playful canned message â€” NOT a confused semantic response
    6. Type "barrel roll" again â€” grid spins again (no additive rotation, no snap to 0 flash)
    7. Repeat with "do a flip" â€” same behavior

    **Barrel roll â€” Search input:**
    1. Click the search input (top of marketplace)
    2. Type "barrel roll"
    3. Grid spins 360Â°
    4. Input clears automatically
    5. Grid does NOT show a "barrel roll" search query in results (no re-fetch)

    **Admin Leads:**
    1. Open https://tcs-three-sigma.vercel.app/admin and log in
    2. Navigate to Leads page
    3. A "Newsletter Subscribers" section appears above or alongside existing leads
    4. Subscriber count shown (may be 0 if no one has subscribed yet â€” that's OK)
    5. "Export CSV" button visible â€” click it
    6. A CSV file downloads containing header rows and any subscriber data
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Barrel roll fires from both Sage and SearchInput trigger detection
2. ExpertGrid container spins without breaking VirtuosoGrid scroll
3. Rotation resets cleanly (no additive rotation on repeat)
4. Admin Leads page renders newsletter section with count + list + CSV export
5. Human visual verification passes (checkpoint task)
</verification>

<success_criteria>
- Typing "barrel roll" or "do a flip" in Sage causes grid to spin 360Â° and shows canned message (no API call for trigger phrases)
- Typing trigger phrases in search input causes spin without triggering a real query; input clears
- ExpertGrid scroll intact after animation
- Admin Leads shows newsletter subscriber count, email list, and working CSV download
- CSV download button sends X-Admin-Key header correctly (fetch+blob pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/27-newsletter-gate-easter-egg/27-03-SUMMARY.md`
</output>
