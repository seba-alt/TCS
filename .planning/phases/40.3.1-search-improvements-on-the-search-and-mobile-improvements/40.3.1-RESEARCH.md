# Phase 40.3.1: Search & Mobile Improvements - Research

**Researched:** 2026-02-26
**Domain:** React frontend UX — search autocomplete dropdown, mobile layout, bottom-sheet interactions, Sage mobile panel
**Confidence:** HIGH (all findings verified against live codebase; no external library research needed for new dependencies — all required libraries already installed)

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

**Search behavior:**
- Search bar and Sage both use the existing hybrid search system (FAISS + text matching)
- Live debounced dropdown (autocomplete) appears as user types (~300ms debounce)
- Suggestions are a classic dropdown list below the search bar (not inline cards)
- Suggestions show all searchable fields: categories, companies, domain tags, job titles
- Maximum 5 suggestions in the dropdown
- Selecting a suggestion fills the search bar text, then a full hybrid search runs
- Expert grid updates only on Enter press or suggestion click (not live as you type)
- Clearing the search bar (delete text or X button) removes the search term but keeps any active filter chips (rate, tags, saved, etc.)

**Mobile layout:**
- 2 expert cards per row on mobile (portrait phone)
- Header and search bar are sticky — always visible at top when scrolling
- Card content density at Claude's discretion (what fits well in 2-column grid)
- Tap behavior: first tap expands/highlights card with more details, second tap opens external profile link

**Filter experience (mobile):**
- Filters accessed via bottom sheet — tap filter button, sheet slides up from bottom
- Active filters shown as dismissible chips between search bar and grid (chip row always visible)
- Bottom sheet auto-closes when a filter is applied (optimized for single-filter selection)
- Desktop filter sidebar remains as-is — bottom sheet is mobile-only alternative

**Sage on mobile:**
- FAB positioned at bottom-right corner (classic FAB position)
- Tapping FAB opens Sage as a fixed half-screen (~60%) bottom sheet
- Not draggable — always opens at fixed height, close button to dismiss
- After a discovery query returns results, bottom sheet auto-closes (~2s delay) so user sees the filtered grid

### Claude's Discretion
- Mobile card content density (what info to show/hide at 2-per-row)
- Suggestion dropdown styling and animation
- Bottom sheet implementation details (animation, backdrop)
- Exact debounce timing
- Loading states during search

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

---

## Summary

This phase adds three improvements to the Explorer page (`/`): (1) a live autocomplete suggestion dropdown on the search bar, (2) an expanded mobile layout with 2-per-row cards and tap-expand behavior, and (3) a mobile bottom sheet for Sage (replacing the current desktop-only SagePanel behavior on phone).

The backend already has a `/api/suggest` endpoint using FTS5 prefix matching, but it currently only queries `job_title`. The CONTEXT.md requires suggestions to cover categories, companies, domain tags, and job titles — so the suggest endpoint needs to be expanded. The FTS5 table (`experts_fts`) already indexes `job_title`, `company`, `tags`, `first_name`, `last_name`, `bio`. All four suggestion source fields are already indexed.

On the frontend, Vaul (v1.1.2, already installed) is the correct library for bottom sheets — it is already used for MobileFilterSheet and its API is well understood in this codebase. The Sage mobile bottom sheet will reuse the same pattern. The `motion/react` library (v12, already installed) is used for animations throughout and should be used for the dropdown.

**Primary recommendation:** Reuse existing library patterns (Vaul for sheets, motion/react for animations, Zustand store for state). Expand the suggest endpoint to cover all four field types. Add keyboard navigation to dropdown. Treat the autocomplete as a UI layer over `useHeaderSearch` — do not restructure the search pipeline.

---

## Standard Stack

### Core (all already installed — no new dependencies required)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| vaul | ^1.1.2 | Bottom sheet drawer (Sage mobile panel, filter sheet) | Already used for MobileFilterSheet; correct pattern |
| motion/react | ^12.34.3 | Animations (dropdown, transitions) | Project standard; used in Header, SagePanel, BrowseCard |
| zustand | ^5.0.11 | State for dropdown open/suggestions | Project standard store |
| react-router-dom | ^7.13.0 | No change needed | Route context for useUrlSync |
| lucide-react | ^0.575.0 | Icons (X clear button, search) | Already used |
| tailwindcss | ^3.4.19 | Styling | Project standard |

### No New Dependencies
All required functionality is achievable with the current dependency set. Do NOT add any new packages.

---

## Architecture Patterns

### Current Search Flow (to be modified)

```
useHeaderSearch.ts (localValue, debounce → setQuery)
    ↓ setQuery (store action)
useExplore.ts (watches query in store → calls /api/explore)
    ↓
ExpertGrid renders results
```

The current flow: typing debounces → `setQuery()` → `useExplore` fires → grid updates live.

**The CONTEXT.md decision reverses this**: grid updates only on Enter or suggestion click, not live while typing. This is a significant behavioral change to `useHeaderSearch`.

### New Search Flow (after phase)

```
useHeaderSearch.ts (localValue, debounced → fetchSuggestions only)
    ↓ on Enter or suggestion click → setQuery (store action)
useExplore.ts (watches query in store → calls /api/explore)
    ↓
ExpertGrid renders results

Autocomplete Dropdown:
localValue (300ms debounce) → GET /api/suggest?q=... → dropdown list
```

### Suggested File Structure Changes

```
frontend/src/
├── hooks/
│   ├── useHeaderSearch.ts        # MODIFY: add suggestions state, keyboard nav,
│   │                             #   only call setQuery on Enter/select (not on debounce)
│   └── useSage.ts                # MODIFY: add auto-close logic after search_performed
├── components/
│   ├── Header.tsx                # MODIFY: render dropdown below search bar,
│   │                             #   add X clear button, sticky behavior
│   ├── marketplace/
│   │   ├── ExpertCard.tsx        # MODIFY: add tap-expand behavior (mobile first-tap),
│   │   │                         #   adjust content density for 2-column grid
│   │   └── ExpertGrid.tsx        # MODIFY: grid-cols-2 already set for mobile (verify)
│   ├── pilot/
│   │   ├── SageFAB.tsx          # MODIFY: ensure bottom-right, no layout changes needed
│   │   └── SagePanel.tsx        # MODIFY: add mobile variant (Vaul bottom sheet)
│   │                             #   or create SageMobileSheet.tsx
│   └── sidebar/
│       └── MobileFilterSheet.tsx # MODIFY: ensure auto-close on Apply (already does this)
└── layouts/
    └── RootLayout.tsx            # MODIFY: render SageMobileSheet on mobile alongside SagePanel on desktop
```

### Pattern 1: Autocomplete Dropdown — Non-Live Search with Suggestions

**Critical behavioral distinction:** `localValue` drives the debounced suggestion fetch. `setQuery` (which triggers `/api/explore`) only fires on Enter or suggestion click. This decouples autocomplete from live search.

```typescript
// In useHeaderSearch.ts — modified pattern
const [suggestions, setSuggestions] = useState<string[]>([])
const [showDropdown, setShowDropdown] = useState(false)
const suggestTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)

function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
  const value = e.target.value
  setLocalValue(value)
  // Do NOT call setQuery here (remove existing debounce to setQuery)

  // Fetch suggestions after 300ms
  if (suggestTimerRef.current) clearTimeout(suggestTimerRef.current)
  if (value.trim().length >= 2) {
    suggestTimerRef.current = setTimeout(() => {
      fetchSuggestions(value.trim())
    }, 300)
  } else {
    setSuggestions([])
    setShowDropdown(false)
  }
}

function handleKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {
  if (e.key === 'Enter') {
    setShowDropdown(false)
    setSuggestions([])
    setQuery(localValue)  // Only here does grid update
  }
  if (e.key === 'Escape') {
    setShowDropdown(false)
  }
  // ArrowUp/ArrowDown for keyboard nav (see Pitfall 1)
}

function handleSelectSuggestion(suggestion: string) {
  setLocalValue(suggestion)
  setShowDropdown(false)
  setSuggestions([])
  setQuery(suggestion)  // Grid updates here
}

function handleClear() {
  setLocalValue('')
  setSuggestions([])
  setShowDropdown(false)
  setQuery('')  // Clears search but preserves filter chips (rate, tags stay in store)
}
```

### Pattern 2: Vaul Bottom Sheet for Sage on Mobile

Vaul is already used for `MobileFilterSheet`. The Sage mobile variant needs a **fixed height** (not draggable per CONTEXT.md). Vaul supports `snapPoints` with a single snap point to disable dragging.

```typescript
// SageMobileSheet.tsx — new component using existing Vaul pattern
import { Drawer } from 'vaul'

interface SageMobileSheetProps {
  open: boolean
  onClose: () => void
}

export function SageMobileSheet({ open, onClose }: SageMobileSheetProps) {
  return (
    <Drawer.Root
      open={open}
      onOpenChange={(o) => { if (!o) onClose() }}
      snapPoints={[0.6]}      // Fixed at 60% height
      activeSnapPoint={0.6}   // Always at this snap
      // No setActiveSnapPoint → user cannot drag to different snap
    >
      <Drawer.Portal>
        <Drawer.Overlay className="fixed inset-0 bg-black/40" />
        <Drawer.Content className="fixed bottom-0 left-0 right-0 bg-[oklch(12%_0.025_279/0.97)] rounded-t-2xl flex flex-col" style={{ height: '60vh' }}>
          {/* No drag handle (not draggable per CONTEXT.md) */}
          {/* Sage panel content here */}
        </Drawer.Content>
      </Drawer.Portal>
    </Drawer.Root>
  )
}
```

**Auto-close after discovery query:** The `useSage.ts` hook sets `store.setSageMode(true)` and `store.setResults(...)` when `search_performed === true`. The 2s auto-close should be implemented in the mobile sheet component by watching `isStreaming` transitioning from true → false while `sageMode` is true.

```typescript
// In SageMobileSheet or RootLayout — auto-close logic
const prevStreamingRef = useRef(isStreaming)
useEffect(() => {
  if (prevStreamingRef.current === true && isStreaming === false && sageMode) {
    const t = setTimeout(() => setOpen(false), 2000)
    return () => clearTimeout(t)
  }
  prevStreamingRef.current = isStreaming
}, [isStreaming, sageMode])
```

### Pattern 3: Mobile Sage FAB + Sheet in RootLayout

Currently `RootLayout.tsx` renders `SageFAB` and `SagePanel` (desktop). On mobile, `SagePanel` is a `fixed bottom-6 right-6 w-[380px]` panel — too wide for mobile. The mobile path should render `SageMobileSheet` instead.

```typescript
// RootLayout.tsx — conditional rendering
// Detect mobile via CSS media query or window.innerWidth
// Preferred: CSS class-based (Tailwind) — use two components, let CSS show/hide
<>
  <Outlet />

  {/* FAB — always visible when panel closed */}
  <AnimatePresence>
    {!isOpen && <SageFAB key="sage-fab" />}
  </AnimatePresence>

  {/* Desktop: existing SagePanel (hidden on mobile) */}
  <AnimatePresence>
    {isOpen && (
      <>
        <div className="hidden md:block fixed inset-0 z-30 bg-black/30" onClick={() => setOpen(false)} />
        <div className="hidden md:block">
          <SagePanel key="sage-panel" />
        </div>
      </>
    )}
  </AnimatePresence>

  {/* Mobile: Vaul bottom sheet */}
  <div className="md:hidden">
    <SageMobileSheet open={isOpen} onClose={() => setOpen(false)} />
  </div>
</>
```

**Note:** Tailwind `hidden md:block` / `md:hidden` pattern is the existing project convention for responsive rendering. Do not use JS-based width detection (causes hydration issues).

### Pattern 4: ExpertCard Tap-Expand on Mobile

Current card is a static 180px flex column. The CONTEXT.md requires: first tap → expand/highlight with more details; second tap → opens profile_url.

```typescript
// ExpertCard.tsx — add tap state
const [expanded, setExpanded] = useState(false)

function handleCardClick(e: React.MouseEvent) {
  // Don't intercept bookmark button clicks (already has stopPropagation)
  if (!expanded) {
    setExpanded(true)
  } else {
    onViewProfile(expert.profile_url)
  }
}

// Collapse when card loses focus (user taps elsewhere)
function handleBlur() {
  setExpanded(false)
}
```

In expanded state: show Zone C (domain tags, currently `hidden sm:hidden` on mobile) and Zone D (match reason). Adjust card height dynamically. Use `motion/react` for smooth height animation:

```typescript
// motion/react AnimatePresence for expanded content
<motion.div
  initial={{ height: 0, opacity: 0 }}
  animate={{ height: 'auto', opacity: 1 }}
  exit={{ height: 0, opacity: 0 }}
  transition={{ duration: 0.2 }}
>
  {/* Expanded content: tags + match reason (mobile only) */}
</motion.div>
```

**Height constraint:** Current card is `h-[180px] overflow-hidden`. In expanded state, remove the fixed height. Use `min-h-[180px]` instead of `h-[180px]`.

### Pattern 5: Backend Suggest Endpoint — Multi-Field Expansion

The current `/api/suggest` queries only `job_title` from `experts_fts`. The CONTEXT.md requires suggestions from: categories, companies, domain tags, job titles.

Current FTS5 table schema:
```sql
CREATE VIRTUAL TABLE experts_fts USING fts5(
    first_name, last_name, job_title, company, bio, tags,
    content='experts', content_rowid='id'
)
```

The `tags` field is JSON-serialized (e.g., `["fundraising", "real estate"]`) in the Expert model. FTS5 treats this as a text blob — prefix matching will work on individual tag words.

**Recommendation:** Expand suggest to query multiple fields and deduplicate. Return typed suggestions (so frontend can show field type label):

```python
# suggest.py — expanded multi-field approach
@router.get("/api/suggest", response_model=list[str])
async def suggest(q: str = Query(default="", max_length=200), db: Session = Depends(get_db)) -> list[str]:
    """
    Suggestions from: job_title, company, tags (FTS5 prefix).
    Returns max 5 unique strings, deduplicated, sorted by relevance.
    """
    if len(q.strip()) < 2:
        return []
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, lambda: _run_suggest_multi(q, db))
```

However, the FTS5 MATCH returns rows, not individual field values. To get distinct values from each field, we need separate queries per column:

```python
def _run_suggest_multi(q: str, db: Session) -> list[str]:
    prefix_q = _safe_prefix_query(q.strip())
    if not prefix_q: return []

    results = []

    # Query job_title, company, and tags columns separately
    for column in ('job_title', 'company'):
        try:
            rows = db.execute(text(
                f"SELECT DISTINCT {column} FROM experts_fts "
                f"WHERE experts_fts MATCH :q ORDER BY rank LIMIT 3"
            ), {"q": prefix_q}).fetchall()
            results.extend(r[0] for r in rows if r[0] and r[0].strip())
        except Exception:
            pass

    # Tags are JSON arrays — extract distinct matching tag strings via Python
    # (FTS5 MATCH on tags column returns the whole JSON array, not individual tags)
    # Better: query tags from metadata in-memory or use a separate tag list

    # Deduplicate preserving order, limit to 5
    seen = set()
    unique = []
    for item in results:
        if item not in seen:
            seen.add(item)
            unique.append(item)
        if len(unique) >= 5:
            break
    return unique
```

**Tags caveat:** FTS5 stores `tags` as JSON-serialized text (e.g., `'["fundraising", "saas"]'`). A prefix query on the tags column matches documents, but the column value returned is the full JSON string, not individual tags. For tag suggestions, the better approach is to match against the static `TOP_TAGS` list (already in `constants/tags.ts`) on the frontend rather than hitting the backend for tags. The frontend already has 30 top tags as a constant — a simple `startsWith` or `includes` filter on `TOP_TAGS` returns clean suggestions instantly.

**Revised suggestion strategy (HIGH confidence):**
1. Backend `/api/suggest`: expand to query `job_title` + `company` (both work well with FTS5 MATCH → DISTINCT column)
2. Frontend: merge backend suggestions with local `TOP_TAGS` prefix-match (for domain tags)
3. Limit combined results to 5, deduplicate

### Anti-Patterns to Avoid

- **Calling `setQuery` on every keystroke (or on debounce):** The CONTEXT.md requires grid updates ONLY on Enter/suggestion click. The current `useHeaderSearch` fires `setQuery` on debounce — this must be removed. Do not just add the dropdown on top of the existing live-search behavior.
- **Using `window.innerWidth` for mobile detection:** Causes hydration mismatch. Use Tailwind breakpoints via conditional rendering with `hidden md:block`.
- **Making the Sage mobile sheet draggable:** CONTEXT.md says "Not draggable." Vaul's `snapPoints` must have exactly one point, and `setActiveSnapPoint` must not be provided (or must be a no-op).
- **Closing suggestion dropdown on input blur immediately:** Browser fires blur before the click on a suggestion item, causing the click to miss. Use `onMouseDown` on suggestion items (not `onClick`) to fire before blur, or use `setTimeout` delay on dropdown close.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Bottom sheet drawer | Custom CSS slide-up | Vaul (already installed) | Handles scroll locking, touch events, portal, accessibility |
| Dropdown dismiss on outside click | Custom event listener | `onBlur` + `onMouseDown` pattern (see pitfall below) | React synthetic events handle this correctly |
| Tags prefix match | Backend FTS5 query | Client-side filter on TOP_TAGS constant | 30 tags, instant, no network round-trip |
| Card expand animation | CSS transitions | motion/react `AnimatePresence` + `height: 'auto'` | Already used in project, handles height auto correctly |

**Key insight:** The project has all required libraries. The work is wiring existing patterns together, not adding new infrastructure.

---

## Common Pitfalls

### Pitfall 1: Dropdown closes before suggestion click registers
**What goes wrong:** User clicks a suggestion → `onBlur` fires on the input → dropdown unmounts → `onClick` on the suggestion list item never fires.
**Why it happens:** Browser fires `blur` before `click` in the event sequence.
**How to avoid:** Use `onMouseDown` (fires before blur) on suggestion list items, calling `e.preventDefault()` to prevent the input losing focus, then handle selection in `onMouseDown`.
**Warning signs:** Dropdown flickers away when user clicks on it; suggestions are unclickable.

```typescript
<li
  onMouseDown={(e) => {
    e.preventDefault()  // Prevents input blur
    handleSelectSuggestion(suggestion)
  }}
>
```

### Pitfall 2: Removing live search breaks the debounce-to-setQuery flow
**What goes wrong:** Removing the debounce call to `setQuery` means the search bar no longer updates the grid. But if the user was relying on the old behavior (e.g., typing slowly and seeing results appear), UX regresses.
**Why it happens:** The CONTEXT.md explicitly changes the UX — grid only updates on Enter or suggestion click. This is intentional.
**How to avoid:** Implement clearly: `handleChange` only updates `localValue` and fetches suggestions. `setQuery` only called from `handleKeyDown('Enter')` and `handleSelectSuggestion`. Add a visible search icon or hint.
**Warning signs:** Grid never updates until user presses Enter (correct) but user doesn't know to press Enter (add placeholder guidance).

### Pitfall 3: Sage mobile sheet auto-close fires on non-discovery messages
**What goes wrong:** Sage auto-closes after ANY message response, not just discovery queries that set `sageMode`.
**Why it happens:** Auto-close watches `isStreaming` transition false → true, but doesn't check `sageMode`.
**How to avoid:** Gate auto-close on `sageMode === true`. Only `search_performed: true` responses set `sageMode`; filter-only responses do not.

### Pitfall 4: ExpertCard height blowout in VirtuosoGrid when expanded
**What goes wrong:** `VirtuosoGrid` measures item height once and caches it. When a card expands, Virtuoso may not re-measure, causing overlap or scroll position issues.
**Why it happens:** VirtuosoGrid uses fixed item sizing by default.
**How to avoid:** When adding expand behavior, either (a) limit expand to not change the Virtuoso grid's item height (show details in an overlay/tooltip instead) or (b) accept that expand resets scroll position. The simplest safe approach: expand replaces card content in-place within the fixed 180px height, showing different info rather than growing.
**Alternative approach:** Use a max-height with overflow-hidden and animate max-height (not height: auto) to keep Virtuoso happy. Or use `react-virtuoso`'s `overscan` to pre-render enough items that measurement is less critical.

### Pitfall 5: /api/suggest returns job titles with commas or special chars
**What goes wrong:** FTS5 prefix match returns job titles like `"CEO / Co-Founder"` which display fine but when auto-filled into the search bar and submitted, the `/` or special chars may cause unexpected FTS5 behavior in the main explore endpoint.
**Why it happens:** The suggest endpoint returns raw `job_title` values from the DB.
**How to avoid:** The main `/api/explore` endpoint uses `_safe_fts_query()` which strips special characters — this is already safe. No special handling needed on the frontend.

---

## Code Examples

### Suggestion fetch in useHeaderSearch

```typescript
// Fetch suggestions from backend + local TOP_TAGS match
async function fetchSuggestions(value: string) {
  const lower = value.toLowerCase()

  // Local tag suggestions (instant)
  const tagSuggestions = TOP_TAGS
    .filter(t => t.includes(lower))
    .slice(0, 3)

  // Backend suggestions (job_title, company via FTS5)
  try {
    const res = await fetch(`${API_BASE}/api/suggest?q=${encodeURIComponent(value)}`)
    if (!res.ok) throw new Error()
    const backendSugs: string[] = await res.json()

    // Merge: backend first (job titles/companies), then tags, deduplicate, limit 5
    const merged = [...new Set([...backendSugs, ...tagSuggestions])].slice(0, 5)
    setSuggestions(merged)
    setShowDropdown(merged.length > 0)
  } catch {
    // Fall back to local tags only
    setSuggestions(tagSuggestions)
    setShowDropdown(tagSuggestions.length > 0)
  }
}
```

### Dropdown rendering in Header.tsx

```tsx
{/* Autocomplete dropdown — positioned absolute below search input */}
{showDropdown && suggestions.length > 0 && (
  <motion.ul
    initial={{ opacity: 0, y: -4 }}
    animate={{ opacity: 1, y: 0 }}
    exit={{ opacity: 0 }}
    transition={{ duration: 0.15 }}
    className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl border border-slate-200 shadow-lg z-50 overflow-hidden"
    role="listbox"
  >
    {suggestions.map((suggestion, i) => (
      <li
        key={suggestion}
        role="option"
        aria-selected={i === selectedIndex}
        onMouseDown={(e) => {
          e.preventDefault()
          handleSelectSuggestion(suggestion)
        }}
        className={`px-4 py-2.5 text-sm cursor-pointer hover:bg-gray-50 ${
          i === selectedIndex ? 'bg-purple-50 text-brand-purple' : 'text-gray-700'
        }`}
      >
        {suggestion}
      </li>
    ))}
  </motion.ul>
)}
```

### X clear button in search bar (Header.tsx)

```tsx
{/* X clear button — shown only when localValue has content */}
{localValue && (
  <button
    onClick={handleClear}
    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
    aria-label="Clear search"
    tabIndex={-1}
  >
    <X size={14} />
  </button>
)}
```

### MobileFilterSheet auto-close (already implemented)

The existing `MobileFilterSheet.handleApply()` calls `onClose()` after applying filters. This satisfies "bottom sheet auto-closes when a filter is applied." No changes needed here.

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Live search on debounce | Suggestions only on debounce, grid updates on Enter/select | Phase 40.3.1 | Better UX — user controls when search commits |
| SagePanel desktop-only (380px fixed width) | SageMobileSheet (Vaul 60% height) on mobile | Phase 40.3.1 | Sage accessible on mobile |
| ExpertCard static 180px | Tap-expand on mobile for more details | Phase 40.3.1 | More info per card without layout change |
| /api/suggest job_title only | Multi-field (job_title + company + tags) | Phase 40.3.1 | Richer, more useful suggestions |

---

## Open Questions

1. **Vaul `snapPoints` with single snap — is dragging fully disabled?**
   - What we know: Vaul supports `snapPoints={[0.6]}` with `activeSnapPoint={0.6}`. Omitting `setActiveSnapPoint` prevents programmatic snap changes.
   - What's unclear: Whether Vaul still allows the user to drag down to dismiss even with a single snap point.
   - Recommendation: Keep `dismissible={false}` prop if Vaul supports it, or add a close button as the sole dismiss mechanism (CONTEXT.md says "close button to dismiss"). Test manually after implementation.

2. **ExpertCard Virtuoso height — expand vs. fixed height**
   - What we know: VirtuosoGrid uses `listClassName="grid grid-cols-2 md:grid-cols-3 gap-4 px-4 pb-4 pt-4"` and items have `h-[180px]`.
   - What's unclear: Whether expanding a card breaks Virtuoso's height calculation.
   - Recommendation: Implement expand as in-place content swap (same height, different content shown) rather than height growth. If height growth is needed, use `react-virtuoso`'s `useWindowVirtualizer` or accept a scroll reset.

3. **Suggest endpoint — categories field**
   - What we know: The `category` field in the Expert model is `nullable` and the current data shows 0 unique categories (all `None`). FTS5 does not index `category`.
   - What's unclear: Whether category suggestions are meaningful given no data.
   - Recommendation: Skip category suggestions for now (no data). Focus on job_title, company, and tags.

---

## Validation Architecture

> `workflow.nyquist_validation` is not present in `.planning/config.json` (field absent). Skipping this section.

---

## Implementation Plan Summary (for Planner)

The phase has 5 distinct work areas, suitable for 2-3 plans:

**Plan 1 — Search Autocomplete (backend + frontend):**
- Expand `/api/suggest` to include `company` field (FTS5 already indexes it)
- Add `useHeaderSearch` suggestion state + debounced fetch
- Change search trigger: only `setQuery` on Enter/suggestion click (remove debounce-to-setQuery)
- Add dropdown UI below Header search bar
- Add X clear button

**Plan 2 — Mobile Layout (cards + Sage sheet):**
- ExpertCard: tap-expand behavior + content density for 2-per-row
- SageMobileSheet: new Vaul component wrapping SagePanel content
- RootLayout: conditional rendering (desktop SagePanel vs mobile SageMobileSheet)
- Auto-close logic after discovery query (2s delay, gated on sageMode)

**Plan 3 (optional, if scope large):**
- MobileFilterSheet behavior validation (auto-close on Apply already done)
- Sticky header/search bar verification (Header already has `sticky top-0 z-50`)
- FilterChips always visible on mobile (already rendered between toolbar and grid)

---

## Sources

### Primary (HIGH confidence)
- Codebase direct inspection — all files read live from `/Users/sebastianhamers/Documents/TCS/`
- `frontend/src/hooks/useHeaderSearch.ts` — current search debounce and setQuery behavior
- `frontend/src/components/sidebar/MobileFilterSheet.tsx` — existing Vaul bottom sheet pattern (vaul v1.1.2)
- `app/routers/suggest.py` — existing FTS5 suggest endpoint (job_title only)
- `app/main.py` L234-253 — FTS5 table schema (fields: first_name, last_name, job_title, company, bio, tags)
- `frontend/src/constants/tags.ts` — TOP_TAGS static list (30 tags)
- `data/metadata.json` inspection — 536 experts, 1744 unique tags, 466 companies, 0 categories populated
- `frontend/package.json` — confirmed installed libraries and versions

### Secondary (MEDIUM confidence)
- Vaul scroll-locking + single snap behavior — inferred from existing MobileFilterSheet usage patterns in codebase; should be tested manually

### Tertiary (LOW confidence)
- VirtuosoGrid re-measurement behavior with dynamic card heights — known general VirtuosoGrid limitation, flagged in Open Questions

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all libraries already installed, versions confirmed from package.json
- Architecture: HIGH — all patterns derived from live codebase inspection
- Backend suggest expansion: HIGH — FTS5 schema verified, approach is direct column addition
- Vaul mobile sheet: HIGH — existing MobileFilterSheet provides exact template
- Pitfalls: HIGH for dropdown blur/click ordering (well-known React pattern), MEDIUM for Virtuoso height

**Research date:** 2026-02-26
**Valid until:** 2026-03-28 (stable stack — 30-day window)
