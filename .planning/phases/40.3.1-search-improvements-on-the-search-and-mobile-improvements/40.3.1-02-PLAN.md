---
phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/marketplace/ExpertCard.tsx
  - frontend/src/components/pilot/SageMobileSheet.tsx
  - frontend/src/layouts/RootLayout.tsx
  - frontend/src/components/pilot/SageFAB.tsx
autonomous: true
requirements:
  - MOBILE-01
  - MOBILE-03

must_haves:
  truths:
    - "Mobile users see 2 expert cards per row in a clean, readable layout"
    - "First tap on a mobile card expands it to show more details (tags, match reason)"
    - "Second tap on an expanded card opens the expert's external profile link"
    - "Tapping the Sage FAB opens a fixed 60% height bottom sheet with Sage chat"
    - "The Sage bottom sheet is not draggable — only a close button dismisses it"
    - "After a discovery query returns results, the Sage bottom sheet auto-closes after ~2s"
    - "Desktop Sage panel continues to work unchanged"
  artifacts:
    - path: "frontend/src/components/marketplace/ExpertCard.tsx"
      provides: "Tap-expand behavior on mobile, content density for 2-column grid"
      contains: "expanded"
    - path: "frontend/src/components/pilot/SageMobileSheet.tsx"
      provides: "Vaul bottom sheet wrapping Sage chat for mobile"
      contains: "Drawer"
    - path: "frontend/src/layouts/RootLayout.tsx"
      provides: "Responsive rendering — desktop SagePanel vs mobile SageMobileSheet"
      contains: "md:hidden"
    - path: "frontend/src/components/pilot/SageFAB.tsx"
      provides: "FAB at bottom-right (no layout changes needed, verify position)"
  key_links:
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "frontend/src/components/pilot/SageMobileSheet.tsx"
      via: "conditional render with md:hidden"
      pattern: "SageMobileSheet"
    - from: "frontend/src/components/pilot/SageMobileSheet.tsx"
      to: "frontend/src/hooks/useSage.ts"
      via: "useSage hook for messages/streaming/handleSend"
      pattern: "useSage"
---

<objective>
Add mobile-optimized expert card tap-expand behavior and a Sage bottom sheet for mobile devices, making the Explorer fully usable on phones.

Purpose: Mobile users currently see cards that are too dense and have no way to interact with Sage in a mobile-friendly way. This plan adds tap-to-expand cards and a proper mobile Sage experience via a Vaul bottom sheet.
Output: Modified ExpertCard with tap-expand, new SageMobileSheet component, responsive RootLayout rendering.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-CONTEXT.md
@.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-RESEARCH.md
@frontend/src/components/marketplace/ExpertCard.tsx
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/components/pilot/SagePanel.tsx
@frontend/src/components/pilot/SageFAB.tsx
@frontend/src/layouts/RootLayout.tsx
@frontend/src/components/sidebar/MobileFilterSheet.tsx
@frontend/src/hooks/useSage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tap-expand behavior and mobile content density to ExpertCard</name>
  <files>frontend/src/components/marketplace/ExpertCard.tsx</files>
  <action>
Modify `ExpertCard.tsx` to support tap-to-expand on mobile:

**CRITICAL CONSTRAINT from RESEARCH.md Pitfall 4:** VirtuosoGrid uses fixed item sizing. Expanding a card's height would break Virtuoso's layout. Therefore, implement expand as an **in-place content swap within the same 180px height** — the card stays the same size, but different content is shown when expanded.

1. Add `expanded` state: `const [expanded, setExpanded] = useState(false)`.

2. Add a card-level `onClick` handler:
   ```typescript
   function handleCardClick() {
     if (!expanded) {
       setExpanded(true)
     } else {
       onViewProfile(expert.profile_url)
     }
   }
   ```
   The outer div gets `onClick={handleCardClick}` and `className="cursor-pointer"`.

3. When **not expanded** (default state — optimized for 2-column mobile grid):
   - Zone A: Show name, job title, company, photo, bookmark (same as current but tighter).
   - Zone B: Rate + findability badge (same as current).
   - Zone C (tags): Keep `hidden sm:flex` — hidden on mobile by default.
   - Zone D: Show only "View Full Profile" link (match reason hidden on mobile when not expanded).

4. When **expanded** (mobile tap state — replaces default content):
   - Zone A: Keep name + photo + bookmark (same).
   - Zone B: Keep rate + badge.
   - Zone C: SHOW domain tags on mobile (remove `hidden sm:flex`, show `flex` when expanded). Use `{expanded ? 'flex' : 'hidden sm:flex'}` for the className condition.
   - Zone D: SHOW match reason (when semantic filter active). The "View Full Profile" text changes to indicate second-tap behavior (e.g., "Tap again to view profile").

5. Add a subtle visual indicator for expanded state:
   - Add `ring-2 ring-brand-purple/30` to the card's outer div when expanded.
   - Use motion/react for a subtle scale: wrap content swap in AnimatePresence if needed, but keep it simple since height is fixed.

6. Collapse on outside click: Add `onBlur` with `tabIndex={0}` on the card div so it can receive focus/blur. When the card loses focus (user taps elsewhere), set `expanded(false)`.
   - Alternative approach if onBlur doesn't work well with VirtuosoGrid: skip auto-collapse. User can tap another card (which expands it, but previous card stays expanded until re-rendered by Virtuoso scroll). This is acceptable since Virtuoso recycles items.

7. Import `AnimatePresence, motion` from `motion/react` if not already imported.

**Content density adjustments for 2-column mobile:**
- The grid already uses `grid-cols-2 md:grid-cols-3` in ExpertGrid.tsx — no grid changes needed.
- In the card: job_title and company can truncate (already have `truncate` class). Keep text sizes at `text-xs` and `text-sm` for readability at narrow widths.
- Ensure the card `p-4` padding works at narrow widths. Consider `p-3` on mobile: use `p-3 sm:p-4` for the outer div.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit</automated>
    <manual>Open localhost:5173 in mobile viewport (375px width). Cards show 2 per row. First tap on a card shows tags and match reason. Second tap opens profile link. Card has visual ring when expanded.</manual>
  </verify>
  <done>ExpertCard has tap-expand on mobile: first tap shows expanded content (tags + match reason) within fixed 180px height, second tap navigates to profile. Cards show 2-per-row on mobile with appropriate content density.</done>
</task>

<task type="auto">
  <name>Task 2: Create SageMobileSheet and wire responsive Sage rendering in RootLayout</name>
  <files>frontend/src/components/pilot/SageMobileSheet.tsx, frontend/src/layouts/RootLayout.tsx, frontend/src/components/pilot/SageFAB.tsx</files>
  <action>
**Create `SageMobileSheet.tsx` — new file:**

Create a new component at `frontend/src/components/pilot/SageMobileSheet.tsx` that wraps Sage chat content in a Vaul `Drawer` bottom sheet:

1. Import `Drawer` from `vaul` (same pattern as MobileFilterSheet.tsx).
2. Import `useSage` from `../../hooks/useSage`.
3. Import `useExplorerStore` from `../../store`.
4. Import `SageMessage` from `./SageMessage` and `SageInput` from `./SageInput`.
5. Import `useEffect, useRef` from `react`.
6. Import `X` from `lucide-react`.

Props: `{ open: boolean, onClose: () => void }`.

Structure:
```tsx
<Drawer.Root
  open={open}
  onOpenChange={(o) => { if (!o) onClose() }}
  // Fixed at 60% — not draggable per CONTEXT.md
  // Use modal=true to get overlay + scroll lock
>
  <Drawer.Portal>
    <Drawer.Overlay className="fixed inset-0 bg-black/40 z-40" />
    <Drawer.Content
      className="fixed bottom-0 left-0 right-0 z-40 rounded-t-2xl flex flex-col"
      style={{
        height: '60vh',
        background: 'oklch(12% 0.025 279 / 0.97)',
      }}
    >
      {/* NO drag handle — not draggable per CONTEXT.md */}

      {/* Header with close button */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-white/10 shrink-0">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-full bg-brand-purple flex items-center justify-center">
            <img src="/icon.png" alt="Tinrate" className="w-4 h-4 object-contain brightness-0 invert" />
          </div>
          <span className="font-semibold text-white text-sm">Sage</span>
        </div>
        <button
          onClick={onClose}
          className="w-7 h-7 rounded-full flex items-center justify-center text-white/40 hover:text-white/80 hover:bg-white/10 transition-colors"
        >
          <X size={16} />
        </button>
      </div>

      {/* Messages — scrollable */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto px-4 py-4">
        {/* Same content as SagePanel: greeting, messages, streaming indicator */}
      </div>

      {/* Input */}
      <div className="shrink-0 pb-safe">
        <SageInput onSend={handleSend} disabled={isStreaming} />
      </div>
    </Drawer.Content>
  </Drawer.Portal>
</Drawer.Root>
```

7. Add auto-scroll behavior (same as SagePanel): `useEffect` watching `messages` and `isStreaming` to scroll `scrollRef` to bottom.

8. Add auto-close after discovery query: Watch `isStreaming` transition from `true` to `false` while `sageMode` is `true`. After a 2s delay, call `onClose()`. Use a `prevStreamingRef` pattern:
```typescript
const sageMode = useExplorerStore((s) => s.sageMode)
const prevStreamingRef = useRef(isStreaming)
useEffect(() => {
  if (prevStreamingRef.current === true && isStreaming === false && sageMode) {
    const t = setTimeout(() => onClose(), 2000)
    return () => clearTimeout(t)
  }
  prevStreamingRef.current = isStreaming
}, [isStreaming, sageMode, onClose])
```

9. Include the SAGE_GREETING constant (same as SagePanel):
```typescript
const SAGE_GREETING = "Hey! I'm Sage — tell me what kind of expert you need and I'll find the right people."
```

10. To prevent Vaul from being draggable while still allowing dismiss via close button only: set `dismissible={false}` on `Drawer.Root` so swipe-to-dismiss is disabled. The close button calls `onClose()` which sets `open` to `false`.

**Modify `RootLayout.tsx` — responsive Sage rendering:**

1. Import `SageMobileSheet` from `../components/pilot/SageMobileSheet`.
2. Change the existing Sage panel + backdrop rendering to be desktop-only using `hidden md:block`:
```tsx
{/* Desktop: existing SagePanel + backdrop (hidden on mobile) */}
<AnimatePresence>
  {isOpen && (
    <>
      <div
        key="sage-backdrop"
        className="hidden md:block fixed inset-0 z-30 bg-black/30"
        onClick={() => setOpen(false)}
      />
      <div className="hidden md:block" key="sage-panel-wrapper">
        <SagePanel key="sage-panel" />
      </div>
    </>
  )}
</AnimatePresence>

{/* Mobile: Vaul bottom sheet (hidden on desktop) */}
<div className="md:hidden">
  <SageMobileSheet open={isOpen} onClose={() => setOpen(false)} />
</div>
```

3. The FAB rendering stays the same — `SageFAB` is already positioned `fixed bottom-6 right-6` which works on both mobile and desktop. No changes needed to SageFAB.tsx.

**Verify SageFAB.tsx:**
- Confirm the FAB is at `fixed bottom-6 right-6` (classic FAB position per CONTEXT.md). It already is — no changes needed.
- The FAB is already `z-50` which is above the sheet overlay (`z-40`). This is correct — when the sheet is open, the FAB is hidden via `{!isOpen && <SageFAB />}` in RootLayout.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit</automated>
    <manual>Open localhost:5173 in mobile viewport. Tap Sage FAB — a bottom sheet opens at 60% height showing Sage chat. Cannot drag the sheet. Close button dismisses it. Ask a discovery question — after results arrive, sheet auto-closes after ~2s. Switch to desktop viewport — SagePanel renders as fixed panel (unchanged behavior).</manual>
  </verify>
  <done>SageMobileSheet renders as a fixed 60% height Vaul bottom sheet on mobile with close button, auto-scroll, and auto-close after discovery queries (2s delay). RootLayout shows SagePanel on desktop and SageMobileSheet on mobile. FAB position unchanged at bottom-right.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. Mobile viewport (375px): 2 cards per row, first tap expands card with tags + match reason, second tap opens profile
3. Mobile viewport: Sage FAB at bottom-right, tap opens 60% height bottom sheet
4. Mobile viewport: Bottom sheet not draggable, close button works
5. Mobile viewport: Discovery query in Sage → results load → sheet auto-closes after ~2s
6. Desktop viewport: SagePanel renders as before (380px fixed width), no bottom sheet
7. Desktop viewport: ExpertCard works normally (no tap-expand artifacts on desktop hover/click)
</verification>

<success_criteria>
- ExpertCard has mobile tap-expand within fixed 180px height (content swap, no height change)
- SageMobileSheet is a non-draggable 60% height Vaul bottom sheet with Sage chat
- Auto-close after discovery query (2s delay, gated on sageMode)
- Responsive rendering: desktop SagePanel, mobile SageMobileSheet
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-02-SUMMARY.md`
</output>
