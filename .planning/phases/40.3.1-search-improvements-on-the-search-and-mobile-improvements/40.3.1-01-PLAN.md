---
phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/suggest.py
  - frontend/src/hooks/useHeaderSearch.ts
  - frontend/src/components/Header.tsx
autonomous: true
requirements:
  - SEARCH-01
  - MOBILE-02

must_haves:
  truths:
    - "User types in search bar and sees a dropdown of up to 5 suggestions after ~300ms"
    - "Suggestions include job titles, companies, and domain tags (from TOP_TAGS)"
    - "Selecting a suggestion fills the search bar and triggers a full hybrid search"
    - "Pressing Enter triggers a full hybrid search with the current text"
    - "Grid does NOT update live while typing — only on Enter or suggestion click"
    - "X button clears search text but preserves active filter chips"
    - "Header and search bar are sticky at the top on mobile"
  artifacts:
    - path: "app/routers/suggest.py"
      provides: "Multi-field FTS5 suggestions (job_title + company)"
      contains: "company"
    - path: "frontend/src/hooks/useHeaderSearch.ts"
      provides: "Suggestions state, debounced fetch, keyboard nav, non-live search"
      contains: "fetchSuggestions"
    - path: "frontend/src/components/Header.tsx"
      provides: "Autocomplete dropdown UI, X clear button"
      contains: "listbox"
  key_links:
    - from: "frontend/src/hooks/useHeaderSearch.ts"
      to: "/api/suggest"
      via: "debounced fetch in fetchSuggestions"
      pattern: "api/suggest"
    - from: "frontend/src/components/Header.tsx"
      to: "frontend/src/hooks/useHeaderSearch.ts"
      via: "useHeaderSearch hook returns suggestions + handlers"
      pattern: "useHeaderSearch"
---

<objective>
Add search autocomplete with a debounced suggestion dropdown to the Explorer search bar, and change search behavior so the expert grid only updates on Enter or suggestion click (not live while typing).

Purpose: Better search UX — users see relevant suggestions as they type, but the grid only refreshes when they commit a search (reducing noise and API calls).
Output: Expanded suggest endpoint, modified useHeaderSearch hook, dropdown UI in Header, X clear button.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-CONTEXT.md
@.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-RESEARCH.md
@app/routers/suggest.py
@frontend/src/hooks/useHeaderSearch.ts
@frontend/src/components/Header.tsx
@frontend/src/constants/tags.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand suggest endpoint to include company field</name>
  <files>app/routers/suggest.py</files>
  <action>
Modify `_run_suggest` in `app/routers/suggest.py` to query both `job_title` and `company` columns from FTS5, then deduplicate results.

Specifically:
1. Rename `_run_suggest` to `_run_suggest_multi` (or update in-place).
2. For each column in `('job_title', 'company')`, run a `SELECT DISTINCT {column} FROM experts_fts WHERE experts_fts MATCH :q ORDER BY rank LIMIT 3` query. Use the existing `_safe_prefix_query` helper.
3. Concatenate results from both columns into a single list.
4. Deduplicate preserving order, limit to 5 total results.
5. Update the endpoint docstring to reflect multi-field suggestions.
6. Keep the endpoint signature unchanged: `GET /api/suggest?q=...` returning `list[str]`.
7. Keep error handling: FTS5 MATCH exceptions return empty list per column (continue to next column).

Do NOT add tags to the backend query — tags are JSON arrays in FTS5 and return the full JSON blob, not individual tag strings. Tag suggestions will be handled client-side via TOP_TAGS matching.

Do NOT change the response model (still `list[str]`). The frontend will merge backend suggestions with client-side tag matches.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.suggest import _safe_prefix_query; print(_safe_prefix_query('mark'))" && echo "Import OK"</automated>
    <manual>curl "http://localhost:8000/api/suggest?q=mark" should return suggestions from both job_title and company fields</manual>
  </verify>
  <done>GET /api/suggest returns suggestions from both job_title and company FTS5 columns, deduplicated, max 5 results</done>
</task>

<task type="auto">
  <name>Task 2: Add autocomplete dropdown, non-live search, and X clear button to Header</name>
  <files>frontend/src/hooks/useHeaderSearch.ts, frontend/src/components/Header.tsx</files>
  <action>
**useHeaderSearch.ts — major behavioral change:**

1. Add state: `suggestions: string[]`, `showDropdown: boolean`, `selectedIndex: number` (for keyboard nav, -1 = none selected).
2. Add a `suggestTimerRef` (separate from existing `timerRef`).
3. **CRITICAL behavioral change:** In `handleChange`, REMOVE the debounced `setQuery` call. The debounce timer should ONLY trigger `fetchSuggestions`. `setQuery` must NOT be called on input change — grid updates only on Enter or suggestion selection. Keep the easter egg check.
4. After removing the debounced `setQuery`, the `timerRef` is no longer needed for query debounce. Repurpose it or use a new `suggestTimerRef` for the suggestion debounce (~300ms).
5. Add `fetchSuggestions(value: string)` function:
   - If value.trim().length < 2, clear suggestions and hide dropdown, return.
   - Compute local tag matches: `TOP_TAGS.filter(t => t.includes(value.toLowerCase())).slice(0, 3)`.
   - Fetch from backend: `GET ${API_BASE}/api/suggest?q=${encodeURIComponent(value)}`.
   - Merge: backend suggestions first, then tag matches, deduplicate via Set, limit to 5.
   - Set `suggestions` and `showDropdown = merged.length > 0`.
   - On fetch error, fall back to local tag matches only.
   - Import `TOP_TAGS` from `../constants/tags` and `API_BASE` as `import.meta.env.VITE_API_URL ?? ''`.
6. Modify `handleKeyDown`:
   - `Enter`: clear suggestions, hide dropdown, reset selectedIndex, call `setQuery(localValue)` (this is the ONLY path where Enter triggers grid update). If selectedIndex >= 0, select that suggestion instead.
   - `Escape`: hide dropdown, reset selectedIndex.
   - `ArrowDown`: increment selectedIndex (wrap at suggestions.length - 1).
   - `ArrowUp`: decrement selectedIndex (min -1).
7. Add `handleSelectSuggestion(suggestion: string)`: set localValue to suggestion, clear suggestions, hide dropdown, call `setQuery(suggestion)`.
8. Add `handleClear()`: set localValue to '', clear suggestions, hide dropdown, call `setQuery('')`. This clears search but preserves filter chips (tags, rate stay in store).
9. Add `handleBlur()`: use `setTimeout(() => setShowDropdown(false), 150)` — the 150ms delay allows `onMouseDown` on suggestion items to fire before the dropdown unmounts (critical blur/click ordering fix from RESEARCH.md Pitfall 1).
10. Return all new values: `suggestions`, `showDropdown`, `selectedIndex`, `handleSelectSuggestion`, `handleClear`, `handleBlur`.

**Header.tsx — dropdown UI + X clear button:**

1. Import `X` from lucide-react (already imported Search).
2. Import `AnimatePresence` (already imported from motion/react).
3. Destructure new values from `useHeaderSearch`: `suggestions`, `showDropdown`, `selectedIndex`, `handleSelectSuggestion`, `handleClear`, `handleBlur`.
4. Add `onBlur={handleBlur}` to the input element (alongside existing `onFocus`/`onBlur`). Update the existing onBlur to call both `setIsFocused(false)` and `handleBlur()`.
5. Make the search bar container `relative` (it already is via the motion.div wrapper) so the dropdown positions absolutely below it.
6. Add X clear button: inside the search bar div, after the input, conditionally render a button with `<X size={14} />` when `localValue` is non-empty. Position it `absolute right-3 top-1/2 -translate-y-1/2`. Add padding-right to input (`pr-8` instead of `pr-4`) to avoid text overlapping the X button.
7. Add dropdown below the search bar motion.div wrapper: use `AnimatePresence` + `motion.ul` with `role="listbox"`. Position: `absolute top-full left-0 right-0 mt-1 z-50`. Style: `bg-white rounded-xl border border-slate-200 shadow-lg overflow-hidden`.
8. Each suggestion: `<li>` with `role="option"`, `aria-selected={i === selectedIndex}`. Use `onMouseDown` (NOT onClick) with `e.preventDefault()` to prevent input blur, then call `handleSelectSuggestion(suggestion)`. Highlight selected index with `bg-purple-50 text-brand-purple`.
9. Dropdown animation: `initial={{ opacity: 0, y: -4 }}`, `animate={{ opacity: 1, y: 0 }}`, `exit={{ opacity: 0 }}`, transition 0.15s.
10. The header is already `sticky top-0 z-50` — this satisfies the MOBILE-02 requirement (sticky header on mobile). Verify no changes needed.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit</automated>
    <manual>Open localhost:5173. Type in search bar — suggestions appear after ~300ms. Grid does NOT update while typing. Press Enter — grid updates. Click a suggestion — grid updates. Press X — search clears but filter chips remain.</manual>
  </verify>
  <done>Search bar shows autocomplete dropdown with up to 5 suggestions (job titles, companies, tags). Grid updates only on Enter or suggestion click. X button clears search. Keyboard navigation (arrow keys + Enter/Escape) works. Header stays sticky on mobile.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. Type "mark" in search bar — dropdown appears with suggestions from job titles, companies, and matching tags
3. Arrow keys navigate suggestions, Enter selects highlighted suggestion
4. Clicking a suggestion fills the search bar and triggers grid update
5. Typing without pressing Enter does NOT update the grid
6. X button clears search text, grid returns to unfiltered state, but filter chips (tags, rate) remain active
7. Header is sticky at top when scrolling on mobile viewport
</verification>

<success_criteria>
- Autocomplete dropdown appears with max 5 suggestions after typing 2+ characters
- Grid only updates on Enter key or suggestion click, never live while typing
- X clear button visible when text is entered, clears search on click
- Keyboard navigation (ArrowUp, ArrowDown, Enter, Escape) works on dropdown
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/40.3.1-search-improvements-on-the-search-and-mobile-improvements/40.3.1-01-SUMMARY.md`
</output>
