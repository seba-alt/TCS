---
phase: 40.1-optimization-and-debugging-of-v3
plan: 02
type: execute
wave: 2
depends_on: ["40.1-01"]
files_modified:
  - frontend/src/components/browse/BrowseCard.tsx
  - frontend/src/components/browse/BrowseRow.tsx
  - frontend/src/pages/BrowsePage.tsx
  - frontend/src/hooks/useBrowse.ts
  - frontend/src/store/navigationSlice.ts
  - frontend/src/store/index.ts
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/src/components/Header.tsx
  - frontend/src/index.css
autonomous: true
requirements:
  - BROWSE-01
  - BROWSE-02
  - BROWSE-04
  - NAV-02

must_haves:
  truths:
    - "Browse page rows appear together in a single visual batch — no staggered painting visible"
    - "Navigating Browse -> Explorer -> Browse shows cached data instantly (no loading skeleton on return)"
    - "Browse page and Explorer page feel like the same app — consistent brand purple usage, coherent spacing, shared aurora background"
    - "BrowseRow text ('See All', row titles) uses brand-appropriate colors with adequate contrast on the aurora background"
    - "Card content spacing (name, rate, tags) inside BrowseCard feels balanced and not cramped"
  artifacts:
    - path: "frontend/src/components/browse/BrowseCard.tsx"
      provides: "React.memo wrapped card for render performance"
      contains: "React.memo"
    - path: "frontend/src/hooks/useBrowse.ts"
      provides: "Browse data with Zustand TTL cache"
      contains: "browseData"
    - path: "frontend/src/store/navigationSlice.ts"
      provides: "browseData cache field in NavigationSlice"
      contains: "browseData"
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Explorer page with brand-consistent rate and label colors"
      contains: "text-brand-purple"
  key_links:
    - from: "frontend/src/hooks/useBrowse.ts"
      to: "frontend/src/store/navigationSlice.ts"
      via: "Zustand store browseData field"
      pattern: "browseData"
    - from: "frontend/src/components/browse/BrowseCard.tsx"
      to: "React.memo"
      via: "memoized component export"
      pattern: "React\\.memo"
    - from: "frontend/src/components/browse/BrowseRow.tsx"
      to: "frontend/src/pages/BrowsePage.tsx"
      via: "row title color consistency"
      pattern: "text-gray-800"
---

<objective>
Optimize Browse page render performance (eliminate staggered row painting), add browse data caching for instant back-navigation, and perform a visual consistency pass across Browse and Explorer pages to align with brand guidelines.

Purpose: After Plan 01 fixes the broken card/banner, this plan makes the Browse page feel fast and polished — rows appear as a unit, back-navigation is instant, and both pages share a coherent visual identity rooted in the Tinrate brand (#5128F2 accent, black primary, white secondary, Helvetica Neue feel).

Output: Optimized BrowseCard (memoized), cached browse data in Zustand, and visual consistency across Browse + Explorer pages.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40.1-optimization-and-debugging-of-v3/40.1-RESEARCH.md
@.planning/phases/40.1-optimization-and-debugging-of-v3/40.1-01-SUMMARY.md

@frontend/src/components/browse/BrowseCard.tsx
@frontend/src/components/browse/BrowseRow.tsx
@frontend/src/pages/BrowsePage.tsx
@frontend/src/hooks/useBrowse.ts
@frontend/src/store/navigationSlice.ts
@frontend/src/store/index.ts
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/components/Header.tsx
@frontend/src/index.css
@frontend/tailwind.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize Browse render performance and add data caching</name>
  <files>
    frontend/src/components/browse/BrowseCard.tsx
    frontend/src/hooks/useBrowse.ts
    frontend/src/store/navigationSlice.ts
    frontend/src/store/index.ts
  </files>
  <action>
Two performance improvements:

**1. React.memo on BrowseCard to prevent staggered re-renders:**

Wrap the BrowseCard component export with `React.memo`. The staggered row appearance comes from 40+ motion.div spring calculations firing simultaneously as React commits DOM for all rows. Memoizing prevents unnecessary re-renders as sibling rows mount.

```tsx
import { useState, memo } from 'react'

// Rename the existing function to BrowseCardInner (or keep name, wrap at export)
function BrowseCardInner({ expert }: BrowseCardProps) {
  // ... existing implementation
}

export const BrowseCard = memo(BrowseCardInner)
```

Also reduce initial animation overhead: add `layout={false}` to the motion.div if present, or ensure `whileHover` uses `transition={{ duration: 0.15 }}` instead of spring for hover to reduce computation.

**2. Browse data Zustand cache with TTL (Claude's discretion — research recommended):**

Add `browseData` field to NavigationSlice:

In `frontend/src/store/navigationSlice.ts`:
- Import `BrowseData` type from `../../hooks/useBrowse` (or re-declare the interface to avoid circular deps — prefer re-declaring a minimal `CachedBrowseData` interface)
- Add to NavigationSlice interface:
  ```ts
  browseData: { data: BrowseData; cachedAt: number } | null
  setBrowseData: (data: BrowseData) => void
  ```
- Add to createNavigationSlice:
  ```ts
  browseData: null,
  setBrowseData: (data) => set({ browseData: { data, cachedAt: Date.now() } }),
  ```
- This is NOT persisted (navigationSlice is already excluded from partialize in store/index.ts)

In `frontend/src/store/index.ts`:
- No changes needed to partialize — navigationSlice fields are already excluded
- But ensure the `browseData` and `setBrowseData` are accessible through `useExplorerStore`

In `frontend/src/hooks/useBrowse.ts`:
- Import `useExplorerStore` from the store
- On mount, check if `browseData` is fresh (cachedAt < 5 minutes ago)
- If fresh: use cached data, set loading=false immediately, skip fetch
- If stale or null: fetch as before, then call `setBrowseData(data)` on success
- The 5-minute TTL means data refreshes if user stays on the site long enough, but Browse->Explorer->Browse within a session is instant

```tsx
export function useBrowse() {
  const cached = useExplorerStore((s) => s.browseData)
  const setCached = useExplorerStore((s) => s.setBrowseData)

  const isFresh = cached && (Date.now() - cached.cachedAt < 5 * 60 * 1000)

  const [data, setData] = useState<BrowseData | null>(isFresh ? cached.data : null)
  const [loading, setLoading] = useState(!isFresh)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (isFresh) return // use cached data

    const controller = new AbortController()
    fetch(`${API_BASE}/api/browse?per_row=10`, { signal: controller.signal })
      .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json() })
      .then((d: BrowseData) => {
        setData(d)
        setCached(d)
        setLoading(false)
      })
      .catch((err: Error) => {
        if (err.name === 'AbortError') return
        setError(err.message ?? 'Fetch failed')
        setLoading(false)
      })
    return () => controller.abort()
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  return { data, loading, error }
}
```

IMPORTANT: `isFresh` must be computed once at render time (not inside useEffect) so `useState` initializers get the right value. The `useEffect` dependency array stays empty — we only fetch on mount.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Open localhost:5173, navigate Browse -> Explorer -> Browse. Second Browse visit should show data instantly (no skeleton). Check React DevTools for memo'd BrowseCard.</manual>
  </verify>
  <done>BrowseCard is memo'd (React.memo). Browse data is cached in Zustand with 5-min TTL. Back-navigation to Browse shows cached data instantly. Staggered row painting is reduced.</done>
</task>

<task type="auto">
  <name>Task 2: Visual consistency pass across Browse and Explorer pages</name>
  <files>
    frontend/src/components/browse/BrowseCard.tsx
    frontend/src/components/browse/BrowseRow.tsx
    frontend/src/pages/BrowsePage.tsx
    frontend/src/pages/MarketplacePage.tsx
    frontend/src/components/Header.tsx
    frontend/src/index.css
  </files>
  <action>
Per locked decisions: "General spacing/alignment pass across Browse page" + "Both Browse AND Explorer should feel like the same app" + "Brand assets in frontend/ folder — align to these" + "Color scheme adjustment for clarity."

Brand guidelines from PDF: Primary #000000, Secondary #FFFFFF, Accent #5128F2. Font: Helvetica Neue Bold (headings) / Regular (body). The current app uses system-ui sans-serif which is close enough (Helvetica Neue is a system font on macOS). No custom font import needed.

**BrowseRow.tsx visual fixes:**
- Row title `text-white` is wrong on the light aurora background — change to `text-gray-900` (brand primary black) for readability
- "See All" button: change `text-purple-300` to `text-brand-purple` for brand consistency and better contrast on light aurora
- "See All" hover: change `hover:text-white` to `hover:text-brand-purple/70` (subtle hover on light bg, not white)
- SeeAllEndCard: change `bg-white/5 border-white/10` to `bg-white/60 border-gray-200/60` — the card should be a light glass card on the aurora background, not a dark-themed card
- SeeAllEndCard text: `text-white` -> `text-gray-800` for "See All", `text-gray-400` stays for count, `text-purple-300` -> `text-brand-purple` for chevron
- Left/right fade edges in BrowseRow: These use `var(--aurora-bg)` which is correct for the aurora background

**BrowseCard.tsx spacing fixes (in addition to Plan 01 changes):**
- The bottom overlay padding was changed to `p-3` in Plan 01 — verify this feels balanced
- Add `leading-tight` to the name `<p>` for tighter line height
- Add small `mb-0.5` between name and rate for visual separation

**BrowsePage.tsx spacing fixes:**
- The `pt-8 md:pt-12` top padding is tight — increase to `pt-10 md:pt-14` for more breathing room below where a header would be
- The `gap-12 md:gap-16` between rows is generous and correct — keep as-is
- `pb-16` bottom padding is correct — keep

**Explorer page (MarketplacePage.tsx) — no structural changes, just color alignment:**
- Verify ExpertCard uses `text-brand-purple` for rates — check the ExpertCard component (it likely already does based on research)
- No layout changes to MarketplacePage — the flex-1 min-h-0 chain MUST be preserved (Pitfall 5 from research)

**Header.tsx — minor brand alignment:**
- The header already uses `bg-white/70` backdrop-blur which is on-brand (glass effect)
- Verify logo `src="/logo.png"` works — the logo.png in public/ should be the Tinrate logo with purple star icon
- No changes needed if logo renders correctly

**index.css — verify aurora tokens are brand-aligned:**
- `--aurora-bg: oklch(98% 0.008 279)` — near-white lavender, consistent with brand secondary (#FFFFFF)
- `--aurora-purple: oklch(88% 0.070 279 / 0.55)` — light purple derived from brand accent
- These are already correct — no changes needed

**CRITICAL: Do NOT change the ExpertGrid or ExpertCard layout.** The VirtuosoGrid in ExpertGrid requires exact height chain. Only change text colors if needed for brand consistency. Do NOT add backdrop-filter to anything inside overflow:hidden (Pitfall 6).
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Open localhost:5173 (Browse) and localhost:5173/explore (Explorer). Verify: (1) Browse row titles are dark text on light aurora, (2) "See All" buttons use brand purple, (3) SeeAllEndCards are light glass cards, (4) Overall Browse page feels spacious and balanced, (5) Explorer page looks consistent with Browse (same aurora bg, same brand purple accents)</manual>
  </verify>
  <done>Browse page row titles, buttons, and cards use brand-appropriate colors on the light aurora background. SeeAllEndCards are light glass cards matching the aurora theme. Spacing is balanced across the Browse page. Both Browse and Explorer use consistent brand purple (#5128F2) for accents. The two pages feel like the same app.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Browse page rows appear as a visual unit — no staggered painting on initial load
3. Browse -> Explorer -> Browse navigation shows cached data instantly (no loading skeleton)
4. BrowseRow titles are readable dark text on light aurora background
5. "See All" buttons and SeeAllEndCards use brand-consistent colors
6. BrowseCard spacing (name, rate, tags) feels balanced and not cramped
7. Explorer page maintains identical aurora background and brand purple usage
8. VirtuosoGrid in Explorer still functions correctly (infinite scroll works)
</verification>

<success_criteria>
- Browse page renders smoothly without staggered row painting
- Back-navigation to Browse is instant (cached data)
- Visual consistency between Browse and Explorer — both feel like the same branded app
- All text is readable with adequate contrast on light aurora background
- No regressions in Explorer layout or infinite scroll
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/40.1-optimization-and-debugging-of-v3/40.1-02-SUMMARY.md`
</output>
