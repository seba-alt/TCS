---
phase: 47-public-explorer-polish
plan: 03
type: execute
wave: 2
depends_on:
  - 47-02
files_modified:
  - frontend/src/layouts/RootLayout.tsx
  - frontend/src/components/marketplace/ExpertCard.tsx
  - frontend/src/components/marketplace/ExpertGrid.tsx
  - frontend/src/store/resultsSlice.ts
  - frontend/src/store/index.ts
  - frontend/src/hooks/useExplore.ts
autonomous: true
requirements:
  - EXP-04
  - EXP-05
  - EXP-06

must_haves:
  truths:
    - "On desktop, the Sage panel renders exactly once (no overlapping desktop and mobile instances)"
    - "On mobile, tapping an expert card expands it inline; on desktop, the same click opens the profile directly"
    - "Only one card is expanded at a time on mobile"
    - "Tapping outside an expanded card collapses it back to normal"
    - "When the API fails, the explorer grid shows 'Oops, something went wrong' with a Retry button"
    - "Network errors show 'Check your connection' message"
    - "Clicking Retry re-triggers the API fetch"
  artifacts:
    - path: "frontend/src/layouts/RootLayout.tsx"
      provides: "Conditional SageMobileSheet render using JS media query"
      contains: "useMediaQuery"
    - path: "frontend/src/components/marketplace/ExpertCard.tsx"
      provides: "Desktop bypass for tap-to-expand behavior"
      contains: "window.innerWidth >= 768"
    - path: "frontend/src/components/marketplace/ExpertGrid.tsx"
      provides: "Error state UI with retry button"
      contains: "Oops, something went wrong"
    - path: "frontend/src/store/resultsSlice.ts"
      provides: "retryTrigger counter and retry action"
      contains: "retryTrigger"
    - path: "frontend/src/hooks/useExplore.ts"
      provides: "retryTrigger in useEffect dep array"
      contains: "retryTrigger"
  key_links:
    - from: "frontend/src/components/marketplace/ExpertGrid.tsx"
      to: "frontend/src/store/resultsSlice.ts"
      via: "reads error state + calls retry action"
      pattern: "retry.*retryTrigger"
    - from: "frontend/src/hooks/useExplore.ts"
      to: "frontend/src/store/resultsSlice.ts"
      via: "retryTrigger in dep array triggers re-fetch"
      pattern: "retryTrigger.*useEffect"
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "window.matchMedia"
      via: "useMediaQuery hook conditionally renders SageMobileSheet"
      pattern: "isMobile.*SageMobileSheet"
    - from: "frontend/src/components/marketplace/ExpertGrid.tsx"
      to: "frontend/src/components/marketplace/ExpertCard.tsx"
      via: "expandedExpertId passed as isExpanded prop"
      pattern: "expandedExpertId.*isExpanded"
---

<objective>
Fix three behavioral issues in the public Explorer: (1) Sage panel double-render on desktop, (2) desktop users experiencing mobile tap-to-expand behavior, (3) blank grid on API failures.

Purpose: Desktop users see two Sage panels simultaneously due to Vaul portal leaking from CSS-hidden mobile wrapper. Desktop card clicks require two taps unnecessarily. API failures leave users staring at an empty grid with no recovery path.

Output: Surgical fixes to 6 existing files — useMediaQuery hook for Sage, viewport check in card click handler, error state UI with retry mechanism.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-public-explorer-polish/47-02-SUMMARY.md
@frontend/src/layouts/RootLayout.tsx
@frontend/src/components/marketplace/ExpertCard.tsx
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/store/resultsSlice.ts
@frontend/src/store/index.ts
@frontend/src/hooks/useExplore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Sage double-render and desktop card click behavior</name>
  <files>frontend/src/layouts/RootLayout.tsx, frontend/src/components/marketplace/ExpertCard.tsx, frontend/src/components/marketplace/ExpertGrid.tsx</files>
  <action>
**RootLayout.tsx — conditional render SageMobileSheet (EXP-04):**

1. Add a `useMediaQuery` hook at the top of the file (or just above the component):
```tsx
import { useState, useEffect } from 'react'

function useMediaQuery(query: string): boolean {
  const [matches, setMatches] = useState(() => window.matchMedia(query).matches)
  useEffect(() => {
    const mq = window.matchMedia(query)
    const handler = (e: MediaQueryListEvent) => setMatches(e.matches)
    mq.addEventListener('change', handler)
    return () => mq.removeEventListener('change', handler)
  }, [query])
  return matches
}
```

2. Inside `RootLayout`, add: `const isMobile = useMediaQuery('(max-width: 767px)')`

3. Replace the CSS-hidden mobile wrapper:
```tsx
// REMOVE:
<div className="md:hidden">
  <SageMobileSheet open={isOpen} onClose={() => setOpen(false)} />
</div>

// REPLACE WITH:
{isMobile && (
  <SageMobileSheet open={isOpen} onClose={() => setOpen(false)} />
)}
```

This prevents Vaul's `Drawer.Portal` from mounting on `document.body` when the viewport is desktop-sized. The CSS class `md:hidden` only hides the wrapper visually — the portal appends to body regardless.

**ExpertCard.tsx — desktop bypass for tap-to-expand (EXP-05):**

1. Change the component interface to accept parent-controlled expanded state:
   - Add `isExpanded: boolean` and `onExpand: (username: string) => void` to `ExpertCardProps`.
   - Remove the local `const [expanded, setExpanded] = useState(false)`.
   - Use `isExpanded` prop instead of `expanded` local state throughout the component.

2. Update `handleCardClick` to check viewport width:
```tsx
function handleCardClick() {
  // Desktop: skip expand, open profile directly
  if (window.innerWidth >= 768) {
    const storeState = useExplorerStore.getState()
    void trackEvent('card_click', {
      expert_id: expert.username,
      context,
      rank,
      active_filters: {
        query: storeState.query,
        rate_min: storeState.rateMin,
        rate_max: storeState.rateMax,
        tags: storeState.tags,
      },
    })
    onViewProfile(expert.profile_url)
    return
  }
  // Mobile: two-tap expand behavior
  if (!isExpanded) {
    onExpand(expert.username)
  } else {
    const storeState = useExplorerStore.getState()
    void trackEvent('card_click', {
      expert_id: expert.username,
      context,
      rank,
      active_filters: {
        query: storeState.query,
        rate_min: storeState.rateMin,
        rate_max: storeState.rateMax,
        tags: storeState.tags,
      },
    })
    onViewProfile(expert.profile_url)
  }
}
```

3. Replace `onBlur={() => setExpanded(false)}` with `onBlur={() => onExpand('')}` (passing empty string collapses all cards since no card matches empty string).

4. Replace all `expanded` references in the JSX with `isExpanded`.

**ExpertGrid.tsx — lift expanded state to parent (EXP-05):**

1. Add `useState<string | null>(null)` for `expandedExpertId` at the top of the ExpertGrid component.

2. Create a handler:
```tsx
function handleExpand(username: string) {
  setExpandedExpertId(username || null)
}
```

3. Update the ExpertCard render in `itemContent` to pass the new props:
```tsx
<ExpertCard
  expert={expert}
  onViewProfile={onViewProfile}
  rank={index}
  isExpanded={expandedExpertId === expert.username}
  onExpand={handleExpand}
/>
```

This ensures only one card is expanded at a time — setting `expandedExpertId` to a new username automatically collapses the previous one.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx vite build --mode production 2>&1 | tail -5</automated>
    <manual>On desktop: (1) Open Sage panel — only one panel visible, no bottom sheet. (2) Click an expert card — profile opens directly (no expand step). On mobile: (1) Tap card — expands inline. (2) Tap again — opens profile. (3) Tap outside — collapses.</manual>
  </verify>
  <done>SageMobileSheet only mounts when viewport < 768px (JS conditional, not CSS). Desktop card clicks bypass expand and open profile directly. Only one card expanded at a time on mobile via parent-controlled state in ExpertGrid.</done>
</task>

<task type="auto">
  <name>Task 2: Add error state with retry to Explorer grid</name>
  <files>frontend/src/store/resultsSlice.ts, frontend/src/store/index.ts, frontend/src/hooks/useExplore.ts, frontend/src/components/marketplace/ExpertGrid.tsx</files>
  <action>
**resultsSlice.ts — add retryTrigger counter and retry action:**

1. Add to `ResultsSlice` interface:
```ts
retryTrigger: number
retry: () => void
```

2. Add to the `createResultsSlice` return:
```ts
retryTrigger: 0,
retry: () => set((s) => ({ error: null, retryTrigger: s.retryTrigger + 1 })),
```

The `retry()` action clears the error AND increments the counter, which will trigger the useExplore useEffect to re-fetch.

**store/index.ts — expose retry in useResultsSlice:**

Add `retryTrigger: state.retryTrigger` and `retry: state.retry` to the `useResultsSlice` useShallow selector.

Note: Plan 47-02 already modified store/index.ts to add viewMode to partialize. This plan's changes are in a different section (useResultsSlice hook, not partialize). Read the current file state before editing.

**useExplore.ts — add retryTrigger to dep array:**

1. Add a new selector at the top of useExplore:
```ts
const retryTrigger = useExplorerStore((s) => s.retryTrigger)
```

2. Add `retryTrigger` to the useEffect dependency array (line 88):
```ts
}, [query, rateMin, rateMax, tags, sortBy, sageMode, retryTrigger, setLoading, setResults, setError, resetResults])
```

This ensures that when `retry()` increments `retryTrigger`, the useEffect re-runs and fetches fresh data.

**ExpertGrid.tsx — render error state with retry button (EXP-06):**

1. Import `AlertCircle`, `RefreshCw`, `WifiOff` from `lucide-react`.
2. Read `error` and `retry` from the store:
```tsx
const error = useExplorerStore((s) => s.error)
const retry = useExplorerStore((s) => s.retry)
```

3. Add an error state check AFTER the loading skeleton check and BEFORE the empty state check:
```tsx
// API error: show friendly message with retry
if (error && experts.length === 0) {
  const isNetworkError = error.toLowerCase().includes('failed to fetch')
    || error.toLowerCase().includes('networkerror')
    || error.toLowerCase().includes('network')
  return (
    <div className="flex flex-col items-center justify-center py-20 gap-4 text-center px-6">
      {isNetworkError ? (
        <WifiOff size={40} className="text-gray-300" />
      ) : (
        <AlertCircle size={40} className="text-gray-300" />
      )}
      <div>
        <p className="text-gray-600 font-medium">
          Oops, something went wrong. Let's try that again.
        </p>
        {isNetworkError && (
          <p className="text-sm text-gray-400 mt-1">Check your connection and retry.</p>
        )}
      </div>
      <button
        onClick={retry}
        className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-brand-purple text-white text-sm font-medium hover:bg-brand-purple/90 transition-colors"
      >
        <RefreshCw size={14} />
        Try again
      </button>
    </div>
  )
}
```

The error tone matches the locked decision: "Oops, something went wrong. Let's try that again." Network errors additionally show "Check your connection and retry." with a WifiOff icon.

Retry UX (Claude's discretion): Inline loading — clicking "Try again" calls `retry()` which clears error + increments retryTrigger. The existing `loading` state kicks in and shows the skeleton grid during the re-fetch. No full page reload needed.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx vite build --mode production 2>&1 | tail -5</automated>
    <manual>Simulate API failure (disconnect network or stop backend). Explorer should show "Oops, something went wrong" message with Retry button. Clicking Retry should attempt to re-fetch.</manual>
  </verify>
  <done>resultsSlice has retryTrigger + retry action. useExplore dep array includes retryTrigger. ExpertGrid shows friendly error message with Retry button when error is set. Network errors show "Check your connection" variant. Retry button clears error and triggers re-fetch.</done>
</task>

</tasks>

<verification>
1. `grep -n "useMediaQuery" frontend/src/layouts/RootLayout.tsx` confirms JS-based conditional render
2. `grep -n "isMobile" frontend/src/layouts/RootLayout.tsx` confirms SageMobileSheet is conditionally rendered
3. `grep -n "window.innerWidth" frontend/src/components/marketplace/ExpertCard.tsx` confirms desktop bypass
4. `grep -n "isExpanded" frontend/src/components/marketplace/ExpertCard.tsx` confirms prop-driven expanded state
5. `grep -n "expandedExpertId" frontend/src/components/marketplace/ExpertGrid.tsx` confirms parent state lift
6. `grep -n "retryTrigger" frontend/src/store/resultsSlice.ts` confirms counter field and retry action
7. `grep -n "retryTrigger" frontend/src/hooks/useExplore.ts` confirms dep array inclusion
8. `grep -n "Oops" frontend/src/components/marketplace/ExpertGrid.tsx` confirms error message text
9. Vite production build succeeds without errors
</verification>

<success_criteria>
- SageMobileSheet mounts only when viewport < 768px (useMediaQuery, not CSS)
- Desktop card clicks open profile directly (no expand step)
- Mobile card clicks use two-tap expand flow
- Only one card expanded at a time (parent-controlled state)
- Error state shows "Oops, something went wrong" with Retry button
- Network errors show additional "Check your connection" message with WifiOff icon
- Retry button clears error and triggers re-fetch via retryTrigger counter
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/47-public-explorer-polish/47-03-SUMMARY.md`
</output>
