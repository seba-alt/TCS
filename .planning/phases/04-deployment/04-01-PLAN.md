---
phase: 04-deployment
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitignore
  - app/config.py
  - app/main.py
  - requirements.txt
  - railway.json
autonomous: true
requirements:
  - DEPL-01

must_haves:
  truths:
    - "FAISS index, metadata.json, and experts.csv are tracked by git (not gitignored)"
    - "SQLite database path points to /app/var in production, falls back to data/ locally"
    - "railway.json declares health check at /api/health with 300s timeout"
    - "Sentry SDK initializes on backend startup when SENTRY_DSN env var is set"
    - "Sentry silently skips initialization in local dev when SENTRY_DSN is absent"
  artifacts:
    - path: "railway.json"
      provides: "Railway health check and start command config-as-code"
      contains: "healthcheckPath"
    - path: "app/config.py"
      provides: "VAR_DIR-based DATABASE_URL for Railway Volume-backed SQLite"
      contains: "VAR_DIR"
    - path: "app/main.py"
      provides: "Sentry SDK init guarded by SENTRY_DSN env var"
      contains: "sentry_sdk.init"
    - path: ".gitignore"
      provides: "Data files unignored so Railway can clone them"
  key_links:
    - from: "app/config.py"
      to: "Railway Volume /app/var"
      via: "VAR_DIR env var read by os.getenv"
      pattern: "VAR_DIR"
    - from: "railway.json"
      to: "/api/health"
      via: "healthcheckPath field"
      pattern: "healthcheckPath.*api/health"
    - from: "app/main.py"
      to: "sentry_sdk"
      via: "conditional init on SENTRY_DSN"
      pattern: "if dsn.*sentry_sdk.init"
---

<objective>
Prepare the backend codebase for Railway production deployment: commit data files to git, route SQLite to a Railway Volume path, add railway.json health check config, and instrument the FastAPI backend with Sentry.

Purpose: All code changes required for Railway to successfully host the backend must be committed before the platform is connected to the repo. Getting this wrong means failed deploys that are harder to debug after the GitHub connection is live.

Output: railway.json (new), updated .gitignore, app/config.py, app/main.py, requirements.txt — all committed and ready for Railway to clone.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-RESEARCH.md
@app/main.py
@app/config.py
@.gitignore
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unignore data files and update DATABASE_URL for Railway Volume</name>
  <files>.gitignore, app/config.py</files>
  <action>
    In `.gitignore`, remove the three lines that gitignore the data files Railway needs:
    ```
    data/faiss.index
    data/metadata.json
    data/*.csv
    ```
    Keep `data/conversations.db` gitignored — it lives on the Railway Volume in production and should never be committed.

    In `app/config.py`, replace the DATABASE_URL line with a VAR_DIR-aware version:
    ```python
    import os

    # SQLite on persistent Railway Volume (mounted at /app/var in production).
    # Falls back to DATA_DIR for local development — no env var change needed locally.
    _VAR_DIR = Path(os.getenv("VAR_DIR", str(DATA_DIR)))
    DATABASE_URL = f"sqlite:///{_VAR_DIR / 'conversations.db'}"
    ```
    Place `import os` near the top of config.py (after `from pathlib import Path`). The `_VAR_DIR` and `DATABASE_URL` lines replace the existing single-line `DATABASE_URL = ...` line.

    CRITICAL: Do NOT mount the Volume at `/app/data` — that would shadow the committed FAISS index and metadata.json files. Railway Volume goes at `/app/var` (set via `VAR_DIR=/app/var` env var on Railway dashboard).
  </action>
  <verify>
    Run: `git status` — confirms data/faiss.index, data/metadata.json, and data/experts.csv appear as untracked (no longer gitignored).
    Run: `python -c "from app.config import DATABASE_URL; print(DATABASE_URL)"` from repo root — should print path ending in `data/conversations.db` (local fallback when VAR_DIR not set).
  </verify>
  <done>
    `git status` shows data files as untracked/new. `python -c "from app.config import DATABASE_URL; print(DATABASE_URL)"` succeeds without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create railway.json and add Sentry to backend</name>
  <files>railway.json, app/main.py, requirements.txt</files>
  <action>
    Create `railway.json` at the repo root:
    ```json
    {
      "$schema": "https://railway.com/railway.schema.json",
      "deploy": {
        "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
        "healthcheckPath": "/api/health",
        "healthcheckTimeout": 300
      }
    }
    ```
    The 300-second timeout gives the FAISS lifespan startup time to complete before Railway routes traffic to the new deploy. This matches the Railway default and is confirmed safe for the ~2-second FAISS load time.

    In `requirements.txt`, add `sentry-sdk` on its own line (no version pin — latest stable is fine; Sentry SDK is stable and backwards-compatible).

    In `app/main.py`, add Sentry initialization after the existing imports block and before `app = FastAPI()`:
    ```python
    import sentry_sdk

    if dsn := os.getenv("SENTRY_DSN"):
        sentry_sdk.init(
            dsn=dsn,
            traces_sample_rate=0.1,
            environment="production",
        )
    ```
    The `if dsn :=` walrus-operator guard means Sentry is silently skipped in local dev when `SENTRY_DSN` is not in `.env`. No changes to local `.env` or `.env.example` are needed — the guard handles this.

    Add `import os` to `app/main.py` if it is not already imported (check the existing import block).
  </action>
  <verify>
    Run: `python -c "import json, pathlib; json.loads(pathlib.Path('railway.json').read_text()); print('railway.json valid JSON')"` from repo root.
    Run: `pip install sentry-sdk --dry-run 2>&1 | head -5` to confirm package resolves.
    Run: `python -c "from app.main import app; print('app loaded without SENTRY_DSN error')"` from repo root with no SENTRY_DSN in environment — confirms Sentry init is skipped safely.
  </verify>
  <done>
    railway.json exists at repo root with valid JSON. `sentry-sdk` is in requirements.txt. `app.main` imports cleanly without SENTRY_DSN set in environment.
  </done>
</task>

</tasks>

<verification>
From repo root:
1. `git diff .gitignore` — confirms the three data file entries are removed.
2. `git status` — confirms data/faiss.index, data/metadata.json, data/experts.csv appear (untracked, not gitignored). data/conversations.db should NOT appear.
3. `cat railway.json` — confirms JSON structure with healthcheckPath, healthcheckTimeout, startCommand.
4. `grep sentry-sdk requirements.txt` — confirms entry present.
5. `python -c "from app.main import app"` — imports cleanly (Sentry guard works without SENTRY_DSN).
</verification>

<success_criteria>
- data/faiss.index, data/metadata.json, data/experts.csv are no longer gitignored
- data/conversations.db remains gitignored
- app/config.py reads VAR_DIR env var and falls back to DATA_DIR locally
- railway.json exists at repo root with correct healthcheckPath and 300s timeout
- sentry-sdk is in requirements.txt
- app/main.py initializes Sentry only when SENTRY_DSN env var is present
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-01-SUMMARY.md`
</output>
