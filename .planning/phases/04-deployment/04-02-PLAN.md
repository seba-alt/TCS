---
phase: 04-deployment
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - frontend/src/instrument.ts
  - frontend/src/main.tsx
  - frontend/src/vite-env.d.ts
  - frontend/vite.config.ts
  - frontend/package.json
autonomous: true
requirements:
  - DEPL-01

must_haves:
  truths:
    - "GitHub Actions CI runs ruff and tsc on every push to main"
    - "Frontend Sentry initializes before React renders in production builds"
    - "Sentry is disabled in development builds (enabled: import.meta.env.PROD)"
    - "VITE_SENTRY_DSN is TypeScript-typed in ImportMetaEnv"
    - "CI workflow passes on current codebase before deployment is attempted"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Ruff lint + TypeScript type-check on push to main"
      contains: "ruff check"
    - path: "frontend/src/instrument.ts"
      provides: "Sentry React SDK initialization"
      contains: "Sentry.init"
    - path: "frontend/src/main.tsx"
      provides: "instrument.ts imported as first import"
      contains: "import './instrument'"
    - path: "frontend/src/vite-env.d.ts"
      provides: "VITE_SENTRY_DSN typed in ImportMetaEnv"
      contains: "VITE_SENTRY_DSN"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/instrument.ts"
      via: "first import before React"
      pattern: "import './instrument'"
    - from: "frontend/src/instrument.ts"
      to: "VITE_SENTRY_DSN"
      via: "import.meta.env.VITE_SENTRY_DSN"
      pattern: "VITE_SENTRY_DSN"
    - from: ".github/workflows/ci.yml"
      to: "Railway deploy gate"
      via: "Railway 'Wait for CI' setting"
      pattern: "ruff check"
---

<objective>
Set up the GitHub Actions CI pipeline and instrument the React frontend with Sentry. These two tasks are independent of backend deployment prep and can execute in parallel with Plan 01.

Purpose: CI ensures no broken code reaches Railway. Frontend Sentry gives production error visibility for the client-side app. Both must be committed before the platforms are connected.

Output: .github/workflows/ci.yml (new), frontend/src/instrument.ts (new), updated frontend/src/main.tsx, vite-env.d.ts, vite.config.ts, and frontend/package.json.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-RESEARCH.md
@frontend/src/main.tsx
@frontend/src/vite-env.d.ts
@frontend/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create `.github/workflows/ci.yml` (create the `.github/workflows/` directory if it does not exist):
    ```yaml
    name: CI
    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      lint-and-typecheck:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Set up Python
            uses: actions/setup-python@v5
            with:
              python-version: "3.12"

          - name: Install ruff
            run: pip install ruff

          - name: Ruff lint
            run: ruff check .

          - name: Set up Node
            uses: actions/setup-node@v4
            with:
              node-version: "20"
              cache: "npm"
              cache-dependency-path: frontend/package-lock.json

          - name: Install frontend deps
            run: npm ci
            working-directory: frontend

          - name: TypeScript type check
            run: npx tsc --noEmit
            working-directory: frontend
    ```

    After creating the file, run `ruff check .` locally from the repo root to confirm the current codebase passes lint. If ruff is not installed locally, install it with `pip install ruff` first. Fix any lint errors before proceeding — CI must pass on the first push.

    Also run `npm run type-check 2>/dev/null || npx tsc --noEmit` from `frontend/` to confirm TypeScript passes. Fix any type errors before proceeding.
  </action>
  <verify>
    Run `ruff check .` from repo root — exits 0 with no errors.
    Run `npx tsc --noEmit` from `frontend/` — exits 0 with no errors.
    `cat .github/workflows/ci.yml` — file exists with correct YAML structure.
  </verify>
  <done>
    ci.yml exists with ruff and tsc jobs. Both lint and type-check pass locally on current codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install and configure Sentry React SDK</name>
  <files>frontend/package.json, frontend/src/instrument.ts, frontend/src/main.tsx, frontend/src/vite-env.d.ts, frontend/vite.config.ts</files>
  <action>
    From the `frontend/` directory, install Sentry packages:
    ```bash
    npm install @sentry/react @sentry/vite-plugin
    ```

    Create `frontend/src/instrument.ts`:
    ```typescript
    import * as Sentry from "@sentry/react";

    Sentry.init({
      dsn: import.meta.env.VITE_SENTRY_DSN,
      integrations: [Sentry.browserTracingIntegration()],
      tracesSampleRate: 0.1,
      environment: "production",
      enabled: import.meta.env.PROD,  // disabled in local dev (import.meta.env.PROD is false)
    });
    ```

    In `frontend/src/main.tsx`, add `import "./instrument";` as the VERY FIRST import line — before the React import. The file should start:
    ```typescript
    import "./instrument";
    import React from "react";
    // ... rest of existing imports unchanged
    ```

    In `frontend/src/vite-env.d.ts`, add `VITE_SENTRY_DSN: string` to the existing `ImportMetaEnv` interface. The interface should now include both `VITE_API_URL` and `VITE_SENTRY_DSN`.

    In `frontend/vite.config.ts`, import and add the Sentry Vite plugin for source map upload:
    ```typescript
    import { sentryVitePlugin } from "@sentry/vite-plugin";

    // Inside defineConfig plugins array, add after existing plugins:
    sentryVitePlugin({
      org: process.env.SENTRY_ORG,
      project: process.env.SENTRY_PROJECT,
      authToken: process.env.SENTRY_AUTH_TOKEN,
      disable: !process.env.SENTRY_AUTH_TOKEN,  // skip in local dev
    }),
    ```
    The `disable` guard ensures Vite builds locally do not fail if SENTRY_AUTH_TOKEN is unset.

    Run `npm run build` from `frontend/` to confirm the build succeeds with the new Sentry packages.
  </action>
  <verify>
    Run `npm run build` from `frontend/` — exits 0 with no TypeScript or Vite errors.
    `grep -n "import.*instrument" frontend/src/main.tsx` — confirms instrument is the first import.
    `grep VITE_SENTRY_DSN frontend/src/vite-env.d.ts` — confirms typed field present.
    `ls frontend/node_modules/@sentry/react` — confirms package installed.
  </verify>
  <done>
    `npm run build` from `frontend/` succeeds. instrument.ts exists and is first import in main.tsx. VITE_SENTRY_DSN typed in vite-env.d.ts.
  </done>
</task>

</tasks>

<verification>
1. `ruff check .` from repo root exits 0.
2. `npx tsc --noEmit` from `frontend/` exits 0.
3. `npm run build` from `frontend/` exits 0.
4. `cat .github/workflows/ci.yml` shows both ruff and tsc jobs.
5. `head -3 frontend/src/main.tsx` shows `import "./instrument"` as first line.
</verification>

<success_criteria>
- ci.yml exists and both ruff lint and tsc type-check pass on current codebase
- @sentry/react and @sentry/vite-plugin installed in frontend/package.json
- instrument.ts created with Sentry.init() using VITE_SENTRY_DSN, enabled only in PROD
- instrument.ts is the first import in main.tsx (before React)
- VITE_SENTRY_DSN typed in ImportMetaEnv
- npm run build passes after all changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-02-SUMMARY.md`
</output>
