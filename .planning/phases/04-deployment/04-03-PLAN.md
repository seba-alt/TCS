---
phase: 04-deployment
plan: "03"
type: execute
wave: 2
depends_on:
  - "04-01"
  - "04-02"
files_modified: []
autonomous: false
requirements:
  - DEPL-01

user_setup:
  - service: sentry
    why: "Error tracking for frontend (React) and backend (FastAPI)"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Project -> Settings -> Client Keys (DSN)"
        used_by: Railway (backend)
      - name: VITE_SENTRY_DSN
        source: "Sentry Dashboard -> Project -> Settings -> Client Keys (DSN)"
        used_by: Vercel (frontend)
    dashboard_config:
      - task: "Create a Sentry project (or use one project for both services)"
        location: "sentry.io -> Create Project -> React (frontend) and Python FastAPI (backend)"
  - service: railway
    why: "FastAPI backend hosting on Railway Hobby plan ($5/mo)"
    env_vars:
      - name: GOOGLE_API_KEY
        source: "Google AI Studio -> API keys"
      - name: ALLOWED_ORIGINS
        source: "Set after Vercel frontend URL is known — e.g. https://tinrate-ai.vercel.app"
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Python FastAPI project -> Settings -> Client Keys (DSN)"
      - name: VAR_DIR
        source: "Set to /app/var (literal value, not a secret)"
    dashboard_config:
      - task: "Create Railway project, connect GitHub repo, select root directory"
        location: "railway.com -> New Project -> Deploy from GitHub repo"
      - task: "Add Volume mounted at /app/var for SQLite persistence"
        location: "Railway service -> Volumes -> Add Volume -> Mount path: /app/var"
      - task: "Enable 'Wait for CI' so Railway waits for GitHub Actions before deploying"
        location: "Railway service -> Settings -> Deploy -> Wait for CI"
      - task: "Verify Serverless mode is OFF (Hobby plan should be always-on)"
        location: "Railway service -> Settings -> Serverless toggle must be OFF"
  - service: vercel
    why: "React/Vite frontend hosting on Vercel Hobby (free)"
    env_vars:
      - name: VITE_API_URL
        source: "Railway service -> Settings -> Networking -> Public URL (no trailing slash)"
        used_by: Production environment only
      - name: VITE_SENTRY_DSN
        source: "Sentry Dashboard -> React project -> Settings -> Client Keys (DSN)"
        used_by: Production environment only
    dashboard_config:
      - task: "Import GitHub repo into Vercel — set Root Directory to 'frontend'"
        location: "vercel.com -> Add New Project -> Import Git Repository -> Root Directory: frontend"
      - task: "Set VITE_API_URL to Railway public URL (no trailing slash)"
        location: "Vercel project -> Settings -> Environment Variables -> Production"

must_haves:
  truths:
    - "Visiting the Vercel public URL loads the chatbot UI without errors"
    - "A query typed into the chatbot returns 3 expert recommendations end-to-end"
    - "GET /api/health on the Railway public URL returns 200 with non-zero index_size"
    - "Production CORS is locked to the exact Vercel domain (no wildcard)"
    - "GOOGLE_API_KEY and VITE_API_URL are set in Railway/Vercel env vars and not in any committed file"
    - "SQLite conversations persist across Railway redeployments (Volume mounted)"
  artifacts:
    - path: "Railway service"
      provides: "FastAPI backend at public Railway URL"
    - path: "Vercel project"
      provides: "React frontend at public Vercel URL"
  key_links:
    - from: "Vercel frontend"
      to: "Railway /api/chat"
      via: "VITE_API_URL env var -> fetch in useChat.ts"
      pattern: "VITE_API_URL"
    - from: "Railway ALLOWED_ORIGINS"
      to: "Vercel domain"
      via: "CORS middleware in app/main.py"
      pattern: "ALLOWED_ORIGINS"
---

<objective>
Deploy the backend to Railway and the frontend to Vercel, configure all environment variables, and verify the application is live end-to-end at a public URL.

Purpose: This is the final phase — Plans 01 and 02 committed all the code changes; this plan wires the platforms together and gets the app live on the internet.

Output: Live chatbot at a public Vercel URL backed by a running Railway FastAPI service.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-RESEARCH.md
@.planning/phases/04-deployment/04-01-SUMMARY.md
@.planning/phases/04-deployment/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit and push all deployment prep to main</name>
  <files></files>
  <action>
    Stage and commit all changes from Plans 01 and 02:
    ```bash
    git add data/faiss.index data/metadata.json data/experts.csv
    git add .gitignore app/config.py app/main.py requirements.txt railway.json
    git add .github/workflows/ci.yml
    git add frontend/src/instrument.ts frontend/src/main.tsx frontend/src/vite-env.d.ts frontend/vite.config.ts frontend/package.json frontend/package-lock.json
    git commit -m "feat(deploy): add Railway config, Sentry instrumentation, and CI pipeline"
    git push origin main
    ```

    Wait for the GitHub Actions CI workflow to appear and pass at github.com/{repo}/actions. The workflow runs ruff lint and tsc type-check. If it fails, fix the issue locally, commit the fix, and push again before proceeding to platform setup.

    Confirm: CI passes (green checkmark) before moving to the platform setup checkpoint.
  </action>
  <verify>
    `git log --oneline -1` shows the deployment commit. GitHub Actions CI workflow shows as passed (green) in the repo Actions tab.
  </verify>
  <done>
    Commit pushed to main. CI workflow passes. All deployment prep files are in the remote repo.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Platform setup and end-to-end production verification</name>
  <files></files>
  <action>
    Connect Railway and Vercel to the GitHub repo, set all environment variables, add Railway Volume, and verify the app is live end-to-end.

    DEPLOYMENT ORDER (follow this order to avoid CORS mismatch):
    1. Deploy Railway first to get the Railway public URL
    2. Deploy Vercel second to get the Vercel public URL
    3. Set ALLOWED_ORIGINS on Railway to the exact Vercel URL
    4. Railway auto-redeploys to apply ALLOWED_ORIGINS

    RAILWAY SETUP:
    1. Go to railway.com -> New Project -> Deploy from GitHub repo -> select this repo
    2. Railway auto-detects railway.json — health check is configured automatically
    3. Set environment variables in Railway service -> Variables:
       - GOOGLE_API_KEY = your Google AI Studio key
       - VAR_DIR = /app/var
       - SENTRY_DSN = (from Sentry dashboard, Python project DSN)
       - ALLOWED_ORIGINS = (leave empty for now; set after Vercel deploy)
    4. Add Volume: Railway service -> Volumes -> Add Volume -> Mount path: /app/var
    5. Enable "Wait for CI": Railway service -> Settings -> Deploy -> "Wait for CI" toggle ON
    6. Verify Serverless toggle is OFF
    7. Wait for Railway deploy to complete — health check at /api/health must return 200
    8. Note the Railway public URL (e.g. https://xxx.railway.app)

    VERCEL SETUP:
    1. Go to vercel.com -> Add New Project -> Import Git Repository -> select this repo
    2. Set Root Directory = "frontend" in Build & Deployment settings
    3. Set environment variables (Production scope only):
       - VITE_API_URL = https://xxx.railway.app (exact Railway URL, NO trailing slash)
       - VITE_SENTRY_DSN = (from Sentry dashboard, React project DSN)
    4. Click Deploy — Vercel auto-detects Vite, builds from frontend/, outputs dist/
    5. Wait for Vercel deploy to complete
    6. Note the Vercel public URL (e.g. https://tinrate-ai.vercel.app)

    SET CORS ON RAILWAY:
    1. Go back to Railway service -> Variables
    2. Set ALLOWED_ORIGINS = https://tinrate-ai.vercel.app (exact Vercel URL, no trailing slash)
    3. Railway auto-redeploys — wait for it to complete

    SENTRY SETUP (if not already done):
    1. Create account at sentry.io
    2. Create one project for Python FastAPI (get DSN for SENTRY_DSN on Railway)
    3. Create one project for React (get DSN for VITE_SENTRY_DSN on Vercel)
    4. Update Railway and Vercel env vars with the respective DSNs and redeploy both

    VERIFY END-TO-END:
    1. Visit the Vercel public URL in a browser
    2. The Tinrate chatbot UI should load without console errors
    3. Type a query (e.g. "I need help with my marketing strategy")
    4. Three expert recommendations should appear within ~5 seconds
    5. Clicking an Expert Card should open the expert profile URL in a new tab
    6. In browser DevTools Network tab, confirm /api/chat goes to the Railway URL and returns 200

    VERIFY HEALTH CHECK:
    Run: curl https://xxx.railway.app/api/health
    Expected: {"status": "ok", "index_size": N} where N > 0

    VERIFY CORS:
    Run: curl -H "Origin: https://tinrate-ai.vercel.app" -I https://xxx.railway.app/api/health
    Expected: response includes Access-Control-Allow-Origin: https://tinrate-ai.vercel.app
  </action>
  <verify>
    1. Visit Vercel public URL — chatbot loads without console errors
    2. Submit a query — 3 Expert Cards appear below AI response
    3. curl https://xxx.railway.app/api/health returns 200 with index_size > 0
    4. curl -H "Origin: https://tinrate-ai.vercel.app" -I https://xxx.railway.app/api/health shows correct CORS header (not wildcard)
    5. git grep GOOGLE_API_KEY from repo root — only appears in .env.example, not source files
  </verify>
  <done>
    Chatbot is live at a public Vercel URL. A query returns 3 Expert Cards. Railway health check returns 200. CORS is locked to exact Vercel domain. No secrets in committed files.
  </done>
  <what-built>
    Railway FastAPI service (with Volume for SQLite persistence) and Vercel React frontend — both connected to GitHub repo and auto-deploying on push to main.
  </what-built>
  <how-to-verify>
    Follow the verify steps above: Vercel URL loads chatbot, query returns 3 Expert Cards, curl confirms health check and CORS.
  </how-to-verify>
  <resume-signal>Type "deployed" with the Vercel public URL and Railway public URL, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
After deployment is confirmed by user:
1. curl {RAILWAY_URL}/api/health returns {"status": "ok", "index_size": N} with N > 0
2. curl -H "Origin: {VERCEL_URL}" -I {RAILWAY_URL}/api/health shows Access-Control-Allow-Origin: {VERCEL_URL} (not wildcard)
3. Vercel URL loads chatbot — query returns 3 Expert Cards
4. git grep GOOGLE_API_KEY — only appears in .env.example (not in source files or committed .env)
</verification>

<success_criteria>
- Vercel URL is publicly accessible and loads the chatbot UI
- A query returns 3 expert recommendations end-to-end through the live Railway backend
- Railway /api/health returns 200 with index_size > 0
- CORS is locked to exact Vercel domain (ALLOWED_ORIGINS has no wildcard)
- GOOGLE_API_KEY and VITE_API_URL are in platform env vars only, not in committed files
- Railway Volume is mounted at /app/var so SQLite survives redeployments
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-03-SUMMARY.md`
</output>
