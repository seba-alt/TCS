---
phase: 24-atomic-index-swap-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - app/main.py
  - frontend/src/admin/types.ts
  - frontend/src/admin/hooks/useAdminData.ts
autonomous: true
requirements:
  - IDX-02
  - IDX-03

must_haves:
  truths:
    - "The ingest_run endpoint is async and uses asyncio.Lock to prevent concurrent rebuild OOM"
    - "On rebuild completion, _ingest dict records last_rebuild_at (unix timestamp) and expert_count_at_rebuild"
    - "app.state.tsne_cache is initialized to [] at server startup (not just after first rebuild)"
    - "IngestStatus TypeScript interface includes last_rebuild_at and expert_count_at_rebuild as optional fields"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "asyncio.Lock guard + _ingest dict extension + _run_ingest_job completion fields"
      contains: "_ingest_lock"
    - path: "app/main.py"
      provides: "tsne_cache startup initialization"
      contains: "app.state.tsne_cache"
    - path: "frontend/src/admin/types.ts"
      provides: "IngestStatus type with two new optional fields"
      contains: "last_rebuild_at"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useIngestStatus initial state with new fields"
      contains: "last_rebuild_at: null"
  key_links:
    - from: "app/routers/admin.py (_ingest dict)"
      to: "frontend/src/admin/types.ts (IngestStatus)"
      via: "GET /api/admin/ingest/status JSON response"
      pattern: "last_rebuild_at.*expert_count_at_rebuild"
    - from: "_run_ingest_job"
      to: "app.state.faiss_index"
      via: "atomic swap after ingest.py completes"
      pattern: "app\\.state\\.faiss_index ="
---

<objective>
Add the three surgical backend changes that make atomic index swap observable (Lock, _ingest field extension, tsne_cache init) and extend the TypeScript contract so the frontend can safely consume the new fields.

Purpose: These are the data-layer prerequisites for the IndexPage UI. The Lock prevents OOM from concurrent rebuilds. The _ingest fields let Phase 25 (Index Drift) and the frontend display last-rebuild metadata. The tsne_cache init prevents AttributeError when Phase 26 checks the attribute at cold start.

Output: Extended admin.py (Lock + _ingest fields), updated main.py (tsne_cache startup), extended types.ts + useAdminData.ts initial state.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-atomic-index-swap-ui/24-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend — asyncio.Lock guard, _ingest dict extension, tsne_cache startup init</name>
  <files>app/routers/admin.py, app/main.py</files>
  <action>
    Make three surgical additions. Do NOT modify any existing endpoint behavior beyond what is listed.

    **admin.py — three changes:**

    1. AFTER the `_ingest` dict declaration (line 68), add the lock at module level:
       ```python
       import asyncio as _asyncio
       _ingest_lock = _asyncio.Lock()
       ```
       Note: `asyncio` may already be imported elsewhere in the file — use `import asyncio as _asyncio` to avoid name collision.

    2. UPDATE the `_ingest` dict initial declaration (line 68) to add two new keys:
       ```python
       _ingest: dict = {
           "status": "idle",
           "log": "",
           "error": None,
           "started_at": None,
           "last_rebuild_at": None,          # Phase 24: set on successful FAISS rebuild completion
           "expert_count_at_rebuild": None,  # Phase 24 + 25: expert count at last full rebuild
       }
       ```

    3. UPDATE `_run_ingest_job` success block (currently just `_ingest["status"] = "done"` at line 143). BEFORE setting status to "done", add:
       ```python
       _ingest["last_rebuild_at"] = time.time()
       _ingest["expert_count_at_rebuild"] = len(app.state.metadata)
       app.state.tsne_cache = []   # Phase 26: invalidate stale t-SNE projection
       _ingest["status"] = "done"
       ```
       These lines go after the FTS5 rebuild and username_mapping_refreshed log call, replacing the bare `_ingest["status"] = "done"`.
       Do NOT set these fields in `_run_tag_job` — tag-only runs must not update rebuild timestamp.

    4. CONVERT `ingest_run` from `def` to `async def` and replace the string-check guard with the Lock:
       ```python
       @router.post("/ingest/run")
       async def ingest_run(request: Request):
           """
           Trigger tag_experts.py + ingest.py in a background thread, then hot-reload FAISS.
           Returns 409 if a job is already running.
           asyncio.Lock prevents concurrent invocations causing OOM on Railway.
           """
           global _ingest
           async with _ingest_lock:
               if _ingest["status"] == "running":
                   raise HTTPException(status_code=409, detail="Ingest job already running")
               _ingest["status"] = "running"
           thread = threading.Thread(target=_run_ingest_job, args=(request.app,), daemon=True)
           thread.start()
           return {"status": "started"}
       ```
       The `async with _ingest_lock` requires `async def`. The inner string check is kept as a secondary guard inside the lock. FastAPI handles both sync and async route functions — this is non-breaking.

    **main.py — one change:**

    5. AFTER `app.state.faiss_index = faiss.read_index(...)` and the metadata load block in the lifespan startup section (after the `username_to_faiss_pos` block, around line 215-219), add:
       ```python
       app.state.tsne_cache = []   # Phase 26: t-SNE projection cache; invalidated on index rebuild
       ```
       This ensures the attribute exists at cold start so Phase 26's endpoint can safely check `hasattr(app.state, 'tsne_cache')`.

    Do NOT touch `_run_tag_job`, the `/ingest/status` endpoint, or any other endpoint.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS && python -c "import ast; ast.parse(open('app/routers/admin.py').read()); print('admin.py: syntax OK')"` — must print OK.
    Run: `python -c "import ast; ast.parse(open('app/main.py').read()); print('main.py: syntax OK')"` — must print OK.
    Grep: `grep -n "_ingest_lock\|last_rebuild_at\|expert_count_at_rebuild\|async def ingest_run" app/routers/admin.py` — must show all four patterns.
    Grep: `grep -n "tsne_cache" app/routers/admin.py app/main.py` — must appear in both files.
  </verify>
  <done>
    admin.py parses without syntax errors; _ingest_lock exists at module level; ingest_run is async; _ingest dict has last_rebuild_at and expert_count_at_rebuild keys; _run_ingest_job sets both fields before status="done"; app.state.tsne_cache=[] appears in both admin.py (_run_ingest_job completion) and main.py (startup lifespan).
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript contract — extend IngestStatus interface and useIngestStatus initial state</name>
  <files>frontend/src/admin/types.ts, frontend/src/admin/hooks/useAdminData.ts</files>
  <action>
    Two small changes to bring the TypeScript contract in line with the extended backend response.

    **types.ts — extend IngestStatus:**
    Find the `IngestStatus` interface (lines 120-125) and add two new optional fields:
    ```typescript
    export interface IngestStatus {
      status: 'idle' | 'running' | 'done' | 'error'
      log: string
      error: string | null
      started_at: number | null
      last_rebuild_at: number | null          // Phase 24: unix timestamp of last full FAISS rebuild
      expert_count_at_rebuild: number | null  // Phase 24 + 25: expert count at last rebuild
    }
    ```

    **useAdminData.ts — update initial state in useIngestStatus:**
    Find the `useState<IngestStatus>({...})` call in `useIngestStatus` (lines 186-191) and add the two new fields to the initial object:
    ```typescript
    const [ingest, setIngest] = useState<IngestStatus>({
      status: 'idle',
      log: '',
      error: null,
      started_at: null,
      last_rebuild_at: null,          // Phase 24
      expert_count_at_rebuild: null,  // Phase 24 + 25
    })
    ```

    No other changes to useAdminData.ts. The hook logic (startPolling, stopPolling, triggerRun) is unchanged.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20` — must produce zero type errors related to IngestStatus.
    Grep: `grep -n "last_rebuild_at\|expert_count_at_rebuild" frontend/src/admin/types.ts frontend/src/admin/hooks/useAdminData.ts` — must appear in both files.
  </verify>
  <done>
    TypeScript compiles without errors; IngestStatus interface has last_rebuild_at and expert_count_at_rebuild fields; useIngestStatus initial state includes both new fields initialized to null.
  </done>
</task>

</tasks>

<verification>
1. `python -c "import ast; ast.parse(open('app/routers/admin.py').read()); print('OK')"` — no syntax error
2. `python -c "import ast; ast.parse(open('app/main.py').read()); print('OK')"` — no syntax error
3. `grep -c "last_rebuild_at" app/routers/admin.py` — returns 3 (dict init, _run_ingest_job set, ingest_status returns it implicitly)
4. `grep -c "tsne_cache" app/routers/admin.py app/main.py` — at least 1 match in each file
5. `grep "async def ingest_run" app/routers/admin.py` — confirms async conversion
6. `cd frontend && npx tsc --noEmit 2>&1 | grep -i "IngestStatus\|last_rebuild" | wc -l` — 0 errors
</verification>

<success_criteria>
- admin.py has asyncio.Lock guard replacing bare string check (race-safe)
- _ingest dict has last_rebuild_at and expert_count_at_rebuild (both None initially, populated on _run_ingest_job success)
- app.state.tsne_cache = [] in main.py startup lifespan (Phase 26 AttributeError prevention)
- IngestStatus TypeScript interface and useIngestStatus initial state include both new fields
- Zero TypeScript compile errors
- Zero Python syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-atomic-index-swap-ui/24-01-SUMMARY.md`
</output>
