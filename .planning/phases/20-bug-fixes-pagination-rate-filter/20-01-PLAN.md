---
phase: 20-bug-fixes-pagination-rate-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useExplore.ts
  - frontend/src/components/marketplace/FilterChips.tsx
  - frontend/src/components/sidebar/RateSlider.tsx
  - frontend/src/components/sidebar/MobileFilterSheet.tsx
  - frontend/vite.config.ts
  - frontend/package.json
  - frontend/src/hooks/useExplore.test.ts
  - frontend/src/components/marketplace/FilterChips.test.ts
autonomous: true
requirements:
  - MARKET-01
  - MARKET-02

must_haves:
  truths:
    - "Typing a query and scrolling past page 1 returns semantically-ranked results (not filter-only results)"
    - "On fresh page load with no active rate filter, the EUR 0-5000 chip does not appear"
    - "RateSlider max is 5000 — users can represent rates up to EUR 5000/hr"
    - "MobileFilterSheet draft initial state and number input max are 5000 — matches store defaults"
    - "MobileFilterSheet imports TOP_TAGS from constants/tags.ts — no inline copy"
    - "tsc -b && vite build passes with zero errors after all changes"
    - "vitest regression tests pass: pagination param test and rate chip logic test"
  artifacts:
    - path: "frontend/src/hooks/useExplore.ts"
      provides: "loadNextPage with correct query param name"
      contains: "params.set('query', query)"
    - path: "frontend/src/components/marketplace/FilterChips.tsx"
      provides: "Rate chip visibility logic with correct default"
      contains: "DEFAULT_RATE_MAX = 5000"
    - path: "frontend/src/components/sidebar/RateSlider.tsx"
      provides: "Slider spanning full rate range"
      contains: "max={5000}"
    - path: "frontend/src/components/sidebar/MobileFilterSheet.tsx"
      provides: "Mobile sheet with correct constants and imported TOP_TAGS"
      contains: "import { TOP_TAGS } from '../../constants/tags'"
    - path: "frontend/src/hooks/useExplore.test.ts"
      provides: "Regression test: pagination param correctness"
      exports: ["describe('loadNextPage URL params')"]
    - path: "frontend/src/components/marketplace/FilterChips.test.ts"
      provides: "Regression test: rate chip visibility logic"
      exports: ["describe('FilterChips rate chip visibility')"]
  key_links:
    - from: "frontend/src/hooks/useExplore.ts"
      to: "app/routers/explore.py"
      via: "URLSearchParams key 'query'"
      pattern: "params.set\\('query'"
    - from: "frontend/src/components/marketplace/FilterChips.tsx"
      to: "frontend/src/store/filterSlice.ts"
      via: "DEFAULT_RATE_MAX === store rateMax default"
      pattern: "DEFAULT_RATE_MAX = 5000"
---

<objective>
Fix four confirmed bugs from the v2.0 audit: (1) infinite scroll breaks with active text query because loadNextPage sends `q` instead of `query` to the backend, (2) the rate filter chip shows "EUR 0-5000" on fresh page load because FilterChips has a stale DEFAULT_RATE_MAX of 2000 instead of 5000, (3) RateSlider max is capped at 2000 instead of 5000, and (4) MobileFilterSheet has an inline TOP_TAGS copy and hardcoded 2000 constants. Then install Vitest and add required regression tests, and verify the build passes.

Purpose: Unblock two MARKET requirements (MARKET-01: correct filter chip behavior; MARKET-02: correct infinite scroll pagination) so the v2.0 milestone audit can close.
Output: Four patched source files, two new test files, updated vite.config.ts and package.json, passing regression tests, passing build.
</objective>

<execution_context>
@/Users/sebastianhamers/Documents/TCS/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/Documents/TCS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/sebastianhamers/Documents/TCS/.planning/PROJECT.md
@/Users/sebastianhamers/Documents/TCS/.planning/ROADMAP.md
@/Users/sebastianhamers/Documents/TCS/.planning/STATE.md

# Source files with confirmed bugs (read before editing)
@/Users/sebastianhamers/Documents/TCS/frontend/src/hooks/useExplore.ts
@/Users/sebastianhamers/Documents/TCS/frontend/src/components/marketplace/FilterChips.tsx
@/Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/RateSlider.tsx
@/Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/MobileFilterSheet.tsx
@/Users/sebastianhamers/Documents/TCS/frontend/vite.config.ts
@/Users/sebastianhamers/Documents/TCS/frontend/package.json

# Constants source of truth (do NOT change these)
@/Users/sebastianhamers/Documents/TCS/frontend/src/store/filterSlice.ts
@/Users/sebastianhamers/Documents/TCS/frontend/src/constants/tags.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix four confirmed bugs in useExplore, FilterChips, RateSlider, and MobileFilterSheet</name>
  <files>
    frontend/src/hooks/useExplore.ts
    frontend/src/components/marketplace/FilterChips.tsx
    frontend/src/components/sidebar/RateSlider.tsx
    frontend/src/components/sidebar/MobileFilterSheet.tsx
  </files>
  <action>
Make the following surgical changes — read each file before editing:

**useExplore.ts — Bug 1: pagination param mismatch**
In the `loadNextPage` useCallback, find the line:
  `if (query) params.set('q', query)`
Change to:
  `if (query) params.set('query', query)`
This is the only change. Do NOT touch `useUrlSync.ts` — it uses `q` intentionally as a URL display param, not an API param. Do NOT touch `SearchInput.tsx` — its `/api/suggest?q=` is correct.

**FilterChips.tsx — Bug 2: DEFAULT_RATE_MAX stale constant**
At the top of the file find:
  `const DEFAULT_RATE_MAX = 2000`
Change to:
  `const DEFAULT_RATE_MAX = 5000`
The store's source of truth (`filterSlice.ts` line 25) is `rateMax: 5000`. This one-line fix both prevents the false-positive chip display AND ensures the dismiss action resets to the correct default (5000, not 2000).

**RateSlider.tsx — Bug 3: Slider max capped at 2000**
Find the Radix UI Slider's `max` prop:
  `max={2000}`
Change to:
  `max={5000}`
This is the only change in this file.

**MobileFilterSheet.tsx — Bug 4: three sub-issues**
  (a) Remove the inline `TOP_TAGS` const array (lines 6-37 approximately — the entire `const TOP_TAGS = [...]` block).
      Add this import near the top of the file (after React imports, alongside other sidebar imports):
      `import { TOP_TAGS } from '../../constants/tags'`
      Verify the relative path: MobileFilterSheet lives at `frontend/src/components/sidebar/` so `../../constants/tags` resolves to `frontend/src/constants/tags.ts`. Correct.

  (b) In the `useState<Draft>` initial state (~line 53), change:
      `rateMax: 2000` → `rateMax: 5000`

  (c) Find both number input `max` attributes (min rate input and max rate input).
      Change both `max={2000}` → `max={5000}`

Do NOT refactor any surrounding logic. These are constant value changes only.

After all edits, run the audit specified in CONTEXT.md: confirm no other API call sites use wrong param names, confirm no other files have inline TOP_TAGS copies beyond those already confirmed correct (EmptyState, TagMultiSelect both already import correctly). If additional out-of-scope issues are found, note them but do not fix them — log to ROADMAP.md under a new backlog entry.
  </action>
  <verify>
Run from the frontend directory:
  `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit`
Must exit 0 with no errors. This confirms all four files typecheck correctly after changes.
  </verify>
  <done>
- `useExplore.ts` loadNextPage sends `params.set('query', query)` — confirmed by grep
- `FilterChips.tsx` has `DEFAULT_RATE_MAX = 5000` — confirmed by grep
- `RateSlider.tsx` has `max={5000}` — confirmed by grep
- `MobileFilterSheet.tsx` imports TOP_TAGS from constants, draft init has `rateMax: 5000`, both number inputs have `max={5000}` — confirmed by grep
- `npx tsc --noEmit` exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Vitest, configure it, write regression tests, verify build passes</name>
  <files>
    frontend/package.json
    frontend/vite.config.ts
    frontend/src/hooks/useExplore.test.ts
    frontend/src/components/marketplace/FilterChips.test.ts
  </files>
  <action>
**Step 1: Install Vitest as devDependency**
From `frontend/` directory:
  `npm install --save-dev vitest`
(No @testing-library/react or jsdom needed — tests are pure logic, no React rendering required, `environment: 'node'` suffices.)

**Step 2: Add test scripts to package.json**
Read current `package.json`, then add to the `scripts` block:
  `"test": "vitest run"`
  `"test:watch": "vitest"`

**Step 3: Update vite.config.ts to enable Vitest**
Read current `vite.config.ts`, then:
- Change the import line from `import { defineConfig } from 'vite'` to `import { defineConfig } from 'vitest/config'`
- Add a `test` block inside `defineConfig({...})` after the `plugins` array:
  ```
  test: {
    environment: 'node',
    globals: true,
  },
  ```
This avoids creating a separate `vitest.config.ts` (which could conflict with vite.config). The `defineConfig` from `vitest/config` is a superset that accepts the `test` key.

**Step 4: Create regression test — pagination param**
Create `frontend/src/hooks/useExplore.test.ts`:
```typescript
import { describe, it, expect } from 'vitest'

describe('loadNextPage URL params', () => {
  it('uses "query" param name (not "q") for /api/explore', () => {
    const query = 'react developer'
    const params = new URLSearchParams()
    if (query) params.set('query', query)
    params.set('rate_min', '0')
    params.set('rate_max', '5000')
    params.set('cursor', '20')

    expect(params.get('query')).toBe('react developer')
    expect(params.get('q')).toBeNull()
    expect(params.toString()).toContain('query=react+developer')
  })

  it('does not set "query" param when query is empty string', () => {
    const query = ''
    const params = new URLSearchParams()
    if (query) params.set('query', query)

    expect(params.get('query')).toBeNull()
    expect(params.get('q')).toBeNull()
  })
})
```

**Step 5: Create regression test — rate chip visibility**
Create `frontend/src/components/marketplace/FilterChips.test.ts`:
```typescript
import { describe, it, expect } from 'vitest'

// Mirror the post-fix logic from FilterChips.tsx
const DEFAULT_RATE_MIN = 0
const DEFAULT_RATE_MAX = 5000

function shouldShowRateChip(rateMin: number, rateMax: number): boolean {
  return rateMin !== DEFAULT_RATE_MIN || rateMax !== DEFAULT_RATE_MAX
}

describe('FilterChips rate chip visibility', () => {
  it('does NOT show rate chip when store has default rate values (0-5000)', () => {
    expect(shouldShowRateChip(0, 5000)).toBe(false)
  })

  it('shows rate chip when rateMin is non-default', () => {
    expect(shouldShowRateChip(100, 5000)).toBe(true)
  })

  it('shows rate chip when rateMax is non-default', () => {
    expect(shouldShowRateChip(0, 1500)).toBe(true)
    expect(shouldShowRateChip(0, 300)).toBe(true)
  })

  it('shows rate chip when both min and max are non-default', () => {
    expect(shouldShowRateChip(100, 300)).toBe(true)
  })

  it('regression guard: old DEFAULT_RATE_MAX=2000 would have shown chip incorrectly', () => {
    // Confirm the bug existed: with wrong default, store value 5000 !== 2000 → chip shown
    const wrongDefault = 2000
    const wouldShowWithBug = 0 !== DEFAULT_RATE_MIN || 5000 !== wrongDefault
    expect(wouldShowWithBug).toBe(true)
    // And with the fix, it correctly returns false:
    expect(shouldShowRateChip(0, 5000)).toBe(false)
  })
})
```

**Step 6: Run tests**
From `frontend/` directory:
  `npm test`
All tests must pass.

**Step 7: Verify full build**
From `frontend/` directory:
  `npm run build`
Must complete with exit 0. The `build` script is `tsc -b && vite build` — this validates TypeScript and bundling together.
  </action>
  <verify>
1. `cd /Users/sebastianhamers/Documents/TCS/frontend && npm test` — all tests pass, exit 0
2. `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build` — build succeeds, exit 0
3. `cat /Users/sebastianhamers/Documents/TCS/frontend/package.json | grep vitest` — confirms vitest in devDependencies
  </verify>
  <done>
- Vitest installed as devDependency in package.json
- `test` and `test:watch` scripts added to package.json
- `vite.config.ts` uses `defineConfig` from `vitest/config` with `test: { environment: 'node', globals: true }`
- `useExplore.test.ts` exists and contains 2 passing tests for pagination param correctness
- `FilterChips.test.ts` exists and contains 4 passing tests for rate chip visibility logic (including regression guard)
- `npm test` exits 0 — all tests pass
- `npm run build` exits 0 — TypeScript and Vite build succeed
  </done>
</task>

</tasks>

<verification>
From `frontend/` directory, run these checks in order:

1. Param fix confirmed:
   `grep -n "params.set('query'" /Users/sebastianhamers/Documents/TCS/frontend/src/hooks/useExplore.ts`
   Must show the loadNextPage fix. Must NOT show `params.set('q', query)` in that file.

2. Rate constant fix confirmed:
   `grep -n "DEFAULT_RATE_MAX" /Users/sebastianhamers/Documents/TCS/frontend/src/components/marketplace/FilterChips.tsx`
   Must show `= 5000`.

3. Slider max confirmed:
   `grep -n "max=" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/RateSlider.tsx`
   Must show `max={5000}`.

4. Mobile sheet confirmed:
   `grep -n "TOP_TAGS\|rateMax\|max={" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/MobileFilterSheet.tsx`
   Must show import (not inline const), `rateMax: 5000`, and `max={5000}` for both inputs.

5. Tests pass:
   `cd /Users/sebastianhamers/Documents/TCS/frontend && npm test`
   Exit 0, all tests green.

6. Build passes:
   `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build`
   Exit 0.

7. No out-of-scope files modified:
   `useUrlSync.ts` still uses `params.set('q', ...)` for URL display — intentional, must remain unchanged.
</verification>

<success_criteria>
Phase 20 is complete when ALL of the following are true:

1. Infinite scroll with active text query works: `loadNextPage` in `useExplore.ts` sends `query=` not `q=` to `/api/explore` — semantically-ranked results returned on scroll past page 1
2. Rate chip silent on fresh load: `DEFAULT_RATE_MAX` in `FilterChips.tsx` is 5000, matching store default — "EUR 0-5000" chip does not appear when no filter is active
3. RateSlider spans full range: `max={5000}` — users can filter up to EUR 5000/hr
4. MobileFilterSheet aligned: imports TOP_TAGS from constants, draft init `rateMax: 5000`, number inputs `max={5000}`
5. Regression tests pass: `npm test` exits 0
6. Build passes: `npm run build` exits 0 (tsc -b + vite build)
</success_criteria>

<output>
After completion, create `/Users/sebastianhamers/Documents/TCS/.planning/phases/20-bug-fixes-pagination-rate-filter/20-01-SUMMARY.md`

Include:
- What was fixed (4 bugs with file + line)
- Test files created
- Build verification result
- Any out-of-scope findings logged to ROADMAP.md (or "none found")
- Decision: rate constants source of truth = filterSlice.ts (no new constants file needed)
</output>
