---
phase: 26-embedding-heatmap
plan: 02
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - frontend/src/admin/types.ts
  - frontend/src/admin/hooks/useAdminData.ts
  - frontend/src/admin/pages/IntelligenceDashboardPage.tsx
autonomous: false
requirements:
  - INTEL-06

must_haves:
  truths:
    - "The admin Intelligence tab shows a scatter plot of ~530 points within 30 seconds of app startup"
    - "Each scatter plot point is colored by the expert's category using aurora-adjacent jewel tones (purple, teal, green, pink family)"
    - "Hovering a scatter plot point shows the expert's name in a tooltip"
    - "While t-SNE is computing (202 response), the Intelligence tab shows a visible computing state (spinner or progress message)"
    - "After an index rebuild, the next page visit to the Intelligence tab loads the updated scatter plot"
  artifacts:
    - path: "frontend/src/admin/types.ts"
      provides: "EmbeddingPoint, EmbeddingMapResponse, EmbeddingMapComputing TypeScript interfaces"
      contains: "EmbeddingPoint"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useEmbeddingMap hook with polling logic"
      contains: "useEmbeddingMap"
    - path: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      provides: "EmbeddingMapChart section below existing Phase 25 metrics cards"
      contains: "ScatterChart"
  key_links:
    - from: "frontend/src/admin/hooks/useAdminData.ts useEmbeddingMap"
      to: "/api/admin/embedding-map"
      via: "adminFetch polling every 5s until status is ready"
      pattern: "setInterval.*poll.*5000"
    - from: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      to: "useEmbeddingMap"
      via: "hook import + destructured data/status"
      pattern: "useEmbeddingMap"
    - from: "ScatterChart"
      to: "EmbeddingPoint[]"
      via: "byCategory useMemo grouping data by category, one <Scatter> per group"
      pattern: "byCategory"
---

<objective>
Add the frontend embedding scatter plot to the admin Intelligence tab: TypeScript types for the embedding-map API response, a `useEmbeddingMap` polling hook that auto-polls the 202 endpoint until ready, and an `EmbeddingMapChart` section in IntelligenceDashboardPage using Recharts ScatterChart with category-colored jewel-tone points and expert-name tooltips.

Purpose: Give admins a visual map of the expert embedding space — clusters reveal coverage gaps and category separation.
Output: recharts installed, types.ts extended, useAdminData.ts extended with polling hook, IntelligenceDashboardPage.tsx with scatter chart below existing metrics cards.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-embedding-heatmap/26-RESEARCH.md
@.planning/phases/26-embedding-heatmap/26-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts + add TypeScript types + add useEmbeddingMap polling hook</name>
  <files>frontend/src/admin/types.ts, frontend/src/admin/hooks/useAdminData.ts</files>
  <action>
    **Step 1 — Install recharts:**
    ```bash
    cd frontend && npm install recharts --legacy-peer-deps
    ```
    The `--legacy-peer-deps` flag handles any React 19 peer dependency warnings without breaking the install. Recharts 2.x is not yet in package.json — this is a new dependency.

    **Step 2 — frontend/src/admin/types.ts** — Append to the end of the file (after the existing `LabOverrides` interface):

    ```typescript
    // ── Embedding Heatmap (Phase 26) ──────────────────────────────────────────

    /** One expert point in the t-SNE 2D projection */
    export interface EmbeddingPoint {
      x: number
      y: number
      name: string        // "First Last"
      category: string    // expert category or "Unknown"
      username: string
    }

    /** Response when t-SNE projection is complete */
    export interface EmbeddingMapResponse {
      status: 'ready'
      points: EmbeddingPoint[]
      count: number
    }

    /** Response while t-SNE is still computing (HTTP 202) */
    export interface EmbeddingMapComputing {
      status: 'computing'
    }
    ```

    **Step 3 — frontend/src/admin/hooks/useAdminData.ts** — Add the following imports at the top if not present: `useRef` (already imported). Then append `useEmbeddingMap` as a new exported function at the end of the file:

    ```typescript
    export function useEmbeddingMap() {
      const [data, setData] = useState<import('../types').EmbeddingMapResponse | null>(null)
      const [status, setStatus] = useState<'loading' | 'computing' | 'ready' | 'error'>('loading')
      const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null)

      const poll = useCallback(async () => {
        try {
          const res = await fetch(
            `${API_URL}/api/admin/embedding-map`,
            { headers: { 'X-Admin-Key': getAdminKey() } }
          )
          if (res.status === 202) {
            setStatus('computing')
            return // keep polling
          }
          if (!res.ok) {
            setStatus('error')
            if (intervalRef.current) clearInterval(intervalRef.current)
            return
          }
          const json = await res.json() as import('../types').EmbeddingMapResponse
          setData(json)
          setStatus('ready')
          if (intervalRef.current) {
            clearInterval(intervalRef.current)
            intervalRef.current = null
          }
        } catch {
          setStatus('error')
          if (intervalRef.current) clearInterval(intervalRef.current)
        }
      }, [])

      useEffect(() => {
        poll()
        intervalRef.current = setInterval(poll, 5000)
        return () => {
          if (intervalRef.current) clearInterval(intervalRef.current)
        }
      }, [poll])

      return { data, status }
    }
    ```

    Note: Use direct `fetch` with the raw status code check (rather than `adminFetch`) because `adminFetch` throws on non-ok responses — but 202 is a non-error non-ok code we need to handle. The raw fetch pattern mirrors the existing `useIngestStatus` interval approach.

    Add the import for `useEmbeddingMap` types at the top of useAdminData.ts if needed. The `EmbeddingMapResponse` type is referenced via inline import() — no change to the top-level import needed.
  </action>
  <verify>
    Run `cd frontend && npm ls recharts` — should show recharts version.
    Run `npx tsc --noEmit` from the frontend directory — no type errors in types.ts or useAdminData.ts.
    Grep for `EmbeddingPoint` in frontend/src/admin/types.ts — should appear.
    Grep for `useEmbeddingMap` in frontend/src/admin/hooks/useAdminData.ts — should appear.
  </verify>
  <done>
    recharts is listed in frontend/package.json as a dependency.
    EmbeddingPoint, EmbeddingMapResponse, EmbeddingMapComputing interfaces exist in types.ts.
    useEmbeddingMap hook exported from useAdminData.ts with 5s polling and 202-aware logic.
    TypeScript compiles without errors on modified files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add EmbeddingMapChart to IntelligenceDashboardPage</name>
  <files>frontend/src/admin/pages/IntelligenceDashboardPage.tsx</files>
  <action>
    **frontend/src/admin/pages/IntelligenceDashboardPage.tsx** — Three surgical changes:

    **Change 1 — Add imports at top of file** (after existing imports):
    ```typescript
    import {
      ScatterChart,
      Scatter,
      XAxis,
      YAxis,
      Tooltip,
      Legend,
      ResponsiveContainer,
    } from 'recharts'
    import { useMemo } from 'react'
    import { useEmbeddingMap } from '../hooks/useAdminData'
    import type { EmbeddingPoint } from '../types'
    ```

    **Change 2 — Add CATEGORY_COLORS constant and CustomTooltip component** after the existing helper functions (after `THRESHOLD_ORDER` const, before `export default function IntelligenceDashboardPage()`):

    ```typescript
    // Aurora-adjacent jewel-tone palette — complement the v2.2 purple/teal/green/pink aurora
    const CATEGORY_COLORS: Record<string, string> = {
      'Tech':         '#a855f7',   // vivid purple
      'Finance':      '#06b6d4',   // cyan-teal
      'Marketing':    '#10b981',   // emerald green
      'Sales':        '#f472b6',   // hot pink
      'Strategy':     '#818cf8',   // indigo-purple
      'HR':           '#34d399',   // mint green
      'Operations':   '#2dd4bf',   // teal
      'Legal':        '#c084fc',   // lavender purple
      'Healthcare':   '#38bdf8',   // sky blue
      'Real Estate':  '#fb7185',   // rose pink
      'Sports':       '#a3e635',   // lime green
      'Unknown':      '#475569',   // slate neutral
    }

    const DEFAULT_COLOR = '#6366f1'  // fallback indigo for uncategorized

    function EmbeddingTooltip({ active, payload }: { active?: boolean; payload?: { payload: EmbeddingPoint }[] }) {
      if (!active || !payload?.length) return null
      const pt = payload[0].payload
      return (
        <div className="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs shadow-lg">
          <p className="text-white font-medium">{pt.name || pt.username}</p>
          <p className="text-slate-400">{pt.category}</p>
        </div>
      )
    }
    ```

    **Change 3 — Add useEmbeddingMap hook call and chart section inside the component**:

    Inside `IntelligenceDashboardPage`, after the existing hook calls at the top of the function body, add:
    ```typescript
    const { data: embeddingData, status: embeddingStatus } = useEmbeddingMap()
    ```

    Then add the `byCategory` useMemo inside the component (after the hook call):
    ```typescript
    const byCategory = useMemo(() => {
      const groups: Record<string, EmbeddingPoint[]> = {}
      for (const pt of embeddingData?.points ?? []) {
        const cat = pt.category || 'Unknown'
        if (!groups[cat]) groups[cat] = []
        groups[cat].push(pt)
      }
      return groups
    }, [embeddingData])
    ```

    Finally, add the chart section in the JSX return, placed **below** the existing Phase 25 metrics grid (the `<div className="grid grid-cols-2 gap-4">` block), and **above** the `{/* Header */}` div:

    ```tsx
    {/* Embedding Map — t-SNE scatter plot of expert embeddings */}
    <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5 space-y-4">
      <div>
        <h2 className="text-sm font-semibold text-white">Expert Embedding Map</h2>
        <p className="text-xs text-slate-500 mt-1">
          t-SNE projection of all {embeddingData?.count ?? '—'} expert embeddings — clusters indicate semantic similarity. Recomputes after index rebuild.
        </p>
      </div>

      {embeddingStatus === 'loading' || embeddingStatus === 'computing' ? (
        <div className="flex items-center gap-3 py-12 justify-center">
          <div className="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin" />
          <span className="text-sm text-slate-400">
            {embeddingStatus === 'computing' ? 'Computing t-SNE projection… (up to 30s)' : 'Loading…'}
          </span>
        </div>
      ) : embeddingStatus === 'error' ? (
        <div className="py-8 text-center text-sm text-slate-500">
          Failed to load embedding map. Refresh to retry.
        </div>
      ) : embeddingData && Object.keys(byCategory).length > 0 ? (
        <ResponsiveContainer width="100%" height={480}>
          <ScatterChart margin={{ top: 8, right: 8, bottom: 8, left: 8 }}>
            <XAxis dataKey="x" type="number" domain={['auto', 'auto']} hide />
            <YAxis dataKey="y" type="number" domain={['auto', 'auto']} hide />
            <Tooltip content={<EmbeddingTooltip />} />
            <Legend
              wrapperStyle={{ fontSize: '11px', paddingTop: '12px' }}
              iconSize={8}
            />
            {Object.entries(byCategory).map(([cat, pts]) => (
              <Scatter
                key={cat}
                name={cat}
                data={pts}
                fill={CATEGORY_COLORS[cat] ?? DEFAULT_COLOR}
                opacity={0.85}
                r={4}
              />
            ))}
          </ScatterChart>
        </ResponsiveContainer>
      ) : (
        <div className="py-8 text-center text-sm text-slate-500">No embedding data available.</div>
      )}
    </div>
    ```

    Ensure `useMemo` is imported from 'react' — add it to the existing react import: `import { useState, useEffect, useRef, useMemo } from 'react'`.
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — no type errors.
    Run `cd frontend && npm run build` — Vite build succeeds with no module resolution errors.
    Grep for `ScatterChart` in IntelligenceDashboardPage.tsx — present.
    Grep for `useEmbeddingMap` in IntelligenceDashboardPage.tsx — present.
    Grep for `CATEGORY_COLORS` in IntelligenceDashboardPage.tsx — present.
  </verify>
  <done>
    IntelligenceDashboardPage.tsx imports and uses useEmbeddingMap hook.
    ScatterChart renders with category-grouped Scatter components using jewel-tone CATEGORY_COLORS.
    EmbeddingTooltip shows expert name and category on hover.
    Computing state shows spinner with "Computing t-SNE projection… (up to 30s)" message.
    Error state shows graceful fallback message.
    `npm run build` passes without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human visual verification of embedding scatter plot</name>
  <action>Push to main (auto-deploys to Railway + Vercel). Visit https://tcs-three-sigma.vercel.app/admin, navigate to the Intelligence tab, and verify: scatter plot renders within 30s with ~530 colored points, hovering shows expert name tooltip, existing Phase 25 metrics are unaffected.</action>
  <verify>Human observation at https://tcs-three-sigma.vercel.app/admin/intelligence — scatter plot visible with category-colored points and working tooltips.</verify>
  <done>Admin confirms scatter plot renders correctly with jewel-tone colored points and expert-name tooltips.</done>
  <what-built>
    Backend: GET /api/admin/embedding-map endpoint that returns 202 while t-SNE computes and 200 with 530 expert points when ready.
    Frontend: Recharts ScatterChart in the admin Intelligence tab with category-colored jewel-tone points, expert-name tooltips, and a computing spinner state.
  </what-built>
  <how-to-verify>
    1. Push to main and wait for Railway deploy (auto-deploys on push).
    2. Visit https://tcs-three-sigma.vercel.app/admin and log in.
    3. Navigate to the Intelligence tab.
    4. Within 30 seconds of deploy: the "Expert Embedding Map" section should appear. It may show the computing spinner for up to 30 seconds, then transition to the scatter plot.
    5. Verify scatter plot shows ~530 colored points grouped by category.
    6. Hover over individual points — expert name and category should appear in a tooltip.
    7. Check that the legend lists all categories with their jewel-tone colors.
    8. Verify existing Phase 25 metrics (OTR@K card, Index Drift card) still render correctly above the chart.
    9. Optional: Trigger an index rebuild from the Index tab, then refresh the Intelligence tab. After ~30s the chart should reflect the new embedding computation.
  </how-to-verify>
  <resume-signal>Type "approved" if the scatter plot renders correctly with colored points and tooltips, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
Overall phase checks:
1. `cd frontend && npm run build` exits 0 — no Recharts import errors
2. `cd frontend && npx tsc --noEmit` — no TypeScript errors
3. Python syntax check on both modified backend files passes
4. GET /api/admin/embedding-map returns 202 immediately after startup
5. GET /api/admin/embedding-map returns 200 with {status: ready, points: [...]} after ~30s
6. Intelligence tab chart visible with category-colored points and name tooltips
7. Phase 25 OTR@K and Index Drift cards unaffected
</verification>

<success_criteria>
- recharts in frontend/package.json
- EmbeddingPoint, EmbeddingMapResponse, EmbeddingMapComputing in frontend/src/admin/types.ts
- useEmbeddingMap hook in useAdminData.ts polls every 5s, handles 202 without throwing
- IntelligenceDashboardPage.tsx renders ScatterChart with CATEGORY_COLORS jewel-tone palette below Phase 25 metrics cards
- Computing spinner appears while 202 responses arrive; chart renders on 200
- Human verifies scatter plot, tooltips, and no regressions on Phase 25 metrics
</success_criteria>

<output>
After completion, create `.planning/phases/26-embedding-heatmap/26-02-SUMMARY.md`
</output>
