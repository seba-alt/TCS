---
phase: 34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch
plan: 02
subsystem: api
tags: [gemini, language-detection, translation, dutch, pilot-service, faiss]

requires:
  - phase: 28-sage-search-engine
    provides: search_experts function calling in pilot_service.py
provides:
  - Dutch auto-detection via gemini-2.0-flash-lite
  - English translation pipeline for FAISS search queries
  - Dutch system prompt injection for Sage responses
affects: [sage-copilot, pilot-service, user-experience]

tech-stack:
  added: []
  patterns: [language-detection-translation, structured-json-extraction]

key-files:
  created: []
  modified: [app/services/pilot_service.py]

key-decisions:
  - "Used gemini-2.0-flash-lite for detection — fast structured JSON extraction, not complex reasoning"
  - "Only search_experts path translates queries — apply_filters handles rate/tag adjustments without text"
  - "Original Dutch message passed to Gemini in contents — only FAISS search uses English translation"
  - "Fallback run_explore also uses translated query for consistent FAISS matching"
  - "Expert names/titles kept in English as proper nouns — data is not translatable content"

patterns-established:
  - "Language detection at top of run_pilot: detect once, use translation for search, inject prompt for response language"

requirements-completed: [DUTCH-SAGE]

duration: 5min
completed: 2026-02-23
---

# Plan 34.1-02: Dutch Sage Language Support Summary

**Added auto-detection of Dutch input with Gemini flash-lite translation for FAISS search and Dutch system prompt injection for Sage responses**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-23
- **Completed:** 2026-02-23
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- `_detect_and_translate()` helper using gemini-2.0-flash-lite with structured JSON response
- Language detection wired at top of `run_pilot()` before any search/filter logic
- Dutch system prompt injection when `detected_lang == "nl"`
- English-translated query passed through to `_handle_search_experts` for FAISS search
- Safe fallback to English on any detection error

## Task Commits

1. **Task 1: Add _detect_and_translate helper** - `eda1588` (feat)
2. **Task 2: Wire language detection into run_pilot** - `eda1588` (feat, same commit)

## Files Created/Modified
- `app/services/pilot_service.py` - Added `_detect_and_translate()`, wired into `run_pilot()`, updated `_handle_search_experts` with `search_message` parameter

## Decisions Made
None - followed plan as specified

## Deviations from Plan
None - plan executed exactly as written

## Issues Encountered
None

## User Setup Required
None - no external service configuration required. Uses existing GOOGLE_API_KEY.

## Next Phase Readiness
- Dutch users can now interact with Sage in their native language
- FAISS search uses English translations for accurate expert matching
- English queries unaffected — detection falls through silently

---
*Phase: 34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch*
*Completed: 2026-02-23*
