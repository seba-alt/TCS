---
phase: 34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch
plan: 01
subsystem: api
tags: [sqlalchemy, sqlite, null-safety, admin, gap-detection]

requires:
  - phase: 31-admin-marketplace-intelligence
    provides: admin gap analytics endpoints and queries
provides:
  - NULL-safe gap conditions across all 8 query sites in admin.py
  - _is_gap() helper treating None as gap
affects: [admin-dashboard, gap-analytics, csv-exports]

tech-stack:
  added: []
  patterns: [null-safe-gap-detection, is_none-orm-predicate]

key-files:
  created: []
  modified: [app/routers/admin.py]

key-decisions:
  - "Used .is_(None) for ORM predicates, IS NULL for raw SQL — consistent SQLAlchemy best practice"
  - "gap_flag=False branches now use is_not(None) & >= threshold to explicitly exclude NULLs"
  - "_is_gap() uses 'is None or' instead of 'is not None and' — NULL = no candidates = gap by definition"

patterns-established:
  - "NULL-safe gap detection: always include .is_(None) in gap predicates to catch zero-candidate searches"

requirements-completed: [GAP-NULL-FIX]

duration: 5min
completed: 2026-02-23
---

# Plan 34.1-01: NULL Gap Fix Summary

**Patched all 8 NULL gap conditions in admin.py so zero-candidate searches appear in gap analytics, counters, trend charts, and CSV exports**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-23
- **Completed:** 2026-02-23
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- Fixed `_is_gap()` helper: `None or < threshold` instead of `not None and < threshold`
- Added `.is_(None)` to 6 ORM predicates (get_stats, get_intelligence_stats, get_searches x2, get_gaps, export_searches_csv x2, export_gaps_csv)
- Added `IS NULL` to raw SQL daily trend CASE WHEN in get_intelligence_stats
- Added `is_not(None)` to gap_flag=False branches for explicit NULL exclusion

## Task Commits

1. **Task 1: Patch all 8 NULL gap conditions + _is_gap helper** - `beabdd4` (fix)
2. **Task 2: Handle NULL best_score display in frontend** - No changes needed, backend serialization confirmed safe

## Files Created/Modified
- `app/routers/admin.py` - 8 NULL-safe gap condition patches + _is_gap helper fix

## Decisions Made
None - followed plan as specified

## Deviations from Plan
None - plan executed exactly as written

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Gap analytics now correctly include zero-candidate searches
- Admin Overview, Searches, Gaps pages all show complete gap data
- Ready for Phase 34.1-02 (Dutch Sage)

---
*Phase: 34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch*
*Completed: 2026-02-23*
