---
phase: 46-frontend-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/vite.config.ts
autonomous: true
requirements:
  - PERF-01
  - PERF-02

must_haves:
  truths:
    - "Public Explorer page does not include admin JS in its initial bundle"
    - "Recharts and react-table ship as separate chunks that only load when admin panel is visited"
    - "A Suspense fallback with dark background renders while admin chunks load — no blank screen or white flash"
    - "Vite build produces multiple chunks instead of one monolithic bundle"
    - "All admin routes still function correctly after lazy-loading"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "React.lazy imports for all admin components, Suspense boundaries, AdminLoadingFallback"
      contains: "lazy(() => import("
    - path: "frontend/vite.config.ts"
      provides: "manualChunks configuration for recharts and react-table"
      contains: "manualChunks"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/admin/AdminApp.tsx"
      via: "React.lazy dynamic import"
      pattern: "lazy\\(\\(\\) => import\\('./admin/AdminApp'\\)\\)"
    - from: "frontend/src/main.tsx"
      to: "frontend/src/admin/RequireAuth.tsx"
      via: "React.lazy dynamic import"
      pattern: "lazy\\(\\(\\) => import\\('./admin/RequireAuth'\\)\\)"
    - from: "frontend/vite.config.ts"
      to: "node_modules/recharts"
      via: "manualChunks function"
      pattern: "id\\.includes\\('recharts'\\)"
---

<objective>
Lazy-load all admin routes and split large vendor libraries into separate chunks so public Explorer users download a smaller initial bundle.

Purpose: Public users currently download 1,261 kB of JS including all admin code (Recharts, react-table, 8+ admin pages). After this plan, the public bundle drops to ~250 kB and admin code loads on demand only when navigating to /admin.

Output: Updated main.tsx with React.lazy imports + Suspense boundaries, updated vite.config.ts with manualChunks configuration.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-frontend-performance-optimization/46-RESEARCH.md

@frontend/src/main.tsx
@frontend/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert admin imports to React.lazy and add Suspense boundaries</name>
  <files>frontend/src/main.tsx</files>
  <action>
Replace all static admin component imports with React.lazy dynamic imports and add Suspense boundaries around admin routes.

1. Add `lazy` and `Suspense` to the React import at the top of the file.

2. Remove all static admin imports (lines 8-18 importing AdminApp, LoginPage, RequireAuth, OverviewPage, GapsPage, LeadsPage, ExpertsPage, SettingsPage, IntelligenceDashboardPage, ToolsPage, DataPage).

3. Replace them with React.lazy versions:
```typescript
const AdminApp = lazy(() => import('./admin/AdminApp'))
const LoginPage = lazy(() => import('./admin/LoginPage'))
const RequireAuth = lazy(() => import('./admin/RequireAuth'))
const OverviewPage = lazy(() => import('./admin/pages/OverviewPage'))
const GapsPage = lazy(() => import('./admin/pages/GapsPage'))
const LeadsPage = lazy(() => import('./admin/pages/LeadsPage'))
const ExpertsPage = lazy(() => import('./admin/pages/ExpertsPage'))
const SettingsPage = lazy(() => import('./admin/pages/SettingsPage'))
const IntelligenceDashboardPage = lazy(() => import('./admin/pages/IntelligenceDashboardPage'))
const ToolsPage = lazy(() => import('./admin/pages/ToolsPage'))
const DataPage = lazy(() => import('./admin/pages/DataPage'))
```

4. Add an AdminLoadingFallback component BEFORE the router definition:
```typescript
function AdminLoadingFallback() {
  return (
    <div className="flex h-screen items-center justify-center bg-slate-950" role="status" aria-live="polite">
      <span className="text-slate-400 text-sm">Loading…</span>
    </div>
  )
}
```
Use `bg-slate-950` to match the admin panel's dark background and prevent a white flash.

5. Wrap the `/admin/login` route element with Suspense:
```typescript
{
  path: '/admin/login',
  element: (
    <Suspense fallback={<AdminLoadingFallback />}>
      <LoginPage />
    </Suspense>
  ),
},
```

6. Wrap the `/admin` route element with Suspense:
```typescript
{
  path: '/admin',
  element: (
    <Suspense fallback={<AdminLoadingFallback />}>
      <RequireAuth />
    </Suspense>
  ),
  children: [ ... unchanged ... ],
},
```

One Suspense boundary on RequireAuth covers all nested lazy admin children — do NOT wrap individual admin pages with separate Suspense boundaries.

7. Keep ALL existing functionality unchanged:
   - Static imports for RootLayout and MarketplacePage (public critical path)
   - The RedirectWithParams component stays inline (it is for public redirect routes)
   - All Navigate redirects within admin children stay as-is (Navigate is from react-router-dom, not a lazy component)
   - Legacy redirect routes (/explore, /browse, /marketplace, /chat) stay unchanged

All admin components are confirmed to use default exports, so React.lazy will work without any `.then(m => ...)` wrapping.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify main.tsx has no static admin imports remaining and all admin routes use lazy() + Suspense</manual>
  </verify>
  <done>All 11 admin component imports use React.lazy, /admin and /admin/login routes are wrapped with Suspense + AdminLoadingFallback, public routes remain static imports, TypeScript compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add Vite manualChunks and verify build output</name>
  <files>frontend/vite.config.ts</files>
  <action>
Add manualChunks configuration to vite.config.ts and verify the build produces smaller, correctly split chunks.

1. Add `build.rollupOptions.output.manualChunks` to the existing `defineConfig` in `vite.config.ts`:

```typescript
export default defineConfig({
  plugins: [
    react(),
    sentryVitePlugin({
      org: process.env.SENTRY_ORG,
      project: process.env.SENTRY_PROJECT,
      authToken: process.env.SENTRY_AUTH_TOKEN,
      disable: !process.env.SENTRY_AUTH_TOKEN,
    }),
  ],
  build: {
    rollupOptions: {
      output: {
        manualChunks(id) {
          if (id.includes('node_modules')) {
            if (id.includes('recharts')) return 'vendor-charts'
            if (id.includes('@tanstack/react-table')) return 'vendor-table'
          }
        },
      },
    },
  },
  test: {
    environment: 'node',
    globals: true,
  },
})
```

Only split recharts and @tanstack/react-table — these are the two large libraries used exclusively in admin pages. Do NOT split react/react-dom into a separate chunk (keep the project simple; the research noted this as optional and the cache benefit is marginal for this traffic profile).

2. Run `npm run build` in the frontend directory and verify:
   - Build succeeds without errors or circular dependency warnings
   - Output shows MULTIPLE JS chunks instead of one monolithic bundle
   - No individual chunk exceeds 500 kB (Vite's warning threshold)
   - A `vendor-charts` chunk appears in output (recharts)
   - A `vendor-table` chunk appears in output (@tanstack/react-table)
   - The main index chunk is significantly smaller than the previous 1,261 kB

3. If the build succeeds, record the chunk sizes in the commit message for before/after comparison.

The existing Sentry vite plugin is compatible with manualChunks — no changes needed to Sentry configuration.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -30</automated>
    <manual>Check build output for multiple chunks, no chunk over 500 kB, vendor-charts and vendor-table chunks present</manual>
  </verify>
  <done>Vite build produces split chunks: vendor-charts (recharts), vendor-table (@tanstack/react-table), admin lazy chunks, and a smaller main index chunk. No single chunk exceeds 500 kB. No build warnings about chunk size.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` — succeeds with no errors, no circular dependency warnings
2. Build output shows multiple JS chunks (not one monolithic 1,261 kB bundle)
3. No chunk exceeds 500 kB (Vite's warning threshold)
4. `vendor-charts-[hash].js` and `vendor-table-[hash].js` chunks appear in dist/assets/
5. `npx tsc --noEmit` passes — no TypeScript errors introduced
6. The main index chunk is under 200 kB (public bundle without admin code)
</verification>

<success_criteria>
- Public users visiting the Explorer download only the main bundle (~100-250 kB) without admin code
- Admin code (AdminApp, all admin pages, Recharts, react-table) loads on demand when navigating to /admin
- Vite build output shows recharts in a separate vendor-charts chunk and react-table in a separate vendor-table chunk
- No blank screen while admin chunks load — dark-themed loading fallback renders
- Build completes without warnings about chunks exceeding 500 kB
</success_criteria>

<output>
After completion, create `.planning/phases/46-frontend-performance-optimization/46-01-SUMMARY.md`
</output>
