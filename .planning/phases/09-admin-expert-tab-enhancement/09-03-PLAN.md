---
phase: 09-admin-expert-tab-enhancement
plan: "03"
type: execute
wave: 3
depends_on:
  - "09-02"
files_modified:
  - frontend/src/admin/pages/ExpertsPage.tsx
autonomous: false
requirements:
  - ADMIN-01
  - ADMIN-02
  - ADMIN-03
  - ADMIN-04
  - ADMIN-05
  - ADMIN-06
  - SEARCH-07

must_haves:
  truths:
    - "Admin opens Expert tab and sees a merged Name column (First + Last) as the first column"
    - "Each row shows bio truncated to ~120 characters"
    - "Each row shows profile URL as a clickable external-link icon only (no link text)"
    - "Each row shows up to 2 tag pills; remaining count shown as '+N'"
    - "Each row shows a color-coded findability score badge: red 0-39, yellow 40-69, green 70-100"
    - "Table defaults to ascending findability score order (worst first), matching API default"
    - "All 5 column headers are clickable to re-sort asc/desc"
    - "Zone filter buttons (Red/Yellow/Green) appear above the table and filter rows by score band"
    - "Pagination controls (Prev / Page N of M / Next) appear below the table, 50 experts per page"
    - "Page index resets to 0 whenever sort, zone filter, or tag filter changes"
    - "Domain-map collapsible section appears below pagination; shows top-10 domains with counts"
    - "Clicking a domain in the domain-map sets a tag filter that narrows the expert table"
    - "Text search input and its associated state are removed from the actions bar"
  artifacts:
    - path: "frontend/src/admin/pages/ExpertsPage.tsx"
      provides: "Rebuilt Expert tab with sort/filter/pagination/domain-map"
      min_lines: 200
      contains: "scoreZone"
  key_links:
    - from: "frontend/src/admin/pages/ExpertsPage.tsx"
      to: "useAdminExperts hook"
      via: "const { experts } = useAdminExperts() — fetches all experts on mount"
      pattern: "useAdminExperts"
    - from: "frontend/src/admin/pages/ExpertsPage.tsx"
      to: "useAdminDomainMap hook"
      via: "const { data: domainData, fetchData: fetchDomainMap } = useAdminDomainMap()"
      pattern: "useAdminDomainMap"
    - from: "frontend/src/admin/pages/ExpertsPage.tsx sort state"
      to: "useMemo sorted derivation"
      via: "useMemo(() => [...experts].sort(...), [experts, sortCol, sortDir])"
      pattern: "useMemo.*sort"
    - from: "frontend/src/admin/pages/ExpertsPage.tsx domain-map click"
      to: "tagFilter state"
      via: "onClick={() => setTagFilter(d.domain)} filters expert table by clicked domain"
      pattern: "setTagFilter"
---

<objective>
Rebuild ExpertsPage.tsx into a quality-gate tool: sortable columns, zone filter (Red/Yellow/Green), tag filter via domain-map click-through, 50-per-page pagination, and a collapsible domain-map section showing which tag domains appear most in downvoted results.

Purpose: This is the primary user-facing output of Phase 9 — the admin can now inspect enriched expert data and identify quality gaps at a glance.
Output: Rebuilt `frontend/src/admin/pages/ExpertsPage.tsx` with all Phase 9 features, followed by a human verification checkpoint.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/09-admin-expert-tab-enhancement/09-02-SUMMARY.md
@frontend/src/admin/pages/ExpertsPage.tsx
@frontend/src/admin/types.ts
@frontend/src/admin/hooks/useAdminData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild ExpertsPage.tsx with sort, filter, pagination, and domain-map</name>
  <files>frontend/src/admin/pages/ExpertsPage.tsx</files>
  <action>
    Rewrite frontend/src/admin/pages/ExpertsPage.tsx. Keep the existing file's imports, page shell (title, actions bar structure, auto-classify button) but replace the table and add domain-map. Specific requirements below.

    --- IMPORTS ---
    Add to imports: `useAdminDomainMap` from '../hooks/useAdminData', `DomainMapEntry` from '../types', `useMemo`, `useEffect`, `useCallback` from 'react' (add any not already imported).

    --- STATE ---
    Remove: `search` state, `setSearch` (and any text search filter logic).
    Add:
    ```typescript
    const [sortCol, setSortCol] = useState<string>('score')
    const [sortDir, setSortDir] = useState<'asc' | 'desc'>('asc')
    const [zoneFilter, setZoneFilter] = useState<'red' | 'yellow' | 'green' | null>(null)
    const [tagFilter, setTagFilter] = useState<string | null>(null)
    const [pageIdx, setPageIdx] = useState(0)
    const [showDomainMap, setShowDomainMap] = useState(false)
    ```
    Add domain-map hook:
    ```typescript
    const { data: domainData, loading: domainLoading, fetchData: fetchDomainMap } = useAdminDomainMap()
    ```

    --- HELPER FUNCTIONS (inline or at top of component) ---

    scoreZone helper:
    ```typescript
    function scoreZone(score: number | null | undefined): 'red' | 'yellow' | 'green' | 'none' {
      if (score === null || score === undefined) return 'none'
      if (score < 40) return 'red'
      if (score < 70) return 'yellow'
      return 'green'
    }
    ```

    ZONE_STYLES constant:
    ```typescript
    const ZONE_STYLES: Record<string, string> = {
      red:    'bg-red-500/20 text-red-400 border border-red-500/30',
      yellow: 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30',
      green:  'bg-green-500/20 text-green-400 border border-green-500/30',
      none:   'bg-slate-700/40 text-slate-500 border border-transparent',
    }
    ```

    SortHeader sub-component (inline, above the main return):
    ```typescript
    function SortHeader({ col, label, current, dir, onClick }: {
      col: string; label: string; current: string; dir: 'asc' | 'desc'; onClick: (col: string) => void
    }) {
      const active = current === col
      return (
        <th
          className="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider cursor-pointer select-none hover:text-slate-300"
          onClick={() => onClick(col)}
        >
          {label}
          {active && <span className="ml-1 opacity-70">{dir === 'asc' ? '\u2191' : '\u2193'}</span>}
        </th>
      )
    }
    ```

    ScoreBadge sub-component:
    ```typescript
    function ScoreBadge({ score }: { score: number | null | undefined }) {
      const zone = scoreZone(score)
      return (
        <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${ZONE_STYLES[zone]}`}>
          {score !== null && score !== undefined ? Math.round(score) : '\u2014'}
        </span>
      )
    }
    ```

    TagPills sub-component:
    ```typescript
    function TagPills({ tags }: { tags: string[] }) {
      const visible = tags.slice(0, 2)
      const remaining = tags.length - visible.length
      return (
        <div className="flex flex-wrap gap-1 items-center">
          {visible.map(tag => (
            <span key={tag} className="px-1.5 py-0.5 bg-slate-700/60 text-slate-300 text-xs rounded-md border border-slate-600/40 whitespace-nowrap">
              {tag}
            </span>
          ))}
          {remaining > 0 && (
            <span className="text-xs text-slate-500">+{remaining}</span>
          )}
        </div>
      )
    }
    ```

    --- DATA DERIVATIONS (useMemo) ---

    Sort handler:
    ```typescript
    const handleSort = useCallback((col: string) => {
      if (col === sortCol) {
        setSortDir(d => d === 'asc' ? 'desc' : 'asc')
      } else {
        setSortCol(col)
        setSortDir('asc')
      }
    }, [sortCol])
    ```

    Sorted experts:
    ```typescript
    const sorted = useMemo(() => {
      return [...(experts || [])].sort((a, b) => {
        if (sortCol === 'score') {
          const aScore = a.findability_score ?? -1
          const bScore = b.findability_score ?? -1
          return sortDir === 'asc' ? aScore - bScore : bScore - aScore
        }
        if (sortCol === 'name') {
          const aName = `${a.first_name} ${a.last_name}`.toLowerCase()
          const bName = `${b.first_name} ${b.last_name}`.toLowerCase()
          return sortDir === 'asc' ? aName.localeCompare(bName) : bName.localeCompare(aName)
        }
        return 0
      })
    }, [experts, sortCol, sortDir])
    ```

    Filtered experts:
    ```typescript
    const filtered = useMemo(() => {
      let result = sorted
      if (zoneFilter) result = result.filter(e => scoreZone(e.findability_score) === zoneFilter)
      if (tagFilter) result = result.filter(e => e.tags?.includes(tagFilter))
      return result
    }, [sorted, zoneFilter, tagFilter])
    ```

    Page data:
    ```typescript
    const totalPages = Math.max(1, Math.ceil(filtered.length / 50))
    const pageData = filtered.slice(pageIdx * 50, (pageIdx + 1) * 50)
    ```

    Reset page on filter/sort change:
    ```typescript
    useEffect(() => { setPageIdx(0) }, [zoneFilter, tagFilter, sortCol, sortDir])
    ```

    Domain-map toggle handler:
    ```typescript
    const handleToggleDomainMap = useCallback(() => {
      setShowDomainMap(v => !v)
      if (!domainData && !domainLoading) fetchDomainMap()
    }, [domainData, domainLoading, fetchDomainMap])
    ```

    --- ACTIONS BAR (above table) ---

    Remove: the text search `<input>` and its `onChange` handler.
    Keep: the auto-classify button (and its associated state/handler) and the "Add Expert" button.
    Add zone filter toggle buttons next to the existing buttons:

    ```tsx
    {/* Zone filter */}
    <div className="flex gap-1">
      {(['red', 'yellow', 'green'] as const).map(zone => (
        <button
          key={zone}
          onClick={() => setZoneFilter(zoneFilter === zone ? null : zone)}
          className={`px-3 py-1.5 text-xs font-semibold rounded-lg border transition-colors ${
            zoneFilter === zone
              ? zone === 'red'   ? 'bg-slate-800 border-red-500/50 text-red-400'
              : zone === 'yellow' ? 'bg-slate-800 border-yellow-500/50 text-yellow-400'
              :                     'bg-slate-800 border-green-500/50 text-green-400'
              : 'border-slate-700 text-slate-500 hover:border-slate-500 hover:text-slate-400'
          }`}
        >
          {zone.charAt(0).toUpperCase() + zone.slice(1)}
        </button>
      ))}
      {(zoneFilter || tagFilter) && (
        <button
          onClick={() => { setZoneFilter(null); setTagFilter(null) }}
          className="px-3 py-1.5 text-xs text-slate-500 hover:text-slate-300 transition-colors"
        >
          Clear
        </button>
      )}
    </div>
    ```

    If tagFilter is active, show a small indicator near the zone buttons:
    ```tsx
    {tagFilter && (
      <span className="text-xs text-slate-400">
        Filtered by tag: <span className="text-slate-200 font-medium">{tagFilter}</span>
      </span>
    )}
    ```

    --- TABLE ---

    Column set: 5 columns — Name | Bio | Tags | Link | Score
    Column widths: Name (w-40), Bio (flex-grow), Tags (w-40), Link (w-12 centered), Score (w-28)

    Table header row with SortHeader components:
    ```tsx
    <thead>
      <tr className="border-b border-slate-800">
        <SortHeader col="name"  label="Name"  current={sortCol} dir={sortDir} onClick={handleSort} />
        <th className="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Bio</th>
        <th className="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Tags</th>
        <th className="px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider text-center">Link</th>
        <SortHeader col="score" label="Score" current={sortCol} dir={sortDir} onClick={handleSort} />
      </tr>
    </thead>
    ```

    Table body row (map over pageData):
    ```tsx
    {pageData.map(expert => (
      <tr key={expert.username} className="border-b border-slate-800/60 hover:bg-slate-800/30 transition-colors">
        <td className="px-4 py-3 text-sm text-slate-200 font-medium whitespace-nowrap">
          {expert.first_name} {expert.last_name}
        </td>
        <td className="px-4 py-3 text-sm text-slate-400 max-w-xs">
          <span title={expert.bio || ''}>
            {expert.bio ? (expert.bio.length > 120 ? expert.bio.slice(0, 120) + '…' : expert.bio) : ''}
          </span>
        </td>
        <td className="px-4 py-3">
          <TagPills tags={expert.tags || []} />
        </td>
        <td className="px-4 py-3 text-center">
          {expert.profile_url && (
            <a
              href={expert.profile_url}
              target="_blank"
              rel="noopener noreferrer"
              className="text-slate-400 hover:text-slate-200 transition-colors"
              title={expert.profile_url}
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          )}
        </td>
        <td className="px-4 py-3">
          <ScoreBadge score={expert.findability_score} />
        </td>
      </tr>
    ))}
    ```

    Empty state row (update colSpan to 5):
    ```tsx
    {pageData.length === 0 && (
      <tr>
        <td colSpan={5} className="px-4 py-8 text-center text-slate-500 text-sm">
          {filtered.length === 0 ? 'No experts match the current filters.' : 'Loading experts...'}
        </td>
      </tr>
    )}
    ```

    --- PAGINATION (below table) ---

    ```tsx
    <div className="flex items-center justify-between px-4 py-3 border-t border-slate-800">
      <span className="text-sm text-slate-500">{filtered.length} expert{filtered.length !== 1 ? 's' : ''}</span>
      <div className="flex items-center gap-3 text-sm text-slate-400">
        <button
          disabled={pageIdx === 0}
          onClick={() => setPageIdx(p => p - 1)}
          className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 disabled:opacity-40 disabled:cursor-not-allowed rounded-lg transition-colors"
        >
          Prev
        </button>
        <span>Page {pageIdx + 1} of {totalPages}</span>
        <button
          disabled={pageIdx >= totalPages - 1}
          onClick={() => setPageIdx(p => p + 1)}
          className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 disabled:opacity-40 disabled:cursor-not-allowed rounded-lg transition-colors"
        >
          Next
        </button>
      </div>
    </div>
    ```

    --- DOMAIN-MAP SECTION (below pagination, outside table container) ---

    ```tsx
    <div className="mt-4">
      <button
        onClick={handleToggleDomainMap}
        className="flex items-center gap-2 text-sm text-slate-400 hover:text-slate-200 transition-colors font-medium"
      >
        <span>{showDomainMap ? '\u25BC' : '\u25BA'}</span>
        Domain Map — Top downvoted expert domains
      </button>

      {showDomainMap && (
        <div className="mt-3 bg-slate-800/40 rounded-xl border border-slate-700/50 p-4">
          {domainLoading && (
            <p className="text-sm text-slate-500">Loading domain map...</p>
          )}
          {!domainLoading && domainData && domainData.domains.length === 0 && (
            <p className="text-sm text-slate-500">No downvoted results recorded yet.</p>
          )}
          {!domainLoading && domainData && domainData.domains.length > 0 && (
            <div>
              <p className="text-xs text-slate-500 mb-3">
                Click a domain to filter the expert table. Showing top {domainData.domains.length} domains by downvote count.
              </p>
              <div className="space-y-1.5">
                {domainData.domains.map((d: DomainMapEntry) => (
                  <button
                    key={d.domain}
                    onClick={() => setTagFilter(tagFilter === d.domain ? null : d.domain)}
                    className={`flex items-center justify-between w-full px-3 py-1.5 rounded-lg text-sm transition-colors text-left ${
                      tagFilter === d.domain
                        ? 'bg-slate-700 text-slate-200'
                        : 'hover:bg-slate-700/50 text-slate-300'
                    }`}
                  >
                    <span className="capitalize">{d.domain}</span>
                    <span className="text-xs text-slate-500 ml-4">{d.count} downvote{d.count !== 1 ? 's' : ''}</span>
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
    ```

    --- PITFALL GUARDS ---
    1. Remove `search` state and the search input entirely — do NOT leave stale references.
    2. The existing auto-classify button and its related state (classifyLoading, classifyResult) MUST be preserved. Only remove the search input.
    3. `colSpan` in empty-state row must be 5 (not the old value).
    4. `DomainMapEntry` must be imported from '../types' for the map callback type annotation.
    5. Sub-components (SortHeader, ScoreBadge, TagPills) can be defined inside the file — either inline above the main component or as named functions at module level. Do NOT create separate files.
  </action>
  <verify>
    Build the frontend:
    ```
    cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20
    ```
    Expected: Build succeeds with no TypeScript errors. Warnings about unused variables are acceptable; errors are not.
  </verify>
  <done>
    ExpertsPage.tsx compiles without errors. The file contains: scoreZone helper, SortHeader/ScoreBadge/TagPills sub-components, sort/filter/pagination state, useMemo derivations, zone filter buttons, sortable column headers, table with 5 columns and colSpan=5 in empty state, pagination controls, and a collapsible domain-map section. No search input or search state remains.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Expert tab</name>
  <what-built>
    Full Phase 9 Admin Expert Tab Enhancement:
    - Backend: `_serialize_expert()` now returns tags (parsed array) and findability_score; GET /api/admin/experts defaults to ascending findability_score order; GET /api/admin/domain-map endpoint added
    - Frontend types: ExpertRow has tags and findability_score; DomainMapEntry/DomainMapResponse interfaces added; useAdminDomainMap hook added
    - Frontend UI: ExpertsPage rebuilt with merged Name column, bio preview, tag pills (2 max), profile URL icon, color-coded score badge, sortable headers, zone filter buttons, 50-per-page pagination, and a collapsible domain-map section
  </what-built>
  <how-to-verify>
    1. Start the backend: `cd /Users/sebastianhamers/Documents/TCS && uvicorn app.main:app --reload --port 8000`
    2. Start the frontend: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run dev`
    3. Open http://localhost:5173 in the browser and log in to the admin panel
    4. Navigate to the Expert tab and verify:
       a. Table has 5 columns: Name | Bio | Tags | Link | Score (not the old Username-based columns)
       b. Name column shows "First Last" (e.g., "John Smith") — not raw username
       c. Bio column shows truncated text (~120 chars) for experts with bios; blank for those without
       d. Tags column shows up to 2 small pill badges; experts without tags show nothing
       e. Link column shows a small external-link icon for experts with a profile_url; blank otherwise
       f. Score column shows a colored badge: red for 0–39, yellow for 40–69, green for 70–100; dash (—) for null scores
       g. Table defaults to worst-first order (lowest or null scores at the top)
       h. Clicking "Score" column header reverses the sort direction (arrow toggles)
       i. Clicking "Name" column header sorts alphabetically asc/desc
       j. Zone filter buttons (Red / Yellow / Green) appear — clicking one narrows the table to that score band
       k. Clicking an active zone button again deselects it (returns to All)
       l. "Prev" / "Next" pagination controls appear below the table; "Page 1 of N" shows correct count
       m. Clicking "Next" advances to page 2 (50 more experts); "Prev" is disabled on page 1
    5. Open the domain-map section:
       a. Click "Domain Map — Top downvoted expert domains" toggle
       b. Section expands and shows either "Loading domain map..." briefly, then renders results (or "No downvoted results recorded yet" if DB is empty)
       c. If domains appear: clicking one filters the expert table to show only experts with that tag
       d. The active tag filter is indicated in the actions bar
       e. Clicking the same domain again clears the filter
    6. Verify the search input is gone — no text search box appears in the actions bar
    7. Verify the auto-classify button is still present in the actions bar
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
  <action>Human checkpoint — no automated action. Verify the built UI as described in how-to-verify.</action>
  <verify>Visual inspection per how-to-verify checklist above.</verify>
  <done>Admin confirms all Expert tab features work correctly: columns, sort, filter, pagination, domain-map.</done>
</task>

</tasks>

<verification>
Frontend build succeeds (`npm run build` exits 0). Visual inspection confirms all CONTEXT.md locked decisions are implemented: merged Name column, icon-only profile link, 2-tag limit, worst-first default sort, zone filter buttons, 50-per-page pagination, domain-map collapsible section with click-to-filter.
</verification>

<success_criteria>
- `npm run build` in frontend/ exits cleanly with no TypeScript errors
- Expert tab shows all enriched fields (name, bio, tags, link icon, score badge) in correct column order
- Sort, zone filter, tag filter (from domain-map), and pagination all function correctly
- Domain-map section expands/collapses, fetches lazily on first open, and filters the table when a domain is clicked
- No text search input remains in the UI
- Auto-classify button is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-expert-tab-enhancement/09-03-SUMMARY.md`
</output>
