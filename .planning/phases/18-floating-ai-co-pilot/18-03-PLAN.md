---
phase: 18-floating-ai-co-pilot
plan: "03"
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/src/components/marketplace/EmptyState.tsx
autonomous: true
requirements: [PILOT-01, PILOT-03]

must_haves:
  truths:
    - "SageFAB is visible at all times in the bottom-right corner of MarketplacePage"
    - "Clicking the FAB opens SagePanel which slides in from the right (380px desktop, full-screen mobile)"
    - "When SagePanel is open the FAB disappears; SagePanel has its own X close button"
    - "Clicking outside the panel on mobile closes it (backdrop div)"
    - "EmptyState 'Try the AI Co-Pilot' button opens SagePanel"
  artifacts:
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "SageFAB and SagePanel wired with AnimatePresence"
      contains: "SageFAB"
    - path: "frontend/src/components/marketplace/EmptyState.tsx"
      provides: "Co-pilot CTA wired to setOpen(true)"
      contains: "setOpen"
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/components/pilot/SageFAB.tsx"
      via: "conditional render based on isOpen"
      pattern: "SageFAB"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/components/pilot/SagePanel.tsx"
      via: "AnimatePresence + conditional render"
      pattern: "SagePanel"
    - from: "frontend/src/components/marketplace/EmptyState.tsx"
      to: "frontend/src/store/pilotSlice.ts"
      via: "setOpen(true) on button click"
      pattern: "setOpen"
---

<objective>
Wire SageFAB and SagePanel into MarketplacePage and connect the EmptyState co-pilot CTA to open the panel.

Purpose: The components from Plan 02 exist but aren't rendered anywhere yet. This plan connects them: FAB always visible, panel slides in on open, FAB hides when panel open, click-outside closes on mobile. Also wires the Phase 17 EmptyState CTA (which was a placeholder) to actually open Sage.

Output: MarketplacePage updated with FAB + panel + backdrop. EmptyState CTA wired. Build passes.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/18-floating-ai-co-pilot/18-02-SUMMARY.md
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/components/marketplace/EmptyState.tsx
@frontend/src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire SageFAB + SagePanel into MarketplacePage</name>
  <files>frontend/src/pages/MarketplacePage.tsx</files>
  <action>
Update frontend/src/pages/MarketplacePage.tsx to render SageFAB and SagePanel.

Read the current file carefully first. Preserve ALL existing layout (FilterSidebar, MobileFilterSheet, ExpertGrid, mobile toolbar, desktop header, FilterChips). Only ADD the pilot components at the root level.

Changes to make:

1. Add imports at top:
```tsx
import { AnimatePresence } from 'motion/react'
import { SageFAB } from '../components/pilot/SageFAB'
import { SagePanel } from '../components/pilot/SagePanel'
```

2. Add isOpen selector from pilotSlice (individual selector — Phase 16 pattern):
```tsx
const isOpen = useExplorerStore((s) => s.isOpen)
const setOpen = useExplorerStore((s) => s.setOpen)
```

3. At the bottom of the returned JSX (AFTER the MobileFilterSheet closing tag, BEFORE the final closing div), add:

```tsx
      {/* Sage Co-Pilot — FAB hides when panel is open (per CONTEXT.md locked decision) */}
      <AnimatePresence>
        {!isOpen && <SageFAB key="sage-fab" />}
      </AnimatePresence>

      {/* Sage Panel + mobile backdrop */}
      <AnimatePresence>
        {isOpen && (
          <>
            {/* Mobile backdrop — click to close (desktop panel doesn't need full backdrop) */}
            <div
              key="sage-backdrop"
              className="fixed inset-0 z-30 bg-black/20 md:hidden"
              onClick={() => setOpen(false)}
            />
            <SagePanel key="sage-panel" />
          </>
        )}
      </AnimatePresence>
```

CRITICAL: The root div of MarketplacePage already has `className="flex min-h-screen bg-white"` with NO overflow — this must not be changed (sticky sidebar constraint from Phase 16). The fixed-positioned FAB and panel sit outside the normal flow so they don't affect this.
  </action>
  <verify>
    npm run build from frontend/ — must exit 0.
    grep -n "SageFAB\|SagePanel\|AnimatePresence" frontend/src/pages/MarketplacePage.tsx — all three appear.
    grep -n "isOpen\|setOpen" frontend/src/pages/MarketplacePage.tsx — pilot state selectors present.
  </verify>
  <done>
    MarketplacePage imports and renders SageFAB and SagePanel.
    FAB hidden when isOpen (AnimatePresence with conditional render).
    SagePanel shown with mobile backdrop (click to close) when isOpen.
    AnimatePresence wraps both FAB and panel for mount/unmount animations.
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire EmptyState co-pilot CTA to open Sage</name>
  <files>frontend/src/components/marketplace/EmptyState.tsx</files>
  <action>
Update frontend/src/components/marketplace/EmptyState.tsx to wire the "Try the AI Co-Pilot" button to actually open SagePanel.

The button was created in Phase 17 with an empty `onClick={() => {/* co-pilot CTA — will be wired in Phase 18 */}}`. Replace that with a real handler.

Read the current file. Add:
1. Import `useExplorerStore` from '../../store'
2. Inside the component, add: `const setOpen = useExplorerStore((s) => s.setOpen)`
3. Replace the onClick handler: `onClick={() => setOpen(true)}`

The full updated component:
```tsx
import { Search } from 'lucide-react'
import { useExplorerStore } from '../../store'

export function EmptyState() {
  const setOpen = useExplorerStore((s) => s.setOpen)

  return (
    <div className="flex flex-col items-center justify-center h-full min-h-[400px] gap-4 text-center px-8">
      <div className="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center">
        <Search className="w-8 h-8 text-gray-400" />
      </div>
      <div>
        <h3 className="font-semibold text-gray-700 text-base mb-1">No experts found</h3>
        <p className="text-sm text-gray-500 max-w-xs">
          Try adjusting your filters, or describe what you need to the AI co-pilot.
        </p>
      </div>
      <button
        className="text-sm text-brand-purple font-medium border border-brand-purple rounded-lg px-4 py-2 hover:bg-brand-purple hover:text-white transition-colors"
        onClick={() => setOpen(true)}
      >
        Try the AI Co-Pilot
      </button>
    </div>
  )
}
```

After editing, run npm run build from frontend/ — must pass.
  </action>
  <verify>
    npm run build from frontend/ — must exit 0.
    grep -n "setOpen" frontend/src/components/marketplace/EmptyState.tsx — wired onClick.
    grep -n "useExplorerStore" frontend/src/components/marketplace/EmptyState.tsx — store import present.
  </verify>
  <done>
    EmptyState "Try the AI Co-Pilot" button calls setOpen(true).
    useExplorerStore imported and setOpen extracted.
    Build passes.
    Placeholder comment removed.
  </done>
</task>

</tasks>

<verification>
npm run build from frontend/ — must exit 0 with zero TypeScript errors.
grep -rn "SageFAB\|SagePanel" frontend/src/pages/MarketplacePage.tsx — both present.
grep -n "AnimatePresence" frontend/src/pages/MarketplacePage.tsx — present.
grep -n "setOpen" frontend/src/components/marketplace/EmptyState.tsx — CTA wired.
ls frontend/src/components/pilot/ — shows all 4 components.
</verification>

<success_criteria>
- MarketplacePage renders SageFAB when !isOpen and SagePanel when isOpen
- AnimatePresence wraps both for mount/unmount animation
- Mobile backdrop div (z-30, click to close) rendered with SagePanel
- EmptyState "Try the AI Co-Pilot" button calls setOpen(true) to open panel
- No overflow change to MarketplacePage root div (sticky sidebar constraint preserved)
- npm run build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-floating-ai-co-pilot/18-03-SUMMARY.md`
</output>
