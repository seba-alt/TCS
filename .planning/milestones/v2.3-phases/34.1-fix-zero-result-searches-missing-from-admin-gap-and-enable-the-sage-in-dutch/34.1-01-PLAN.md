---
phase: 34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
autonomous: true
requirements:
  - GAP-NULL-FIX

must_haves:
  truths:
    - "Searches with NULL top_match_score appear in the admin Gaps page"
    - "The gap count on the admin Overview/stats includes NULL-score conversations"
    - "Filtering searches by gap_flag=True returns NULL-score rows; gap_flag=False excludes them"
    - "Daily trend chart gap counts include NULL-score conversations"
    - "CSV exports (searches and gaps) include NULL-score conversations in their gap sets"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "NULL-safe gap conditions across all 8 query sites + _is_gap helper"
      contains: "top_match_score.is_(None)"
  key_links:
    - from: "app/routers/admin.py::_is_gap"
      to: "Conversation.top_match_score"
      via: "Python `is None` check (not `is not None`)"
      pattern: "row\\.top_match_score is None"
    - from: "app/routers/admin.py::get_stats"
      to: "Conversation.top_match_score"
      via: "SQLAlchemy .is_(None) ORM predicate"
      pattern: "top_match_score\\.is_\\(None\\)"
    - from: "app/routers/admin.py::get_intelligence_stats daily trend"
      to: "Raw SQL text"
      via: "IS NULL in SUM CASE WHEN"
      pattern: "top_match_score IS NULL"
---

<objective>
Fix the NULL gap detection bug across all admin query sites so that conversations with NULL top_match_score (zero-candidate searches) are correctly counted and displayed as gaps.

Purpose: Searches where no candidates were found store NULL for top_match_score. SQLite evaluates `NULL < 0.60` as NULL (falsy), silently excluding these from all gap queries, counters, trend charts, and CSV exports. This makes the admin gap analysis incomplete and misleading.

Output: All 8 query sites in `admin.py` + the `_is_gap()` Python helper correctly treat NULL as a gap.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch/34.1-RESEARCH.md
@app/routers/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Patch all 8 NULL gap conditions + _is_gap helper in admin.py</name>
  <files>app/routers/admin.py</files>
  <action>
Fix every location in `app/routers/admin.py` where gap detection excludes NULL scores. There are 8 SQL/ORM sites plus the `_is_gap()` Python helper. Apply the exact patches from RESEARCH.md:

**Location 1 — `_is_gap()` helper (~line 204):**
Change `row.top_match_score is not None and row.top_match_score < GAP_THRESHOLD` to:
```python
row.top_match_score is None or row.top_match_score < GAP_THRESHOLD
```
The full function becomes:
```python
def _is_gap(row: Conversation) -> bool:
    """Return True if the conversation qualifies as a gap.
    NULL top_match_score = no candidates found = gap by definition.
    """
    return (
        row.top_match_score is None or row.top_match_score < GAP_THRESHOLD
    ) or row.response_type == "clarification"
```

**Location 2 — `get_stats()` gap_count query (~line 275):**
Add `Conversation.top_match_score.is_(None) |` before the existing `< GAP_THRESHOLD` condition.

**Location 3 — `get_intelligence_stats()` gap_count query (~line 339):**
Same pattern as Location 2 — add `Conversation.top_match_score.is_(None) |`.

**Location 4 — `get_intelligence_stats()` daily trend raw SQL (~line 372):**
Change the CASE WHEN from:
`WHEN top_match_score < :threshold OR response_type = 'clarification'`
to:
`WHEN top_match_score IS NULL OR top_match_score < :threshold OR response_type = 'clarification'`

**Location 5 — `get_searches()` gap_flag filter (~line 495):**
- `gap_flag is True` branch: Add `Conversation.top_match_score.is_(None) |` before the `< GAP_THRESHOLD` condition.
- `gap_flag is False` branch: Add `Conversation.top_match_score.is_not(None) &` as the first condition, so NULL rows are excluded from non-gap results.

**Location 6 — `get_gaps()` WHERE clause (~line 560):**
Add `Conversation.top_match_score.is_(None) |` before the existing `< GAP_THRESHOLD` condition.

**Location 7 — `export_searches_csv()` gap_flag filter (~line 1101):**
Same pattern as Location 5 — update both True and False branches identically.

**Location 8 — `export_gaps_csv()` WHERE clause (~line 1328):**
Same pattern as Location 6 — add `Conversation.top_match_score.is_(None) |`.

**Important:** Line numbers are approximate from the RESEARCH.md analysis. Search for the actual patterns to find the correct locations. Use `Conversation.top_match_score.is_(None)` for ORM queries and `top_match_score IS NULL` for raw SQL strings. Do NOT use `== None` in SQLAlchemy ORM code.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "
import ast, sys
source = open('app/routers/admin.py').read()
# Check _is_gap uses 'is None' not 'is not None'
if 'is not None and' in source and 'top_match_score is not None and' in source:
    print('FAIL: _is_gap still excludes NULL'); sys.exit(1)
if 'top_match_score is None or' not in source:
    print('FAIL: _is_gap not updated'); sys.exit(1)
# Check ORM queries use .is_(None)
count = source.count('top_match_score.is_(None)')
if count < 5:
    print(f'FAIL: expected >=5 .is_(None) occurrences, found {count}'); sys.exit(1)
# Check raw SQL has IS NULL
if 'top_match_score IS NULL' not in source:
    print('FAIL: daily trend SQL missing IS NULL'); sys.exit(1)
# Check gap_flag=False has is_not(None)
if 'top_match_score.is_not(None)' not in source:
    print('FAIL: gap_flag=False not updated with is_not(None)'); sys.exit(1)
print(f'PASS: _is_gap fixed, {count} ORM .is_(None), raw SQL IS NULL, is_not(None) present')
"
    </automated>
    <manual>Deploy and check admin Gaps page — searches with NULL best_score should now appear with an em dash in the Best Score column.</manual>
  </verify>
  <done>All 8 gap query sites and the _is_gap helper treat NULL top_match_score as a gap. The gap_flag=False branches explicitly exclude NULLs with is_not(None). The daily trend raw SQL includes IS NULL.</done>
</task>

<task type="auto">
  <name>Task 2: Handle NULL best_score display in frontend GapsTable</name>
  <files>app/routers/admin.py</files>
  <action>
Verify the backend serializes `top_match_score: null` correctly in the JSON response for gap rows. The frontend GapsTable already receives a `best_score` field from the API. When `top_match_score` is NULL in the database, Python's `json.dumps` serializes `None` as `null`, so this should work out of the box.

Check the `get_gaps()` endpoint response serialization — confirm that `top_match_score` is included in the response dict without any `.toFixed()` or similar formatting that would crash on None. If any Python-side formatting like `f"{row.top_match_score:.3f}"` exists for this field, guard it with a None check: `row.top_match_score if row.top_match_score is not None else None`.

Also check the `get_searches()` endpoint response serialization for the same issue.

This is a safety check — if no Python-side formatting exists for this field, no changes are needed. The frontend TypeScript rendering (`score.toFixed(3)` vs `'—'`) is a display concern handled by the existing GapsTable component which should already handle null gracefully. If it does not, note it but do NOT modify frontend files (this plan is backend-only).
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "
import ast
source = open('app/routers/admin.py').read()
# Verify no unguarded .format or f-string on top_match_score that would crash on None
# This is a safety check — we just confirm the file parses without syntax errors after edits
tree = ast.parse(source)
print('PASS: admin.py parses correctly, no syntax errors')
"
    </automated>
  </verify>
  <done>Backend serialization confirmed safe for NULL top_match_score values — no Python formatting crashes on None.</done>
</task>

</tasks>

<verification>
1. `python -c "import app.routers.admin"` succeeds (no import errors)
2. The automated verify scripts pass for all tasks
3. After deploy: Admin Gaps page shows searches that previously had NULL scores
4. After deploy: Admin Overview gap_count includes NULL-score conversations
5. After deploy: Searches page gap_flag filter correctly includes/excludes NULL rows
</verification>

<success_criteria>
- All 8 gap query locations in admin.py include NULL-safe conditions
- _is_gap() helper treats None as a gap
- gap_flag=False branches explicitly exclude NULLs
- Daily trend raw SQL uses IS NULL
- No Python formatting crashes on None top_match_score
- Admin gap counts are higher than before (now including zero-candidate searches)
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-fix-zero-result-searches-missing-from-admin-gap-and-enable-the-sage-in-dutch/34.1-01-SUMMARY.md`
</output>
