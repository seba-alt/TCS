---
phase: 32-sage-direct-search
plan: "03"
type: execute
wave: 2
depends_on:
  - "32-02"
files_modified:
  - frontend/src/components/marketplace/FilterChips.tsx
  - frontend/src/components/marketplace/EmptyState.tsx
  - frontend/src/components/sidebar/SearchInput.tsx
  - frontend/src/components/sidebar/RateSlider.tsx
autonomous: false
requirements:
  - SAGE-DX-02
  - SAGE-DX-03

must_haves:
  truths:
    - "When sageMode=true, a Sage avatar icon appears next to the expert count in the FilterChips bar"
    - "The Sage icon fades out smoothly (opacity transition) when the user returns to normal filter mode"
    - "Zero-result Sage queries show a Sage-specific empty state message encouraging a new Sage message"
    - "Typing in the search bar while in sageMode shows an inline tooltip confirmation before switching modes"
    - "Moving the rate slider while in sageMode shows an inline tooltip confirmation before switching"
    - "Clicking a tag chip while in sageMode exits sage mode silently with no confirmation"
    - "The expert count in FilterChips reflects Sage's actual result count (from store.total, no hardcoded values)"
  artifacts:
    - path: "frontend/src/components/marketplace/FilterChips.tsx"
      provides: "Sage mode icon + count display (sageMode-aware)"
      contains: "sageMode"
    - path: "frontend/src/components/marketplace/EmptyState.tsx"
      provides: "Sage-specific zero-result message when sageMode=true"
      contains: "sageMode"
    - path: "frontend/src/components/sidebar/SearchInput.tsx"
      provides: "Inline tooltip confirmation before exiting sage mode via search bar"
      contains: "sageMode"
    - path: "frontend/src/components/sidebar/RateSlider.tsx"
      provides: "Inline tooltip confirmation before exiting sage mode via rate slider"
      contains: "sageMode"
  key_links:
    - from: "frontend/src/components/marketplace/FilterChips.tsx"
      to: "frontend/src/store/resultsSlice.ts"
      via: "useExplorerStore sageMode selector"
      pattern: "sageMode"
    - from: "frontend/src/components/sidebar/SearchInput.tsx"
      to: "frontend/src/store/resultsSlice.ts"
      via: "useExplorerStore sageMode selector for confirmation gate"
      pattern: "sageMode"
---

<objective>
Add the Sage mode visual UX layer on top of the store plumbing from Plan 02: Sage icon in the count bar, Sage-specific empty state, and inline confirmation tooltips when the search bar or rate slider are used while in sage mode.

Purpose: Plan 02 wires the sageMode mechanics. This plan surfaces that state to users — they see the Sage icon when Sage results are active, get a specific message when Sage finds nothing, and get a non-blocking confirmation prompt before their sidebar input replaces Sage's results.

Output: Four frontend files with sageMode-aware UI. All user decisions from CONTEXT.md honored: icon in header (opacity fade-out), Sage empty state message, inline tooltip for search+rate (not modal), silent exit for tag chips.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-sage-direct-search/32-CONTEXT.md
@.planning/phases/32-sage-direct-search/32-RESEARCH.md
@.planning/phases/32-sage-direct-search/32-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sage icon in FilterChips + Sage-specific EmptyState</name>
  <files>
    frontend/src/components/marketplace/FilterChips.tsx
    frontend/src/components/marketplace/EmptyState.tsx
  </files>
  <action>
**FilterChips.tsx — Sage mode icon:**

Add `sageMode` from the store. When `sageMode=true`, show the Sage avatar icon (`/icon.png`) next to the expert count with an opacity transition. When `sageMode=false`, the icon fades out. The icon also shows during zero-result sage mode (consistent with non-zero behavior).

Imports to add:
```typescript
import { motion } from 'motion/react'
```

Add selector (alongside existing `total`):
```typescript
const sageMode = useExplorerStore((s) => s.sageMode)
```

Icon placement: inside the flex row, immediately BEFORE the `{total} experts found` span. The icon fades in when `sageMode=true`, fades out when `sageMode=false`:

```tsx
{/* Sage mode indicator — fades in/out with opacity transition */}
<motion.img
  src="/icon.png"
  alt="Sage results"
  animate={{ opacity: sageMode ? 1 : 0 }}
  transition={{ duration: 0.3 }}
  className="w-4 h-4 object-contain"
  style={{ pointerEvents: 'none' }}
/>
```

The icon uses `animate={{ opacity }}` NOT conditional rendering — so it fades smoothly rather than disappearing abruptly. Always render it in the DOM; opacity handles visibility.

The count display `{total} experts found` remains exactly as-is — it already reads from `store.total` which is set by `setResults()`, so it reflects Sage's actual count. No hardcoding.

NOTE: FilterChips has an early return: `if (chips.length === 0 && total === 0) return null`. In zero-result sage mode: `sageMode=true`, `total=0`, `chips.length=0` — FilterChips returns null and the Sage icon will NOT show during zero-result state. This is acceptable — the EmptyState fills the grid area instead (consistent, non-confusing). Do not change the early-return guard.

**EmptyState.tsx — Sage-specific message:**

Add `sageMode` selector:
```typescript
const sageMode = useExplorerStore((s) => s.sageMode)
```

When `sageMode=true`, show a Sage-specific message instead of the generic "No experts found". When `sageMode=false`, keep all existing content exactly as it is.

Sage-specific zero-result content (replaces the `<div>` with h3 + p, NOT the icon or buttons):
```tsx
{sageMode ? (
  <div>
    <h3 className="font-semibold text-gray-700 text-base mb-1">No results found</h3>
    <p className="text-sm text-gray-500 max-w-xs">
      Try describing what you need differently in Sage.
    </p>
  </div>
) : (
  <div>
    <h3 className="font-semibold text-gray-700 text-base mb-1">No experts found</h3>
    <p className="text-sm text-gray-500 max-w-xs">
      Try a different tag or describe what you need to Sage.
    </p>
  </div>
)}
```

In sage mode, HIDE the tag suggestion chips (they are irrelevant when Sage found nothing — user should talk to Sage). Keep the "Try describing it to Sage" CTA button and "Clear all filters" button — they are still useful:
```tsx
{/* Tag suggestions — only in normal mode, not sage mode */}
{!sageMode && suggestions.length > 0 && (
  // ... existing tag suggestion JSX unchanged ...
)}
```

The Search icon, CTA, and "Clear all filters" button remain visible in both modes.
  </action>
  <verify>
    TypeScript build: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build` — zero errors.

    Visual checks (browser):
    1. Trigger a Sage search — Sage icon appears next to the expert count in the FilterChips bar.
    2. Type in the search bar to exit sage mode — icon fades out smoothly.
    3. Trigger a zero-result Sage query — EmptyState shows "No results found. Try describing what you need differently in Sage." (no tag chip suggestions visible).
    4. Trigger a zero-result from normal filters — EmptyState shows the original generic message with tag suggestions.
  </verify>
  <done>
    FilterChips shows the Tinrate icon (`/icon.png`, 16x16) with opacity 1 when sageMode=true, opacity 0 when sageMode=false (animated, 0.3s).
    EmptyState shows sage-specific message and hides tag chips when sageMode=true.
    EmptyState shows original message + tag chips when sageMode=false.
    TypeScript build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inline sage-mode confirmation in SearchInput and RateSlider</name>
  <files>
    frontend/src/components/sidebar/SearchInput.tsx
    frontend/src/components/sidebar/RateSlider.tsx
  </files>
  <action>
Per CONTEXT.md locked decisions: typing in the search bar OR adjusting the rate slider while in sage mode shows a NON-BLOCKING inline tooltip confirmation before switching modes. Tag chips exit silently (handled by filterSlice `toggleTag`/`setTags` already calling `setSageMode(false)`). No modal — tooltip only.

**SearchInput.tsx — sage mode confirmation:**

The confirmation flow:
1. User starts typing while `sageMode=true`.
2. Instead of immediately committing `setQuery()` (which would call `setSageMode(false)` and trigger a refetch), show an inline confirmation tooltip: "Switch to search mode? Sage results will be replaced."
3. Tooltip has two options: "Switch" (confirm) and "Cancel".
4. If user confirms: call `setQuery(localValue)` as normal — this calls `setSageMode(false)` via filterSlice and triggers useExplore.
5. If user cancels: revert `localValue` back to the committed `query` from the store. Do NOT call `setQuery()`.

Add local state:
```typescript
const [showSageConfirm, setShowSageConfirm] = useState(false)
const [pendingQuery, setPendingQuery] = useState<string | null>(null)
```

Add selector (import `useExplorerStore` alongside existing `useFilterSlice`):
```typescript
import { useFilterSlice, useExplorerStore } from '../../store'
// ...
const sageMode = useExplorerStore((s) => s.sageMode)
```

Modify `handleChange` to gate on sageMode:
```typescript
function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
  const value = e.target.value
  const lower = value.toLowerCase().trim()

  // Barrel roll easter egg — unchanged
  if (BARREL_ROLL_PHRASES.some(p => lower.includes(p))) { /* ... unchanged ... */ }

  setLocalValue(value)
  fetchSuggestions(value)

  // Sage mode: show confirmation instead of immediately committing the query
  if (sageMode) {
    setPendingQuery(value)
    setShowSageConfirm(true)
    if (timerRef.current) clearTimeout(timerRef.current)
    return  // Do NOT call setQuery yet
  }

  // Normal mode: debounced setQuery as before
  if (timerRef.current) clearTimeout(timerRef.current)
  timerRef.current = setTimeout(() => {
    setQuery(value)
    if (value.trim().length > 0) {
      void trackEvent('filter_change', { filter: 'query', value: value.trim() })
    }
  }, DEBOUNCE_MS)
}
```

Confirmation handlers:
```typescript
function handleSageConfirmSwitch() {
  setShowSageConfirm(false)
  if (pendingQuery !== null) {
    setQuery(pendingQuery)  // setSageMode(false) fires inside setQuery via filterSlice
    void trackEvent('filter_change', { filter: 'query', value: pendingQuery.trim() })
  }
  setPendingQuery(null)
}

function handleSageConfirmCancel() {
  setShowSageConfirm(false)
  setLocalValue(query)  // revert input to committed store query
  setSuggestions([])
  setShowSuggestions(false)
  setPendingQuery(null)
}
```

The confirmation tooltip (add inside the return JSX, below the suggestions dropdown):
```tsx
{showSageConfirm && (
  <div className="absolute top-full left-0 right-0 z-30 mt-1 bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg">
    <p className="mb-1.5">Switch to search mode? Sage results will be replaced.</p>
    <div className="flex gap-2">
      <button
        type="button"
        onMouseDown={(e) => e.preventDefault()}
        onClick={handleSageConfirmSwitch}
        className="bg-brand-purple text-white rounded px-2 py-0.5 hover:bg-purple-700 transition-colors"
      >
        Switch
      </button>
      <button
        type="button"
        onMouseDown={(e) => e.preventDefault()}
        onClick={handleSageConfirmCancel}
        className="text-gray-300 hover:text-white transition-colors px-1"
      >
        Cancel
      </button>
    </div>
  </div>
)}
```

`setSageMode` is NOT needed directly in SearchInput — `setQuery` already calls `setSageMode(false)` via filterSlice. No double-calling needed.

**RateSlider.tsx — sage mode confirmation:**

Read the current RateSlider implementation first (at `/Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/RateSlider.tsx`) before implementing. The rate slider fires `setRateRange` on drag-end (`onValueCommit` or equivalent). Apply the same confirmation pattern:

1. Add `sageMode` selector via `useExplorerStore((s) => s.sageMode)`.
2. On drag-end, intercept when `sageMode=true` and show an inline confirmation tooltip before committing.
3. Confirmation copy: "Switch to filter mode? Sage results will be replaced." with "Switch" / "Cancel" buttons.
4. If switch: call `setRateRange(min, max)` as normal (calls `setSageMode(false)` via filterSlice).
5. If cancel: revert the slider's local display value back to the committed store values (rateMin, rateMax from the store).

Add local state `showSageConfirm: boolean` and `pendingRange: [number, number] | null`.

Tooltip positioning: use `relative` on the slider container and `absolute top-full` on the tooltip — same visual pattern as SearchInput.
  </action>
  <verify>
    TypeScript build: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build` — zero errors.

    Behavioral verification (browser):
    1. Trigger a Sage search to enter sage mode (Sage icon visible in header).
    2. Type a letter in the search bar — confirmation tooltip appears below the input with "Switch" and "Cancel" buttons. Grid stays as Sage results.
    3. Click "Cancel" — input reverts to previous value, sage mode active, tooltip gone.
    4. Type again, click "Switch" — sage mode exits, normal search triggers, Sage icon fades out.
    5. Trigger Sage search again. Move the rate slider — confirmation tooltip appears near the slider. "Cancel" reverts slider, "Switch" exits sage mode.
    6. Trigger Sage search again. Click a tag chip — sage mode exits silently, no confirmation, normal filter results load.
  </verify>
  <done>
    SearchInput shows a dark inline tooltip when the user types while sageMode=true. "Switch" commits the query and exits sage mode. "Cancel" reverts the input. Tooltip does not appear in normal mode.
    RateSlider shows a dark inline tooltip when drag-end fires while sageMode=true. "Switch" commits the range and exits sage mode. "Cancel" reverts the slider display.
    Tag chips exit sage mode silently (handled by filterSlice.toggleTag, no component change needed).
    TypeScript build passes with zero errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verify Phase 32 Sage Direct Search end-to-end</name>
  <files>frontend/src/components/marketplace/FilterChips.tsx</files>
  <action>Automated work is complete. Human verification required for visual and interactive correctness.</action>
  <verify>See how-to-verify section below for the full test plan.</verify>
  <done>All 8 tests pass and user types "approved".</done>
  <what-built>
    Full Phase 32 Sage Direct Search Integration:
    - Backend: pilot_service.py populates experts array in search_experts response (Plan 01)
    - Store: sageMode flag wired across resultsSlice, filterSlice, useExplore, useSage (Plan 02)
    - UX: Sage icon in count bar, sage empty state, filter confirmation tooltips (Plan 03)
  </what-built>
  <how-to-verify>
    Visit https://tcs-three-sigma.vercel.app (wait ~2min after push for Vercel deploy).

    Test 1 — Sage direct search (SAGE-DX-01):
    1. Open Sage, type "find me a blockchain expert", hit send.
    2. EXPECTED: Grid updates with Sage results. Search bar stays EMPTY. Sage icon appears next to the expert count in the FilterChips bar.

    Test 2 — Result count (SAGE-DX-02):
    3. After a Sage search, the expert count in the header shows the Sage result count (not the full database total). The count should be a small number reflecting the actual FAISS-ranked results.

    Test 3 — Zero result state (SAGE-DX-02):
    4. Ask Sage something very obscure that returns no results (e.g. "find me a quantum telepathy expert").
    5. EXPECTED: EmptyState appears with "No results found. Try describing what you need differently in Sage." — NOT the generic "No experts found" message. No tag chip suggestions visible.

    Test 4 — Search bar confirmation (SAGE-DX-03):
    6. Trigger a Sage search (sage icon visible). Then type a letter in the search bar.
    7. EXPECTED: Dark inline tooltip appears below the search bar: "Switch to search mode? Sage results will be replaced." with Switch/Cancel buttons. Grid still shows Sage results.
    8. Click Cancel — input reverts, sage mode active.
    9. Type again, click Switch — sage mode exits, normal search loads, Sage icon fades out.

    Test 5 — Rate slider confirmation (SAGE-DX-03):
    10. Trigger a Sage search. Drag the rate slider to a new position and release.
    11. EXPECTED: Confirmation tooltip appears near the slider. Switch exits sage mode. Cancel reverts the slider.

    Test 6 — Tag chip silent exit (SAGE-DX-03):
    12. Trigger a Sage search. Click a tag chip in the sidebar.
    13. EXPECTED: Sage mode exits immediately, no confirmation, normal filter results load, Sage icon fades out.

    Test 7 — apply_filters path regression check:
    14. Ask Sage "show me cheaper options" (refine, not discover).
    15. EXPECTED: Normal filter adjustment — search bar may update based on Sage intent, NO sage icon appears, grid updates via normal useExplore fetch.

    Test 8 — Page refresh resets sage mode:
    16. After a Sage search, refresh the page.
    17. EXPECTED: Grid reloads with normal filter-driven results. No sage icon visible.
  </how-to-verify>
  <resume-signal>Type "approved" to mark Phase 32 complete, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
```
cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build
```
Zero TypeScript errors across all modified files.

```
grep -n "sageMode" frontend/src/components/marketplace/FilterChips.tsx
grep -n "sageMode" frontend/src/components/marketplace/EmptyState.tsx
grep -n "sageMode" frontend/src/components/sidebar/SearchInput.tsx
grep -n "sageMode" frontend/src/components/sidebar/RateSlider.tsx
```

All four files reference `sageMode`.
</verification>

<success_criteria>
1. Sage icon (Tinrate `/icon.png`, 16x16) appears in FilterChips when sageMode=true, fades out when sageMode=false.
2. Zero-result sage queries show "No results found. Try describing what you need differently in Sage." with no tag chip suggestions.
3. Search bar and rate slider show non-blocking inline confirmation tooltip while in sage mode.
4. Tag chips exit sage mode silently.
5. Human verify checkpoint approved.
6. TypeScript build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/32-sage-direct-search/32-03-SUMMARY.md` following the summary template.
</output>
