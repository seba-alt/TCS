---
plan: 30-01
phase: 30-behavior-tracking
title: "Backend — UserEvent model + events router"
status: pending
gap_closure: false
---

# Plan 30-01: Backend — UserEvent model + events router

## Goal

Add the `UserEvent` SQLAlchemy model and `POST /api/events` router so user events can be persisted durably. Table is auto-created by existing `Base.metadata.create_all` at lifespan. Endpoint returns 202, requires no auth, and rejects unknown `event_type` values with 422.

## Context

- `app/models.py`: uses `Mapped[type]` + `mapped_column()` (SQLAlchemy 2.x); `datetime.datetime.utcnow` as default (no parentheses); no FK constraints on any existing model
- `app/routers/feedback.py`: canonical router pattern — `router = APIRouter()`, `Depends(get_db)`, `Literal[...]` for allowlist, `db.add(record)` → `db.commit()`, structlog for logging
- `app/main.py`: router import line 37; `app.include_router(...)` block lines 342-352; `Base.metadata.create_all(bind=engine)` at line 184 auto-creates new tables
- `UserEvent` is a NEW table — `create_all` handles it safely; NO `ALTER TABLE` needed

## Tasks

### Task 1: Add `UserEvent` model to `app/models.py`

Append the following class after `NewsletterSubscriber` (line 125):

```python
class UserEvent(Base):
    """
    Records user behavior events for marketplace intelligence (Phase 30).
    event_type allowlist: card_click, sage_query, filter_change.
    Auto-created by Base.metadata.create_all at startup — no migration needed.
    Composite index on (event_type, created_at) for Phase 31 aggregation queries.
    """
    __tablename__ = "user_events"
    __table_args__ = (
        Index("ix_user_events_type_created", "event_type", "created_at"),
    )

    id: Mapped[int] = mapped_column(primary_key=True, index=True)
    session_id: Mapped[str] = mapped_column(String(64), nullable=False, index=True)
    event_type: Mapped[str] = mapped_column(String(50), nullable=False)
    # payload: JSON blob — shape varies by event_type (see events.py for schema)
    payload: Mapped[str] = mapped_column(Text, nullable=False, default="{}")
    created_at: Mapped[datetime.datetime] = mapped_column(
        DateTime, default=datetime.datetime.utcnow, nullable=False
    )
```

Required import addition at top of models.py:
```python
from sqlalchemy import Boolean, DateTime, Float, Index, String, Text
```
(Add `Index` to the existing import line.)

### Task 2: Create `app/routers/events.py`

New file — do NOT modify any existing router. Pattern mirrors `feedback.py`.

```python
"""
POST /api/events — Record user behavior events (card clicks, Sage queries, filter changes).

Fire-and-forget from frontend (fetch + keepalive: true, no await).
Returns 202 Accepted. No authentication required.
event_type is validated via Pydantic Literal — unknown values return 422.
"""
import json
from typing import Any, Literal

import structlog
from fastapi import APIRouter, Depends
from pydantic import BaseModel, Field
from sqlalchemy.orm import Session

from app.database import get_db
from app.models import UserEvent

log = structlog.get_logger()
router = APIRouter()

EVENT_TYPES = Literal["card_click", "sage_query", "filter_change"]


class EventRequest(BaseModel):
    session_id: str = Field(..., min_length=1, max_length=64)
    event_type: EVENT_TYPES
    payload: dict[str, Any] = Field(default_factory=dict)


@router.post("/api/events", status_code=202)
def record_event(body: EventRequest, db: Session = Depends(get_db)):
    """
    Insert a user behavior event. Returns 202 Accepted.
    Unknown event_type values are rejected with 422 by Pydantic validation.
    """
    record = UserEvent(
        session_id=body.session_id,
        event_type=body.event_type,
        payload=json.dumps(body.payload),
    )
    db.add(record)
    db.commit()
    log.info("event.recorded", event_type=body.event_type, session_id=body.session_id)
    return {"status": "accepted"}
```

### Task 3: Register events router in `app/main.py`

Two changes:

1. Add `events` to the router import line (line 37):
   ```python
   from app.routers import admin, chat, email_capture, events, feedback, health, explore, newsletter, pilot, suggest
   ```

2. Add `app.include_router(events.router)` after `feedback.router` (line 347):
   ```python
   app.include_router(feedback.router)
   app.include_router(events.router)  # Phase 30: behavior tracking
   ```

## Verification

```bash
# Syntax check
python3 -c "from app.routers.events import router; print('events router OK')"
python3 -c "from app.models import UserEvent; print('UserEvent model OK')"

# Confirm event_type allowlist rejects unknown values (expect ValidationError, not import error)
python3 -c "
from app.routers.events import EventRequest
try:
    EventRequest(session_id='test', event_type='unknown_type', payload={})
    print('FAIL: should have raised')
except Exception as e:
    print('PASS: rejected unknown event_type:', type(e).__name__)
"

# Confirm valid event types pass
python3 -c "
from app.routers.events import EventRequest
for et in ['card_click', 'sage_query', 'filter_change']:
    r = EventRequest(session_id='test-123', event_type=et, payload={'test': True})
    print(f'PASS: {et} accepted')
"

# Confirm UserEvent table args (composite index present)
python3 -c "
from app.models import UserEvent
args = UserEvent.__table_args__
print('table_args:', args)
idx = next((a for a in args if hasattr(a, 'name') and 'type_created' in a.name), None)
assert idx is not None, 'composite index not found'
print('PASS: composite index ix_user_events_type_created found')
"
```

## Self-Check

- [ ] `UserEvent` model added to `app/models.py` with correct `__tablename__ = "user_events"` and composite `Index` in `__table_args__`
- [ ] `Index` imported from `sqlalchemy` in `models.py`
- [ ] `app/routers/events.py` created with `status_code=202`, no auth dep, `Literal["card_click", "sage_query", "filter_change"]` on `event_type`
- [ ] `app/main.py` import line includes `events`
- [ ] `app/main.py` includes `app.include_router(events.router)`
- [ ] All verification commands pass
- [ ] No existing files broken (feedback.py, models.py existing models untouched)
