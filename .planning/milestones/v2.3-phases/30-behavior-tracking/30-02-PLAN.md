---
plan: 30-02
phase: 30-behavior-tracking
title: "Frontend — tracking.ts module + event instrumentation"
status: pending
gap_closure: false
depends_on: [30-01]
---

# Plan 30-02: Frontend — tracking.ts module + event instrumentation

## Goal

Create `tracking.ts` as a fire-and-forget module function using `fetch` + `keepalive: true`. Instrument three surfaces: `ExpertCard` (card_click), `useSage` (sage_query), and filter components (`SearchInput`, `RateSlider`, `TagMultiSelect`) for `filter_change` events. No user-facing UI changes.

## Context

### tracking.ts design
- Module function (NOT a hook) — importable anywhere without React rules
- Always `void fetch(...)` — NEVER `await` in any call path
- `session_id`: `crypto.randomUUID()`, stored in `localStorage` under `tcs_session_id`; generated once on first call, reused thereafter
- Endpoint: `POST /api/events` (202, no auth)
- Payload shape matches `EventRequest` in `events.py`

### ExpertCard injection point
- File: `frontend/src/components/marketplace/ExpertCard.tsx`
- The "View Full Profile" button `onClick` at lines 76-79 is the injection point
- `expert.username` is the stable ID (unique, DB-indexed)
- Must add `context: 'grid' | 'sage_panel'` prop to `ExpertCard` — defaults to `'grid'`
- Also add `rank?: number` prop for grid position (optional — passed when available from VirtuosoGrid `_index`)
- Active filters snapshot: read from `useExplorerStore.getState()` (snapshot, not reactive)
- `trackEvent` fires BEFORE `onViewProfile(expert.profile_url)` call

### ExpertGrid prop chain
- `ExpertGrid` (`frontend/src/components/marketplace/ExpertGrid.tsx`) passes `expert` to `ExpertCard` with `itemContent={(_index, expert) => <ExpertCard expert={expert} .../>}`
- `_index` is available in VirtuosoGrid `itemContent` — pass as `rank={_index}` to `ExpertCard`
- `ExpertGrid` does NOT need a `context` prop — all grid cards are `context='grid'`

### useSage injection point
- File: `frontend/src/hooks/useSage.ts`
- Inject AFTER `data` is received, BEFORE `addMessage()` (success path, after line 112)
- Fields: `text.trim()` (query_text), `data.search_performed ? 'search_experts' : 'apply_filters'` (function_called), `data.total ?? 0` (result_count), `data.total === 0` (zero_results)
- Expert IDs: not currently in `PilotResponse` — omit `expert_ids` field from sage_query payload for now (Phase 31 queries use result_count and zero_results)
- `trackEvent` call is `void` — no await

### Filter tracking injection points
- **SearchInput** (`frontend/src/components/sidebar/SearchInput.tsx`): fire inside the debounce callback (line 85-87), AFTER `setQuery(value)`, only when `value.trim().length > 0`
  - Result count: read from `useExplorerStore.getState().total` after the setQuery call (note: this is the PREVIOUS total, not the updated one — acceptable for tracking purposes)
- **RateSlider** (`frontend/src/components/sidebar/RateSlider.tsx`): fire inside `onValueCommit` callback — this is Radix UI's drag-end event (fires on mouse/touch release), exactly matching the requirement
- **TagMultiSelect** (`frontend/src/components/sidebar/TagMultiSelect.tsx`): fire inside `onClick={() => toggleTag(tag)}` — tag toggle is a discrete settled action, no debounce needed
  - Track only ADD actions (when tag is not currently selected): `if (!isSelected)` check before tracking

## Tasks

### Task 1: Create `frontend/src/tracking.ts`

New file:

```typescript
/**
 * tracking.ts — Fire-and-forget user behavior tracking.
 *
 * trackEvent() is a module function (NOT a React hook).
 * Always call as: void trackEvent(...)   — NEVER await.
 * Uses fetch + keepalive: true so events survive page navigation.
 */

const API_BASE = import.meta.env.VITE_API_URL ?? ''
const SESSION_KEY = 'tcs_session_id'

function getSessionId(): string {
  let sid = localStorage.getItem(SESSION_KEY)
  if (!sid) {
    sid = crypto.randomUUID()
    localStorage.setItem(SESSION_KEY, sid)
  }
  return sid
}

type EventType = 'card_click' | 'sage_query' | 'filter_change'

interface TrackPayload {
  [key: string]: unknown
}

export function trackEvent(event_type: EventType, payload: TrackPayload = {}): void {
  const session_id = getSessionId()
  void fetch(`${API_BASE}/api/events`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    keepalive: true,
    body: JSON.stringify({ session_id, event_type, payload }),
  })
}
```

### Task 2: Instrument `ExpertCard.tsx` for `card_click` events

File: `frontend/src/components/marketplace/ExpertCard.tsx`

Changes:
1. Add `context` and `rank` props to `ExpertCardProps` interface
2. Import `trackEvent` from `../../tracking`
3. Inside the "View Full Profile" button onClick, call `trackEvent` before `onViewProfile`
4. Read active filters snapshot from store at click time

Full updated file:

```typescript
import { useExplorerStore } from '../../store'
import { trackEvent } from '../../tracking'
import type { Expert } from '../../store/resultsSlice'

interface ExpertCardProps {
  expert: Expert
  onViewProfile: (url: string) => void
  context?: 'grid' | 'sage_panel'
  rank?: number
}

// Findability badge label — thresholds from Phase 14 (score range 50-100, neutral at 75)
function findabilityLabel(score: number | null): 'Top Match' | 'Good Match' | null {
  if (score === null) return null
  if (score >= 88) return 'Top Match'
  if (score >= 75) return 'Good Match'
  return null
}

export function ExpertCard({ expert, onViewProfile, context = 'grid', rank }: ExpertCardProps) {
  const toggleTag = useExplorerStore((s) => s.toggleTag)
  const query = useExplorerStore((s) => s.query)
  const tags = useExplorerStore((s) => s.tags)
  const badgeLabel = findabilityLabel(expert.findability_score)

  const hasSemanticFilter = query.trim().length > 0 || tags.length > 0

  return (
    <div className="expert-card bg-white/90 rounded-xl border border-gray-100 p-4 flex flex-col gap-1.5 h-[180px] overflow-hidden">

      {/* Zone A: name/role/company */}
      <div className="flex-shrink-0 min-w-0">
        <h3 className="font-semibold text-gray-900 text-sm leading-snug truncate">
          {expert.first_name} {expert.last_name}
        </h3>
        <p className="text-xs text-gray-500 truncate">{expert.job_title}</p>
        <p className="text-xs text-gray-400 truncate">{expert.company}</p>
      </div>

      {/* Zone B: Rate + Findability badge */}
      <div className="flex-shrink-0 flex items-center gap-2 flex-wrap">
        <span className="text-xs font-semibold text-brand-purple whitespace-nowrap">
          {expert.currency} {expert.hourly_rate}/hr
        </span>
        {hasSemanticFilter && badgeLabel && (
          <span className="text-xs bg-green-50 text-green-700 rounded-full px-2 py-0.5 whitespace-nowrap">
            {badgeLabel}
          </span>
        )}
      </div>

      {/* Zone C: Domain tag pills */}
      <div className="flex-shrink-0 hidden sm:flex flex-nowrap gap-1 overflow-hidden">
        {expert.tags.slice(0, 2).map((tag) => (
          <button
            key={tag}
            onClick={() => toggleTag(tag)}
            className="flex-shrink-0 cursor-pointer text-xs bg-gray-100/80 text-gray-600 rounded-full px-2 py-0.5 hover:bg-brand-purple hover:text-white transition-colors whitespace-nowrap"
          >
            {tag}
          </button>
        ))}
      </div>

      {/* Zone D: match reason + View Profile */}
      <div className="flex-1 min-h-0 flex flex-col justify-between border-t border-gray-100/60 pt-1.5">
        {hasSemanticFilter && expert.match_reason && (
          <p className="text-xs text-gray-500 line-clamp-2">
            {expert.match_reason}
          </p>
        )}

        <button
          onClick={(e) => {
            e.stopPropagation()
            // Track card click — fire-and-forget, never await
            const storeState = useExplorerStore.getState()
            void trackEvent('card_click', {
              expert_id: expert.username,
              context,
              rank,
              active_filters: {
                query: storeState.query,
                rate_min: storeState.rateMin,
                rate_max: storeState.rateMax,
                tags: storeState.tags,
              },
            })
            onViewProfile(expert.profile_url)
          }}
          className="mt-auto cursor-pointer text-xs text-brand-purple font-medium hover:underline self-start"
        >
          View Full Profile →
        </button>
      </div>
    </div>
  )
}
```

### Task 3: Update `ExpertGrid.tsx` to pass `rank` prop

File: `frontend/src/components/marketplace/ExpertGrid.tsx`

Change the `itemContent` callback to pass `rank`:
```tsx
itemContent={(index, expert) => (
  <ExpertCard expert={expert} onViewProfile={onViewProfile} rank={index} />
)}
```
(Change `_index` to `index` and add `rank={index}`)

### Task 4: Instrument `useSage.ts` for `sage_query` events

File: `frontend/src/hooks/useSage.ts`

Add import at top:
```typescript
import { trackEvent } from '../tracking'
```

Inside the `try` block, after `const data = await res.json()` and BEFORE the `if (data.search_performed === true)` dispatch block, add:

```typescript
// Track sage_query — fire-and-forget, never await
void trackEvent('sage_query', {
  query_text: text.trim(),
  function_called: data.search_performed ? 'search_experts' : 'apply_filters',
  result_count: data.total ?? 0,
  zero_results: (data.total ?? 0) === 0,
})
```

### Task 5: Instrument `SearchInput.tsx` for `filter_change` (query)

File: `frontend/src/components/sidebar/SearchInput.tsx`

Add import:
```typescript
import { trackEvent } from '../../tracking'
```

Inside the debounce callback (the `setTimeout` body), AFTER `setQuery(value)`, add:
```typescript
timerRef.current = setTimeout(() => {
  setQuery(value)
  if (value.trim().length > 0) {
    void trackEvent('filter_change', {
      filter: 'query',
      value: value.trim(),
    })
  }
}, DEBOUNCE_MS)
```

### Task 6: Instrument `RateSlider.tsx` for `filter_change` (rate)

File: `frontend/src/components/sidebar/RateSlider.tsx`

Add import:
```typescript
import { trackEvent } from '../../tracking'
```

Update `onValueCommit` to track after `setRateRange`:
```tsx
onValueCommit={(val) => {
  setRateRange(val[0], val[1])
  void trackEvent('filter_change', {
    filter: 'rate',
    value: [val[0], val[1]],
  })
}}
```

### Task 7: Instrument `TagMultiSelect.tsx` for `filter_change` (tags)

File: `frontend/src/components/sidebar/TagMultiSelect.tsx`

Add import:
```typescript
import { trackEvent } from '../../tracking'
```

Update the tag button onClick to track only when adding (not removing):
```tsx
onClick={() => {
  if (!isSelected) {
    // Only track tag ADD, not tag remove — reduces noise
    void trackEvent('filter_change', {
      filter: 'tag',
      value: tag,
    })
  }
  toggleTag(tag)
}}
```

(The `isSelected` variable is already computed in `TagMultiSelect` from `tags.includes(tag)`)

## Verification

```bash
# TypeScript compile — must be clean
cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit

# Confirm tracking.ts exports trackEvent
grep -n "export function trackEvent" /Users/sebastianhamers/Documents/TCS/frontend/src/tracking.ts

# Confirm ExpertCard has context prop
grep -n "context" /Users/sebastianhamers/Documents/TCS/frontend/src/components/marketplace/ExpertCard.tsx

# Confirm useSage has sage_query tracking
grep -n "sage_query" /Users/sebastianhamers/Documents/TCS/frontend/src/hooks/useSage.ts

# Confirm SearchInput has filter_change tracking
grep -n "filter_change" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/SearchInput.tsx

# Confirm RateSlider has filter_change tracking
grep -n "filter_change" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/RateSlider.tsx

# Confirm TagMultiSelect has filter_change tracking
grep -n "filter_change" /Users/sebastianhamers/Documents/TCS/frontend/src/components/sidebar/TagMultiSelect.tsx

# Confirm no await on trackEvent calls
grep -n "await trackEvent" /Users/sebastianhamers/Documents/TCS/frontend/src/tracking.ts
grep -rn "await trackEvent" /Users/sebastianhamers/Documents/TCS/frontend/src/

# Production build
cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build
```

Expected: all greps find matches (except "await trackEvent" which must return nothing), tsc exits 0, build exits 0.

## Self-Check

- [ ] `frontend/src/tracking.ts` created with `trackEvent()` as named export, `void fetch(...)` (no await), `keepalive: true`, session_id from localStorage
- [ ] `ExpertCard.tsx` has `context` prop (default `'grid'`), `rank` prop, `trackEvent('card_click', ...)` fires before `onViewProfile`
- [ ] `ExpertGrid.tsx` passes `rank={index}` to `ExpertCard` (index not _index)
- [ ] `useSage.ts` fires `sage_query` event with `function_called` from `data.search_performed` boolean
- [ ] `SearchInput.tsx` fires `filter_change` inside debounce callback, only when value is non-empty
- [ ] `RateSlider.tsx` fires `filter_change` inside `onValueCommit` (drag-end only, not per tick)
- [ ] `TagMultiSelect.tsx` fires `filter_change` only on tag ADD (not on remove)
- [ ] Zero `await trackEvent` calls anywhere in codebase
- [ ] `npx tsc --noEmit` exits 0
- [ ] `npm run build` exits 0
