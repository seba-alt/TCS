---
phase: 31-admin-marketplace-intelligence
plan: "02"
type: execute
wave: 2
depends_on:
  - "31-01"
files_modified:
  - frontend/src/admin/types.ts
  - frontend/src/admin/hooks/useAdminData.ts
  - frontend/src/admin/pages/AdminMarketplacePage.tsx
  - frontend/src/main.tsx
  - frontend/src/admin/components/AdminSidebar.tsx
autonomous: false
requirements:
  - INTEL-01
  - INTEL-02
  - INTEL-03
  - INTEL-04

must_haves:
  truths:
    - "Admin navigates to /admin/marketplace and sees the page load without errors"
    - "When user_events table is empty, page shows cold-start message with tracking start info — no blank or broken state"
    - "Demand section shows zero-result Sage query table with query_text, frequency, last_seen, unique_users columns, paginated 25 rows, sorted by frequency DESC"
    - "Exposure section shows expert click table with expert_id, total_clicks, and context breakdown (Clicks: N grid / N sage)"
    - "Chart section shows Recharts BarChart with stacked bars (Matched purple, Zero Results red) for last 14 days"
    - "Headline KPIs appear above chart: total queries, zero-result rate %, and change vs prior period"
    - "Time range dropdown (7d / 30d / 90d / all time) applies to demand and exposure tables; chart stays at 14 days"
    - "Export CSV buttons on demand and exposure tables trigger file download via authenticated fetch"
    - "Marketplace nav entry appears in AdminSidebar Analytics section"
  artifacts:
    - path: "frontend/src/admin/types.ts"
      provides: "DemandRow, DemandResponse, ExposureRow, ExposureResponse, DailyTrendRow, MarketplaceTrendResponse TypeScript interfaces"
      contains: "DemandResponse"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useMarketplaceDemand, useMarketplaceExposure, useMarketplaceTrend hooks"
      contains: "useMarketplaceDemand"
    - path: "frontend/src/admin/pages/AdminMarketplacePage.tsx"
      provides: "Full marketplace intelligence page with cold-start check, demand table, exposure table, BarChart"
      min_lines: 200
    - path: "frontend/src/main.tsx"
      provides: "Route registration for /admin/marketplace"
      contains: "marketplace"
    - path: "frontend/src/admin/components/AdminSidebar.tsx"
      provides: "Marketplace nav entry in Analytics section"
      contains: "marketplace"
  key_links:
    - from: "AdminMarketplacePage.tsx"
      to: "useMarketplaceDemand / useMarketplaceExposure / useMarketplaceTrend"
      via: "hook calls"
      pattern: "useMarketplace"
    - from: "hooks"
      to: "/events/demand, /events/exposure, /events/trend"
      via: "adminFetch"
      pattern: "adminFetch.*events"
    - from: "AdminMarketplacePage.tsx"
      to: "data_since null check"
      via: "cold-start guard before any table/chart render"
      pattern: "data_since.*null"
---

<objective>
Build the complete AdminMarketplacePage.tsx and wire it into the admin routing system. This is the frontend half of Phase 31: it reads from the five endpoints created in Plan 01 and renders demand intelligence, expert exposure, daily trend chart, and a cold-start empty state.

Purpose: Give admins a diagnostic view of unmet demand, expert visibility, and Sage usage trends.
Output: One new page component, three new hooks, TypeScript types, route registration, and sidebar nav entry.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-admin-marketplace-intelligence/31-CONTEXT.md
@.planning/phases/31-admin-marketplace-intelligence/31-RESEARCH.md
@.planning/phases/31-admin-marketplace-intelligence/31-01-SUMMARY.md
@frontend/src/admin/types.ts
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/components/AdminSidebar.tsx
@frontend/src/main.tsx
@frontend/src/admin/pages/IntelligenceDashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TypeScript types and data-fetching hooks</name>
  <files>
    frontend/src/admin/types.ts
    frontend/src/admin/hooks/useAdminData.ts
  </files>
  <action>
**1. frontend/src/admin/types.ts — append new interfaces after existing types:**

```typescript
// --- Marketplace Intelligence types ---

export interface DemandRow {
  query_text: string
  frequency: number
  last_seen: string      // ISO datetime string
  unique_users: number
}

export interface DemandResponse {
  data_since: string | null  // null = cold start (no events yet)
  demand: DemandRow[]
  total: number
  page: number
  page_size: number
}

export interface ExposureRow {
  expert_id: string      // username / expert identifier
  total_clicks: number
  grid_clicks: number
  sage_clicks: number
}

export interface ExposureResponse {
  data_since: string | null
  exposure: ExposureRow[]
}

export interface DailyTrendRow {
  day: string            // YYYY-MM-DD
  total: number
  hits: number
  zero_results: number
}

export interface MarketplaceTrendResponse {
  data_since: string | null
  daily: DailyTrendRow[]
  kpis: {
    total_queries: number
    zero_result_rate: number
    prior_period_total: number
  }
}
```

**2. frontend/src/admin/hooks/useAdminData.ts — add three hooks following the existing useAdminGaps pattern:**

Import the new types at the top of the file alongside existing type imports:
```typescript
import type {
  DemandResponse,
  ExposureResponse,
  MarketplaceTrendResponse,
} from '../types'
```

Then add the three hooks at the end of the file (after all existing hooks):

```typescript
export function useMarketplaceDemand(days: number, page: number) {
  const [data, setData] = useState<DemandResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<DemandResponse>('/events/demand', { days, page, page_size: 25 })
      .then(setData)
      .catch((e: Error) => setError(e.message))
      .finally(() => setLoading(false))
  }, [days, page])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}

export function useMarketplaceExposure(days: number) {
  const [data, setData] = useState<ExposureResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<ExposureResponse>('/events/exposure', { days })
      .then(setData)
      .catch((e: Error) => setError(e.message))
      .finally(() => setLoading(false))
  }, [days])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}

export function useMarketplaceTrend() {
  const [data, setData] = useState<MarketplaceTrendResponse | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchData = useCallback(() => {
    setLoading(true)
    adminFetch<MarketplaceTrendResponse>('/events/trend')
      .then(setData)
      .catch((e: Error) => setError(e.message))
      .finally(() => setLoading(false))
  }, [])

  useEffect(() => { fetchData() }, [fetchData])

  return { data, loading, error, refetch: fetchData }
}
```

Note: `adminFetch` prepends `/api/admin` automatically. Pass `/events/demand` (not `/api/admin/events/demand`).

Check that `useState`, `useCallback`, `useEffect` are already imported at the top of useAdminData.ts — add to the existing React import if needed.
  </action>
  <verify>
```bash
cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30
```
No TypeScript errors on the new types or hooks. Confirm DemandResponse, ExposureResponse, MarketplaceTrendResponse exist in types.ts. Confirm useMarketplaceDemand, useMarketplaceExposure, useMarketplaceTrend exported from useAdminData.ts.
  </verify>
  <done>
6 new interfaces in types.ts. 3 new hooks in useAdminData.ts. `npx tsc --noEmit` produces no errors related to these files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build AdminMarketplacePage and wire routing + sidebar</name>
  <files>
    frontend/src/admin/pages/AdminMarketplacePage.tsx
    frontend/src/main.tsx
    frontend/src/admin/components/AdminSidebar.tsx
  </files>
  <action>
**1. Create frontend/src/admin/pages/AdminMarketplacePage.tsx**

This is a new file. Use the dark slate design language of existing admin pages (bg-slate-900, bg-slate-800/60 cards, text-slate-300, border-slate-700/60).

Structure:
- Page-level `days` state: `useState(30)` — shared by demand and exposure hooks
- Call all three hooks: `useMarketplaceDemand(days, demandPage)`, `useMarketplaceExposure(days)`, `useMarketplaceTrend()`
- CRITICAL: Check cold-start BEFORE rendering any data sections. Cold-start = demand.data_since === null AND exposure.data_since === null. Show cold-start block for both sections individually (each section checks its own data_since).

**Cold-start empty state (per section):**
```tsx
const isColdStart = !loading && data?.data_since === null

if (isColdStart) {
  return (
    <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-8 text-center space-y-2">
      <p className="text-slate-300 font-medium">No tracking data yet</p>
      <p className="text-slate-500 text-sm">
        Tracking started — insights appear after approximately 50 page views.
      </p>
    </div>
  )
}
```

**Page layout:**
```
<div className="p-6 space-y-8">
  <div className="flex items-center justify-between">
    <h1>Marketplace Intelligence</h1>
    <TimeRangeDropdown value={days} onChange={setDays} />
  </div>

  {/* Chart + KPIs section — always 14 days, not affected by dropdown */}
  <TrendSection />

  {/* Demand section */}
  <DemandSection days={days} />

  {/* Exposure section */}
  <ExposureSection days={days} />
</div>
```

**TimeRangeDropdown:** A `<select>` element with options: 7 / 30 / 90 / 0 (all time). Label values: "Last 7 days" / "Last 30 days" / "Last 90 days" / "All time". Changing it updates `days` state.

**TrendSection (Sage Query Volume chart):**
- Uses `useMarketplaceTrend()` (fixed 14 days — does NOT use the page-level `days` state)
- Check `data?.data_since === null` for cold-start
- Above chart: three KPI pill badges: "N total queries" | "N% zero-result rate" | "up/down N vs prior 14d"
- For "change vs prior period": compute `((current - prior) / prior * 100).toFixed(1)` — guard for prior === 0 (show "N/A")
- BarChart: use Recharts `BarChart` with `stackId="a"`. Bar 1: dataKey="hits" name="Matched" fill="#a855f7". Bar 2: dataKey="zero_results" name="Zero Results" fill="#ef4444"
- Chart uses the exact Recharts pattern from RESEARCH.md (ResponsiveContainer height=240, CartesianGrid, XAxis, YAxis, Tooltip, Legend with dark theme styling)
- Import from `recharts`: `BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, CartesianGrid`

**DemandSection:**
- Section header: "Unmet Demand" with description "Zero-result Sage queries sorted by frequency"
- Two sub-sections visually separated by a section divider:
  - Sub-section A: "Zero-Result Sage Queries" table
  - Sub-section B: placeholder "Filter demand signals — coming soon" (Phase 31 backend does not have a filter aggregation endpoint; do NOT add one)
- Zero-result queries table columns: Query Text | Frequency | Last Seen | Unique Users
- Pagination: show "Showing X-Y of Z" + Prev/Next buttons using `demandPage` state
- Export button: triggers authenticated fetch to `/api/admin/export/demand.csv?days={days}`. Use the existing `useAdminExport` hook from `useAdminExport.ts`.

**ExposureSection:**
- Section header: "Expert Exposure" with description "Click activity by expert, breakdown by context"
- Table columns: Expert ID | Total Clicks | Context Breakdown
- Context Breakdown cell: render as `"Grid: {grid_clicks} / Sage: {sage_clicks}"` — inline text, no sub-columns needed
- Expert ID is a plain text cell (no link — profile_url is not in the response)
- Export button: authenticated fetch to `/api/admin/export/exposure.csv?days={days}` via `useAdminExport`.

**CSV Export:** Import `useAdminExport` from `../hooks/useAdminExport`. Read useAdminExport.ts to understand the exact API the hook exposes, then call it accordingly.

**Imports at top of AdminMarketplacePage.tsx:**
```typescript
import { useState } from 'react'
import {
  BarChart, Bar, XAxis, YAxis, Tooltip, Legend,
  ResponsiveContainer, CartesianGrid,
} from 'recharts'
import { useMarketplaceDemand, useMarketplaceExposure, useMarketplaceTrend } from '../hooks/useAdminData'
import { useAdminExport } from '../hooks/useAdminExport'
```

---

**2. frontend/src/main.tsx — add route for /admin/marketplace:**

Read main.tsx to find the admin children routes array. Add alongside existing admin page routes:

```tsx
import AdminMarketplacePage from './admin/pages/AdminMarketplacePage'

// Inside the admin children array (near other admin page routes):
{ path: 'marketplace', element: <AdminMarketplacePage /> },
```

---

**3. frontend/src/admin/components/AdminSidebar.tsx — add Marketplace nav entry:**

Read AdminSidebar.tsx to find the NAV_ITEMS array. The sidebar splits items into Analytics (slice 0-3) and Intelligence (slice 3+). Add Marketplace in the Analytics section (insert at index 2 — after "Searches", before "Gaps"):

```tsx
{
  to: '/admin/marketplace',
  label: 'Marketplace',
  end: false,
  icon: (
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
  ),
},
```

Read the actual NAV_ITEMS in the file first to confirm the correct insertion index before making the change.
  </action>
  <verify>
```bash
cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -40
cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20
```
Build must complete with exit code 0. No TypeScript errors on new files.

Confirm:
- `AdminMarketplacePage.tsx` exists and has BarChart import from recharts
- `main.tsx` contains `marketplace` route
- `AdminSidebar.tsx` NAV_ITEMS contains `/admin/marketplace` entry
  </verify>
  <done>
`npm run build` exits 0. AdminMarketplacePage.tsx renders cold-start check before any data sections. Route registered at /admin/marketplace. Marketplace appears in AdminSidebar Analytics section. BarChart imported from recharts with stackId="a" for stacked bars.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Marketplace Intelligence page end-to-end</name>
  <what-built>
    Complete Admin Marketplace Intelligence page with:
    - Cold-start empty state (data_since === null check before any table/chart)
    - Unmet Demand section: zero-result Sage query table with pagination and CSV export
    - Expert Exposure section: click counts table with context breakdown and CSV export
    - Sage Volume chart: stacked BarChart (Matched / Zero Results) for last 14 days
    - Headline KPIs: total queries, zero-result rate, change vs prior period
    - Time range dropdown (7d / 30d / 90d / all time) affecting demand + exposure tables
    - Marketplace nav entry in AdminSidebar
  </what-built>
  <how-to-verify>
    1. Deploy or run locally: push to main (triggers Railway + Vercel deploys) or run `npm run dev` in frontend/ and uvicorn in project root
    2. Navigate to https://tcs-three-sigma.vercel.app/admin/marketplace (or http://localhost:5173/admin/marketplace)
    3. Login with admin key
    4. Verify Marketplace appears in the left sidebar under the Analytics section
    5. If user_events table is empty: confirm cold-start message appears ("No tracking data yet — insights appear after approximately 50 page views") — NOT a blank page or spinner
    6. If events exist: confirm demand table shows zero-result query rows sorted by frequency, with Prev/Next pagination
    7. If events exist: confirm exposure table shows expert click rows with "Grid: N / Sage: N" context breakdown
    8. If events exist: confirm BarChart renders with two stacked bars (purple for Matched, red for Zero Results) and hover tooltips
    9. Confirm headline KPIs appear above chart (total queries, zero-result rate %, change vs prior)
    10. Change time range dropdown to "Last 7 days" — confirm demand and exposure tables refresh; chart does NOT change
    11. Click "Export CSV" on demand table — confirm file downloads as demand-YYYY-MM-DD.csv with correct columns
    12. Click "Export CSV" on exposure table — confirm file downloads as exposure-YYYY-MM-DD.csv
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` exits 0 with no TypeScript errors
2. `/admin/marketplace` route resolves to AdminMarketplacePage
3. Cold-start guard: `data?.data_since === null` check appears BEFORE any table/chart JSX in the render tree
4. BarChart uses `stackId="a"` on both Bar components
5. useMarketplaceTrend called without `days` parameter (fixed 14d)
6. useMarketplaceDemand and useMarketplaceExposure receive `days` from page-level dropdown state
7. adminFetch paths use `/events/demand`, `/events/exposure`, `/events/trend` (not full `/api/admin/...` path)
</verification>

<success_criteria>
- AdminMarketplacePage.tsx exists with cold-start check, demand table, exposure table, BarChart, and KPIs
- npm run build exits 0
- /admin/marketplace route registered in main.tsx
- Marketplace nav entry in AdminSidebar.tsx Analytics section
- Three hooks exported from useAdminData.ts: useMarketplaceDemand, useMarketplaceExposure, useMarketplaceTrend
- Six types exported from types.ts: DemandRow, DemandResponse, ExposureRow, ExposureResponse, DailyTrendRow, MarketplaceTrendResponse
- Human verifier confirms page renders correctly with no blank states
</success_criteria>

<output>
After completion, create `.planning/phases/31-admin-marketplace-intelligence/31-02-SUMMARY.md`
</output>
