---
phase: 29-sage-personality-fab-reactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/pilot_service.py
  - frontend/src/components/pilot/SageFAB.tsx
autonomous: true
requirements:
  - SAGE-05
  - FAB-01

must_haves:
  truths:
    - "Sage responses use contractions and warm language — no 'Absolutely!', 'Great question!', or clinical filter-confirm tone"
    - "Sage asks at most one clarifying question per conversation; after the user replies, Sage always calls a function (apply_filters or search_experts)"
    - "Clarifying questions offer 2-3 concrete options, not open-ended blanks"
    - "The Sage FAB displays a visible boxShadow pulse/glow animation after Sage responds (purple glow) and after filter changes (blue glow)"
    - "FAB whileHover scale and whileTap scale gestures continue to work without conflict alongside the glow animation"
    - "Frontend build passes with no TypeScript errors"
  artifacts:
    - path: "app/services/pilot_service.py"
      provides: "Rewritten system_instruction in run_pilot() with personality constraints and clarifying question hard-cap"
      contains: "at most ONE clarifying question"
    - path: "frontend/src/components/pilot/SageFAB.tsx"
      provides: "motion.div glow wrapper around FAB button with boxShadow animation on Sage activity and filter changes"
      contains: "motion.div"
  key_links:
    - from: "app/services/pilot_service.py"
      to: "Gemini API"
      via: "system_instruction injected into GenerateContentConfig"
      pattern: "system_instruction.*at most ONE"
    - from: "frontend/src/components/pilot/SageFAB.tsx"
      to: "frontend/src/store/index.ts"
      via: "useExplorerStore selectors for isStreaming + filter state"
      pattern: "useExplorerStore.*isStreaming"
---

<objective>
Rewrite Sage's system prompt for a warmer "smart funny friend" voice with a hard one-clarifying-question cap, and add a reactive boxShadow pulse/glow to the Sage FAB button.

Purpose: Sage currently sounds clinical and formulaic. This makes Sage feel genuinely helpful and alive — warm voice in every response, FAB reacts to app activity.
Output: Updated `pilot_service.py` (system_instruction rewrite), updated `SageFAB.tsx` (motion.div glow wrapper + trigger logic).
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-sage-personality-fab-reactions/29-CONTEXT.md
@.planning/phases/29-sage-personality-fab-reactions/29-RESEARCH.md
@app/services/pilot_service.py
@frontend/src/components/pilot/SageFAB.tsx
@frontend/src/hooks/useSage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite system_instruction in pilot_service.py for Sage personality</name>
  <files>app/services/pilot_service.py</files>
  <action>
In `app/services/pilot_service.py`, replace the entire `system_instruction` string in `run_pilot()` with the following rewritten prompt. The prompt MUST remain an f-string (it injects `{current_filters}` at the end). Only the `system_instruction` variable changes — do NOT modify any function declarations, handlers, or other logic.

Replace the existing `system_instruction = (...)` assignment with:

```python
system_instruction = (
    "You are Sage — a sharp, warm expert-finder. Think 'smart funny friend who happens to know everyone': "
    "knowledgeable, approachable, gets to the point. You use contractions naturally. "
    "Humor is rare and earned — maybe once every ten messages, and only if it genuinely fits. Never forced.\n\n"
    "Hard rules (non-negotiable):\n"
    "- Never use filler affirmations: no 'Absolutely!', 'Great question!', 'Of course!', 'Certainly!'\n"
    "- Never over-explain. One sentence is often enough.\n"
    "- You may ask at most ONE clarifying question per conversation. "
    "After the user responds to any question — even vaguely — you MUST call a function. Never ask a second question.\n"
    "- When asking a clarifying question, always offer 2-3 concrete options (not open-ended). "
    "Example: 'Are you looking for someone hands-on (consulting), a trainer, or a speaker?'\n\n"
    "You have two tools:\n"
    "- apply_filters: narrow or refine what the user currently sees\n"
    "- search_experts: discover experts from scratch when the user asks to find, show, or explore experts\n\n"
    "Narration style for search_experts results:\n"
    "- Found results: 'Found {N} {domain} experts — {Name1} and {Name2} stand out. "
    "Updated the grid.' (mention 1-2 names, one differentiating detail, then done)\n"
    "- Large result set (100+): mention the size briefly and offer to narrow\n"
    "- Zero results with fallback: acknowledge, name the closest alternative with its count or rate, done\n"
    "- Zero results no fallback: 'Nothing matched — resetting the grid so you can start fresh.'\n\n"
    "Don't restate the filters you applied. Don't explain what you're about to do. Just do it and narrate the outcome.\n"
    f"Current active filters: {current_filters}."
)
```

**What to leave unchanged:**
- `APPLY_FILTERS_DECLARATION` and `SEARCH_EXPERTS_DECLARATION` — do not touch
- `_handle_apply_filters()` and `_handle_search_experts()` — do not touch
- `config = types.GenerateContentConfig(tools=[tool], system_instruction=system_instruction)` — already correct
- All imports and module-level constants
  </action>
  <verify>
Run `python3 -c "from app.services.pilot_service import run_pilot; print('import OK')"` — must print "import OK".
Also run: `grep -n "at most ONE" /Users/sebastianhamers/Documents/TCS/app/services/pilot_service.py` — must return at least 1 match.
Also run: `grep -n "Absolutely" /Users/sebastianhamers/Documents/TCS/app/services/pilot_service.py` — must return NO matches (confirm banned words removed).
  </verify>
  <done>pilot_service.py imports cleanly; system_instruction contains the one-clarifying-question hard cap; no filler affirmation words in the prompt; f-string with {current_filters} preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Add motion.div glow wrapper to SageFAB with Sage and filter activity triggers</name>
  <files>frontend/src/components/pilot/SageFAB.tsx</files>
  <action>
Rewrite `frontend/src/components/pilot/SageFAB.tsx` to add a reactive boxShadow glow animation on the FAB button.

**Architecture rules (CRITICAL):**
- The outer fixed `div` stays as the positioning container for the tooltip + button column
- Insert a `motion.div` wrapper around the `motion.button` ONLY (not around the tooltip)
- The `motion.div` animates `boxShadow` ONLY — NEVER add `scale`, `x`, `y`, or any transform to the wrapper
- The inner `motion.button` retains its `whileHover={{ scale: 1.05 }}` and `whileTap={{ scale: 0.95 }}` unchanged
- The `motion.div` must be `rounded-full` to match the button shape (otherwise glow is rectangular)

**Glow state:**
- Two glow types: `'sage'` (Sage responds) and `'filter'` (filter changes)
- `'sage'` glow: `'0 0 22px 8px rgba(139, 92, 246, 0.55)'` — brand purple
- `'filter'` glow: `'0 0 18px 6px rgba(99, 179, 237, 0.45)'` — cool blue
- `'none'` state: `'0 0 0 0 rgba(0,0,0,0)'`
- Auto-fade after 1500ms — `setTimeout(() => setGlowType('none'), 1500)`

**Sage activity trigger (isStreaming → false after API call):**
```tsx
const prevStreamingRef = useRef(isStreaming)
useEffect(() => {
  if (prevStreamingRef.current === true && isStreaming === false) {
    setGlowType('sage')
    const t = setTimeout(() => setGlowType('none'), 1500)
    return () => clearTimeout(t)
  }
  prevStreamingRef.current = isStreaming
}, [isStreaming])
```

**Filter change trigger (skip first render to avoid spurious glow on page load):**
```tsx
const query = useExplorerStore((s) => s.query)
const tags = useExplorerStore((s) => s.tags)
const rateMin = useExplorerStore((s) => s.rateMin)
const rateMax = useExplorerStore((s) => s.rateMax)
const filterKey = `${query}|${rateMin}|${rateMax}|${tags.join(',')}`
const prevFilterKey = useRef<string | null>(null)
useEffect(() => {
  if (prevFilterKey.current === null) {
    // Skip first render — initialize without glowing
    prevFilterKey.current = filterKey
    return
  }
  if (prevFilterKey.current !== filterKey) {
    prevFilterKey.current = filterKey
    setGlowType('filter')
    const t = setTimeout(() => setGlowType('none'), 1500)
    return () => clearTimeout(t)
  }
}, [filterKey])
```

**Full component structure:**
```tsx
import { useEffect, useRef, useState } from 'react'
import { motion } from 'motion/react'
import { useExplorerStore } from '../../store'

const TOOLTIP_KEY = 'sage-tooltip-shown'

type GlowType = 'none' | 'sage' | 'filter'

const GLOW_SHADOWS: Record<GlowType, string> = {
  none: '0 0 0 0 rgba(0,0,0,0)',
  sage: '0 0 22px 8px rgba(139, 92, 246, 0.55)',
  filter: '0 0 18px 6px rgba(99, 179, 237, 0.45)',
}

export function SageFAB() {
  const setOpen = useExplorerStore((s) => s.setOpen)
  const isStreaming = useExplorerStore((s) => s.isStreaming)
  const query = useExplorerStore((s) => s.query)
  const tags = useExplorerStore((s) => s.tags)
  const rateMin = useExplorerStore((s) => s.rateMin)
  const rateMax = useExplorerStore((s) => s.rateMax)

  const [showTooltip, setShowTooltip] = useState(false)
  const [glowType, setGlowType] = useState<GlowType>('none')

  // First-visit tooltip
  useEffect(() => {
    if (!localStorage.getItem(TOOLTIP_KEY)) {
      setShowTooltip(true)
      const timer = setTimeout(() => {
        setShowTooltip(false)
        localStorage.setItem(TOOLTIP_KEY, '1')
      }, 4000)
      return () => clearTimeout(timer)
    }
  }, [])

  // Sage activity glow — fires when isStreaming flips false (response received)
  const prevStreamingRef = useRef(isStreaming)
  useEffect(() => {
    if (prevStreamingRef.current === true && isStreaming === false) {
      setGlowType('sage')
      const t = setTimeout(() => setGlowType('none'), 1500)
      return () => clearTimeout(t)
    }
    prevStreamingRef.current = isStreaming
  }, [isStreaming])

  // Filter change glow — skip first render to avoid spurious glow on page load
  const filterKey = `${query}|${rateMin}|${rateMax}|${tags.join(',')}`
  const prevFilterKey = useRef<string | null>(null)
  useEffect(() => {
    if (prevFilterKey.current === null) {
      prevFilterKey.current = filterKey
      return
    }
    if (prevFilterKey.current !== filterKey) {
      prevFilterKey.current = filterKey
      setGlowType('filter')
      const t = setTimeout(() => setGlowType('none'), 1500)
      return () => clearTimeout(t)
    }
  }, [filterKey])

  const handleClick = () => {
    setShowTooltip(false)
    localStorage.setItem(TOOLTIP_KEY, '1')
    setOpen(true)
  }

  return (
    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-2">
      {/* Tooltip — first visit only */}
      {showTooltip && (
        <motion.div
          initial={{ opacity: 0, y: 4 }}
          animate={{ opacity: 1, y: 0 }}
          className="relative bg-gray-900 text-white text-xs rounded-lg px-3 py-2 whitespace-nowrap shadow-lg"
        >
          Try the AI assistant
          <div className="absolute -bottom-1.5 right-5 w-3 h-3 bg-gray-900 rotate-45" />
        </motion.div>
      )}

      {/* Glow wrapper — surrounds button only, not tooltip. boxShadow ONLY — no scale/transform */}
      <motion.div
        className="rounded-full"
        animate={{ boxShadow: GLOW_SHADOWS[glowType] }}
        transition={{ duration: 0.4, ease: 'easeOut' }}
      >
        <motion.button
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          onClick={handleClick}
          className="w-14 h-14 rounded-full bg-brand-purple text-white shadow-lg flex items-center justify-center hover:bg-purple-700 transition-colors"
          aria-label="Open Sage AI assistant"
        >
          <img src="/icon.png" alt="Tinrate" className="w-8 h-8 object-contain brightness-0 invert" />
        </motion.button>
      </motion.div>
    </div>
  )
}
```

**Note on panel-open state:** The existing ExplorerPage/SagePanel renders `{!isOpen && <SageFAB />}` — the FAB is already hidden when the panel is open. No additional panel-open logic needed in this component.
  </action>
  <verify>
1. Run `cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20` — no TypeScript errors.
2. Run `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -10` — exits 0.
3. Run `grep -n "whileHover\|whileTap" /Users/sebastianhamers/Documents/TCS/frontend/src/components/pilot/SageFAB.tsx` — must show both on the inner motion.button.
4. Run `grep -n "scale" /Users/sebastianhamers/Documents/TCS/frontend/src/components/pilot/SageFAB.tsx | grep -v "whileHover\|whileTap"` — must return NO matches on the motion.div wrapper.
5. Run `grep -n "boxShadow" /Users/sebastianhamers/Documents/TCS/frontend/src/components/pilot/SageFAB.tsx` — must show the GLOW_SHADOWS object with at least 2 entries.
  </verify>
  <done>
- SageFAB.tsx has motion.div wrapper with boxShadow animation only (no scale on wrapper)
- inner motion.button retains whileHover/whileTap scale props
- Sage activity glow (purple) fires on isStreaming → false transition
- Filter change glow (blue) fires on filter state changes (skips initial mount)
- Auto-fades after 1500ms
- TypeScript compiles clean, build exits 0
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from app.services.pilot_service import run_pilot; print('OK')"` — no ImportError
2. `grep "at most ONE" app/services/pilot_service.py` — clarifying question cap present
3. `grep -i "Absolutely\|Great question\|Of course\|Certainly" app/services/pilot_service.py` — no matches
4. `npx tsc --noEmit` in frontend/ — no errors
5. `npm run build` in frontend/ — exits 0
6. `grep "whileHover\|whileTap" frontend/src/components/pilot/SageFAB.tsx` — shows scale on inner button
7. `grep "boxShadow" frontend/src/components/pilot/SageFAB.tsx` — shows glow shadow values
</verification>

<success_criteria>
- Sage responses drop clinical language; contractions used naturally; no filler affirmations
- Clarifying questions (when asked) offer 2-3 concrete options
- After user replies to any clarifying question, Sage calls a function — no second question
- FAB glows purple (1.5s) after Sage responds; glows blue (1.5s) after filter changes
- FAB hover/tap scale gestures work without conflict alongside glow
- Frontend build passes clean (tsc + vite)
</success_criteria>

<output>
After completion, create `.planning/phases/29-sage-personality-fab-reactions/29-01-SUMMARY.md`
</output>
