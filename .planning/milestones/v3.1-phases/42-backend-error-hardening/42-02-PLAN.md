---
phase: 42-backend-error-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - frontend/src/admin/pages/SearchLabPage.tsx
  - frontend/src/admin/types.ts
autonomous: true
requirements: [SRCH-01, SRCH-02]

must_haves:
  truths:
    - "Search Lab query results use the same run_explore() pipeline as the search bar and Sage"
    - "Search Lab A/B comparison supports toggling HyDE and feedback as per-run overrides"
    - "Each Search Lab result column shows a pipeline label indicating which pipeline produced it"
    - "The legacy retriever pipeline is available as a comparison option for validating alignment"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "Search Lab compare endpoint using run_explore() as default pipeline"
      contains: "run_explore"
    - path: "frontend/src/admin/pages/SearchLabPage.tsx"
      provides: "Pipeline labels on each result column"
      contains: "pipeline"
    - path: "frontend/src/admin/types.ts"
      provides: "Updated types for pipeline field"
      contains: "pipeline"
  key_links:
    - from: "app/routers/admin.py compare_configs()"
      to: "app/services/explorer.run_explore()"
      via: "import and direct function call"
      pattern: "run_explore"
    - from: "frontend/src/admin/pages/SearchLabPage.tsx"
      to: "POST /api/admin/compare"
      via: "adminPost('/compare', ...)"
      pattern: "adminPost.*compare"
---

<objective>
Align Search Lab's query pipeline with the live run_explore() pipeline so admin results match what users see, while preserving A/B comparison with legacy pipeline and per-run HyDE/feedback overrides.

Purpose: Ensure Search Lab produces meaningful comparisons against the actual live pipeline, not just the FAISS-only retriever.
Output: Refactored compare endpoint with dual-pipeline support (run_explore + legacy) and pipeline labels in the UI.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/42-backend-error-hardening/42-RESEARCH.md
@.planning/phases/42-backend-error-hardening/42-CONTEXT.md
@app/routers/admin.py
@app/services/explorer.py
@frontend/src/admin/pages/SearchLabPage.tsx
@frontend/src/admin/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Search Lab backend to use run_explore() with legacy fallback</name>
  <files>app/routers/admin.py</files>
  <action>
Refactor the Search Lab compare endpoint in `app/routers/admin.py` to use `run_explore()` as the default pipeline while keeping the legacy retriever pipeline available for A/B comparison.

**Step 1: Add new config presets**

Update `_LAB_CONFIGS` to include pipeline-based presets. Keep the old presets but add new ones:

```python
_LAB_CONFIGS = {
    # New defaults — use run_explore() pipeline (matches live search)
    "explore_baseline": {"pipeline": "run_explore"},
    "explore_full":     {"pipeline": "run_explore"},  # run_explore always has feedback
    # Legacy — use old retriever pipeline (for alignment validation)
    "legacy_baseline":  {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": False, "FEEDBACK_LEARNING_ENABLED": False},
    "legacy_hyde":      {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": True,  "FEEDBACK_LEARNING_ENABLED": False},
    "legacy_feedback":  {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": False, "FEEDBACK_LEARNING_ENABLED": True},
    "legacy_full":      {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": True,  "FEEDBACK_LEARNING_ENABLED": True},
    # Backwards-compatible aliases (mapped to legacy for existing API consumers)
    "baseline": {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": False, "FEEDBACK_LEARNING_ENABLED": False},
    "hyde":     {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": True,  "FEEDBACK_LEARNING_ENABLED": False},
    "feedback": {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": False, "FEEDBACK_LEARNING_ENABLED": True},
    "full":     {"pipeline": "legacy", "QUERY_EXPANSION_ENABLED": True,  "FEEDBACK_LEARNING_ENABLED": True},
}
```

Update `_LAB_LABELS` similarly:
```python
_LAB_LABELS = {
    "explore_baseline": "Explore (Baseline)",
    "explore_full":     "Explore (Full)",
    "legacy_baseline":  "Legacy Baseline",
    "legacy_hyde":      "Legacy HyDE Only",
    "legacy_feedback":  "Legacy Feedback Only",
    "legacy_full":      "Legacy Full Intelligence",
    # Backwards-compatible
    "baseline": "Legacy Baseline",
    "hyde":     "Legacy HyDE Only",
    "feedback": "Legacy Feedback Only",
    "full":     "Legacy Full Intelligence",
}
```

**Step 2: Update CompareRequest defaults**

Change the default configs list to showcase the new pipeline:
```python
class CompareRequest(BaseModel):
    query: str = Field(..., min_length=1, max_length=2000)
    configs: list[str] = Field(
        default=["explore_baseline", "explore_full", "legacy_baseline", "legacy_full"],
        description="Which preset configs to run. Explore-prefixed use run_explore(); legacy-prefixed use FAISS retriever.",
    )
    result_count: int = Field(default=20, ge=1, le=50)
    overrides: dict[str, bool] = Field(
        default_factory=dict,
        description=(
            "Per-run flag overrides applied on top of DB settings. "
            "Keys: QUERY_EXPANSION_ENABLED, FEEDBACK_LEARNING_ENABLED. "
            "Only affects legacy pipeline configs."
        ),
    )
```

**Step 3: Add run_explore()-based retrieval function**

Add a new function `_explore_for_lab()` alongside the existing `_retrieve_for_lab()`:

```python
def _explore_for_lab(
    query: str,
    db: Session,
    app_state,
    result_count: int,
) -> tuple[list, dict]:
    """Run query through run_explore() pipeline for Search Lab.

    Uses the same 3-stage hybrid search (pre-filter + FAISS IDSelector + FTS5 BM25 fusion
    + findability boost + feedback boost) as the live /api/explore endpoint.
    """
    from app.services.explorer import run_explore as _run_explore

    result = _run_explore(
        query=query,
        rate_min=0.0,
        rate_max=10000.0,
        tags=[],
        limit=result_count,
        cursor=0,
        db=db,
        app_state=app_state,
    )

    experts = [
        {
            "rank": i + 1,
            "name": f"{e.first_name} {e.last_name}",
            "title": e.job_title,
            "score": round(e.final_score, 4),
            "profile_url": getattr(e, 'profile_url', None),
        }
        for i, e in enumerate(result.experts)
    ]
    intelligence = {
        "hyde_triggered": False,
        "hyde_bio": None,
        "feedback_applied": True,  # run_explore always applies inline feedback boost
        "pipeline": "run_explore",
    }
    return experts, intelligence
```

**Step 4: Update the _run_one() function in compare_configs()**

In `compare_configs()`, update the `_run_one()` inner function to route based on the pipeline field:

```python
def _run_one(args):
    name, flags = args
    pipeline = flags.get("pipeline", "legacy")
    thread_db = SessionLocal()
    try:
        if pipeline == "run_explore":
            experts, intelligence = _explore_for_lab(
                body.query, thread_db, app_state, body.result_count
            )
            # _explore_for_lab returns pre-serialized experts list
            return name, experts, intelligence
        else:
            # Legacy pipeline (original behavior)
            config_flags = {k: v for k, v in flags.items() if k != "pipeline"}
            config_flags.update(body.overrides)
            candidates, intelligence = _retrieve_for_lab(
                body.query, faiss_index, metadata, thread_db, config_flags, body.result_count
            )
            intelligence["pipeline"] = "legacy"
            return name, candidates, intelligence
    finally:
        thread_db.close()
```

**Step 5: Update serialization in compare_configs()**

The serialization needs to handle both return types: `_explore_for_lab` returns pre-serialized expert dicts, while `_retrieve_for_lab` returns `RetrievedExpert` objects. Update the column-building loop:

```python
columns = []
for name, result_data, intelligence in results:
    pipeline = intelligence.get("pipeline", "legacy")
    if pipeline == "run_explore":
        # Already serialized by _explore_for_lab
        experts_serialized = result_data
    else:
        # Legacy — serialize RetrievedExpert objects
        experts_serialized = [
            {
                "rank": i + 1,
                "name": c.name,
                "title": c.title,
                "score": round(c.score, 4),
                "profile_url": c.profile_url,
            }
            for i, c in enumerate(result_data)
        ]
    columns.append({
        "config": name,
        "label": _LAB_LABELS.get(name, name),
        "pipeline": pipeline,
        "experts": experts_serialized,
        "intelligence": intelligence,
    })
```

Note: The `app_state` variable needs to be captured. Add it to the compare_configs function before the ThreadPoolExecutor:
```python
app_state = request.app.state
```
Then pass it to `_run_one`. Since `_run_one` is a closure, it already has access to `request` -- but for run_explore we need `app_state` not `faiss_index/metadata` separately. The easiest approach: capture `app_state = request.app.state` at the top of compare_configs() and reference it in `_run_one`.

**Important:** The existing `_retrieve_for_lab()` function must NOT be deleted — it powers the legacy pipeline columns. Rename nothing; just add the new function alongside it.
  </action>
  <verify>
    grep -n "run_explore" app/routers/admin.py should show the new _explore_for_lab function and its import.
    grep -n "explore_baseline" app/routers/admin.py should show the new config preset.
    grep -n '"pipeline"' app/routers/admin.py should show the pipeline field in configs and response.
    python -c "from app.routers.admin import router; print('admin imports OK')"
  </verify>
  <done>The compare endpoint routes explore-prefixed configs through run_explore() and legacy-prefixed configs through the original retriever pipeline. Each response column includes a "pipeline" field. The existing _retrieve_for_lab() is preserved for legacy comparison. Backwards-compatible aliases (baseline, hyde, feedback, full) still work.</done>
</task>

<task type="auto">
  <name>Task 2: Add pipeline labels to Search Lab UI and update default configs</name>
  <files>frontend/src/admin/pages/SearchLabPage.tsx, frontend/src/admin/types.ts</files>
  <action>
**Step 1: Update types (types.ts)**

In `frontend/src/admin/types.ts`, find the `CompareColumn` type and add a `pipeline` field:

```typescript
// Add 'pipeline' to CompareColumn
pipeline?: string  // "run_explore" or "legacy"
```

Update `LabConfigKey` to include the new config options:

```typescript
export type LabConfigKey =
  | 'explore_baseline' | 'explore_full'
  | 'legacy_baseline' | 'legacy_hyde' | 'legacy_feedback' | 'legacy_full'
  | 'baseline' | 'hyde' | 'feedback' | 'full'
```

(If LabConfigKey is a union of string literals, expand it. If it's just `string`, no change needed.)

**Step 2: Update SearchLabPage.tsx**

Update the CONFIG_OPTIONS array to show the new pipeline-aware presets:

```typescript
const CONFIG_OPTIONS: { key: LabConfigKey; label: string; description: string }[] = [
  { key: 'explore_baseline', label: 'Explore (Baseline)',     description: 'Live search pipeline — no intelligence overrides' },
  { key: 'explore_full',     label: 'Explore (Full)',         description: 'Live search pipeline — matches what users see' },
  { key: 'legacy_baseline',  label: 'Legacy Baseline',        description: 'FAISS-only retriever, no intelligence' },
  { key: 'legacy_hyde',      label: 'Legacy HyDE Only',       description: 'FAISS retriever + HyDE query expansion' },
  { key: 'legacy_feedback',  label: 'Legacy Feedback Only',   description: 'FAISS retriever + feedback re-ranking' },
  { key: 'legacy_full',      label: 'Legacy Full Intelligence', description: 'FAISS retriever + HyDE + feedback' },
]
```

Update the default selectedConfigs state:
```typescript
const [selectedConfigs, setSelectedConfigs] = useState<LabConfigKey[]>(['explore_baseline', 'explore_full', 'legacy_baseline', 'legacy_full'])
```

**Step 3: Add pipeline label badge to CompareColumnCard**

In the `CompareColumnCard` component, add a pipeline badge in the column header (after the existing HyDE/Feedback badges). The badge should be visually distinct:

```tsx
{/* Pipeline label — shows which pipeline produced results */}
<span
  className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium border ${
    column.pipeline === 'run_explore'
      ? 'bg-emerald-900/50 text-emerald-300 border-emerald-700/50'
      : 'bg-slate-700/50 text-slate-400 border-slate-600/50'
  }`}
>
  <span
    className={`w-1 h-1 rounded-full ${
      column.pipeline === 'run_explore' ? 'bg-emerald-400' : 'bg-slate-500'
    }`}
  />
  {column.pipeline === 'run_explore' ? 'run_explore' : 'legacy'}
</span>
```

Add this badge BEFORE the HyDE and Feedback badges in the flex-wrap container, so the pipeline label appears first.

**Step 4: Update overrides note**

Update the per-run overrides description text to note that overrides only affect legacy pipeline configs:

Change the span text from:
```
(overrides preset configs, does not change global settings)
```
to:
```
(affects legacy configs only, does not change global settings)
```

**Step 5: Update minimum config count**

Keep the minimum at 2 configs for comparison. No change needed here.
  </action>
  <verify>
    grep -n "explore_baseline" frontend/src/admin/pages/SearchLabPage.tsx should show the new config option.
    grep -n "pipeline" frontend/src/admin/pages/SearchLabPage.tsx should show the pipeline badge code.
    grep -n "pipeline" frontend/src/admin/types.ts should show the new type field.
    cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>Search Lab UI shows pipeline labels on each result column (green "run_explore" badge for live pipeline, gray "legacy" badge for old retriever). Default configs compare explore pipeline against legacy pipeline for alignment validation. Override notes updated to clarify they only affect legacy configs. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `grep -rn "explore_baseline" app/routers/admin.py` confirms new config presets exist
2. `grep -rn "run_explore" app/routers/admin.py` confirms pipeline integration
3. `grep -rn "pipeline" frontend/src/admin/pages/SearchLabPage.tsx` confirms UI labels
4. Backend Python modules all import cleanly
5. Frontend TypeScript compiles without errors
</verification>

<success_criteria>
- Search Lab default configs use run_explore() as the base pipeline
- Legacy pipeline configs (legacy_baseline, legacy_hyde, legacy_feedback, legacy_full) use the old FAISS retriever for comparison
- Each result column shows a pipeline badge indicating "run_explore" or "legacy"
- Per-run HyDE/feedback overrides still work on legacy pipeline configs
- Backwards-compatible config aliases (baseline, hyde, feedback, full) still work
- The Search Lab UI is identical in layout; only config options and pipeline labels changed
</success_criteria>

<output>
After completion, create `.planning/phases/42-backend-error-hardening/42-02-SUMMARY.md`
</output>
