---
phase: 41-expert-email-purge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/main.py
  - app/routers/admin.py
  - data/experts.csv
autonomous: true
requirements:
  - PRIV-01
  - PRIV-02
  - PRIV-03

must_haves:
  truths:
    - "No Expert row in the SQLite database has a non-empty email value after server startup"
    - "The data/experts.csv file contains no Email column or Email data"
    - "Uploading a CSV with an Email column via POST /api/admin/experts/import-csv does not write email to any Expert row"
    - "Adding an expert via POST /api/admin/experts does not write Email to experts.csv"
    - "Conversation.email and Feedback.email columns are untouched and the admin Leads page functions normally"
  artifacts:
    - path: "app/main.py"
      provides: "Idempotent email purge UPDATE in lifespan + seed logic without Email"
      contains: "UPDATE experts SET email"
    - path: "app/routers/admin.py"
      provides: "Import and add_expert endpoints that never write Expert.email"
    - path: "data/experts.csv"
      provides: "Expert CSV with Email column entirely removed"
  key_links:
    - from: "app/main.py lifespan()"
      to: "SQLite experts table"
      via: "UPDATE experts SET email = ''"
      pattern: "UPDATE experts SET email"
    - from: "app/routers/admin.py import_experts_csv()"
      to: "Expert model"
      via: "Upsert without email assignment"
      pattern: "Expert\\("
    - from: "app/routers/admin.py add_expert()"
      to: "data/experts.csv"
      via: "CSV append without Email field"
      pattern: "fieldnames"
---

<objective>
Purge expert email data from all data stores and close re-introduction vectors.

Purpose: Remove expert PII (email addresses) before any public traffic reaches the platform. This is the first mandatory step of launch prep — all 1,558+ expert email values must be blanked in the DB, the Email column stripped from experts.csv, and future import/add paths must never write email data again. Only Expert.email is affected — Conversation.email and Feedback.email (user-consented lead captures) are explicitly preserved.

Output: Three surgical edits — lifespan migration in main.py, CSV column strip of data/experts.csv, and import guard updates in admin.py.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-expert-email-purge/41-CONTEXT.md
@.planning/phases/41-expert-email-purge/41-RESEARCH.md
@app/main.py
@app/routers/admin.py
@app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email purge migration to lifespan and clean seed logic</name>
  <files>app/main.py</files>
  <action>
Two changes to app/main.py:

**1. Add idempotent email purge UPDATE in lifespan() (PRIV-01)**

After the Phase 36 photo_url migration block (after the `log.info("startup: expert photo_url column migrated/verified")` line at ~line 232), add a new migration block:

```python
# Phase 41: Expert email purge — blank all Expert.email values (PII removal)
with engine.connect() as _conn:
    _conn.execute(_text("UPDATE experts SET email = ''"))
    _conn.commit()
log.info("startup: expert email purge applied (Phase 41)")
```

This runs on every startup. On the first run it blanks all 1,558 emails. On subsequent runs it's a no-op (already-blank values stay blank). No try/except needed — UPDATE with SET to empty string is always safe.

**2. Remove Email from _seed_experts_from_csv() (PRIV-03 coverage for seed path)**

In the `_seed_experts_from_csv()` function (~line 83-85), delete the line:
```python
email=(row.get("Email") or "").strip(),
```

The Expert model has `email` with `default=""` so omitting it from the constructor is valid — it will default to `""`. This ensures that even if someone re-adds an Email column to the CSV, seeding will never populate the email field.

**Important: Do NOT touch Conversation.email or Feedback.email anywhere — those are different tables for lead capture and must remain functional.**
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "
import ast, sys
with open('app/main.py') as f:
    content = f.read()
# Check 1: purge migration exists
assert \"UPDATE experts SET email = ''\" in content, 'PRIV-01: purge migration missing'
# Check 2: seed logic no longer references Email
tree = ast.parse(content)
for node in ast.walk(tree):
    if isinstance(node, ast.Call) and hasattr(node, 'keywords'):
        for kw in node.keywords:
            if kw.arg == 'email' and isinstance(kw.value, ast.Call):
                # Check if this is inside _seed_experts_from_csv
                pass  # AST check is tricky; fall back to string check
# Simpler string check: the seed function should not have row.get('Email')
seed_start = content.index('def _seed_experts_from_csv')
seed_end = content.index('\ndef ', seed_start + 1) if '\ndef ' in content[seed_start+1:] else len(content)
seed_body = content[seed_start:seed_start + (seed_end - seed_start) if seed_end != len(content) else len(content)]
assert 'Email' not in seed_body, 'seed function still references Email'
print('All checks passed')
"
    </automated>
    <manual>Start the server locally and check: SELECT COUNT(*) FROM experts WHERE email != '' — should be 0</manual>
  </verify>
  <done>
    - The lifespan() function contains an idempotent UPDATE experts SET email = '' migration block after the Phase 36 block
    - The _seed_experts_from_csv() function no longer passes email= to the Expert constructor
    - Conversation.email and Feedback.email references are completely untouched
  </done>
</task>

<task type="auto">
  <name>Task 2: Strip Email from CSV and close import/add re-introduction vectors</name>
  <files>data/experts.csv, app/routers/admin.py</files>
  <action>
Three changes:

**1. Strip Email column from data/experts.csv (PRIV-02)**

Run an inline Python script to rewrite data/experts.csv without the Email column:

```python
import csv
from pathlib import Path

csv_path = Path("data/experts.csv")

with open(csv_path, "r", encoding="utf-8-sig", newline="") as f:
    reader = csv.DictReader(f)
    rows = list(reader)
    fieldnames = [fn for fn in (reader.fieldnames or []) if fn != "Email"]

with open(csv_path, "w", newline="", encoding="utf-8") as f:
    writer = csv.DictWriter(f, fieldnames=fieldnames, extrasaction="ignore")
    writer.writeheader()
    writer.writerows(rows)
```

After running, verify the output: the CSV should have the same number of data rows (1,610) but one fewer column, and "Email" should not appear in the header row.

**2. Remove email writes from import_experts_csv() in admin.py (PRIV-03)**

In `app/routers/admin.py`, function `import_experts_csv()`:

- In the `if existing:` branch (~line 1035), DELETE this line:
  ```python
  existing.email = (row.get("Email") or "").strip()
  ```

- In the `else:` branch Expert() constructor (~line 1053), DELETE this line:
  ```python
  email=(row.get("Email") or "").strip(),
  ```

The Expert model `email` field has `default=""`, so omitting it from the constructor is valid. Uploaded CSVs that still include an Email column are harmless — the value is simply never read.

**3. Remove Email from add_expert() CSV append in admin.py (PRIV-03)**

In `app/routers/admin.py`, function `add_expert()`:

- In the `fieldnames` list (~line 968-972), remove `"Email"` from the list. The line currently reads:
  ```python
  "Email", "Username", "First Name", "Last Name", "Job Title",
  ```
  Change to:
  ```python
  "Username", "First Name", "Last Name", "Job Title",
  ```

- In the `writer.writerow({...})` call (~line 977), remove the `"Email": "",` entry.

This prevents a ValueError crash when appending to experts.csv (which no longer has an Email header) and ensures no Email data is ever written to the CSV again.

**Important: Do NOT modify any code related to Conversation.email, Feedback.email, EmailLead, or the leads/newsletter endpoints. Those are different tables serving the admin Leads page and must remain untouched.**
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "
import csv, sys

# Check 1: experts.csv has no Email column
with open('data/experts.csv', 'r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    rows = list(reader)
    assert 'Email' not in (reader.fieldnames or []), 'PRIV-02: Email column still in CSV header'
    assert len(rows) > 1500, f'PRIV-02: CSV row count too low: {len(rows)}'

# Check 2: admin.py import_experts_csv no longer writes email
with open('app/routers/admin.py') as f:
    content = f.read()

# Find import_experts_csv function body
import_start = content.index('def import_experts_csv')
import_end = content.index('\nasync def ', import_start + 1) if '\nasync def ' in content[import_start+1:] else content.index('\ndef ', import_start + 1)
import_body = content[import_start:import_end]
assert 'existing.email' not in import_body, 'PRIV-03: import still writes existing.email'
# The Expert() constructor in the else branch should not have email=
# Check that there's no email=(row.get pattern in the import function
assert 'email=(row.get' not in import_body, 'PRIV-03: import Expert() still has email= from CSV'

# Check 3: add_expert fieldnames no longer includes Email
add_start = content.index('def add_expert')
add_end_search = content[add_start+1:]
try:
    add_end = add_start + 1 + add_end_search.index('\nasync def ')
except ValueError:
    add_end = add_start + 1 + add_end_search.index('\ndef ')
add_body = content[add_start:add_end]
# Check fieldnames list does not include Email
assert '\"Email\"' not in add_body, 'PRIV-03: add_expert still has Email in fieldnames or writerow'

# Check 4: Conversation.email and leads code is untouched
assert 'Conversation.email' in content, 'SAFETY: Conversation.email references were accidentally removed'

print(f'All checks passed. CSV has {len(rows)} rows, {len(reader.fieldnames)} columns.')
"
    </automated>
    <manual>Upload a test CSV with an Email column via the admin import endpoint — Expert.email should remain "" for all imported/updated rows</manual>
  </verify>
  <done>
    - data/experts.csv has no Email column header and no email data (same row count, one fewer column)
    - import_experts_csv() no longer assigns email from CSV data to Expert rows (both update and insert branches)
    - add_expert() CSV append no longer includes Email in fieldnames or row dict
    - All Conversation.email, Feedback.email, and Leads-related code is completely untouched
  </done>
</task>

</tasks>

<verification>
Run all verification checks in sequence:

1. **PRIV-01 — DB purge migration exists:**
   ```
   grep -c "UPDATE experts SET email" app/main.py  # Should output 1
   ```

2. **PRIV-02 — CSV Email column removed:**
   ```
   head -1 data/experts.csv | grep -c "Email"  # Should output 0
   ```

3. **PRIV-03 — Import re-introduction vector closed:**
   ```
   grep -c "existing.email" app/routers/admin.py  # Should output 0 (for Expert email writes)
   ```

4. **Safety — Lead capture email untouched:**
   ```
   grep -c "Conversation.email" app/routers/admin.py  # Should be > 0
   ```

5. **Functional — Server starts without errors:**
   ```
   cd /Users/sebastianhamers/Documents/TCS && timeout 10 python -c "from app.main import app; print('Import OK')" 2>&1 || true
   ```
</verification>

<success_criteria>
- UPDATE experts SET email = '' migration runs on every server startup (idempotent)
- data/experts.csv has zero Email column presence (header and data)
- import_experts_csv() silently ignores Email in uploaded CSVs
- add_expert() appends to CSV without Email field
- _seed_experts_from_csv() does not read Email from CSV
- Conversation.email, Feedback.email, EmailLead, and admin Leads page code are 100% unchanged
- Server imports and starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-expert-email-purge/41-01-SUMMARY.md`
</output>
