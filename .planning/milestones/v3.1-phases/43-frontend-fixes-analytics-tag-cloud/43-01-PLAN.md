---
phase: 43-frontend-fixes-analytics-tag-cloud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/src/components/sidebar/TagCloud.tsx
  - frontend/index.html
  - frontend/src/analytics.tsx
  - frontend/src/layouts/RootLayout.tsx
autonomous: true
requirements:
  - ERR-02
  - DISC-01
  - ANLT-01
  - ANLT-02

must_haves:
  truths:
    - "Navigating to /explore, /marketplace, /browse, or /chat does not produce a Maximum call stack exceeded error — the browser redirects to / with query params preserved"
    - "The GA4 property G-0T526W3E1Z receives a page_view event on initial load with the full path including query params"
    - "Navigating between routes via React Router fires a new page_view event in GA4 without a full page reload"
    - "The desktop tag cloud displays 18 tags simultaneously (up from 12)"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "Fixed RedirectWithParams using imperative useNavigate+useEffect instead of declarative Navigate"
      contains: "useNavigate"
    - path: "frontend/index.html"
      provides: "gtag.js script loading GA4 property G-0T526W3E1Z with send_page_view:false"
      contains: "G-0T526W3E1Z"
    - path: "frontend/src/analytics.tsx"
      provides: "Analytics component that fires page_view on every route change via useLocation"
      exports: ["Analytics"]
    - path: "frontend/src/layouts/RootLayout.tsx"
      provides: "Analytics component mounted inside router context"
      contains: "Analytics"
    - path: "frontend/src/components/sidebar/TagCloud.tsx"
      provides: "Tag cloud showing 18 visible tags"
      contains: "Math.max(18"
  key_links:
    - from: "frontend/src/analytics.tsx"
      to: "window.gtag"
      via: "useEffect on useLocation change"
      pattern: "window\\.gtag.*page_view"
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "frontend/src/analytics.tsx"
      via: "import and render Analytics component"
      pattern: "import.*Analytics"
    - from: "frontend/src/main.tsx"
      to: "react-router-dom navigate()"
      via: "useEffect with empty deps for one-shot redirect"
      pattern: "useEffect.*navigate.*\\[\\]"
---

<objective>
Fix the React redirect loop on legacy routes, add GA4 page-view tracking, and expand the desktop tag cloud from 12 to 18 visible tags.

Purpose: Eliminate the last frontend Sentry error (redirect loop), enable analytics from launch day, and improve expert discovery with more visible domain tags.
Output: Four modified files + one new file (analytics.tsx) delivering all four phase requirements.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-frontend-fixes-analytics-tag-cloud/43-RESEARCH.md

@frontend/src/main.tsx
@frontend/src/layouts/RootLayout.tsx
@frontend/src/components/sidebar/TagCloud.tsx
@frontend/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix redirect loop and expand tag cloud</name>
  <files>
    frontend/src/main.tsx
    frontend/src/components/sidebar/TagCloud.tsx
  </files>
  <action>
**ERR-02 — Fix RedirectWithParams in main.tsx:**

Replace the current `RedirectWithParams` component (lines 25-29) with an imperative version using `useNavigate` + `useEffect`:

```tsx
function RedirectWithParams({ to }: { to: string }) {
  const navigate = useNavigate()
  const [searchParams] = useSearchParams()

  useEffect(() => {
    const qs = searchParams.toString()
    navigate(qs ? `${to}?${qs}` : to, { replace: true })
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  return null
}
```

Key changes:
1. Add `useNavigate` to the import from `react-router-dom` (add `useNavigate` and `useEffect` from react)
2. Replace the declarative `<Navigate>` return with `navigate()` inside `useEffect(fn, [])` — runs once on mount
3. Return `null` instead of a Navigate element
4. Add eslint-disable comment on the empty deps array (intentional run-once redirect semantics)
5. Remove `Navigate` from the `react-router-dom` import ONLY IF it's no longer used elsewhere in the file — BUT it IS still used for `/browse`, `/chat`, and admin redirects. So keep the `Navigate` import.

**DISC-01 — Expand tag cloud in TagCloud.tsx:**

In `TagCloud.tsx` line 89, change:
```tsx
const visibleCount = Math.max(12, selected.length)
```
to:
```tsx
const visibleCount = Math.max(18, selected.length)
```

Update the comment on line 86 from "up to 12 total" to "up to 18 total" to match.

No responsive breakpoint logic needed — TagCloud is only rendered inside FilterSidebar which has `hidden md:flex`, so it is always desktop-only.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Open browser to /explore — should redirect to / without console errors. Tag cloud should show 18 pills.</manual>
  </verify>
  <done>
    - RedirectWithParams uses imperative useNavigate+useEffect pattern — no more Navigate re-render loop
    - Legacy routes (/explore, /marketplace) still redirect to / with query params preserved
    - /browse and /chat still redirect to / (these use plain Navigate which is fine — no useSearchParams re-render trigger)
    - Tag cloud displays 18 visible tags on desktop
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GA4 page-view tracking with SPA route change support</name>
  <files>
    frontend/index.html
    frontend/src/analytics.tsx
    frontend/src/layouts/RootLayout.tsx
  </files>
  <action>
**ANLT-01 — Add gtag.js script to index.html:**

In `frontend/index.html`, add the following inside `<head>` before the closing `</head>` tag:

```html
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0T526W3E1Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-0T526W3E1Z', { send_page_view: false });
</script>
```

CRITICAL: `send_page_view: false` is required to prevent double page_view on initial load. The React Analytics component handles ALL page_view events manually.

**ANLT-02 — Create Analytics component:**

Create a new file `frontend/src/analytics.tsx`:

```tsx
import { useEffect } from 'react'
import { useLocation } from 'react-router-dom'

declare global {
  interface Window {
    gtag: (...args: unknown[]) => void
  }
}

export function Analytics() {
  const location = useLocation()

  useEffect(() => {
    if (typeof window.gtag !== 'function') return
    window.gtag('event', 'page_view', {
      page_path: location.pathname + location.search,
      page_title: document.title,
    })
  }, [location])

  return null
}
```

Key points:
- `location.pathname + location.search` includes query params (e.g. `/?tags=saas`) per user decision
- Guard `typeof window.gtag !== 'function'` handles ad blockers and script load failures gracefully
- TypeScript `declare global` extends Window with gtag type to avoid TS errors

**Mount Analytics in RootLayout.tsx:**

In `frontend/src/layouts/RootLayout.tsx`:
1. Add import: `import { Analytics } from '../analytics'`
2. Add `<Analytics />` as the first child inside the top-level fragment, before `<Outlet />`:

```tsx
return (
  <>
    <Analytics />
    <Outlet />
    {/* ... rest of existing layout ... */}
  </>
)
```

This places Analytics inside the RouterProvider context (required for `useLocation`) and tracks all non-admin routes. Admin routes are intentionally excluded (different layout tree, per research recommendation).
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Open browser with Network tab filtered to "collect" or "google" — navigate between pages and verify page_view requests fire with correct page_path including query params.</manual>
  </verify>
  <done>
    - index.html loads gtag.js with GA4 property G-0T526W3E1Z and send_page_view:false
    - Analytics component fires page_view on every route change with full path + query params
    - Analytics is mounted inside RootLayout (inside RouterProvider context)
    - Ad blocker resilient — gtag existence check prevents errors
    - Admin routes are NOT tracked (intentional — different layout tree)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd frontend && npx tsc --noEmit` passes with no errors
2. Redirect loop: Navigate to /explore in browser — redirects to / without "Maximum call stack exceeded" in console
3. Query param preservation: Navigate to /explore?tags=saas — redirects to /?tags=saas
4. Tag cloud: Desktop view shows 18 tag pills in the sidebar
5. GA4 initial load: Network tab shows gtag.js loaded and a page_view event fired
6. GA4 SPA navigation: Click a tag or navigate — new page_view event fires without full page reload
7. Build: `cd frontend && npm run build` completes without errors
</verification>

<success_criteria>
- Zero "Maximum call stack exceeded" errors when visiting /explore, /marketplace, /browse, or /chat
- GA4 property G-0T526W3E1Z receives page_view events on load and on SPA route changes
- Desktop tag cloud shows 18 tags (confirmed by counting pills in sidebar)
- `npm run build` succeeds with no TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-frontend-fixes-analytics-tag-cloud/43-01-SUMMARY.md`
</output>
