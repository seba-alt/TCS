---
phase: 37-backend-endpoints
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
autonomous: true
requirements: [PHOTO-01]

must_haves:
  truths:
    - "Admin can POST CSV with first_name,last_name,photo_url to bulk-import photo URLs"
    - "Dry-run mode (default) returns preview counts and line-by-line detail without writing anything"
    - "Commit mode (dry_run=false) actually writes photo URLs to Expert records"
    - "Ambiguous name matches (2+ experts with same first+last name) are skipped and reported"
    - "Not-found names are reported in response details"
    - "Existing photos are overwritten when matched (admin intentionally updating)"
    - "Admin _serialize_expert includes photo_url field"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "POST /api/admin/experts/photos endpoint and updated _serialize_expert"
      contains: "experts/photos"
  key_links:
    - from: "app/routers/admin.py"
      to: "app/models.py"
      via: "Expert.photo_url write on commit"
      pattern: "expert\\.photo_url\\s*="
---

<objective>
Add admin bulk photo URL import endpoint (POST /api/admin/experts/photos) with CSV upload, dry-run preview, and name-based matching. Also update _serialize_expert to include photo_url.

Purpose: Admin can populate expert photos from a CSV before the Browse UI launches, with a safe dry-run preview step to verify matches before writing.
Output: New endpoint in `app/routers/admin.py`, updated serializer
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-backend-endpoints/37-CONTEXT.md
@.planning/phases/37-backend-endpoints/37-RESEARCH.md
@.planning/phases/36-foundation/36-02-SUMMARY.md
@app/routers/admin.py
@app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST /api/admin/experts/photos endpoint with CSV bulk import</name>
  <files>app/routers/admin.py</files>
  <action>
Add a new endpoint to the admin `router` (the one with `_require_admin` dependency) in `app/routers/admin.py`.

**Endpoint:** `POST /api/admin/experts/photos`
- Accepts `file: UploadFile` (CSV file)
- Query param: `dry_run: bool = Query(default=True)`
- Requires `X-Admin-Key` header (already handled by the router dependency)

**CSV format expected:** `first_name,last_name,photo_url` — standard CSV with header row.

**Implementation logic:**
1. Read the uploaded CSV file content (`await file.read()`, decode utf-8)
2. Parse with `csv.DictReader` from `io.StringIO`
3. Validate that CSV has the required columns: `first_name`, `last_name`, `photo_url`. If missing, return 400 with detail of which columns are missing.
4. For each row:
   a. Query Expert by `func.lower(Expert.first_name) == row["first_name"].strip().lower()` AND `func.lower(Expert.last_name) == row["last_name"].strip().lower()`
   b. If exactly 1 match: status = `"matched"`, record `username` and `existing_photo` (current photo_url or null)
   c. If 0 matches: status = `"not_found"`
   d. If 2+ matches: status = `"ambiguous"`, record list of matching usernames
5. If `dry_run=False`: for each matched expert, set `expert.photo_url = row["photo_url"].strip()`, then `db.commit()`
6. If `dry_run=True`: no writes, just return the preview

**Response shape:**
```json
{
    "dry_run": true,
    "summary": {
        "total": 11,
        "matched": 8,
        "not_found": 2,
        "ambiguous": 1,
        "will_overwrite": 3
    },
    "details": [
        {"first_name": "John", "last_name": "Doe", "status": "matched", "username": "john-doe", "existing_photo": null},
        {"first_name": "Jane", "last_name": "Smith", "status": "ambiguous", "matches": ["jane-smith-1", "jane-smith-2"]},
        {"first_name": "Bob", "last_name": "Unknown", "status": "not_found"}
    ]
}
```

`will_overwrite` counts how many matched experts already have a non-null `photo_url` (so admin knows they are replacing existing photos).

Place this endpoint near the bottom of the admin router, below the existing expert management endpoints. Add a section comment: `# --- Photo management endpoints ---`

Note: `csv`, `io`, `func` (from sqlalchemy) are already imported at the top of admin.py. `UploadFile`, `File`, and `Query` are already imported from FastAPI.

Add `Query` to the fastapi import if not present (check first — it may already be there from explore.py pattern). Actually, `Query` is NOT currently in the admin.py imports. Add it: change `from fastapi import APIRouter, BackgroundTasks, Depends, File, HTTPException, Request, Security, UploadFile, status` to include `Query` (alphabetical: after `HTTPException`, before `Request`).
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.admin import router; routes = [r.path for r in router.routes]; assert '/experts/photos' in routes or any('photos' in r for r in routes), f'Missing photo endpoint in {routes}'; print('Photo import endpoint registered')"</automated>
    <manual>Verify the endpoint appears in admin router routes and accepts UploadFile</manual>
  </verify>
  <done>POST /api/admin/experts/photos accepts CSV upload, supports dry_run preview and commit mode, handles matched/not_found/ambiguous cases, reports will_overwrite count.</done>
</task>

<task type="auto">
  <name>Task 2: Update _serialize_expert to include photo_url</name>
  <files>app/routers/admin.py</files>
  <action>
Update the `_serialize_expert()` function at line 222 of `app/routers/admin.py` to include the `photo_url` field.

Add `"photo_url": e.photo_url,` to the returned dictionary, after the `"findability_score"` entry.

This ensures the admin expert list endpoint (GET /api/admin/experts) and any other admin endpoints using this serializer will include the photo URL in their responses, which is important for admin to see which experts have photos assigned.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.admin import _serialize_expert; from app.models import Expert; e = Expert(username='test', photo_url='https://example.com/photo.jpg'); d = _serialize_expert(e); assert 'photo_url' in d and d['photo_url'] == 'https://example.com/photo.jpg', f'photo_url missing or wrong: {d}'; print('photo_url in serializer OK')"</automated>
  </verify>
  <done>_serialize_expert includes photo_url field — admin expert list shows photo URL status for all experts.</done>
</task>

</tasks>

<verification>
1. `python -c "from app.routers.admin import router; print([r.path for r in router.routes])"` — shows `/experts/photos` in routes
2. `python -c "from app.routers.admin import _serialize_expert; print('photo_url' in _serialize_expert.__code__.co_consts)"` — confirms photo_url in serializer
3. Manual: create a test CSV with 2-3 rows, POST to endpoint with dry_run=true, verify response counts and details
</verification>

<success_criteria>
- POST /api/admin/experts/photos accepts CSV with first_name,last_name,photo_url columns
- Dry-run (default) returns preview with matched/not_found/ambiguous/will_overwrite counts plus line-by-line details
- Commit mode (dry_run=false) writes photo URLs to Expert records
- Ambiguous matches (2+ experts same name) are skipped and reported
- _serialize_expert includes photo_url field
- Endpoint requires X-Admin-Key authentication
</success_criteria>

<output>
After completion, create `.planning/phases/37-backend-endpoints/37-02-SUMMARY.md`
</output>
