---
phase: 36-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/src/pages/BrowsePage.tsx
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/vercel.json
autonomous: true
requirements:
  - NAV-01
must_haves:
  truths:
    - "Visiting `/` renders the BrowsePage stub component (not Explorer)"
    - "Visiting `/explore` renders the Explorer (formerly at `/marketplace`)"
    - "Visiting `/marketplace` redirects permanently to `/explore` with query params preserved"
    - "Visiting `/chat` redirects to `/explore`"
    - "Direct `/explore` URL visits still reset the Sage pilot (clean panel)"
    - "Navigating from Browse to Explorer does not wipe Sage pilot state when navigationSource is 'browse'"
  artifacts:
    - path: "frontend/src/pages/BrowsePage.tsx"
      provides: "BrowsePage stub component"
      min_lines: 15
    - path: "frontend/src/main.tsx"
      provides: "Route definitions for /, /explore, /marketplace redirect, /chat redirect"
      contains: "BrowsePage"
    - path: "frontend/vercel.json"
      provides: "CDN-level permanent redirect from /marketplace to /explore"
      contains: "redirects"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/pages/BrowsePage.tsx"
      via: "route element import"
      pattern: "import BrowsePage"
    - from: "frontend/src/main.tsx"
      to: "frontend/src/pages/MarketplacePage.tsx"
      via: "route element at /explore path"
      pattern: "path.*explore.*MarketplacePage"
---

<objective>
Restructure frontend routes so `/` serves a BrowsePage stub, `/explore` serves the existing Explorer, `/marketplace` permanently redirects to `/explore`, and `/chat` redirects to `/explore`.

Purpose: Establish the v3.0 URL structure before any Browse UI is built. Every subsequent phase depends on these routes existing.
Output: Updated router config, BrowsePage stub, Vercel redirect config, gated resetPilot.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-foundation/36-CONTEXT.md
@.planning/phases/36-foundation/36-RESEARCH.md
@frontend/src/main.tsx
@frontend/src/pages/MarketplacePage.tsx
@frontend/vercel.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrowsePage stub and restructure routes</name>
  <files>
    frontend/src/pages/BrowsePage.tsx
    frontend/src/main.tsx
  </files>
  <action>
1. Create `frontend/src/pages/BrowsePage.tsx` — a minimal stub component that renders:
   - A centered container with "Browse" as the heading
   - A short placeholder text like "Coming soon — expert discovery reimagined"
   - Use Tailwind classes consistent with the project style (e.g., flex centering, text-gray-900)
   - Export as default function component `BrowsePage`
   - No data fetching, no API calls, no store usage — pure stub

2. Update `frontend/src/main.tsx` router:
   - Import `BrowsePage` from `./pages/BrowsePage.tsx`
   - Change the `path: '/'` route from `<Navigate to="/marketplace" replace />` to `element: <BrowsePage />`
   - Change the `path: '/marketplace'` route to serve as a redirect: create a small `MarketplaceRedirect` component inline (or as a separate tiny component in main.tsx) that reads `useSearchParams()`, builds the destination URL `/explore` + preserved query string, and renders `<Navigate to={destination} replace />`. This handles SPA-internal navigation to `/marketplace`. Note: `useSearchParams` requires the component to be rendered inside the router, so it must be a component (not just a Navigate element).
   - Add a new route `path: '/explore'` with `element: <MarketplacePage />`
   - Change `path: '/chat'` from `element: <App />` to `element: <Navigate to="/explore" replace />`
   - Keep all `/admin` routes unchanged

The final router array should look like:
```
[
  { path: '/', element: <BrowsePage /> },
  { path: '/explore', element: <MarketplacePage /> },
  { path: '/marketplace', element: <MarketplaceRedirect /> },
  { path: '/chat', element: <Navigate to="/explore" replace /> },
  { path: '/admin/login', ... },
  { path: '/admin', ... },
]
```

For the `MarketplaceRedirect` component, define it above the router:
```tsx
function MarketplaceRedirect() {
  const [searchParams] = useSearchParams()
  const queryString = searchParams.toString()
  const destination = queryString ? `/explore?${queryString}` : '/explore'
  return <Navigate to={destination} replace />
}
```

Note: `useSearchParams` is already imported in the project (used by useUrlSync.ts) so the import pattern is established.

3. Remove the `App` import from main.tsx since `/chat` no longer uses it. The standalone chat App component at `App.tsx` can stay in the codebase (no deletion) — it just won't be routed to.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Visit http://localhost:5173/ and verify BrowsePage stub renders. Visit /explore and verify Explorer loads. Visit /marketplace?q=test and verify redirect to /explore?q=test.</manual>
  </verify>
  <done>
    - `/` renders BrowsePage stub (not Explorer, not redirect)
    - `/explore` renders the full Explorer (MarketplacePage component)
    - `/marketplace` redirects to `/explore` preserving query params
    - `/chat` redirects to `/explore`
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Vercel permanent redirect and gate resetPilot</name>
  <files>
    frontend/vercel.json
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
1. Update `frontend/vercel.json` to add a permanent redirect from `/marketplace` to `/explore`. Vercel processes `redirects` before `rewrites`, so this will catch requests at the CDN level before the SPA catch-all rewrite fires. The query string is preserved automatically by Vercel for permanent redirects.

Update the file to:
```json
{
  "redirects": [
    { "source": "/marketplace", "destination": "/explore", "permanent": true }
  ],
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

2. Gate the `resetPilot()` call in `frontend/src/pages/MarketplacePage.tsx` (lines 33-36).

Currently:
```tsx
const resetPilot = useExplorerStore((s) => s.resetPilot)
useEffect(() => {
  resetPilot()
}, [resetPilot])
```

Replace with a gated version that checks `navigationSource` from the store. The `navigationSlice` is created in Plan 02 (same wave), but since this plan may execute first, use a safe access pattern: check if `navigationSource` exists on the store state, and default to `'direct'` if it doesn't (backward-compatible).

```tsx
const resetPilot = useExplorerStore((s) => s.resetPilot)
const navigationSource = useExplorerStore((s) => (s as any).navigationSource ?? 'direct')
useEffect(() => {
  // Only reset pilot on direct URL visits — preserve Sage state when arriving from Browse
  if (navigationSource === 'direct') {
    resetPilot()
  }
}, [resetPilot, navigationSource])
```

IMPORTANT: After Plan 02 creates the navigationSlice, the `(s as any)` cast becomes unnecessary because the store type will include `navigationSource`. But this safe access pattern ensures Plan 01 works independently of Plan 02's execution order.

Note: STATE.md warns this is "the highest-risk single change in the milestone." The default of `'direct'` preserves existing behavior for all current paths: anyone visiting `/explore` directly or via bookmark gets the pilot reset. Only when `navigationSource` is explicitly set to `'browse'` (by Browse page navigation in Phase 38+) does the reset skip.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>
      1. Verify vercel.json has the redirects array with /marketplace -> /explore permanent redirect
      2. Verify MarketplacePage.tsx has gated resetPilot with navigationSource check
      3. Visit /explore directly — pilot should still reset (navigationSource defaults to 'direct')
    </manual>
  </verify>
  <done>
    - vercel.json has permanent redirect from /marketplace to /explore
    - resetPilot() only fires when navigationSource is 'direct' (default behavior preserved)
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes in frontend directory
- [ ] Route `/` renders BrowsePage stub
- [ ] Route `/explore` renders Explorer (MarketplacePage)
- [ ] Route `/marketplace?q=test` redirects to `/explore?q=test` (SPA-level)
- [ ] Route `/chat` redirects to `/explore`
- [ ] vercel.json contains permanent redirect for CDN-level `/marketplace` -> `/explore`
- [ ] resetPilot() is gated by navigationSource with safe default of 'direct'
</verification>

<success_criteria>
All four NAV-01 route requirements met: `/` serves BrowsePage, `/explore` serves Explorer, `/marketplace` redirects permanently to `/explore` with query params, `/chat` redirects appropriately. The Vercel CDN redirect ensures external bookmarks/crawlers get a 308. The resetPilot gate is in place for the Sage handoff pattern (SAGE-04 precondition).
</success_criteria>

<output>
After completion, create `.planning/phases/36-foundation/36-01-SUMMARY.md`
</output>
