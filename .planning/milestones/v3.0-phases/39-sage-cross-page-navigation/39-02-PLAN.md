---
phase: 39-sage-cross-page-navigation
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - frontend/src/hooks/useSage.ts
  - frontend/src/hooks/useExplore.ts
autonomous: false
requirements: [SAGE-03]

must_haves:
  truths:
    - "User asks Sage a discovery question on Browse, Sage responds in the popover with results message, then auto-navigates to Explorer after ~2 seconds"
    - "Search results are visible in the Explorer expert grid on arrival — no competing 530-expert fetch flash"
    - "Non-discovery questions (general chat, filter refinements) stay on Browse — no navigation triggered"
    - "Multiple questions accumulate in the popover — only discovery responses trigger navigation"
    - "Sage panel on Explorer shows the full conversation thread including messages from Browse"
  artifacts:
    - path: "frontend/src/hooks/useSage.ts"
      provides: "Discovery detection and auto-navigation logic for Browse"
      min_lines: 80
    - path: "frontend/src/hooks/useExplore.ts"
      provides: "Pending Sage results consumption on Explorer mount"
      min_lines: 80
  key_links:
    - from: "frontend/src/hooks/useSage.ts"
      to: "navigationSlice"
      via: "setPendingSageResults + setNavigationSource('sage') before navigate"
      pattern: "setPendingSageResults"
    - from: "frontend/src/hooks/useSage.ts"
      to: "react-router-dom"
      via: "useNavigate for auto-navigation from Browse to Explorer"
      pattern: "navigate.*explore"
    - from: "frontend/src/hooks/useExplore.ts"
      to: "navigationSlice"
      via: "reads and consumes pendingSageResults on mount"
      pattern: "pendingSageResults"
    - from: "frontend/src/hooks/useSage.ts"
      to: "resultsSlice"
      via: "sets sageMode=true before navigation"
      pattern: "setSageMode.*true"
---

<objective>
Wire up Sage discovery search auto-navigation: when Sage performs a discovery search on Browse, show results message in the popover, then auto-navigate to Explorer with results pre-loaded in the grid. Non-discovery questions stay on Browse.

Purpose: SAGE-03 — discovery searches on Browse land the user in Explorer with results visible, no competing fetch flash.
Output: Updated useSage hook with navigation logic, updated useExplore hook consuming pending results.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-sage-cross-page-navigation/39-CONTEXT.md
@.planning/phases/39-sage-cross-page-navigation/39-RESEARCH.md
@.planning/phases/39-sage-cross-page-navigation/39-01-SUMMARY.md

# Key existing files
@frontend/src/hooks/useSage.ts
@frontend/src/hooks/useExplore.ts
@frontend/src/store/index.ts
@frontend/src/store/navigationSlice.ts
@frontend/src/store/resultsSlice.ts
@frontend/src/store/pilotSlice.ts
@frontend/src/pages/MarketplacePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add discovery auto-navigation to useSage and pending results consumption to useExplore</name>
  <files>
    frontend/src/hooks/useSage.ts
    frontend/src/hooks/useExplore.ts
  </files>
  <action>
**1. Update `frontend/src/hooks/useSage.ts`:**

The useSage hook needs to detect when it's on Browse and a discovery search was performed, then auto-navigate to Explorer after a delay.

Add imports:
```typescript
import { useLocation, useNavigate } from 'react-router-dom'
```

Inside `useSage()`, add route detection and navigation:
```typescript
const location = useLocation()
const navigate = useNavigate()
const isExplorer = location.pathname === '/explore'
```

**Modify the `handleSend` callback to handle Browse-specific discovery flow:**

In the existing `search_performed === true` branch, add a conditional path:

```typescript
if (data.search_performed === true) {
  const store = useExplorerStore.getState()
  const experts = data.experts ?? []
  const total = data.total ?? 0

  if (isExplorer) {
    // On Explorer: existing behavior — inject results directly into store
    store.setLoading(false)
    store.setResults(experts, total, null)
    store.setSageMode(true)
  } else {
    // On Browse: store results as pending, then auto-navigate after delay
    store.setPendingSageResults(experts, data.message ?? '')
    store.setSageMode(true)  // MUST set before navigate to prevent useExplore competing fetch

    // Add assistant message to popover first (user sees "Found X experts...")
    addMessage({
      id: `${Date.now()}-assistant`,
      role: 'assistant',
      content: data.message ?? "I've found some experts for you!",
      timestamp: Date.now(),
    })

    // Auto-navigate after ~2 seconds so user can read the response
    setTimeout(() => {
      store.setNavigationSource('sage')  // MUST be before navigate — prevents resetPilot
      navigate('/explore')
    }, 2000)

    // Early return — skip the addMessage below (we already added it above)
    setStreaming(false)
    return
  }
}
```

**CRITICAL ordering for navigation:**
1. `setPendingSageResults()` — stores experts for Explorer to consume
2. `setSageMode(true)` — prevents useExplore from starting a competing /api/explore fetch
3. `setNavigationSource('sage')` — prevents resetPilot on Explorer mount
4. `navigate('/explore')` — triggers route change

Steps 1-2 happen immediately after API response. Steps 3-4 happen in the setTimeout (after 2 second delay).

**For the `filters` branch (non-discovery, apply_filters):** On Browse, filter refinements have no grid to apply to. Simply show the message in the popover without applying filters:

```typescript
} else if (data.filters && typeof data.filters === 'object') {
  if (isExplorer) {
    // On Explorer: existing behavior — apply filter changes
    validateAndApplyFilters(data.filters as Record<string, unknown>)
  }
  // On Browse: no grid to filter — just show the message (falls through to addMessage below)
}
```

Update the `useCallback` dependency array to include `isExplorer` and `navigate`:
```typescript
}, [isStreaming, addMessage, setStreaming, triggerSpin, isExplorer, navigate])
```

**Important note on `setPendingSageResults` second argument:** The current navigationSlice signature is `setPendingSageResults(experts: Expert[], query: string)`. Pass the search query text (the user's original message) as the second argument, NOT the response message. This is the `pendingSearchQuery` used for display context. Use the user's input text:
```typescript
store.setPendingSageResults(experts, text.trim())
```

**2. Update `frontend/src/hooks/useExplore.ts`:**

The useExplore hook needs to consume `pendingSageResults` on mount when navigating from Browse via Sage.

Add a new `useEffect` that runs once on mount to check for and consume pending Sage results:

```typescript
// Consume pending Sage results (from Browse → Explorer Sage navigation)
const pendingSageResults = useExplorerStore((s) => s.pendingSageResults)
const pendingSearchQuery = useExplorerStore((s) => s.pendingSearchQuery)
const clearPendingSageResults = useExplorerStore((s) => s.clearPendingSageResults)

useEffect(() => {
  if (pendingSageResults && pendingSageResults.length > 0) {
    // Inject Sage results directly — skip the normal /api/explore fetch
    setResults(pendingSageResults, pendingSageResults.length, null)
    setLoading(false)
    // sageMode is already true (set by useSage before navigation)
    clearPendingSageResults()
  }
}, [])  // Empty deps — run once on mount only
```

**IMPORTANT:** This effect must run BEFORE the main fetch effect. Place it above the existing `useEffect` that calls `/api/explore`. The `sageMode` guard in the main effect will prevent competing fetches since `sageMode` was set to `true` by `useSage` before navigation.

The empty dependency array `[]` is intentional — we only want to consume pending results on initial mount, not on every re-render. ESLint may warn about missing deps — this is a deliberate one-time mount effect.

Actually, a cleaner approach that avoids the lint warning: check for pending results inside the existing sageMode guard, since sageMode is already true when pending results exist:

Alternative approach (preferred — no extra effect needed):
In the existing main `useEffect`, BEFORE the sageMode guard, add consumption logic:

```typescript
useEffect(() => {
  // Consume pending Sage results from Browse navigation
  const pending = useExplorerStore.getState().pendingSageResults
  if (pending && pending.length > 0) {
    setResults(pending, pending.length, null)
    setLoading(false)
    useExplorerStore.getState().clearPendingSageResults()
    // sageMode is already true — the return below will prevent /api/explore fetch
  }

  // Sage mode guard — abort any in-flight explore request
  if (sageMode) {
    if (controllerRef.current) {
      controllerRef.current.abort()
      controllerRef.current = null
    }
    return
  }

  // ... rest of existing fetch logic unchanged
```

This reads pending results directly from the store (not via selector) to avoid adding it to the dependency array. The `clearPendingSageResults()` call ensures they're consumed exactly once. The `sageMode` guard then prevents any fetch.

Use this preferred approach — modify the existing useEffect, not add a new one.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Test flow: Open Browse, click FAB, type "find me AI experts", verify popover shows response, after ~2s auto-navigates to /explore with results in grid (no flash of 530 experts)</manual>
  </verify>
  <done>Discovery search on Browse shows results message in popover, then auto-navigates to Explorer after ~2s with Sage results pre-loaded in grid. Non-discovery questions stay on Browse. No competing 530-expert fetch flash on Explorer arrival. Conversation thread visible in Explorer SagePanel.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of Sage cross-page navigation</name>
  <files>
    frontend/src/hooks/useSage.ts
    frontend/src/hooks/useExplore.ts
  </files>
  <action>
Human verifies the complete Sage cross-page navigation flow. No code changes — this is a verification checkpoint.

What was built: Sage cross-page navigation — FAB on Browse opens popover, discovery searches auto-navigate to Explorer with pre-loaded results, conversation persists, direct visits start clean.

How to verify:
1. Start dev server: `cd frontend && npm run dev`
2. Open http://localhost:5173/ (Browse page)
3. **SAGE-01:** Verify purple FAB is visible at bottom-right on Browse page
4. Click FAB — verify compact popover opens (smaller than Explorer panel, no backdrop dimming)
5. Type a general question like "what is Tinrate?" — verify response shows in popover, NO navigation occurs
6. **SAGE-03:** Type a discovery question like "find me marketing experts" — verify:
   a. Sage responds in popover ("Found X experts...")
   b. After ~2 seconds, auto-navigates to /explore
   c. Expert grid shows the discovery results immediately (no flash of 530 experts first)
7. **SAGE-02:** Click FAB on Explorer — verify full SagePanel opens showing the COMPLETE conversation thread from Browse (both questions and all responses visible)
8. Close panel, navigate back to Browse (click browser back or logo)
9. Verify FAB is visible on Browse, popover is closed
10. **Direct visit test:** Type http://localhost:5173/explore directly in address bar — verify Sage panel starts clean (no stale messages from previous navigation)
11. **Mobile:** Check that FAB and popover work on mobile viewport (resize browser to ~375px width)
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>User confirms all 11 verification steps pass — covers SAGE-01, SAGE-02, SAGE-03 success criteria</manual>
  </verify>
  <done>User types "approved" confirming Sage cross-page navigation meets all success criteria: FAB on Browse, conversation continuity, discovery auto-navigation with pre-loaded results</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. Discovery search on Browse → popover shows response → auto-navigates to Explorer → results in grid (no flash)
3. Non-discovery questions on Browse stay in popover, no navigation
4. Conversation thread persists from Browse to Explorer
5. Direct /explore visits start with clean Sage panel
6. sageMode set to true BEFORE navigate prevents competing /api/explore fetch
7. navigationSource set to 'sage' BEFORE navigate prevents resetPilot
</verification>

<success_criteria>
- Discovery search on Browse auto-navigates to Explorer with results pre-loaded in grid
- No competing 530-expert fetch flash on Explorer arrival after Sage navigation
- Non-discovery questions stay on Browse
- Full conversation thread visible in Explorer after Browse interaction
- Human verifies end-to-end flow and approves
</success_criteria>

<output>
After completion, create `.planning/phases/39-sage-cross-page-navigation/39-02-SUMMARY.md`
</output>
