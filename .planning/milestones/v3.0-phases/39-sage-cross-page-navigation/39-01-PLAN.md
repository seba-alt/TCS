---
phase: 39-sage-cross-page-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/main.tsx
  - frontend/src/layouts/RootLayout.tsx
  - frontend/src/components/pilot/SagePopover.tsx
  - frontend/src/components/pilot/SageFAB.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: [SAGE-01, SAGE-02]

must_haves:
  truths:
    - "Sage FAB is visible on the Browse page at root layout level above the route outlet"
    - "Sage FAB is still visible on the Explorer page — behavior unchanged from v2.3"
    - "Clicking the FAB on Browse opens a compact popover chat (not the full Explorer side panel)"
    - "Clicking the FAB on Explorer opens the existing full-height SagePanel as before"
    - "Conversation history survives navigation from Browse to Explorer — messages are not lost"
    - "Direct /explore URL visits still start with a clean Sage panel (resetPilot on navigationSource=direct)"
    - "Back-navigation from Explorer to Browse closes any open Sage popover"
  artifacts:
    - path: "frontend/src/layouts/RootLayout.tsx"
      provides: "Shared layout wrapping Browse and Explorer with Sage components"
      min_lines: 30
    - path: "frontend/src/components/pilot/SagePopover.tsx"
      provides: "Compact chat popover for Browse page Sage interactions"
      min_lines: 40
    - path: "frontend/src/main.tsx"
      provides: "Updated router with layout route wrapping / and /explore"
      min_lines: 50
  key_links:
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "SageFAB"
      via: "renders FAB above Outlet"
      pattern: "SageFAB"
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "SagePopover"
      via: "renders popover when on Browse and isOpen"
      pattern: "SagePopover"
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "SagePanel"
      via: "renders full panel when on Explorer and isOpen"
      pattern: "SagePanel"
    - from: "frontend/src/main.tsx"
      to: "RootLayout"
      via: "layout route wrapping / and /explore"
      pattern: "RootLayout"
---

<objective>
Lift Sage FAB and panel rendering from MarketplacePage to a shared RootLayout, making Sage visible on both Browse and Explorer. Create a compact SagePopover for Browse interactions. Conversation history persists across navigation via Zustand pilotSlice.

Purpose: SAGE-01 (FAB on Browse) and SAGE-02 (conversation continuity) — the foundation for cross-page Sage presence.
Output: RootLayout component, SagePopover component, updated routing and MarketplacePage.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-sage-cross-page-navigation/39-CONTEXT.md
@.planning/phases/39-sage-cross-page-navigation/39-RESEARCH.md

# Key existing files
@frontend/src/main.tsx
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/pages/BrowsePage.tsx
@frontend/src/components/pilot/SageFAB.tsx
@frontend/src/components/pilot/SagePanel.tsx
@frontend/src/components/pilot/SageInput.tsx
@frontend/src/components/pilot/SageMessage.tsx
@frontend/src/hooks/useSage.ts
@frontend/src/store/index.ts
@frontend/src/store/pilotSlice.ts
@frontend/src/store/navigationSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SagePopover and RootLayout, update routing</name>
  <files>
    frontend/src/components/pilot/SagePopover.tsx
    frontend/src/layouts/RootLayout.tsx
    frontend/src/main.tsx
    frontend/src/components/pilot/SageFAB.tsx
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
**1. Create `frontend/src/components/pilot/SagePopover.tsx`:**

A compact chat popover for Browse. Lighter than SagePanel — smaller dimensions, positioned as a chat bubble above the FAB.

```typescript
import { useEffect, useRef } from 'react'
import { motion } from 'motion/react'
import { X } from 'lucide-react'
import { useExplorerStore } from '../../store'
import { useSage } from '../../hooks/useSage'
import { SageMessage } from './SageMessage'
import { SageInput } from './SageInput'
```

Export `SagePopover` component:
- Use `useSage()` hook (same as SagePanel — shared conversation via pilotSlice).
- Greeting: same `"Hey! I'm Sage — tell me what kind of expert you need and I'll find the right people."` shown when messages empty.
- Auto-scroll to bottom on new messages (same pattern as SagePanel).

Render structure — compact popover positioned above the FAB:
```tsx
<motion.div
  initial={{ opacity: 0, scale: 0.9, y: 8 }}
  animate={{ opacity: 1, scale: 1, y: 0 }}
  exit={{ opacity: 0, scale: 0.9, y: 8 }}
  transition={{ type: 'spring', stiffness: 400, damping: 28 }}
  className="fixed bottom-24 right-6 z-40"
>
  <div
    className="w-[340px] rounded-2xl border border-white/10 shadow-2xl flex flex-col overflow-hidden"
    style={{
      height: 'min(50vh, 420px)',
      background: 'oklch(12% 0.025 279 / 0.97)',
      backdropFilter: 'blur(20px)',
      WebkitBackdropFilter: 'blur(20px)',
    }}
  >
```

- **Header:** Same as SagePanel but slightly smaller. Sage icon + "Sage" label + close button.
- **Messages area:** Scrollable, same SageMessage rendering. Show greeting when empty, map messages, streaming indicator.
- **Input:** `<SageInput onSend={handleSend} disabled={isStreaming} />`

The popover is narrower (340px vs 380px) and shorter (50vh/420px vs 70vh/560px) for a lightweight chat bubble feel.

Key difference from SagePanel: no backdrop overlay. The popover floats over content without dimming the page.

**2. Create `frontend/src/layouts/RootLayout.tsx`:**

```typescript
import { useEffect } from 'react'
import { Outlet, useLocation } from 'react-router-dom'
import { AnimatePresence } from 'motion/react'
import { useExplorerStore } from '../store'
import { SageFAB } from '../components/pilot/SageFAB'
import { SagePanel } from '../components/pilot/SagePanel'
import { SagePopover } from '../components/pilot/SagePopover'
```

Export `RootLayout` component:
- Get `isOpen` and `setOpen` from `useExplorerStore`.
- Get current route via `useLocation()`.
- Determine `isExplorer = location.pathname === '/explore'`.

**Close popover on route change to Browse:**
```tsx
useEffect(() => {
  if (!isExplorer) {
    setOpen(false)
  }
}, [location.pathname])
```
This ensures back-navigation from Explorer to Browse always starts with Sage closed. Do NOT include `setOpen` in the dependency array — it is a stable Zustand reference, but including it is unnecessary since we only want to react to pathname changes.

Actually, to match CONTEXT.md: "On back-navigation (Browse <- Explorer), Sage popover always starts closed regardless of previous state." We need this close behavior. BUT we should NOT close when the user is already on Browse and opens the popover. The key insight: close only when transitioning TO Browse (pathname changes to '/'), not on every render.

Better approach — track previous path:
```tsx
const prevPathRef = useRef(location.pathname)
useEffect(() => {
  if (prevPathRef.current !== location.pathname && location.pathname === '/') {
    setOpen(false)
  }
  prevPathRef.current = location.pathname
}, [location.pathname, setOpen])
```

Render:
```tsx
return (
  <>
    <Outlet />

    {/* Sage FAB — visible on all pages when panel/popover is closed */}
    <AnimatePresence>
      {!isOpen && <SageFAB key="sage-fab" />}
    </AnimatePresence>

    {/* Sage panel/popover — route-dependent rendering */}
    <AnimatePresence>
      {isOpen && isExplorer && (
        <>
          <div
            key="sage-backdrop"
            className="fixed inset-0 z-30 bg-black/30"
            onClick={() => setOpen(false)}
          />
          <SagePanel key="sage-panel" />
        </>
      )}
      {isOpen && !isExplorer && (
        <SagePopover key="sage-popover" />
      )}
    </AnimatePresence>
  </>
)
```

On Explorer: full SagePanel with backdrop (existing behavior).
On Browse (or any non-Explorer page): compact SagePopover, no backdrop.

**3. Update `frontend/src/main.tsx`:**

Add layout route wrapping `/` and `/explore`:

```typescript
import RootLayout from './layouts/RootLayout.tsx'
```

Change the router to use a layout route:
```typescript
const router = createBrowserRouter([
  {
    element: <RootLayout />,
    children: [
      {
        path: '/',
        element: <BrowsePage />,
      },
      {
        path: '/explore',
        element: <MarketplacePage />,
      },
    ],
  },
  {
    path: '/marketplace',
    element: <MarketplaceRedirect />,
  },
  {
    path: '/chat',
    element: <Navigate to="/explore" replace />,
  },
  // ... admin routes unchanged
])
```

The `/marketplace` redirect and `/chat` redirect stay outside the layout (they redirect immediately, no Sage needed). Admin routes stay outside too.

**4. Update `frontend/src/pages/MarketplacePage.tsx`:**

Remove the SageFAB, SagePanel, AnimatePresence, and backdrop rendering — all moved to RootLayout.

Remove these imports:
- `AnimatePresence` from `motion/react`
- `SageFAB` from `../components/pilot/SageFAB`
- `SagePanel` from `../components/pilot/SagePanel`

Remove the `isOpen` and `setOpen` selectors (no longer needed for Sage panel control in this component).

Remove the entire Sage section from the JSX:
```tsx
{/* Sage Co-Pilot — FAB hides when panel is open */}
<AnimatePresence>
  {!isOpen && <SageFAB key="sage-fab" />}
</AnimatePresence>

{/* Sage Panel popup + full-screen backdrop */}
<AnimatePresence>
  {isOpen && (
    <>
      <div ... />
      <SagePanel key="sage-panel" />
    </>
  )}
</AnimatePresence>
```

Keep everything else: Header, FilterSidebar, ExpertGrid, MobileFilterSheet, NewsletterGateModal, the pilot reset logic (navigationSource gate), etc.

**Note on AnimatePresence:** MarketplacePage may still need AnimatePresence for other things. Check if any remain — if not, remove the import. Currently it's only used for Sage, so it can be removed along with the `motion/react` import.

**5. Update `frontend/src/components/pilot/SageFAB.tsx`:**

The SageFAB currently reads filter state (`query`, `tags`, `rateMin`, `rateMax`) for the filter-change glow. On Browse, these filters are irrelevant and the glow should be suppressed.

Add route detection:
```typescript
import { useLocation } from 'react-router-dom'
```

Inside the component:
```typescript
const location = useLocation()
const isExplorer = location.pathname === '/explore'
```

Conditionally skip the filter glow effect when not on Explorer. Wrap the filter glow useEffect:
```typescript
useEffect(() => {
  if (!isExplorer) return  // Skip filter glow on non-Explorer pages
  if (prevFilterKey.current === null) {
    prevFilterKey.current = filterKey
    return
  }
  if (prevFilterKey.current !== filterKey) {
    prevFilterKey.current = filterKey
    setGlowType('filter')
    const t = setTimeout(() => setGlowType('none'), 1500)
    return () => clearTimeout(t)
  }
}, [filterKey, isExplorer])
```

The Sage activity glow (isStreaming change) should still work on all pages — it indicates Sage responded.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Check: SagePopover renders as compact chat, RootLayout wraps routes with Outlet + Sage, MarketplacePage no longer renders SageFAB/SagePanel, SageFAB filter glow suppressed on Browse</manual>
  </verify>
  <done>SageFAB visible on both Browse and Explorer via RootLayout. Browse shows compact SagePopover, Explorer shows full SagePanel with backdrop. Conversation persists across navigation (shared pilotSlice). Back-navigation to Browse closes popover. Direct /explore visits still reset pilot (existing gate unchanged). Filter glow only active on Explorer.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. SageFAB renders on Browse page (visible at bottom-right)
3. Clicking FAB on Browse opens compact SagePopover
4. Clicking FAB on Explorer opens full SagePanel with backdrop
5. Sending a message in Browse popover, then navigating to Explorer — message visible in SagePanel
6. Direct /explore visit starts with clean Sage panel (resetPilot fires)
7. Navigator back from Explorer to Browse closes any open Sage UI
8. MarketplacePage no longer contains any Sage component rendering
</verification>

<success_criteria>
- Sage FAB visible on Browse page without manual mounting — at root layout level
- Conversation continuity: messages sent on Browse survive navigation to Explorer
- Direct /explore visits still reset pilot state (existing behavior preserved)
- Browse uses compact popover, Explorer uses full side panel
</success_criteria>

<output>
After completion, create `.planning/phases/39-sage-cross-page-navigation/39-01-SUMMARY.md`
</output>
