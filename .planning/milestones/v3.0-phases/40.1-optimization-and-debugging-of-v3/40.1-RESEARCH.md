# Phase 40.1: Optimization and Debugging of v3 - Research

**Researched:** 2026-02-25
**Domain:** React/Tailwind frontend — layout bugs, visual polish, performance, brand alignment
**Confidence:** HIGH (codebase fully readable; all issues verified from source)

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

- BrowseCard layout/sizing is off — cards don't display correctly (not a photo-loading issue, but layout/sizing problems)
- Hero banner photos not loading — profile pictures are small/portrait-oriented and don't work as banner imagery; rethink the banner approach entirely
- Hero banner direction: replace photo-based hero with abstract/branded hero — use brand imagery, abstract gradients, or illustration rather than individual expert profile photos
- Text contrast too low — names, rates, or tags are hard to read against their backgrounds
- No mobile-specific bugs at this time — focus on desktop
- Browse page content loads in visible chunks (rows appear staggered) — optimize for smoother initial render so content appears together
- Images should lazy-load as rows scroll into view — prioritize fast initial render
- Acceptable load time: whatever's reasonable — noticeably faster than current state
- Card content spacing is off — name, rate, tags inside cards feel cramped or unevenly positioned
- General spacing/alignment pass needed across the entire Browse page
- Both Browse AND Explorer pages should receive visual polish for consistency — they should feel like the same app
- Color scheme adjustment for clarity — improve text contrast and readability across both pages
- Brand assets (logo, colors, fonts, PDF guidelines) are in the `frontend/` folder — align visual polish to these
- No new features — this is about making what exists work correctly and look polished
- Focus is desktop only

### Claude's Discretion

- Browse data caching strategy (cache between Browse↔Explorer navigation or re-fetch)
- Exact animation/transition polish approach
- Loading skeleton and error state handling
- Specific image loading implementation (intersection observer, native lazy, etc.)
- Compression and bundling optimizations

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 40.1 is a polish-and-fix sprint on the completed v3.0 Netflix Browse + Agentic Navigation UI. All changes are confined to the frontend. The backend is stable and deployed; no backend work is required. The codebase has been fully read — all bugs and deficiencies are traceable to specific lines of code.

The three areas of work are: (1) **bug fixes** — BrowseCard sizing, HeroBanner photo strategy, text contrast; (2) **performance** — staggered row render eliminated via data-driven batch render, native lazy loading on card images; and (3) **visual polish** — spacing audit across Browse page and alignment between Browse and Explorer so they feel like a single app.

**Primary recommendation:** Fix bugs first (BrowseCard sizing, hero banner replacement), then performance (lazy images, data caching), then visual consistency pass (spacing, contrast, brand color alignment between Browse and Explorer).

---

## Standard Stack

### Core (already in project — no new installs)

| Library | Version | Purpose | Notes |
|---------|---------|---------|-------|
| React | 19.2 | UI rendering | Already installed |
| Tailwind CSS | 3.4.19 | Utility styling | Already configured |
| motion/react | 12.34.3 | Animations | Already used in BrowseCard, HeroBanner |
| Vite | 7.3.1 | Build + bundler | Already configured |
| Zustand | 5.0.11 | State management | Already used |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Intersection Observer API | Browser native | Lazy loading images outside viewport | Use for BrowseRow cards not yet scrolled into view |
| Native `loading="lazy"` | Browser native | Deferred image fetching | Simplest path — zero dependencies |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Native `loading="lazy"` | react-intersection-observer | Native is sufficient for this use case; no new dep needed |
| CSS-only gradient hero | react-spring/canvas animation | CSS gradient is cheaper, aligns with existing aurora pattern |
| Re-fetch on every Browse visit | Zustand cache + TTL | Cache adds complexity; at current scale re-fetch is fast enough |

**Installation:** None required. All libraries are already installed.

---

## Architecture Patterns

### Existing Project Structure (relevant files)

```
frontend/src/
├── components/browse/     # BrowseCard, BrowseRow, HeroBanner, Skeleton*
├── components/marketplace/ # ExpertCard, ExpertGrid, FilterChips, etc.
├── components/pilot/      # SageFAB, SagePanel, SagePopover
├── components/sidebar/    # FilterSidebar
├── components/Header.tsx  # Desktop header (Explorer only)
├── components/AuroraBackground.tsx
├── pages/BrowsePage.tsx
├── pages/MarketplacePage.tsx
├── hooks/useBrowse.ts
├── index.css              # OKLCH tokens, aurora-bg, glass-surface
└── tailwind.config.ts     # brand colors: purple #5128F2

frontend/                  # Brand assets (source of truth)
├── For Dark bg.png        # Logo variant
├── For white bg.png       # Logo variant
├── Logo Icon Black.png
├── Logo Icon Purple.png
├── Logo Icon White.png
├── White logo.png
└── Tinrate Logo Guidelines.pdf
```

### Pattern 1: Card Sizing — Fixed-Dimension Cards in Scroll Container

**What:** BrowseCard uses `style={{ width: 160, minHeight: 220 }}` on a motion.div with `animate={{ height: expanded ? 260 : 220 }}`. The surrounding snap-scroll container doesn't set a fixed height, so card height and the image layer interact.

**Current problem (verified from source):**
- `minHeight: 220` allows the card to grow taller than 220 when content overflows, pushing cards inconsistently
- The `<img>` inside uses `absolute inset-0 w-full h-full object-cover` — this works only when the parent has a fixed height (not `minHeight`)
- `animate={{ height: expanded ? 260 : 220 }}` conflicts with `minHeight: 220` — motion animates `height` from undefined initial state

**Fix:** Change `minHeight` to `height` on the card root to give the `absolute`-positioned image a definite containing block. Use `height: 220` static plus motion `animate` for the expand only.

```tsx
// Before (broken — minHeight doesn't bound absolute children)
style={{ width: 160, minHeight: 220 }}

// After (correct — fixed height gives absolute children a containing block)
style={{ width: 160, height: expanded ? 260 : 220 }}
// Remove animate={{ height: ... }} or keep as transition driver only
```

### Pattern 2: Hero Banner — Abstract Branded Gradient (replace photo logic)

**Current state (verified from HeroBanner.tsx):**
- Conditionally renders `<img>` if `current.photo_url` exists, otherwise renders a gradient div
- Expert profile photos are portrait/headshot oriented — they don't fill a 300px-tall wide banner attractively
- The `API_BASE` prefix is missing on the hero image `src` (bug: `src={current.photo_url}` not `src={${API_BASE}${current.photo_url}}`), so photos never load even for experts who have them

**Locked decision:** Replace with abstract/branded hero — remove the photo branch entirely.

**Recommended approach:** Remove the `{current.photo_url ? <img /> : <gradient div />}` branch. Always render the branded gradient. Add text content (expert name, title, company) on top as currently exists, plus the "Explore All Experts" CTA. The existing `HERO_GRADIENTS` palette is already brand-appropriate (purple-indigo range).

**Optional enhancement (Claude's discretion):** Add a subtle animated mesh or CSS pattern to the hero background for visual interest without photos — aligns with aurora background pattern already in the codebase.

```tsx
// Remove photo branch — always use gradient
<div className={`w-full h-full bg-gradient-to-br ${HERO_GRADIENTS[gradientIdx]}`} />
// Expert info overlay remains unchanged
```

### Pattern 3: Text Contrast — Tailwind Opacity Utilities

**Current state (verified from BrowseCard.tsx):**
- Name: `text-white` over `from-black/70 via-black/40` gradient — should be fine, but gradient may not be dark enough at the top
- Rate: `text-purple-300` — on dark overlay should be fine, but on gradient backgrounds it may be too light
- Tags: `text-white/90 bg-white/20` — low-contrast combination on variable photo backgrounds

**Fix strategy:**
- Darken the bottom gradient overlay: `from-black/85 via-black/60 to-transparent` instead of current `from-black/70 via-black/40`
- Rate: change `text-purple-300` to `text-purple-200` or `text-white` with smaller font-weight for contrast
- Tags: increase background opacity `bg-white/30` and ensure `text-white` (not `text-white/90`)

### Pattern 4: Staggered Row Render — Eliminate via Single Conditional

**Current state (verified from BrowsePage.tsx):**
- `useBrowse` fetches `/api/browse?per_row=10` — single request, all rows returned at once
- The "staggered" appearance is NOT from staggered fetches — it's from React rendering 4+ rows sequentially in the same render cycle, where each row paints as its DOM is committed
- Skeleton rows show while `loading === true`, then ALL real rows render at once when `loading === false`

**Root cause candidates:**
1. Browser paint scheduling — React commits DOM for all rows but browser paints incrementally during the JS task
2. Framer Motion / motion.react initial animations on each BrowseCard (160+ cards) firing simultaneously causing jank
3. The aurora background animation competing with card renders during the initial paint

**Fix strategies:**
- Add `will-change: transform` or `contain: layout` to BrowseRow containers to isolate paint layers
- Reduce initial motion.div spring computation: use `transition={{ duration: 0 }}` initially or use `layout` prop sparingly
- Consider `React.memo` on BrowseCard to prevent re-renders as sibling rows mount

### Pattern 5: Image Lazy Loading

**Current state (verified from BrowseCard.tsx):**
- `<img src={...} className="absolute inset-0 w-full h-full object-cover" />` — no lazy loading attribute
- All 10 cards per row (× 4 rows = 40 images) fetch simultaneously on mount
- The backend proxy at `/api/photos/{username}` adds 24h cache headers — subsequent visits are fast but first load is 40 simultaneous requests

**Fix:** Add `loading="lazy"` to the `<img>` in BrowseCard. Cards in the first visible row will still load eagerly (browser ignores `lazy` for above-fold content by default), but rows below the fold will defer.

```tsx
<img
  src={`${API_BASE}${expert.photo_url!}`}
  alt={name}
  loading="lazy"
  className="absolute inset-0 w-full h-full object-cover"
  onError={() => setImgError(true)}
/>
```

### Pattern 6: Browse ↔ Explorer Visual Consistency

**Current discrepancy (verified by reading both pages):**

| Element | Browse | Explorer |
|---------|--------|----------|
| Background | AuroraBackground (light aurora) | AuroraBackground (same) ✓ |
| Header | None (no Header component) | Header.tsx (glassmorphic, desktop only) |
| Card style | Dark gradient overlay, photo-dominant | White/90 bg, text-dominant, border-gray-100 |
| Text colors | white on dark | gray-900, gray-500, gray-400 on white |
| Rate color | text-purple-300 | text-brand-purple (oklch darker) |
| Tag pills | bg-white/20 text-white/90 (dark) | bg-gray-100/80 text-gray-600 (light) |
| Spacing | gap-3 cards, gap-12/16 rows | gap-4 grid, no row concept |
| Font weight | font-semibold for names | font-semibold ✓ |

The two pages have deliberately different card styles (BrowseCard is cinematic/photo-dominant, ExpertCard is information-dense). The visual consistency goal is at the **page level**, not card level — same aurora background (done), same brand purple usage, consistent header treatment.

**Recommended consistency fixes:**
- Add a minimal Browse page header that matches the `glass-surface` / aurora treatment (or ensure the aurora + no-header on Browse feels intentional with a brief hero-area top treatment)
- Ensure `text-brand-purple` (oklch value) is used consistently for rates on both pages instead of `text-purple-300` (Tailwind default)
- FilterSidebar has a text contrast bug: `text-white/60` for "Domain Tags" label (line 39 in FilterSidebar.tsx) against a `glass-surface` white background — this is invisible. Should be `text-gray-500` matching other labels.

### Pattern 7: Browse Data Caching (Claude's Discretion)

**Current state:** `useBrowse` re-fetches on every mount — no caching. Since `BrowsePage` is in a React Router route under `RootLayout`, navigating Browse → Explorer → Browse unmounts and remounts `BrowsePage`, triggering a new fetch.

**Recommended approach:** Store browse data in Zustand with a timestamp. On mount, check if data is fresh (< 5 min). If fresh, skip fetch. This eliminates the loading skeleton on back-navigation and makes Browse feel instant.

```tsx
// In useBrowse.ts — check Zustand cache before fetching
const cachedAt = useExplorerStore((s) => s.browseData?.cachedAt)
const isFresh = cachedAt && Date.now() - cachedAt < 5 * 60 * 1000
if (isFresh) return // use cached data
```

**Tradeoff:** Adds a `browseData` field to `ExplorerStore`. NOT persisted (no `partialize` for it) — cache is session-only.

**Alternative:** React Router's `loader` API could preload Browse data before component mount, but the project uses client-side fetch hooks, not loaders. Changing to loaders is out of scope.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Image lazy loading | Custom IntersectionObserver hook | Native `loading="lazy"` | Browser-native, zero KB, sufficient for this use case |
| Data caching with TTL | Custom cache class | Zustand state + `Date.now()` timestamp | Fits existing store pattern, 5 lines of code |
| Card height animation | Custom CSS height transition | motion.react `animate={{ height }}` | Already in use; just fix the `minHeight` vs `height` conflict |
| Branded gradient hero | Canvas drawing or WebGL | CSS `bg-gradient-to-br` with Tailwind | Matches aurora pattern, GPU-composited, zero dependencies |

**Key insight:** This phase involves fixing and tuning existing code, not building new systems. Every problem has a solution within the existing stack.

---

## Common Pitfalls

### Pitfall 1: `absolute` Children Need a Fixed-Height Parent

**What goes wrong:** `absolute inset-0` positions relative to the nearest positioned ancestor. If that ancestor uses `minHeight` instead of `height`, the image has no definite height reference — it collapses to 0 or renders incorrectly.

**Why it happens:** `minHeight` sets a floor but doesn't create a fixed containing block for absolutely-positioned children. `height` does.

**How to avoid:** Always use `height` (not `minHeight`) on card containers that have `absolute`-positioned image children.

**Warning signs:** Card images appearing 0px tall or card sizes varying unexpectedly between cards.

### Pitfall 2: motion.react `animate` Conflicts with Inline `style` Height

**What goes wrong:** If both `style={{ height: 220 }}` and `animate={{ height: expanded ? 260 : 220 }}` are set, Framer Motion and the inline style fight for control. Motion wins on animated frames, but the initial render uses the `style` value creating a flash.

**How to avoid:** Use either `style` OR `animate` for a given property, never both. For the expand animation, remove `height` from `style` and use `animate` exclusively, but set an `initial={{ height: 220 }}` to prevent flash.

### Pitfall 3: Missing `API_BASE` Prefix in HeroBanner

**What goes wrong:** `HeroBanner.tsx` line 62 uses `src={current.photo_url}` without prefixing `API_BASE`. Since `photo_url` is a path like `/api/photos/username` (relative), this only works in local dev (where Vite proxies to localhost:8000). In production on Vercel, the `VITE_API_URL` env var is set to the Railway URL — without the prefix, the request goes to Vercel (404).

**Current status:** This is moot since hero photos are being replaced with gradients. But the same pattern exists in BrowseCard (line 74) where it IS correctly prefixed: `` src={`${API_BASE}${expert.photo_url!}`} ``. Remove the photo branch from HeroBanner entirely to close this bug.

### Pitfall 4: FilterSidebar Label Invisible on Light Background

**What goes wrong:** FilterSidebar.tsx line 39 uses `text-white/60` for the "Domain Tags" label, but `glass-surface` on the light aurora is white/frosted. White text on a white background is invisible.

**How to avoid:** Audit all text in glass-surface components against the aurora background. `text-gray-500` is the correct match for secondary labels (matches "Hourly Rate" label on line 36 which uses `text-gray-500`).

### Pitfall 5: `react-virtuoso` Grid + Tailwind Height Constraints

**What goes wrong:** The ExpertGrid uses `VirtuosoGrid` which requires a parent element with a fixed height (`height: '100%'` on both `<div>` and `<VirtuosoGrid />`). If any ancestor in MarketplacePage breaks the `flex-1 min-h-0` chain, the grid collapses.

**Relevance to this phase:** Any spacing/padding changes to the Explorer layout must preserve the `flex-1 min-h-0` chain: `div.flex.flex-col.h-screen` → `div.flex.flex-1.min-h-0` → `main.flex-1.flex.flex-col.min-h-0` → `div.flex-1.min-h-0.pt-2` → `ExpertGrid`.

### Pitfall 6: `backdrop-filter` Inside `overflow:hidden`

**What goes wrong:** `backdrop-filter` (glass blur) does not render when any ancestor has `overflow:hidden`. This was already solved for BrowseCard (uses dark gradient instead of `.glass-surface`). Do NOT add `.glass-surface` to any component inside `overflow:hidden`.

**Warning signs:** Glass blur appearing as flat white rectangle instead of blurred transparency.

---

## Code Examples

Verified patterns from codebase inspection:

### BrowseCard Height Fix

```tsx
// Current (broken)
<motion.div
  className="relative rounded-xl overflow-hidden cursor-pointer group"
  style={{ width: 160, minHeight: 220 }}
  animate={{ height: expanded ? 260 : 220 }}
  transition={{ type: 'spring', stiffness: 300, damping: 25 }}
>

// Fixed
<motion.div
  className="relative rounded-xl overflow-hidden cursor-pointer group"
  initial={{ height: 220 }}
  animate={{ height: expanded ? 260 : 220 }}
  style={{ width: 160 }}
  transition={{ type: 'spring', stiffness: 300, damping: 25 }}
>
```

### HeroBanner Abstract Gradient (no photos)

```tsx
// Remove photo branch entirely — always branded gradient
<motion.div key={current.username} ... className="absolute inset-0">
  <div className={`w-full h-full bg-gradient-to-br ${HERO_GRADIENTS[gradientIdx]}`} />

  {/* Keep readability overlay */}
  <div className="absolute inset-0 bg-gradient-to-r from-black/80 via-black/40 to-transparent" />

  {/* Keep expert info overlay */}
  <div className="absolute bottom-8 left-8 ...">
    <h2 ...>{current.first_name} {current.last_name}</h2>
    ...
  </div>
</motion.div>
```

### Image Lazy Loading in BrowseCard

```tsx
<img
  src={`${API_BASE}${expert.photo_url!}`}
  alt={name}
  loading="lazy"
  decoding="async"
  className="absolute inset-0 w-full h-full object-cover"
  onError={() => setImgError(true)}
/>
```

### Text Contrast Improvement — Darker Overlay

```tsx
// Current (may not be dark enough at gradient midpoint)
<div className="absolute bottom-0 left-0 right-0 p-2.5 bg-gradient-to-t from-black/70 via-black/40 to-transparent">

// Improved (darker base, adequate at all photo brightnesses)
<div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/85 via-black/55 to-transparent">
```

### FilterSidebar Label Fix

```tsx
// Current (invisible on light glass-surface)
<span className="text-xs font-medium text-white/60 uppercase">Domain Tags</span>

// Fixed (matches "Hourly Rate" label style)
<span className="text-xs font-medium text-gray-500 uppercase">Domain Tags</span>
```

### Browse Data Cache (Zustand pattern — Claude's discretion)

```tsx
// In useBrowse.ts — check store before fetching
export function useBrowse() {
  const browseData = useExplorerStore((s) => s.browseData)
  const setBrowseData = useExplorerStore((s) => s.setBrowseData)
  const [loading, setLoading] = useState(!browseData || !isFresh(browseData.cachedAt))
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (browseData && isFresh(browseData.cachedAt)) return // use cache
    // ... fetch logic unchanged, on success call setBrowseData({ ...d, cachedAt: Date.now() })
  }, [])

  return { data: browseData ?? null, loading, error }
}

function isFresh(ts: number) { return Date.now() - ts < 5 * 60 * 1000 }
```

---

## Brand Identity Reference

Brand assets are in `/Users/sebastianhamers/Documents/TCS/frontend/` (not in `public/`). To use them in the app, they must be copied to `public/` or `src/assets/`. Currently only `logo.png`, `icon.png`, and `favicon.png` are in `public/`.

**Established brand colors (from tailwind.config.ts and index.css):**

| Token | Value | Use |
|-------|-------|-----|
| `brand-purple` | `#5128F2` | CTA buttons, active states, rate labels (Explorer) |
| `--aurora-bg` | `oklch(98% 0.008 279)` | Near-white lavender page background |
| `--aurora-purple` | `oklch(88% 0.070 279 / 0.55)` | Light blob in aurora animation |

**Current inconsistency:** BrowsePage uses `text-purple-300` (Tailwind's built-in, lighter) for rates. Explorer uses `text-brand-purple` (`#5128F2`, darker). The rate display on Browse cards should also use brand-purple or a light variant consistent with the dark card overlay.

**Logo asset in `public/logo.png`** is already used in Header.tsx. BrowsePage has no logo/nav. For desktop consistency, consider adding a minimal top bar to BrowsePage with the logo — but this is Claude's discretion (not a locked decision from CONTEXT.md).

---

## State of the Art

| Old Approach | Current Approach | Impact on This Phase |
|--------------|------------------|---------------------|
| `minHeight` for flex card floors | `height` with fixed value for photo containing blocks | Must switch to fix card sizing |
| Photo-based hero banners | Abstract gradient hero | Decision locked — remove photo logic |
| Eager-load all images | `loading="lazy"` native attribute | Simple 1-line fix per image |
| Re-fetch on every mount | Zustand TTL cache | Optional — Claude's discretion |

---

## Open Questions

1. **Does the staggered row render come from React batching or motion.react?**
   - What we know: Single API call, data returned all at once, skeleton → real content transition is atomic
   - What's unclear: Whether each BrowseRow's 10 cards creating 10 `motion.div` spring calculations causes measurable frame drop on first paint
   - Recommendation: Profile in browser DevTools before optimizing. If paint time is < 16ms, no change needed. If > 16ms, wrap BrowseCard render in `React.memo` and reduce initial spring computation.

2. **Should BrowsePage get a header?**
   - What we know: MarketplacePage has `Header.tsx` (desktop only, glassmorphic). BrowsePage has no header.
   - What's unclear: Whether the hero banner area substitutes for a header or if a logo/nav bar is needed for brand consistency
   - Recommendation: Claude's discretion — if adding a header, reuse `Header.tsx` component (it uses `hidden md:flex` so mobile-safe). If not, leave it and let the aurora + hero serve as the top-of-page treatment.

3. **Which specific Tinrate Logo Guidelines font is used?**
   - What we know: `Tinrate Logo Guidelines.pdf` is in `frontend/` but cannot be read as a PDF in this research session; tailwind.config.ts has no custom fonts; the UI uses browser default (system-ui/sans-serif)
   - What's unclear: Whether there is a brand font that should be applied
   - Recommendation: Read the PDF at planning time, or defer font alignment to a follow-on phase if it requires a Google Fonts or local font addition.

---

## Sources

### Primary (HIGH confidence)
- Direct codebase inspection: `frontend/src/components/browse/BrowseCard.tsx` — card sizing root cause
- Direct codebase inspection: `frontend/src/components/browse/HeroBanner.tsx` — missing API_BASE prefix, photo branch logic
- Direct codebase inspection: `frontend/src/components/sidebar/FilterSidebar.tsx` — invisible label bug (line 39)
- Direct codebase inspection: `frontend/src/index.css` — OKLCH tokens, glass-surface pattern, backdrop-filter warning comment
- Direct codebase inspection: `frontend/src/pages/BrowsePage.tsx` — render structure, useBrowse hook
- Direct codebase inspection: `frontend/src/hooks/useBrowse.ts` — no caching, single fetch per mount
- Direct codebase inspection: `frontend/tailwind.config.ts` — brand colors
- Direct codebase inspection: `frontend/package.json` — library versions

### Secondary (MEDIUM confidence)
- MDN (training knowledge, current as of 2025): `loading="lazy"` on `<img>` is fully supported in all major browsers, ignored for above-fold images

### Tertiary (LOW confidence)
- None

---

## Metadata

**Confidence breakdown:**
- Bug identification: HIGH — all bugs confirmed from source code
- Fix approach: HIGH — standard React/Tailwind/motion patterns
- Performance diagnosis: MEDIUM — staggered render root cause not profiled; candidate causes identified
- Brand alignment: MEDIUM — colors/tokens confirmed, font from PDF not read

**Research date:** 2026-02-25
**Valid until:** 2026-03-25 (stable stack — motion, Tailwind, React change slowly)
