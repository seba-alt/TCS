---
phase: 40.3-revert-to-explorer-only
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - frontend/src/hooks/useSage.ts
  - frontend/src/hooks/useExplore.ts
  - frontend/src/layouts/RootLayout.tsx
  - frontend/src/components/Header.tsx
  - frontend/src/components/pilot/SageFAB.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Sage discovery search on Explorer injects results directly into the grid — no pending results, no auto-navigation, no setTimeout"
    - "useSage has no Browse-specific code paths — no isExplorer conditional, no location check"
    - "useExplore has no pendingSageResults consumption — Sage results are always injected directly by useSage"
    - "RootLayout always renders SagePanel (not SagePopover) — no Browse vs Explorer branching"
    - "Header search bar is visible and sticky on mobile — users can always search"
    - "SageFAB filter glow works on all pages (no isExplorer guard needed since only Explorer exists)"
    - "TypeScript compilation passes with zero errors"
  artifacts:
    - path: "frontend/src/hooks/useSage.ts"
      provides: "Simplified Sage hook with direct store injection only"
    - path: "frontend/src/layouts/RootLayout.tsx"
      provides: "Simplified layout always rendering SagePanel"
    - path: "frontend/src/components/Header.tsx"
      provides: "Mobile-visible sticky header with search bar"
  key_links:
    - from: "frontend/src/hooks/useSage.ts"
      to: "frontend/src/store/index.ts"
      via: "setResults direct injection"
      pattern: "setResults"
    - from: "frontend/src/layouts/RootLayout.tsx"
      to: "frontend/src/components/pilot/SagePanel.tsx"
      via: "always-rendered panel"
      pattern: "SagePanel"
---

<objective>
Simplify Sage hooks and RootLayout for single-page Explorer architecture, and make the Header search bar visible and sticky on mobile.

Purpose: Complete the Browse removal by cleaning up all cross-page Sage logic and making the Explorer mobile-first with an always-accessible search bar.
Output: Clean Sage integration, simplified layout, mobile-responsive Header.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/40.3-revert-to-explorer-only-remove-browse-page-keep-explorer-with-adjustments/40.3-CONTEXT.md
@.planning/phases/40.3-revert-to-explorer-only-remove-browse-page-keep-explorer-with-adjustments/40.3-RESEARCH.md
@.planning/phases/40.3-revert-to-explorer-only-remove-browse-page-keep-explorer-with-adjustments/40.3-01-SUMMARY.md
@frontend/src/hooks/useSage.ts
@frontend/src/hooks/useExplore.ts
@frontend/src/layouts/RootLayout.tsx
@frontend/src/components/Header.tsx
@frontend/src/components/pilot/SageFAB.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify useSage, useExplore, RootLayout, and SageFAB for single-page architecture</name>
  <files>
    frontend/src/hooks/useSage.ts
    frontend/src/hooks/useExplore.ts
    frontend/src/layouts/RootLayout.tsx
    frontend/src/components/pilot/SageFAB.tsx
  </files>
  <action>
    1. EDIT frontend/src/hooks/useSage.ts — remove ALL Browse-specific code:
       - Remove `useLocation` and `useNavigate` imports from react-router-dom.
       - Remove `const location = useLocation()`, `const navigate = useNavigate()`, and `const isExplorer = location.pathname === '/explore'`.
       - In the `handleSend` callback, remove the `isExplorer` conditional branching for search_performed:
         - DELETE the `if (isExplorer)` / `else` block. Keep ONLY the Explorer code path (direct store injection):
           ```tsx
           if (data.search_performed === true) {
             const store = useExplorerStore.getState()
             const experts = data.experts ?? []
             const total = data.total ?? 0
             store.setLoading(false)
             store.setResults(experts, total, null)
             store.setSageMode(true)
           }
           ```
         - This removes: the Browse branch that called `setPendingSageResults`, `setTimeout` auto-navigate, the early return, and the `addMessage` inside the Browse branch.
       - Remove the `isExplorer` conditional around filter application (`validateAndApplyFilters`):
         - Always apply filters when `data.filters` exists (was previously Explorer-only).
       - Remove the Browse-specific clean filter state logic:
         - Remove the `isExplorer` ternary for `currentFilters`. Always send real filter state:
           ```tsx
           const currentFilters = {
             query: storeState.query,
             rate_min: storeState.rateMin,
             rate_max: storeState.rateMax,
             tags: storeState.tags,
           }
           ```
       - Remove `isExplorer` and `navigate` from the handleSend dependency array.
       - Remove `useLocation` and `useNavigate` imports if no other references remain.

    2. EDIT frontend/src/hooks/useExplore.ts — remove pendingSageResults consumption:
       - Remove the block at the top of the useEffect that reads `pendingSageResults` from store and calls `clearPendingSageResults`. This was the Browse→Explorer handoff that no longer exists.
       - Specifically remove:
         ```tsx
         const pending = useExplorerStore.getState().pendingSageResults
         if (pending && pending.length > 0) {
           setResults(pending, pending.length, null)
           setLoading(false)
           useExplorerStore.getState().clearPendingSageResults()
         }
         ```
       - Keep the sageMode guard and all other useExplore logic unchanged.

    3. EDIT frontend/src/layouts/RootLayout.tsx — simplify for single page:
       - Remove `useLocation` import and all location-based logic.
       - Remove `SagePopover` import (file was deleted in Plan 01).
       - Remove `const location = useLocation()` and `const isExplorer = location.pathname === '/explore'`.
       - Remove the `prevPathRef` useRef and the useEffect that closes popover on Browse navigation.
       - Remove `useRef` from the import if no other refs remain.
       - In the Sage panel rendering: remove the `isExplorer` conditional. Always render SagePanel when `isOpen` is true (there is no Browse page to show the popover on):
         ```tsx
         <AnimatePresence>
           {isOpen && (
             <>
               <div key="sage-backdrop" className="fixed inset-0 z-30 bg-black/30" onClick={() => setOpen(false)} />
               <SagePanel key="sage-panel" />
             </>
           )}
         </AnimatePresence>
         ```
       - Remove the `{isOpen && !isExplorer && <SagePopover />}` block entirely.

    4. EDIT frontend/src/components/pilot/SageFAB.tsx — remove route detection:
       - Remove `useLocation` import from react-router-dom.
       - Remove `const location = useLocation()` and `const isExplorer = location.pathname === '/explore'`.
       - In the filter glow useEffect: remove the `if (!isExplorer) return` guard. Filter glow should always work since we're always on Explorer.
       - Remove `isExplorer` from the useEffect dependency array.
  </action>
  <verify>Run `npx tsc --noEmit` from frontend/ directory — zero TypeScript errors. Run `grep -r "isExplorer" frontend/src/` — should return nothing (or only in test files). Run `grep -r "SagePopover" frontend/src/` — should return nothing. Run `grep -r "pendingSageResults" frontend/src/` — should return nothing.</verify>
  <done>useSage always injects results directly. useExplore has no pending results consumption. RootLayout always shows SagePanel. SageFAB has no route detection. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Make Header search bar visible and sticky on mobile</name>
  <files>
    frontend/src/components/Header.tsx
  </files>
  <action>
    EDIT frontend/src/components/Header.tsx to make it mobile-responsive:

    The Header currently has `hidden md:flex` — invisible on mobile. Change this to be visible on all screen sizes with a responsive layout.

    1. Change the header className:
       - FROM: `hidden md:flex items-center gap-6 px-6 py-3 sticky top-0 z-50 backdrop-blur-md bg-white/70 border-b border-white/20`
       - TO: `flex items-center gap-3 md:gap-6 px-3 md:px-6 py-2 md:py-3 sticky top-0 z-50 backdrop-blur-md bg-white/70 border-b border-white/20`
       - Key changes: `hidden md:flex` → `flex` (always visible), reduced gap/padding on mobile.

    2. Logo section — make smaller on mobile:
       - Change logo img className from `h-8 w-auto` to `h-6 md:h-8 w-auto` (24px on mobile, 32px on desktop).

    3. Search bar container — full width on mobile:
       - Keep `relative flex-1 max-w-2xl` (flex-1 naturally fills available space).

    4. Expert count — hide on mobile to save space:
       - Change the count div className from `shrink-0 text-sm text-slate-500 tabular-nums` to `hidden md:block shrink-0 text-sm text-slate-500 tabular-nums`.

    5. Search input — slightly smaller on mobile:
       - Keep existing padding. The search bar is already well-sized for mobile via flex-1.

    The result: on mobile, users see a compact header with the Tinrate logo and a full-width search bar that is always sticky at the top. The expert count is hidden on mobile to maximize search bar width. The desktop experience remains unchanged.

    IMPORTANT: Do NOT change the mobile toolbar in MarketplacePage.tsx (the "Experts" title + Saved + Filters bar). That toolbar provides mobile-specific filter access and complements the Header search bar. Both should be visible on mobile — Header at very top with search, mobile toolbar below with filter controls.
  </action>
  <verify>Run `npx tsc --noEmit` from frontend/ directory — zero errors. Run `grep "hidden md:flex" frontend/src/components/Header.tsx` — should return nothing (was changed to `flex`). Visually: on mobile viewports, Header with search bar should be visible and sticky.</verify>
  <done>Header search bar is visible on mobile with `flex` (not hidden). Logo is compact on mobile. Expert count hidden on mobile. Desktop layout unchanged. Sticky positioning works on all viewports.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors from frontend/ directory
- `grep -r "isExplorer" frontend/src/` returns nothing (except test files if any)
- `grep -r "SagePopover" frontend/src/` returns nothing
- `grep -r "pendingSageResults" frontend/src/` returns nothing
- `grep -r "navigationSource" frontend/src/` returns nothing
- `grep -r "useLocation" frontend/src/hooks/useSage.ts` returns nothing
- `grep -r "useLocation" frontend/src/layouts/RootLayout.tsx` returns nothing
- `grep "hidden md:flex" frontend/src/components/Header.tsx` returns nothing (now `flex`)
- Header is visible at all viewport sizes
</verification>

<success_criteria>
- useSage has zero Browse-specific code — direct store injection only
- useExplore has no pendingSageResults consumption
- RootLayout has no Browse/Explorer branching — always renders SagePanel
- SageFAB has no route detection — filter glow always active
- Header search bar visible on mobile (sticky at top)
- Full TypeScript compilation passes with zero errors
- All navigation-related dead code removed (isExplorer, navigationSource, pendingSageResults, SagePopover)
</success_criteria>

<output>
After completion, create `.planning/phases/40.3-revert-to-explorer-only-remove-browse-page-keep-explorer-with-adjustments/40.3-02-SUMMARY.md`
</output>
