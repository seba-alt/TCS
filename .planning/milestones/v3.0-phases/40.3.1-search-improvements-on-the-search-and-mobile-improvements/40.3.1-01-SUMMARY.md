---
phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements
plan: 01
subsystem: ui
tags: [react, fastapi, fts5, sqlite, autocomplete, typescript]

# Dependency graph
requires:
  - phase: 40.3-revert-to-explorer-only-remove-browse-page-keep-explorer-with-adjustments
    provides: Explorer at / with Header search bar, FTS5 suggest endpoint

provides:
  - Debounced autocomplete dropdown with up to 5 suggestions (job title + company + tags)
  - Non-live search — expert grid only updates on Enter or suggestion click
  - X clear button clears search text, preserves filter chips
  - Keyboard navigation (ArrowUp/Down, Enter, Escape) on dropdown
  - Backend suggest endpoint now queries both job_title and company FTS5 columns

affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Blur/click ordering fix: handleBlur uses 150ms setTimeout so onMouseDown on suggestions fires before dropdown unmounts
    - Suggestion merge pattern: backend results first, then client-side TOP_TAGS filter, deduplicated via Set, limited to 5
    - Non-live grid update: handleChange only fetches suggestions (debounced 300ms), setQuery only called from handleKeyDown Enter / handleSelectSuggestion

key-files:
  created: []
  modified:
    - app/routers/suggest.py
    - frontend/src/hooks/useHeaderSearch.ts
    - frontend/src/components/Header.tsx

key-decisions:
  - "suggest endpoint queries job_title and company FTS5 columns (3 each), deduplicates, returns max 5 — not tags (JSON array blobs in FTS5)"
  - "Tag suggestions handled client-side via TOP_TAGS.filter() — avoids FTS5 JSON array blob problem"
  - "Grid does NOT update live while typing — setQuery only called from Enter keydown or suggestion selection"
  - "handleBlur uses 150ms delay — allows onMouseDown on suggestion items to fire before dropdown unmounts (critical blur/click ordering fix)"
  - "onMouseDown with e.preventDefault() on suggestion items instead of onClick — prevents input blur before selection registers"
  - "Header already sticky top-0 z-50 — no change needed for MOBILE-02 requirement"

patterns-established:
  - "Autocomplete blur/click ordering: handleBlur with 150ms setTimeout, onMouseDown + preventDefault on option items"
  - "Non-live search with suggestions: debounce only triggers fetchSuggestions, setQuery only on commit (Enter/click)"

requirements-completed: [SEARCH-01, MOBILE-02]

# Metrics
duration: 2min
completed: 2026-02-26
---

# Phase 40.3.1 Plan 01: Search Autocomplete Summary

**Debounced autocomplete dropdown with job-title/company/tag suggestions, non-live grid updates, X clear button, and keyboard navigation — zero TypeScript errors**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-26T08:53:16Z
- **Completed:** 2026-02-26T08:55:30Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Backend `/api/suggest` now queries both `job_title` and `company` FTS5 columns (3 each), deduplicates, returns up to 5 results
- `useHeaderSearch` completely refactored: suggestions state, debounced fetchSuggestions (300ms), non-live grid (setQuery only on Enter/click), keyboard nav, handleClear, handleBlur
- Header dropdown UI: `AnimatePresence` motion.ul with role=listbox, aria attributes, onMouseDown blur fix, X clear button, keyboard highlight styling

## Task Commits

1. **Task 1: Expand suggest endpoint to include company field** - `5ab5687` (feat)
2. **Task 2: Add autocomplete dropdown, non-live search, X clear button** - `b93413f` (feat)

## Files Created/Modified

- `app/routers/suggest.py` - Multi-field FTS5 suggest: queries job_title + company, deduplicates to 5 results
- `frontend/src/hooks/useHeaderSearch.ts` - Suggestions state, fetchSuggestions, non-live search, keyboard nav, handleClear, handleBlur
- `frontend/src/components/Header.tsx` - Autocomplete dropdown UI, X clear button, aria attributes

## Decisions Made

- suggest endpoint queries job_title and company FTS5 columns only (not tags — JSON array blobs return full blob string, not individual tags)
- Tag suggestions handled client-side via `TOP_TAGS.filter()` — cleaner and avoids FTS5 JSON issue
- Grid does NOT update live while typing — `setQuery` only called from Enter keydown or suggestion selection (explicit commit pattern)
- `handleBlur` uses 150ms delay so `onMouseDown` on suggestion items fires before dropdown unmounts (critical blur/click ordering fix)
- `onMouseDown` + `e.preventDefault()` on suggestion list items instead of `onClick` — prevents input blur before selection registers
- Header already `sticky top-0 z-50` — MOBILE-02 requirement satisfied without changes

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness

- Autocomplete dropdown complete, ready for Plan 02 execution
- All TypeScript compiles cleanly (0 errors)
- Header sticky behavior already satisfies MOBILE-02 — no additional mobile work needed for this requirement

---
*Phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements*
*Completed: 2026-02-26*

## Self-Check: PASSED

- app/routers/suggest.py: FOUND
- frontend/src/hooks/useHeaderSearch.ts: FOUND
- frontend/src/components/Header.tsx: FOUND
- 40.3.1-01-SUMMARY.md: FOUND
- Commit 5ab5687: FOUND
- Commit b93413f: FOUND
