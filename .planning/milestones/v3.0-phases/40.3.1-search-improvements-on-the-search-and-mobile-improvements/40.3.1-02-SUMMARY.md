---
phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements
plan: 02
subsystem: ui
tags: [react, vaul, mobile, bottom-sheet, expert-card, tap-expand, sage]

# Dependency graph
requires:
  - phase: 40.3-revert-to-explorer-only
    provides: Single-page Explorer at /, RootLayout with SagePanel + FAB, ExpertCard with 2-column grid
provides:
  - ExpertCard with tap-expand behavior for mobile (first tap = details, second tap = profile)
  - SageMobileSheet: non-draggable 60vh Vaul bottom sheet wrapping Sage chat for mobile
  - Responsive RootLayout: SagePanel on desktop, SageMobileSheet on mobile
affects: [any future ExpertCard changes, mobile UX work, Sage panel variations]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Mobile tap-expand: content swap within fixed 180px card height (VirtuosoGrid constraint)"
    - "Responsive Sage: hidden md:block / md:hidden CSS classes for desktop/mobile component swap in RootLayout"
    - "prevStreamingRef pattern for auto-close: detect isStreaming true→false transition gated on sageMode"

key-files:
  created:
    - frontend/src/components/pilot/SageMobileSheet.tsx
  modified:
    - frontend/src/components/marketplace/ExpertCard.tsx
    - frontend/src/layouts/RootLayout.tsx

key-decisions:
  - "ExpertCard tap-expand: content swap within fixed 180px height (VirtuosoGrid uses fixed item sizing — expanding height breaks layout)"
  - "SageMobileSheet dismissible=false: swipe-to-dismiss disabled, close button only (per CONTEXT.md spec)"
  - "Auto-close after discovery: prevStreamingRef tracks true→false transition, gated on sageMode=true, 2s delay"
  - "RootLayout responsive split: hidden md:block wraps SagePanel+backdrop, md:hidden wraps SageMobileSheet"
  - "SageFAB unchanged: already at fixed bottom-6 right-6 z-50 — correct position on both mobile and desktop"

patterns-established:
  - "Mobile-only content: use expanded state flag + conditional className ('flex' vs 'hidden sm:flex') for in-place content swap"
  - "Mobile bottom sheet: Vaul Drawer with dismissible=false + explicit close button for non-draggable sheets"

requirements-completed: [MOBILE-01, MOBILE-03]

# Metrics
duration: 2min
completed: 2026-02-26
---

# Phase 40.3.1 Plan 02: Mobile Expert Cards and Sage Bottom Sheet Summary

**Tap-expand ExpertCard for 2-column mobile grid (content swap within 180px) and non-draggable Vaul Sage bottom sheet with auto-close after discovery queries**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-26T08:53:23Z
- **Completed:** 2026-02-26T08:55:10Z
- **Tasks:** 2
- **Files modified:** 3 (2 modified, 1 created)

## Accomplishments

- ExpertCard gains tap-expand: first tap shows domain tags + match reason within fixed 180px height; second tap opens profile link. Visual ring indicator on expanded state.
- SageMobileSheet: Vaul bottom sheet at 60vh, fixed height (not draggable), close button only, auto-scrolls messages, auto-closes 2s after discovery query completes.
- RootLayout splits Sage rendering responsively: desktop uses existing SagePanel + backdrop, mobile uses SageMobileSheet — all via `hidden md:block` / `md:hidden` CSS.

## Task Commits

Each task was committed atomically:

1. **Task 1: Add tap-expand behavior and mobile content density to ExpertCard** - `2926dd5` (feat)
2. **Task 2: Create SageMobileSheet and wire responsive Sage rendering in RootLayout** - `e214827` (feat)

## Files Created/Modified

- `frontend/src/components/marketplace/ExpertCard.tsx` - Added expanded state, handleCardClick (two-tap navigation), conditional tag/match-reason visibility, ring visual indicator, p-3 sm:p-4 mobile padding
- `frontend/src/components/pilot/SageMobileSheet.tsx` - New component: Vaul Drawer at 60vh, non-draggable, Sage messages + streaming indicator + auto-close + auto-scroll
- `frontend/src/layouts/RootLayout.tsx` - Responsive split: SagePanel desktop-only (hidden md:block), SageMobileSheet mobile-only (md:hidden)

## Decisions Made

- ExpertCard expand is a **content swap within fixed 180px** — height never changes. This respects VirtuosoGrid's fixed item sizing constraint (expanding card height breaks virtualization layout).
- `dismissible={false}` on Drawer.Root disables swipe-to-dismiss. Users must use close button.
- Auto-close uses `prevStreamingRef` pattern (same as SageFAB glow) to detect streaming completion, gated on `sageMode=true` to only auto-close after discovery queries (not filter adjustments).
- RootLayout wraps SageMobileSheet in `md:hidden` div that is always mounted but Drawer stays hidden when `open=false` — this avoids remounting Vaul on open/close.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Mobile improvements for plan 02 complete. Expert cards are tap-expandable, Sage is accessible via bottom sheet on mobile.
- Plan 01 (search autocomplete) and plan 02 (mobile) are both complete for phase 40.3.1.
- Ready for deployment or phase completion UAT.

---
*Phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements*
*Completed: 2026-02-26*
