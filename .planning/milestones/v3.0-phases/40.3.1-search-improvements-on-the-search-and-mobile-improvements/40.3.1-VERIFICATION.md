---
phase: 40.3.1-search-improvements-on-the-search-and-mobile-improvements
verified: 2026-02-26T10:30:00Z
status: passed
score: 14/14 must-haves verified
gaps: []
human_verification:
  - test: "Type 2+ characters in search bar and observe dropdown timing"
    expected: "Autocomplete dropdown appears after ~300ms, shows up to 5 suggestions combining job titles, companies, and matching tags"
    why_human: "Debounce timing and dropdown rendering are runtime behaviors not verifiable by static analysis"
  - test: "Type in search bar and watch the expert grid — grid must NOT update while typing"
    expected: "Grid stays unchanged until Enter is pressed or a suggestion is clicked"
    why_human: "Non-live search behavior requires observing runtime state flow"
  - test: "On a mobile viewport (375px): tap an expert card once, then tap the same card again"
    expected: "First tap expands card (shows tags + match reason), second tap opens the external profile link"
    why_human: "Two-tap navigation requires a real browser touch/click sequence on mobile viewport"
  - test: "On a mobile viewport: tap the Sage FAB, then try to drag the bottom sheet"
    expected: "Bottom sheet opens at 60% height and cannot be dragged — only the close button dismisses it"
    why_human: "Swipe gesture behavior requires a touch device or simulated touch in DevTools"
  - test: "On a mobile viewport: send a discovery query in Sage, wait for results"
    expected: "After streaming completes, bottom sheet auto-closes after ~2 seconds revealing the expert grid"
    why_human: "Auto-close timing requires end-to-end runtime flow with real backend streaming"
  - test: "On a desktop viewport (1024px+): verify SagePanel renders as fixed side panel"
    expected: "SagePanel appears as before (380px fixed width), no bottom sheet visible on desktop"
    why_human: "Responsive rendering split (md:hidden / hidden md:block) requires visual confirmation"
---

# Phase 40.3.1: Search Improvements and Mobile Optimization — Verification Report

**Phase Goal:** Add search autocomplete with debounced suggestion dropdown, change search to commit-on-Enter, and optimize mobile experience with tap-expand cards and Sage bottom sheet
**Verified:** 2026-02-26T10:30:00Z
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | User types in search bar and sees a dropdown of up to 5 suggestions after ~300ms | ✓ VERIFIED | `useHeaderSearch.ts` L7: `SUGGEST_DEBOUNCE_MS = 300`. `fetchSuggestions` merges backend + tags, limits to 5. `Header.tsx` renders `motion.ul role="listbox"` when `showDropdown && suggestions.length > 0` |
| 2  | Suggestions include job titles, companies, and domain tags (from TOP_TAGS) | ✓ VERIFIED | `suggest.py`: queries `job_title` and `company` FTS5 columns. `useHeaderSearch.ts` L70-72: `TOP_TAGS.filter(t => t.includes(value.toLowerCase())).slice(0, 3)`. Merged backend-first, deduplicated |
| 3  | Selecting a suggestion fills the search bar and triggers a full hybrid search | ✓ VERIFIED | `handleSelectSuggestion` (L162-168): sets `localValue`, clears dropdown, calls `setQuery(suggestion)` which triggers grid update via store |
| 4  | Pressing Enter triggers a full hybrid search with the current text | ✓ VERIFIED | `handleKeyDown` Enter branch (L145-159): calls `setQuery(localValue)` — the only grid-update path on Enter |
| 5  | Grid does NOT update live while typing — only on Enter or suggestion click | ✓ VERIFIED | `handleChange` (L99-122): debounce timer calls ONLY `fetchSuggestions`. `setQuery` is called at lines 105 (easter egg), 155 (Enter), 167 (suggestion click), 176 (clear) — never in the debounce timer |
| 6  | X button clears search text but preserves active filter chips | ✓ VERIFIED | `handleClear` (L171-177): sets `localValue('')`, clears suggestions, calls `setQuery('')`. Does NOT reset tags, rateMin, rateMax — those remain in store |
| 7  | Header and search bar are sticky at the top on mobile | ✓ VERIFIED | `Header.tsx` L66: `className="... sticky top-0 z-50 ..."` — sticky positioning at all viewport sizes |
| 8  | Mobile users see 2 expert cards per row in a clean, readable layout | ✓ VERIFIED | `ExpertGrid.tsx` L23, L74: `grid-cols-2 md:grid-cols-3` — 2 columns on mobile, 3 on desktop. Card uses `p-3 sm:p-4` for mobile-tight padding |
| 9  | First tap on a mobile card expands it to show more details (tags, match reason) | ✓ VERIFIED | `ExpertCard.tsx` L35: `const [expanded, setExpanded] = useState(false)`. L47-66: `handleCardClick` sets `expanded=true` on first tap. Zone C (L126): `expanded ? 'flex' : 'hidden sm:flex'`. Zone D match reason (L143): `expanded ? '' : 'hidden sm:block'` |
| 10 | Second tap on an expanded card opens the expert's external profile link | ✓ VERIFIED | `handleCardClick` (L47-66): `else { onViewProfile(expert.profile_url) }` — second tap fires when `expanded=true` |
| 11 | Tapping the Sage FAB opens a fixed 60% height bottom sheet with Sage chat | ✓ VERIFIED | `SageMobileSheet.tsx` L57: `height: '60vh'`. `RootLayout.tsx` L47-49: `div.md:hidden` wraps `SageMobileSheet open={isOpen}` — FAB sets `isOpen=true` which opens it |
| 12 | The Sage bottom sheet is not draggable — only a close button dismisses it | ✓ VERIFIED | `SageMobileSheet.tsx` L49: `dismissible={false}` on `Drawer.Root`. No drag handle element present. Close button at L71-77 calls `onClose` |
| 13 | After a discovery query returns results, the Sage bottom sheet auto-closes after ~2s | ✓ VERIFIED | `SageMobileSheet.tsx` L36-42: `prevStreamingRef` pattern detects `true→false` transition gated on `sageMode=true`. Calls `setTimeout(() => onClose(), 2000)` |
| 14 | Desktop Sage panel continues to work unchanged | ✓ VERIFIED | `RootLayout.tsx` L31-44: existing `SagePanel` + backdrop wrapped in `hidden md:block` — hidden on mobile, unchanged on desktop |

**Score: 14/14 truths verified**

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `app/routers/suggest.py` | Multi-field FTS5 suggestions (job_title + company) | ✓ VERIFIED | `_run_suggest_multi` queries both columns (3 each), deduplicates to max 5. Commit `5ab5687` verified |
| `frontend/src/hooks/useHeaderSearch.ts` | Suggestions state, debounced fetch, keyboard nav, non-live search | ✓ VERIFIED | `suggestions`, `showDropdown`, `selectedIndex` state. `fetchSuggestions` with 300ms debounce. Full keyboard nav (ArrowUp/Down/Enter/Escape). `setQuery` only on commit |
| `frontend/src/components/Header.tsx` | Autocomplete dropdown UI, X clear button | ✓ VERIFIED | `motion.ul role="listbox"` with `AnimatePresence`. X button when `localValue` non-empty. All `aria-*` attributes present |
| `frontend/src/components/marketplace/ExpertCard.tsx` | Tap-expand behavior, 2-column content density | ✓ VERIFIED | `expanded` state, `handleCardClick` two-tap pattern, `ring-2 ring-brand-purple/30` visual indicator, `p-3 sm:p-4` mobile padding |
| `frontend/src/components/pilot/SageMobileSheet.tsx` | Vaul bottom sheet wrapping Sage chat for mobile | ✓ VERIFIED | `Drawer.Root dismissible={false}`, `60vh` fixed height, `useSage` wired, auto-scroll, auto-close, streaming indicator |
| `frontend/src/layouts/RootLayout.tsx` | Responsive rendering — desktop SagePanel vs mobile SageMobileSheet | ✓ VERIFIED | `hidden md:block` wraps SagePanel+backdrop. `md:hidden` wraps SageMobileSheet. Both use shared `isOpen`/`setOpen` from store |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `useHeaderSearch.ts` | `/api/suggest` | debounced fetch in `fetchSuggestions` | ✓ WIRED | L76: `fetch(\`${API_BASE}/api/suggest?q=${encodeURIComponent(value)}\`)` inside `fetchSuggestions`, response assigned to `backendResults` |
| `Header.tsx` | `useHeaderSearch.ts` | `useHeaderSearch` hook | ✓ WIRED | L4: `import { useHeaderSearch }`, L23: destructure `suggestions`, `showDropdown`, `selectedIndex`, `handleSelectSuggestion`, `handleClear`, `handleBlur` — all consumed in JSX |
| `RootLayout.tsx` | `SageMobileSheet.tsx` | conditional render with `md:hidden` | ✓ WIRED | L6: `import { SageMobileSheet }`, L48: `<SageMobileSheet open={isOpen} onClose={() => setOpen(false)} />` inside `div.md:hidden` |
| `SageMobileSheet.tsx` | `useSage.ts` | `useSage` hook | ✓ WIRED | L5: `import { useSage }`, L23: `const { messages, isStreaming, handleSend } = useSage()` — all three destructured values consumed in JSX |

---

### Requirements Coverage

**CRITICAL NOTE: Requirement ID namespace collision and missing definitions**

The four requirement IDs used in Phase 40.3.1 plans — SEARCH-01, MOBILE-01, MOBILE-02, MOBILE-03 — are **not defined in `.planning/REQUIREMENTS.md`** (the v3.0 requirements document). Furthermore, SEARCH-01 already exists in `.planning/milestones/v1.1-REQUIREMENTS.md` with a completely different meaning (HyDE query expansion for Sage). The MOBILE-01/02/03 IDs exist nowhere in the requirements system.

These IDs were invented in the ROADMAP.md phase entry for 40.3.1 without formal definition in REQUIREMENTS.md. They are effectively informal labels, not traceable requirements.

| Requirement | Source Plan | Description (from ROADMAP / CONTEXT) | Status | Evidence |
|-------------|-------------|--------------------------------------|--------|----------|
| SEARCH-01 | 40.3.1-01-PLAN.md | Search autocomplete with debounced suggestions (NOTE: ID collision with v1.1 HyDE requirement) | SATISFIED (implementation) | `suggest.py` multi-field FTS5, `useHeaderSearch` debounced fetchSuggestions, Header dropdown UI — all implemented and wired |
| MOBILE-02 | 40.3.1-01-PLAN.md | Header and search bar sticky at top on mobile | SATISFIED (implementation) | `Header.tsx` L66: `sticky top-0 z-50` — no mobile-specific override needed |
| MOBILE-01 | 40.3.1-02-PLAN.md | 2-column mobile card grid + tap-expand behavior | SATISFIED (implementation) | `ExpertGrid.tsx` `grid-cols-2 md:grid-cols-3`. `ExpertCard.tsx` `expanded` state, `handleCardClick` two-tap pattern |
| MOBILE-03 | 40.3.1-02-PLAN.md | Sage bottom sheet on mobile (non-draggable, 60% height, auto-close) | SATISFIED (implementation) | `SageMobileSheet.tsx` `dismissible={false}`, `60vh`, auto-close `prevStreamingRef` pattern |

**Orphaned requirement IDs:** SEARCH-01, MOBILE-01, MOBILE-02, MOBILE-03 are referenced in ROADMAP.md for Phase 40.3.1 but are absent from REQUIREMENTS.md. These IDs should be formally defined in REQUIREMENTS.md for traceability completeness. SEARCH-01 additionally shadows an existing v1.1 requirement with a different meaning.

---

### Commit Verification

All four task commits from the SUMMARY files are confirmed present in git history:

| Commit | Plan | Task | Verified |
|--------|------|------|---------|
| `5ab5687` | 40.3.1-01 | Expand suggest endpoint — company FTS5 field | ✓ Present |
| `b93413f` | 40.3.1-01 | Autocomplete dropdown, non-live search, X clear | ✓ Present |
| `2926dd5` | 40.3.1-02 | Tap-expand behavior, mobile content density | ✓ Present |
| `e214827` | 40.3.1-02 | SageMobileSheet + responsive RootLayout | ✓ Present |

---

### Anti-Patterns Found

No blocking anti-patterns found. The following items were inspected and cleared:

- `return []` in `suggest.py` (L44, L48, L93): Legitimate early returns for short queries and FTS5 error handling — not stubs
- `return null` in `ExpertCard.tsx` (L18, L21): Legitimate null returns from `findabilityLabel` helper function — not stubs
- `PLACEHOLDERS` constant and `placeholderIndex` in `useHeaderSearch.ts`: These are the animated search bar placeholder strings — not stub implementations
- `handleChange` debounce: Timer only calls `fetchSuggestions` — `setQuery` is intentionally absent (non-live search design)

**TypeScript:** Zero TypeScript errors (`npx tsc --noEmit` — clean output)

---

### Human Verification Required

#### 1. Autocomplete dropdown appearance and timing

**Test:** Open the Explorer at `/`, click the search bar, type "mark" and watch for a dropdown
**Expected:** A dropdown list appears below the search bar after ~300ms showing up to 5 suggestions (may include "Marketing Director", "Marketing Manager", "HubSpot" or similar job titles/companies, plus any TOP_TAGS that contain "mark")
**Why human:** Debounce timing and backend connectivity cannot be verified statically; requires live app with running backend

#### 2. Non-live grid update behavior

**Test:** Type several characters in the search bar (e.g., "fintech") — watch the expert grid carefully
**Expected:** The expert grid does NOT change while typing. Only after pressing Enter does the grid refresh with filtered results
**Why human:** React state flow (setQuery only on commit) cannot be observed without running the app

#### 3. Mobile two-tap card navigation

**Test:** Open the app in Chrome DevTools mobile viewport (375px), find any expert card, tap it once, then tap it a second time
**Expected:** First tap: card gets a purple ring, tags and match reason become visible ("Tap again to view profile" text appears). Second tap: browser navigates to (or opens) the expert's external profile URL
**Why human:** Touch event sequencing and visual state change require real browser interaction

#### 4. Sage bottom sheet non-draggable constraint

**Test:** Open mobile viewport, tap the Sage FAB, then try to swipe the bottom sheet downward
**Expected:** The sheet stays fixed at 60% height, does not drag down or dismiss on swipe. Only the X close button dismisses it
**Why human:** Vaul `dismissible={false}` prop behavior requires touch gesture testing

#### 5. Sage auto-close after discovery query

**Test:** On mobile viewport, tap Sage FAB, send a query like "find me a fintech strategist", watch the sheet
**Expected:** After Sage finishes streaming the response (typing indicator stops), the sheet closes automatically after about 2 seconds, revealing the filtered expert grid
**Why human:** Requires end-to-end runtime flow: useSage streaming, sageMode=true detection, prevStreamingRef pattern, 2s timer

#### 6. Desktop Sage panel unchanged

**Test:** Open the app at 1280px desktop width, click the Sage FAB
**Expected:** The existing fixed-width SagePanel appears on the right side — no bottom sheet, no visual regression from the 40.3 behavior
**Why human:** Visual regression check requires running the app at desktop viewport width

---

### Gaps Summary

No gaps found. All 14 observable truths are verified at all three levels (exists, substantive, wired). All four commits are present. TypeScript compiles clean. No stub anti-patterns detected.

The one notable administrative gap is that SEARCH-01, MOBILE-01, MOBILE-02, MOBILE-03 are not formally defined in `REQUIREMENTS.md`. This does not affect the implementation quality but creates a traceability gap. Additionally, "SEARCH-01" shadows an existing v1.1 requirement with a different meaning. These IDs should be added to REQUIREMENTS.md with their correct definitions for Phase 40.3.1.

---

_Verified: 2026-02-26T10:30:00Z_
_Verifier: Claude (gsd-verifier)_
