# Phase 40.2: UAT Fixes and Browse/Explorer Enhancements - Research

**Researched:** 2026-02-25
**Domain:** React UI fixes + feature enhancements (Browse + Explorer pages)
**Confidence:** HIGH

## Summary

Phase 40.2 addresses seven distinct items from UAT: BrowseCard alignment fixes, hero banner category taglines, email gate on Browse, Sage search reconnection, Explorer profile pictures, Explorer Clear All pill styling, and Explorer save/bookmark feature. All work is frontend-only except the Sage search fix which requires understanding the existing backend pipeline (already fully wired via `pilot_service.py` -> `run_explore()`).

The codebase is well-structured with clear patterns. Each feature touches 1-3 files with no major architectural changes needed. The existing component patterns (BrowseCard, ExpertCard, FilterChips, EmailGate/useEmailGate, SagePopover, useSage) provide templates for all modifications.

**Primary recommendation:** Group changes into 3 plans by wave: Wave 1 handles Browse page fixes (cards + hero + email gate + Sage), Wave 2 handles Explorer enhancements (profile pics + Clear All + save/bookmark).

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- BrowseCard: Name, rate, and tags pinned to the bottom of each card -- consistent alignment across all cards in a row regardless of content length
- BrowseCard: First card in each row needs left margin/padding away from the edge -- Claude decides appropriate spacing
- Hero banner: Category-specific taglines in the hero banner -- each category row's hero displays a unique tagline related to that domain
- Email gate on Browse: Same email gate as Explorer -- reuse the exact same component and trigger logic, identical behavior to Explorer implementation
- Sage search fix: Wire Sage queries on Browse through the same FAISS + keyword hybrid search pipeline that powers Explorer. When Sage finds results on Browse, navigate to Explorer showing search results (no category context preserved). Use existing Sage FAB/popover from Phase 39 -- just fix the search backend connection
- Explorer profile pictures: Small circle avatar (32-36px) to the left of the expert name in each expert row. If no profile photo: hide the circle entirely -- no placeholder, name shifts left. Use the same photo proxy endpoint that BrowseCards use
- Explorer Clear All button: Style as a pill matching existing filter tag pills -- same rounded shape, similar size, consistent styling
- Explorer save/bookmark: Bookmark icon (outline that fills when saved) at the right edge of each expert row. Storage: localStorage (no backend needed). Access saved experts via a "Saved" filter toggle/pill in Explorer. Explorer only -- no save indicators on Browse page

### Claude's Discretion
- Exact hero banner tagline text per category
- BrowseCard first-card left margin amount
- Bookmark icon animation/transition on toggle
- Exact positioning of bookmark icon within expert row

### Deferred Ideas (OUT OF SCOPE)
None -- discussion stayed within phase scope
</user_constraints>

## Standard Stack

### Core (already in project)
| Library | Purpose | Why Standard |
|---------|---------|--------------|
| React 18+ | UI framework | Already installed |
| Tailwind CSS | Utility styling | All components use Tailwind |
| motion/react (framer-motion) | Animations | Used by BrowseCard, HeroBanner, FilterChips |
| Zustand | State management | Store at `store/index.ts` with slices |
| lucide-react | Icons | Used throughout (ChevronRight, X, SlidersHorizontal) |
| react-router-dom | Routing | useNavigate, useLocation, Outlet |

### No New Dependencies Needed
All seven features can be implemented using the existing stack. The bookmark icon is available from lucide-react (`Bookmark`). localStorage API is native browser. No new npm packages required.

## Architecture Patterns

### Existing Component Structure
```
frontend/src/
├── components/
│   ├── browse/           # BrowseCard, BrowseRow, HeroBanner, Skeletons
│   ├── marketplace/      # ExpertCard, ExpertGrid, FilterChips, EmptyState
│   ├── pilot/            # SageFAB, SagePanel, SagePopover, SageInput, SageMessage
│   ├── sidebar/          # FilterSidebar, TagCloud, RateSlider
│   └── EmailGate.tsx     # Reusable email capture form
├── hooks/
│   ├── useBrowse.ts      # Browse data fetching + cache
│   ├── useEmailGate.ts   # Email gate localStorage + API
│   ├── useSage.ts        # Sage chat with search_experts/apply_filters
│   └── useExplore.ts     # Explorer data fetching
├── pages/
│   ├── BrowsePage.tsx    # Browse landing page
│   └── MarketplacePage.tsx # Explorer page
├── store/
│   ├── index.ts          # Combined Zustand store
│   ├── filterSlice.ts    # Filter state
│   ├── resultsSlice.ts   # Expert results
│   ├── navigationSlice.ts # Cross-page navigation
│   └── pilotSlice.ts     # Sage conversation
└── layouts/
    └── RootLayout.tsx    # Shared layout with Sage FAB/panel/popover
```

### Pattern 1: BrowseCard Bottom Alignment
**What:** Currently BrowseCard uses absolute positioning with a gradient overlay at bottom. Name/rate/tags are inside this overlay but don't have consistent alignment across cards of different content lengths.
**Fix:** The overlay div with `absolute bottom-0` already pins content to bottom. The issue is that card content varies (photo vs monogram) but the overlay is consistent. The fix is ensuring the text content within the overlay has `flex flex-col justify-end` so name/rate/tags stack from the bottom up consistently regardless of card height.
**Current code:** `BrowseCard.tsx` line 88 - overlay div with `absolute bottom-0 left-0 right-0 p-3`

### Pattern 2: Email Gate Reuse
**What:** Explorer uses `NewsletterGateModal` with `useNltrStore()` for email gating profile views. Browse needs the same gate but for card clicks.
**Current Explorer pattern:** `MarketplacePage.tsx` has `handleViewProfile()` which checks `isUnlocked`, shows gate modal if locked, opens profile if unlocked. Uses `useNltrStore` (Zustand) not `useEmailGate` (localStorage hook).
**Fix:** The same pattern should be applied to BrowsePage. The BrowseCard currently opens profile directly on second tap. Instead, it should check unlock state and show the gate modal.
**Important:** Explorer uses `NewsletterGateModal` component (not `EmailGate` component). The `EmailGate` component is an inline form from v1. The `NewsletterGateModal` is the modal overlay used in Explorer. Reuse `NewsletterGateModal` + `useNltrStore` pattern.

### Pattern 3: Sage Search on Browse - Current Behavior Analysis
**What:** The CONTEXT.md says Sage on Browse is "broken -- responds with generic answers, almost never finds results."
**Root cause analysis:** Looking at `useSage.ts`, the Browse path already calls `POST /api/pilot` with the same payload. The backend `pilot_service.py` always has access to `run_explore()` via `search_experts` function. The issue is NOT the backend pipeline -- it IS the same hybrid search.
**Likely root cause:** The `useSage.ts` code works correctly -- `search_performed: true` on Browse triggers `setPendingSageResults()` + `navigate('/explore')`. The issue may be that Sage on Browse more often returns `apply_filters` instead of `search_experts` because the system prompt includes `current_filters` which may confuse Gemini when on Browse (where no grid exists). However, looking more carefully, `current_filters` is always sent from the store's filter state which starts empty on Browse.
**Alternative diagnosis:** The "almost never finds results" may be a user perception issue -- Sage DOES search, but the 2-second delay + navigation to Explorer may feel broken. OR the `isExplorer` check in useSage means non-discovery questions just show a message (no filter application), which on Browse makes Sage feel unresponsive.
**Recommendation:** Test the actual behavior. If Sage IS searching correctly, the fix is UX messaging. If Sage is failing to call search_experts, the fix is in the system prompt or filter state sent from Browse.

### Pattern 4: Explorer ExpertCard Profile Pictures
**What:** Add small circle avatar to the left of expert name in each ExpertCard row.
**Current:** `ExpertCard.tsx` has Zone A (name/role/company) at top. Photo needs to be added to the left of Zone A.
**Photo endpoint:** `/api/photos/{username}` proxy (same as BrowseCard). Need `API_BASE` prefix.
**Expert type:** `Expert` interface in `resultsSlice.ts` does NOT have `photo_url` field. This needs to be added, and the backend `/api/explore` endpoint needs to include it in responses.

### Pattern 5: Saved/Bookmarked Experts
**What:** localStorage-based save feature with bookmark icon on ExpertCard + "Saved" filter pill.
**Storage pattern:** Use a Zustand slice (like `nltrStore`) or a simple localStorage set. Given that Zustand already manages all Explorer state, a dedicated `savedSlice` or extending `filterSlice` makes sense.
**localStorage key:** `tcs_saved_experts` storing a Set<string> of usernames (JSON serialized array).
**Filter integration:** Add a "Saved" pill/toggle to FilterChips that, when active, filters the expert grid to only show saved usernames.

### Anti-Patterns to Avoid
- **Don't create a new backend endpoint for bookmarks** -- localStorage only per CONTEXT.md
- **Don't add photo_url to the persisted Zustand state** -- it's in Expert objects from API
- **Don't modify EmailGate.tsx** -- use NewsletterGateModal pattern from Explorer instead
- **Don't build a separate Browse Sage** -- the existing useSage hook handles both paths already

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Email gate on Browse | New email gate component | NewsletterGateModal + useNltrStore (same as Explorer) | CONTEXT.md says "reuse exact same component and trigger logic" |
| Bookmark storage | Custom localStorage wrapper | Zustand persist slice or simple localStorage + useState | Consistent with existing state patterns |
| Profile photo display | Custom image loader | `<img>` with `API_BASE + /api/photos/{username}` + onError handler (same as BrowseCard) | Photo proxy already handles CORS, caching, 404s |

## Common Pitfalls

### Pitfall 1: Expert Interface Missing photo_url
**What goes wrong:** ExpertCard tries to render photo but `Expert` type has no `photo_url` field.
**Why it happens:** The `/api/explore` endpoint serializer may not include `photo_url`.
**How to avoid:** Check backend `explorer.py` response model. Add `photo_url` to `Expert` interface in `resultsSlice.ts`. Verify backend includes it.
**Warning signs:** TypeScript compilation error, photos never render.

### Pitfall 2: BrowseCard onViewProfile Callback Threading
**What goes wrong:** Adding email gate to Browse means BrowseCard needs access to the gate state, but BrowseCard is a memoized component receiving only `expert` prop.
**Why it happens:** Current BrowseCard handles profile opening internally (second tap opens profile_url directly). Adding email gate requires lifting the profile-open action to BrowsePage.
**How to avoid:** Add an `onViewProfile` callback prop to BrowseCard (like ExpertCard already has) and handle the gate logic in BrowsePage.

### Pitfall 3: Saved Filter vs Server-Side Filtering
**What goes wrong:** "Saved" filter toggle needs to work with VirtuosoGrid's data array, but saved usernames are client-side while expert data comes from server pagination.
**Why it happens:** The Explorer uses infinite scroll with server-side cursor pagination. Filtering to "only saved" can't be done server-side because the backend doesn't know about localStorage bookmarks.
**How to avoid:** When "Saved" filter is active, fetch ALL experts client-side (or use a special mode), then filter by saved usernames. OR: simpler approach -- the "Saved" pill replaces the grid data entirely with a client-side filtered list from the current `experts` array in store. This means only currently-loaded experts can show as saved.
**Recommendation:** Keep it simple -- "Saved" filter shows saved experts from the currently-loaded list. If a saved expert isn't in the current view, they won't appear. This is acceptable for v1 of the feature.

### Pitfall 4: HeroBanner Category Context
**What goes wrong:** HeroBanner currently shows featured experts. Category-specific taglines require knowing WHICH category each row belongs to.
**Why it happens:** HeroBanner receives `featured` array and `onExploreAll` -- no category context.
**How to avoid:** HeroBanner gets a new `categoryTagline` or similar prop, OR the tagline is rendered PER ROW (before each BrowseRow) rather than in the single HeroBanner carousel. The CONTEXT.md says "each category row's hero displays a unique tagline" -- this means taglines go ON the category rows, not in the main HeroBanner.
**Clarification:** Re-reading CONTEXT.md: "Category-specific taglines in the hero banner -- each category row's hero displays a unique tagline related to that domain." This is ambiguous -- it could mean the HeroBanner rotates with category-specific taglines, OR each row has a tagline above it. Given "Fills the open space in the gradient-only hero," it means adding tagline TEXT to the existing HeroBanner gradient. The banner already rotates through featured experts; adding a tagline PER featured expert or a general tagline makes most sense. Since the hero is category-agnostic (shows featured experts), a SINGLE rotating tagline per banner rotation or a category-based tagline map is the approach.

### Pitfall 5: First Card Left Margin in BrowseRow
**What goes wrong:** The scroll container already has `px-4 md:px-8` padding, so the first card should have left spacing. But the left fade overlay may cover the first card.
**Why it happens:** The left fade gradient overlay is `w-16` (64px) and starts at `left-0`. The scroll container padding is `px-4 md:px-8` (16px/32px). The first card may partially sit under the fade.
**How to avoid:** Increase the left padding on the scroll container, or add a spacer before the first card, or adjust the fade overlay width. Claude's discretion per CONTEXT.md.

## Code Examples

### Email Gate Pattern (from MarketplacePage.tsx)
```typescript
// Pattern to reuse on BrowsePage
const { subscribed, setSubscribed } = useNltrStore()
const legacyUnlocked = localStorage.getItem('tcs_gate_email') !== null || localStorage.getItem('tcs_email_unlocked') !== null
const isUnlocked = subscribed || legacyUnlocked
const [showGate, setShowGate] = useState(false)
const [pendingProfileUrl, setPendingProfileUrl] = useState<string | null>(null)

function handleViewProfile(url: string) {
  if (isUnlocked) {
    window.open(url, '_blank', 'noopener,noreferrer')
  } else {
    setPendingProfileUrl(url)
    setShowGate(true)
  }
}
```

### Photo Display Pattern (from BrowseCard.tsx)
```typescript
const API_BASE = import.meta.env.VITE_API_URL ?? ''
// In ExpertCard, add conditional photo rendering:
{expert.photo_url && (
  <img
    src={`${API_BASE}${expert.photo_url}`}
    alt=""
    className="w-8 h-8 rounded-full object-cover shrink-0"
    onError={(e) => { (e.target as HTMLElement).style.display = 'none' }}
  />
)}
```

### Bookmark localStorage Pattern
```typescript
const SAVED_KEY = 'tcs_saved_experts'

function getSavedExperts(): Set<string> {
  try {
    const raw = localStorage.getItem(SAVED_KEY)
    return raw ? new Set(JSON.parse(raw)) : new Set()
  } catch { return new Set() }
}

function toggleSaved(username: string): Set<string> {
  const saved = getSavedExperts()
  if (saved.has(username)) saved.delete(username)
  else saved.add(username)
  localStorage.setItem(SAVED_KEY, JSON.stringify([...saved]))
  return saved
}
```

### Filter Chip Pill Pattern (from FilterChips.tsx)
```typescript
// Existing chip styling -- reuse for Clear All and Saved pills
<span className="inline-flex items-center gap-1 text-xs bg-gray-100 text-gray-700 rounded-full px-2.5 py-0.5">
  {chip.label}
  <button onClick={chip.onDismiss} className="hover:text-gray-900 ml-0.5">x</button>
</span>
```

## Key Implementation Notes

### Backend Change Required: Expert photo_url in /api/explore
The `Expert` interface in `resultsSlice.ts` lacks `photo_url`. The backend `/api/explore` serializer needs to include `photo_url` so ExpertCard can render photos. Check `app/services/explorer.py` for the response model.

### Sage on Browse Investigation
The Sage pipeline already routes through hybrid search (`pilot_service.py` -> `run_explore()`). The "broken" behavior may be:
1. Gemini calling `apply_filters` instead of `search_experts` on Browse (because `current_filters` is sent)
2. The 2-second delay before navigation feeling unresponsive
3. Non-discovery questions showing only text (by design) but feeling broken

The fix should focus on ensuring `search_experts` is reliably called for discovery questions on Browse, and improving the UX messaging during the navigate-to-Explorer flow.

## Open Questions

1. **Sage "broken" root cause** -- Need to verify whether the issue is Gemini function selection, UX perception, or actual search failure. Recommendation: Assume both and fix system prompt + add better UX feedback.

2. **Expert photo_url in /api/explore** -- Need to verify backend `explorer.py` includes `photo_url` in response. If not, this is a backend change. Recommendation: Check and add if missing.

3. **Saved experts with pagination** -- When "Saved" filter is active, should we show only from loaded experts or fetch all? Recommendation: Filter from loaded list (simple, no backend change).

## Sources

### Primary (HIGH confidence)
- Direct codebase analysis of all referenced files
- `frontend/src/components/browse/BrowseCard.tsx` - current card implementation
- `frontend/src/components/marketplace/ExpertCard.tsx` - Explorer card with onViewProfile pattern
- `frontend/src/components/marketplace/FilterChips.tsx` - chip/pill styling
- `frontend/src/hooks/useSage.ts` - Sage search pipeline (Browse + Explorer paths)
- `frontend/src/pages/MarketplacePage.tsx` - email gate pattern
- `app/services/pilot_service.py` - backend Sage search (uses run_explore)
- `frontend/src/store/resultsSlice.ts` - Expert type definition

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - all libraries already in project, no new deps
- Architecture: HIGH - direct codebase analysis, clear patterns to follow
- Pitfalls: HIGH - identified from reading actual code, not hypothetical

**Research date:** 2026-02-25
**Valid until:** 2026-03-25
