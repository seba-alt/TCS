---
phase: 40-close-v3-audit-gaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md
  - frontend/src/store/index.ts
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: [SAGE-01, SAGE-02, SAGE-03]
gap_closure: true

must_haves:
  truths:
    - "Phase 39 has a VERIFICATION.md that validates SAGE-01, SAGE-02, SAGE-03 with pass/fail evidence and file+line references"
    - "useNavigationSlice convenience hook no longer exists in store/index.ts"
    - "navigationSource is reset to 'direct' after Explorer consumes it, so subsequent Explorer mounts start clean"
  artifacts:
    - path: ".planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md"
      provides: "Formal verification of SAGE-01, SAGE-02, SAGE-03 with evidence"
      contains: "status: passed"
    - path: "frontend/src/store/index.ts"
      provides: "Zustand store without orphaned useNavigationSlice hook"
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Explorer page that resets navigationSource to 'direct' after consuming it"
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "navigationSlice"
      via: "setNavigationSource('direct') after consuming navigationSource"
      pattern: "setNavigationSource.*direct"
---

<objective>
Close all three gaps from the v3.0 milestone audit: create the missing Phase 39 VERIFICATION.md, remove the orphaned `useNavigationSlice` dead code from store/index.ts, and fix the navigationSource sticky-state bug in MarketplacePage.tsx.

Purpose: Bring SAGE-01, SAGE-02, SAGE-03 from "partial" to "satisfied" in the 3-source cross-reference, remove dead code, and fix an edge case where subsequent Explorer mounts skip `resetPilot()`.
Output: 39-VERIFICATION.md, cleaned store, fixed navigationSource lifecycle.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v3.0-MILESTONE-AUDIT.md
@.planning/phases/40-close-v3-audit-gaps/40-RESEARCH.md

# Phase 39 plans and summaries (evidence sources for VERIFICATION.md)
@.planning/phases/39-sage-cross-page-navigation/39-01-PLAN.md
@.planning/phases/39-sage-cross-page-navigation/39-02-PLAN.md
@.planning/phases/39-sage-cross-page-navigation/39-01-SUMMARY.md
@.planning/phases/39-sage-cross-page-navigation/39-02-SUMMARY.md

# Verification format template
@.planning/phases/36-foundation/36-VERIFICATION.md

# Files to modify
@frontend/src/store/index.ts
@frontend/src/pages/MarketplacePage.tsx

# Evidence files to read for VERIFICATION.md
@frontend/src/layouts/RootLayout.tsx
@frontend/src/main.tsx
@frontend/src/store/pilotSlice.ts
@frontend/src/hooks/useSage.ts
@frontend/src/hooks/useExplore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 39 VERIFICATION.md</name>
  <files>
    .planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md
  </files>
  <action>
Create `.planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md` following the exact format of `36-VERIFICATION.md`.

**Before writing:** Read the following files to extract exact line numbers for evidence:
- `frontend/src/layouts/RootLayout.tsx` — SageFAB mounted above Outlet (SAGE-01)
- `frontend/src/main.tsx` — RootLayout wraps / and /explore routes (SAGE-01)
- `frontend/src/store/pilotSlice.ts` — messages in Zustand (SAGE-02)
- `frontend/src/pages/MarketplacePage.tsx` — resetPilot gated by navigationSource=direct (SAGE-02)
- `frontend/src/hooks/useSage.ts` — Browse discovery flow: search_performed -> setPendingSageResults -> setSageMode -> setTimeout -> navigate (SAGE-03)
- `frontend/src/hooks/useExplore.ts` — pendingSageResults consumption on mount (SAGE-03)

**Frontmatter:**
```yaml
---
phase: 39-sage-cross-page-navigation
status: passed
verified: 2026-02-24
---
```

**Structure:**
1. `# Phase 39: Sage Cross-Page Navigation — Verification`
2. `## Phase Goal` — one line: "Sage operates as a persistent co-pilot across both Browse and Explorer — conversation history survives navigation and discovery searches land the user directly in Explorer with results already loaded."
3. `## Success Criteria Verification` — four numbered subsections matching Phase 39 ROADMAP success criteria:
   - SC1: Sage FAB visible on Browse (root layout level) — cite RootLayout.tsx rendering SageFAB above Outlet, main.tsx layout route wrapping
   - SC2: Discovery search on Browse -> Explorer with results in grid (no competing fetch) — cite useSage.ts Browse discovery path, useExplore.ts pending consumption
   - SC3: Conversation history preserved Browse -> Explorer — cite pilotSlice.ts messages in Zustand store, not component state
   - SC4: Direct /explore visits start clean, Browse->Explorer does not reset — cite MarketplacePage.tsx navigationSource gate
4. `## Requirement Coverage` — table with SAGE-01 (39-01), SAGE-02 (39-01), SAGE-03 (39-02), all PASSED with brief evidence
5. `## Must-Haves Verification` — two subsections (Plan 39-01 and Plan 39-02) with checkbox lists copied from plan must_haves.truths
6. `## Result` — "Score: 4/4 success criteria passed / Status: PASSED"

**Evidence to cite (read files for current line numbers):**
- SAGE-01: RootLayout.tsx — SageFAB rendered above Outlet; main.tsx — layout route element=RootLayout wrapping / and /explore
- SAGE-02: pilotSlice.ts — messages array in Zustand store; MarketplacePage.tsx — `if (navigationSource === 'direct') { resetPilot() }`
- SAGE-03: useSage.ts — `search_performed === true && !isExplorer` branch: setPendingSageResults -> setSageMode(true) -> setTimeout 2s -> setNavigationSource('sage') -> navigate('/explore'); useExplore.ts — reads pendingSageResults via getState(), calls setResults + clearPendingSageResults

Use verified: 2026-02-24 (original Phase 39 completion date, not Phase 40 write date — per research recommendation).
  </action>
  <verify>
    <automated>test -f /Users/sebastianhamers/Documents/TCS/.planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md && grep -c "PASSED" /Users/sebastianhamers/Documents/TCS/.planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md</automated>
    <manual>39-VERIFICATION.md exists with proper frontmatter, 4 success criteria all PASSED, requirement coverage table, must-haves checklists, file+line evidence</manual>
  </verify>
  <done>Phase 39 VERIFICATION.md exists following project format, validates all 4 success criteria as PASSED with specific file and line references, covers SAGE-01/SAGE-02/SAGE-03 in requirement coverage table</done>
</task>

<task type="auto">
  <name>Task 2: Remove orphaned useNavigationSlice hook and fix navigationSource sticky-state</name>
  <files>
    frontend/src/store/index.ts
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
**1. Remove `useNavigationSlice` from `frontend/src/store/index.ts`:**

Delete lines 106-116 — the entire `useNavigationSlice` function export:

```typescript
// DELETE this entire block:
export const useNavigationSlice = () =>
  useExplorerStore(
    useShallow((state) => ({
      navigationSource:        state.navigationSource,
      pendingSageResults:      state.pendingSageResults,
      pendingSearchQuery:      state.pendingSearchQuery,
      setNavigationSource:     state.setNavigationSource,
      setPendingSageResults:   state.setPendingSageResults,
      clearPendingSageResults: state.clearPendingSageResults,
    }))
  )
```

**KEEP** all of the following (do NOT delete):
- Line 8: `import { createNavigationSlice } from './navigationSlice'` — used in `create()` call
- Line 13: `import type { NavigationSlice } from './navigationSlice'` — used in ExplorerStore type
- Line 16: `export type { ... NavigationSlice }` — re-export for consumers
- Line 21: `ExplorerStore = FilterSlice & ResultsSlice & PilotSlice & NavigationSlice` — type union

After deletion, verify with: `grep -r "useNavigationSlice" frontend/src/` — must return zero results.

**2. Fix navigationSource sticky-state in `frontend/src/pages/MarketplacePage.tsx`:**

Current code (lines 27-33):
```typescript
const resetPilot = useExplorerStore((s) => s.resetPilot)
const navigationSource = useExplorerStore((s) => s.navigationSource)
useEffect(() => {
  if (navigationSource === 'direct') {
    resetPilot()
  }
}, [resetPilot, navigationSource])
```

**Add** a `setNavigationSource` selector and unconditional reset after consuming:

```typescript
const resetPilot = useExplorerStore((s) => s.resetPilot)
const navigationSource = useExplorerStore((s) => s.navigationSource)
const setNavigationSource = useExplorerStore((s) => s.setNavigationSource)
useEffect(() => {
  if (navigationSource === 'direct') {
    resetPilot()
  }
  // Reset after consume — next Explorer mount starts clean regardless of how user arrived
  setNavigationSource('direct')
}, [resetPilot, navigationSource, setNavigationSource])
```

The unconditional `setNavigationSource('direct')` is safe because:
- Zustand uses Object.is equality on primitives — setting 'direct' when already 'direct' is a no-op (no re-render, no infinite loop)
- This ensures Browse->Explorer sets navigationSource='browse'/'sage', Explorer consumes it for the gate check, then resets to 'direct' so the next mount starts clean

**Do NOT:**
- Put the reset in a cleanup function (would fire on unmount — wrong timing)
- Create a separate useEffect for the reset (competing effects on same state)
- Add a conditional `if (navigationSource !== 'direct')` guard (unnecessary — the unconditional form is idempotent and clearer)
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>grep for useNavigationSlice returns zero matches; MarketplacePage.tsx has setNavigationSource('direct') in the pilot reset useEffect</manual>
  </verify>
  <done>useNavigationSlice hook deleted from store/index.ts (zero remaining references). navigationSource is reset to 'direct' after Explorer consumes it — subsequent mounts in the same SPA session start clean and correctly gate resetPilot()</done>
</task>

</tasks>

<verification>
1. `test -f .planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md` — file exists
2. `grep -c "PASSED" .planning/phases/39-sage-cross-page-navigation/39-VERIFICATION.md` — at least 4 (success criteria) + 3 (requirements) = 7 occurrences
3. `grep -r "useNavigationSlice" frontend/src/` — zero results (dead code removed)
4. `grep "setNavigationSource.*direct" frontend/src/pages/MarketplacePage.tsx` — matches (sticky-state fix in place)
5. `cd frontend && npx tsc --noEmit` — zero TypeScript errors
6. `createNavigationSlice` and `NavigationSlice` type still present in store/index.ts (not accidentally deleted)
</verification>

<success_criteria>
- Phase 39 VERIFICATION.md exists with passed status and evidence for all 4 success criteria
- SAGE-01, SAGE-02, SAGE-03 all have PASSED entries in requirement coverage table
- useNavigationSlice completely removed from codebase (zero grep matches)
- navigationSource resets to 'direct' after Explorer mount consumes it
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/40-close-v3-audit-gaps/40-01-SUMMARY.md`
</output>
