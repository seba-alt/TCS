# Milestone Archive: v1.1 Expert Intelligence & Search Quality

**Archived:** 2026-02-21
**Status:** SHIPPED
**Commits:** 49 commits (c8a0f8b..4ab4651)
**Files changed:** 55 files, +9,028 / -1,516 lines

---

## Milestone Goal

Transform the expert layer — auto-tag all 1,558 experts, score findability, enhance the admin Expert tab — then systematically improve retrieval using feedback signals and query expansion.

## Timeline

- **Started:** 2026-02-21
- **Completed:** 2026-02-21
- **Phases:** 3 (Phases 8–10)
- **Plans:** 9 total

---

## Key Accomplishments

1. **Full expert tagging pipeline** — AI-generated 3–8 domain tags for all 1,558 experts via Gemini 2.5 Flash structured output; tags stored as JSON in SQLite and embedded in FAISS vectors
2. **FAISS re-ingest to 1,558 experts** — Index rebuilt with all experts (up from 530); tag-enriched embedding text; crash-safe atomic promotion via temp file swap
3. **Findability scoring** — Deterministic 0–100 score (bio 40pts + tags 25pts + profile URL 15pts + title 10pts + rate 10pts) per expert with color-coded admin display
4. **Admin Expert tab overhaul** — First/last name, bio preview, profile URL, domain tag pills, color-coded findability score, worst-first sort so lowest-quality profiles surface immediately
5. **Search Intelligence Layer (HyDE + Feedback Re-ranking)** — `QUERY_EXPANSION_ENABLED` triggers hypothetical bio generation and blended FAISS re-search on weak queries; `FEEDBACK_LEARNING_ENABLED` applies ±20% feedback-weighted boost with cold-start guard (10+ interactions)
6. **Admin Intelligence Dashboard & Search Lab** — Real-time tracking of HyDE trigger rate, gap rate, avg similarity score; 30-day daily trend table; Search Lab for live query testing with intelligence metadata

---

## Phases

### Phase 8: Data Enrichment Pipeline
**Goal:** All 1,558 experts have AI-generated domain tags and findability scores; FAISS index rebuilt with tag-enriched embeddings
**Status:** Complete (4/4 plans)

**Plans:**
- `08-01` — Expert model schema migration + shared tagging service (app/models.py, app/services/tagging.py)
- `08-02` — Batch tagging script with async concurrency + findability scoring (scripts/tag_experts.py)
- `08-03` — Ingest rewrite: DB-sourced + tag enrichment + crash-safe FAISS promotion (scripts/ingest.py)
- `08-04` — Auto-tag on expert create: sync Gemini + BackgroundTasks retry + UI status (app/routers/admin.py)

**Requirements satisfied:** TAGS-01, TAGS-02, TAGS-03, TAGS-04, TAGS-05, FIND-01, FIND-02, FIND-03

**Key decisions:**
- TYPE_CHECKING guard for ORM imports in service modules (avoids circular imports)
- Sync Gemini client in route handlers; async only in batch scripts
- `compute_findability_score()` accepts optional pre-computed tags list for batch processing

---

### Phase 9: Admin Expert Tab Enhancement
**Goal:** Admin Expert tab surfaces first+last name, bio, profile URL, domain tags, and color-coded findability score — sorted worst-first
**Status:** Complete (3/3 plans)

**Plans:**
- `09-01` — Backend: enrich `_serialize_expert()` with tags+score, fix default sort, add `GET /api/admin/domain-map`
- `09-02` — Frontend types + hook: update ExpertRow, add DomainMap interfaces, add useAdminDomainMap hook
- `09-03` — Frontend table overhaul: sort/filter/pagination/domain-map section + human verification

**Requirements satisfied:** ADMIN-01, ADMIN-02, ADMIN-03, ADMIN-04, ADMIN-05, ADMIN-06, SEARCH-07

**Key decisions:**
- `json.loads(e.tags or '[]')` — safe NULL handling without try/except
- `Expert.findability_score.asc().nulls_first()` — worst-quality experts at top
- `Expert.profile_url.in_()` not username — Feedback.expert_ids stores profile URLs
- Empty `url_set` guard prevents SQLite empty `.in_()` error

---

### Phase 10: Search Intelligence Layer
**Goal:** HyDE query expansion and feedback-weighted re-ranking on the enriched index, gated by env var flags
**Status:** Complete (2/2 plans)

**Plans:**
- `10-01` — Create search_intelligence.py service: HyDE expansion + feedback re-ranking
- `10-02` — Wire chat.py + add intelligence SSE field + persist to DB + admin dashboard

**Requirements satisfied:** SEARCH-01, SEARCH-02, SEARCH-03, SEARCH-04, SEARCH-05, SEARCH-06

**Key decisions:**
- `retrieve_with_intelligence()` is synchronous; asyncio.wait_for timeout handled by chat.py caller
- Both flags default False; Railway explicitly enables after validation
- `faiss.normalize_L2` mandatory after blending averaged vectors (IndexFlatIP requires unit vectors)
- `feedback_applied` set True when flag is True (regardless of cold-start threshold) — signal to caller
- Raw SQL `CASE WHEN` for boolean aggregation in SQLite (not SQLAlchemy `cast`)

---

## Tech Debt Accepted

1. **HyDE embedding task type mismatch** — HyDE uses `RETRIEVAL_DOCUMENT` but query uses `RETRIEVAL_QUERY`. In Google's text-embedding-004, RETRIEVAL_DOCUMENT produces document-space vectors; blending with a query-space vector can reduce semantic coherence slightly. Low priority until retrieval quality degrades measurably.
2. **No-bio required field in Search Lab** — Expert display in Search Lab assumes `why_them` populated; fallback renders empty. Edge case: rare in production data.

---

## Stats

| Metric | Value |
|--------|-------|
| Phases | 3 (Phases 8–10) |
| Plans | 9 |
| Commits | 49 |
| Files changed | 55 |
| Lines added | +9,028 |
| Lines removed | -1,516 |
| Requirements | 21/21 (100%) |
| Start | 2026-02-21 |
| End | 2026-02-21 |
