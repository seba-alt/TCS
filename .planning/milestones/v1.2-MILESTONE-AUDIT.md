---
milestone: v1.2
audited: 2026-02-21T19:30:00Z
status: passed
scores:
  requirements: 12/12
  phases: 3/3
  integration: 12/12
  flows: 5/5
gaps_resolved:
  - id: "PANEL-03"
    fix: "Replaced HYDE_TRIGGER_SENSITIVITY with STRONG_RESULT_MIN in THRESHOLD_ORDER and friendlyLabel() — commit 00c74ba"
  - id: "LAB-01"
    fix: "Each ThreadPoolExecutor worker now creates its own SessionLocal() — commit 00c74ba"
# Original gaps found and resolved:
gaps_original:
  requirements:
    - id: "PANEL-03"
      status: "partial"
      phase: "12-steering-panel-frontend"
      claimed_by_plans: ["12-02-PLAN.md"]
      completed_by_plans: ["12-02-PLAN.md"]
      verification_status: "passed (code)"
      evidence: "IntelligenceDashboardPage.tsx line 63: THRESHOLD_ORDER includes 'HYDE_TRIGGER_SENSITIVITY' which does not exist in backend SETTINGS_SCHEMA. Backend has 'STRONG_RESULT_MIN' (same concept, different key name). UI silently renders only 2 threshold rows (SIMILARITY_THRESHOLD and FEEDBACK_BOOST_CAP) instead of the intended 3. STRONG_RESULT_MIN is unviewable and uneditable through the admin panel."
    - id: "LAB-01"
      status: "partial"
      phase: "13-search-lab-a-b-comparison"
      claimed_by_plans: ["13-01-PLAN.md"]
      completed_by_plans: ["13-01-PLAN.md"]
      verification_status: "passed (code)"
      evidence: "admin.py lines 1337-1341: the same SQLAlchemy Session object (db) is passed to all parallel _retrieve_for_lab calls running in ThreadPoolExecutor. SQLAlchemy Sessions are not thread-safe. Concurrent db.scalars() calls from multiple threads create a race condition. Does not crash in practice with SQLite (file-level locking serializes queries), but is incorrect and can produce intermittent errors under load."
  integration:
    - from: "IntelligenceDashboardPage.tsx (frontend)"
      to: "GET /api/admin/settings (backend)"
      issue: "THRESHOLD_ORDER references 'HYDE_TRIGGER_SENSITIVITY' but backend SETTINGS_SCHEMA has 'STRONG_RESULT_MIN'. The HyDE trigger sensitivity row never renders. STRONG_RESULT_MIN is returned by the API but silently discarded by the frontend."
      requirements_affected: ["PANEL-03"]
    - from: "POST /api/admin/compare (admin.py)"
      to: "SQLAlchemy Session"
      issue: "Single db Session passed to multiple ThreadPoolExecutor worker threads. Sessions are not thread-safe. Concurrent SELECT queries on AppSetting and Feedback tables create a race condition."
      requirements_affected: ["LAB-01"]
  flows:
    - flow: "Admin views all 3 intelligence thresholds in Steering Panel"
      breaks_at: "Step 2 — HYDE_TRIGGER_SENSITIVITY threshold row is missing; STRONG_RESULT_MIN is invisible and cannot be edited"
      requirements_affected: ["PANEL-03"]
tech_debt:
  - phase: 11-backend-settings-api
    items:
      - "GET /api/admin/settings returned dict instead of array — fixed in commit 7368ff4 (post-phase hotfix)"
  - phase: 12-steering-panel-frontend
    items:
      - "adminPost sends value as native JSON boolean/number; SettingUpdate.value is typed str — Pydantic v2 coerces safely but semantically wrong and version-fragile"
  - phase: 13-search-lab-a-b-comparison
    items:
      - "Shared db Session across ThreadPoolExecutor threads (see gaps.requirements LAB-01)"
  - phase: all
    items:
      - "/api/admin/intelligence-stats reads QUERY_EXPANSION_ENABLED and FEEDBACK_LEARNING_ENABLED from os.getenv() directly, bypassing get_settings(db). Flag display in stats endpoint lags behind DB-written values."
---

# Milestone v1.2 Audit — Intelligence Activation & Steering Panel

**Audited:** 2026-02-21
**Status:** gaps_found
**Scope:** Phases 11–13 (Backend Settings API, Steering Panel Frontend, Search Lab A/B Comparison)

---

## Requirements Coverage

**Score: 10/12 satisfied (2 partial)**

| Requirement | Phase | VERIFICATION.md | REQUIREMENTS.md | Integration | Final Status |
|-------------|-------|----------------|-----------------|-------------|-------------|
| CONF-01 | 11 | SATISFIED | [x] Complete | WIRED | ✓ satisfied |
| CONF-02 | 11 | SATISFIED | [x] Complete | WIRED | ✓ satisfied |
| CONF-03 | 11 | SATISFIED | [x] Complete | WIRED (array fix applied) | ✓ satisfied |
| CONF-04 | 11 | SATISFIED | [x] Complete | WIRED (latent Pydantic type coercion) | ✓ satisfied |
| PANEL-01 | 12 | SATISFIED (code) | [x] Complete | WIRED | ✓ satisfied |
| PANEL-02 | 12 | SATISFIED (code) | [x] Complete | WIRED | ✓ satisfied |
| PANEL-03 | 12 | SATISFIED (code) | [x] Complete | BROKEN — wrong key name, STRONG_RESULT_MIN invisible | ⚠ partial |
| PANEL-04 | 12 | SATISFIED (code) | [x] Complete | WIRED | ✓ satisfied |
| LAB-01 | 13 | SATISFIED | [x] Complete | PARTIAL — shared db Session thread-safety | ⚠ partial |
| LAB-02 | 13 | SATISFIED | [x] Complete | WIRED | ✓ satisfied |
| LAB-03 | 13 | SATISFIED | [x] Complete | WIRED | ✓ satisfied |
| LAB-04 | 13 | SATISFIED | [x] Complete | WIRED | ✓ satisfied |

---

## Phase Verification Status

| Phase | VERIFICATION.md Status | Score | Notes |
|-------|----------------------|-------|-------|
| 11 — Backend Settings API | passed | 8/8 | All automated truths verified |
| 12 — Steering Panel Frontend | human_needed | 9/9 code | Human verified during phase execution checkpoint |
| 13 — Search Lab A/B Comparison | human_needed | 6/6 code | Human verified "approved" during phase execution checkpoint |

---

## Cross-Phase Integration Findings

### Issue A — PANEL-03 BROKEN: HYDE_TRIGGER_SENSITIVITY key mismatch

**Files:**
- `frontend/src/admin/pages/IntelligenceDashboardPage.tsx` line 63: `THRESHOLD_ORDER`
- `app/routers/admin.py` lines 1010–1042: `SETTINGS_SCHEMA`

**The problem:** `THRESHOLD_ORDER` references `'HYDE_TRIGGER_SENSITIVITY'`. Backend `SETTINGS_SCHEMA` has no such key — the equivalent is `'STRONG_RESULT_MIN'` (range 1–10). The HyDE sensitivity row never renders; `STRONG_RESULT_MIN` is returned by the API but silently ignored by the frontend.

**Fix:** Replace `'HYDE_TRIGGER_SENSITIVITY'` with `'STRONG_RESULT_MIN'` in `THRESHOLD_ORDER` and add `case 'STRONG_RESULT_MIN': return 'HyDE Trigger Sensitivity'` to `friendlyLabel()`.

---

### Issue B — CONF-04/PANEL-02/PANEL-04 LATENT: Frontend sends wrong value type

**File:** `frontend/src/admin/pages/IntelligenceDashboardPage.tsx` lines 103, 129

`adminPost` sends `value` as a JS boolean or number. Backend `SettingUpdate.value` is typed `str`. Pydantic v2 coerces silently but this is version-fragile.

**Fix:** Use `String(newValue)` and `String(numVal)`.

---

### Issue C — LAB-01 LATENT: Shared db Session in ThreadPoolExecutor

**File:** `app/routers/admin.py` lines 1337–1341

Same SQLAlchemy `Session` passed to all parallel `_retrieve_for_lab` calls. Sessions are not thread-safe.

**Fix:** Pre-fetch `get_settings(db)` before spawning threads; pass the resolved dict to each worker. For Feedback queries, create a new `SessionLocal()` per thread.

---

### Issue D — MINOR: intelligence-stats reads env vars, not DB settings

**File:** `app/routers/admin.py` lines 296–299

`flags` dict reads `os.getenv(...)` directly, bypassing `get_settings(db)`. Stats display lags behind DB-written values.

**Fix:** Call `get_settings(db)` in the intelligence-stats endpoint.

---

## E2E Flow Verification

| Flow | Status | Notes |
|------|--------|-------|
| Admin flips HyDE/Feedback toggle → change persists → next chat uses new flag | ✓ Complete | Full chain verified |
| Admin edits SIMILARITY_THRESHOLD / FEEDBACK_BOOST_CAP → saves | ✓ Complete | Works correctly |
| Admin edits HyDE sensitivity (STRONG_RESULT_MIN) via panel | ✗ Broken | Row invisible in UI (Issue A) |
| Admin runs Search Lab compare → side-by-side results, no DB mutation | ✓ Complete | In-memory overrides only |
| Admin runs Search Lab compare with all 4 configs in parallel | ⚠ Risk | Thread-safety issue with shared Session |

---

## Tech Debt Summary

| Phase | Item | Severity |
|-------|------|----------|
| 11 (hotfix) | GET /api/admin/settings returned dict instead of array — patched in 7368ff4 | Resolved |
| 12 | adminPost sends native bool/number, backend expects string — Pydantic coerces | Low |
| 13 | Shared db Session in ThreadPoolExecutor | Medium |
| All | intelligence-stats reads env vars, not DB settings | Low |

---

*Audited: 2026-02-21*
*Auditor: Claude (gsd-integration-checker + orchestrator)*
