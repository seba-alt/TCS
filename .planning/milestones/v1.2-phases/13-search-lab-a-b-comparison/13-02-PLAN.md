---
phase: 13-search-lab-a-b-comparison
plan: "02"
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/admin/pages/SearchLabPage.tsx
autonomous: false
requirements: [LAB-02, LAB-03]

must_haves:
  truths:
    - "Admin enters a query in Search Lab, selects configs in the collapsible panel, and clicks Compare — results render as labeled side-by-side columns each showing ranked expert name, score, job title"
    - "Diff view toggle (default off) colors rows warm (amber) for rank improvements and cool (blue) for rank drops versus baseline, with a delta badge showing the rank change magnitude"
    - "Experts absent from a config show a ghost/grayed placeholder row so all columns maintain equal row alignment"
    - "Active per-run overrides display a prominent banner above the results (e.g. 'Overrides active: HyDE forced ON')"
    - "After the compare run, GET /api/admin/settings (verified by the human) still shows the same flag values as before"
  artifacts:
    - path: "frontend/src/admin/pages/SearchLabPage.tsx"
      provides: "A/B comparison UI with config panel, side-by-side columns, diff view, override controls"
      min_lines: 250
      contains: "CompareResponse"
  key_links:
    - from: "frontend/src/admin/pages/SearchLabPage.tsx"
      to: "POST /api/admin/compare"
      via: "fetch with X-Admin-Key header via adminPost utility"
      pattern: "adminPost.*compare"
    - from: "frontend/src/admin/pages/SearchLabPage.tsx"
      to: "CompareResponse"
      via: "import type from types.ts"
      pattern: "CompareResponse"
---

<objective>
Rewrite SearchLabPage.tsx as a full A/B comparison UI: collapsible config selection panel with 4 preset checkboxes, per-run override checkboxes, compare execution, side-by-side column results, and an optional diff view highlighting rank changes and absent experts.

Purpose: Delivers the visual A/B comparison experience. Admin can see exactly how HyDE and feedback re-ranking change expert rankings for any query — without touching global settings.
Output: A fully interactive SearchLabPage.tsx replacing the existing single-mode page.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

@.planning/phases/13-search-lab-a-b-comparison/13-CONTEXT.md
@.planning/phases/13-search-lab-a-b-comparison/13-01-SUMMARY.md

@frontend/src/admin/pages/SearchLabPage.tsx
@frontend/src/admin/types.ts
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/pages/IntelligenceDashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SearchLabPage with A/B comparison UI</name>
  <files>frontend/src/admin/pages/SearchLabPage.tsx</files>
  <action>
Rewrite SearchLabPage.tsx from scratch. Remove the existing SSE single-query flow; the compare endpoint covers all use cases.

**Import dependencies:**
```typescript
import { useState, useRef } from 'react'
import { adminPost } from '../hooks/useAdminData'
import type { CompareResponse, CompareColumn, CompareExpert, LabConfigKey, LabOverrides } from '../types'
```

**Constants (module-level, outside component):**
```typescript
const CONFIG_OPTIONS: { key: LabConfigKey; label: string; description: string }[] = [
  { key: 'baseline', label: 'Baseline',           description: 'No intelligence features' },
  { key: 'hyde',     label: 'HyDE Only',          description: 'Query expansion on weak queries' },
  { key: 'feedback', label: 'Feedback Only',       description: 'Re-ranking by thumbs feedback' },
  { key: 'full',     label: 'Full Intelligence',   description: 'Both HyDE + feedback re-ranking' },
]
```

**Component state:**
```typescript
const [query, setQuery]               = useState('')
const [panelOpen, setPanelOpen]       = useState(true)
const [selectedConfigs, setSelectedConfigs] = useState<LabConfigKey[]>(['baseline', 'hyde', 'feedback', 'full'])
const [resultCount, setResultCount]   = useState(20)
const [overrides, setOverrides]       = useState<LabOverrides>({})
const [compareResult, setCompareResult] = useState<CompareResponse | null>(null)
const [diffMode, setDiffMode]         = useState(false)
const [status, setStatus]             = useState<'idle' | 'loading' | 'done' | 'error'>('idle')
const [error, setError]               = useState<string | null>(null)
const abortRef                        = useRef<AbortController | null>(null)
```

**runCompare() function:**
```typescript
async function runCompare() {
  if (!query.trim() || status === 'loading' || selectedConfigs.length < 2) return
  abortRef.current?.abort()
  const ctrl = new AbortController()
  abortRef.current = ctrl
  setStatus('loading')
  setCompareResult(null)
  setError(null)
  try {
    const result = await adminPost<CompareResponse>('/compare', {
      query: query.trim(),
      configs: selectedConfigs,
      result_count: resultCount,
      overrides,
    })
    setCompareResult(result)
    setStatus('done')
  } catch (err) {
    if ((err as { name?: string }).name === 'AbortError') return
    setError(err instanceof Error ? err.message : String(err))
    setStatus('error')
  }
}
```

**JSX layout:**
Page header, query textarea (Cmd+Enter to run), collapsible config panel (toggle button + panel body when open), active overrides banner (when overrides active), loading/error states, diff toggle + results columns.

**Collapsible config panel:**
Config checkboxes: Render CONFIG_OPTIONS as checkboxes. Clicking a checked item unchecks it ONLY if selectedConfigs.length > 2. Show "(min 2 required)" hint when at 2.

Result count input: `<input type="number" min={1} max={50} value={resultCount} />` with label "Results per config".

Per-run override checkboxes (co-located with config selection per CONTEXT.md):
```
[ ] Force HyDE ON for this run (overrides all preset configs)
[ ] Force Feedback ON for this run (overrides all preset configs)
```
Checking "Force HyDE ON" sets `overrides.QUERY_EXPANSION_ENABLED = true`. Unchecking removes the key from the object. Same for feedback. Overrides persist within session, reset on page reload (useState initializes empty).

Compare button: disabled when query is empty, loading, or fewer than 2 configs selected. Show "Select at least 2 configs" text when 1 config selected.

**Active overrides banner (shown above results when any override is active):**
```tsx
<div className="bg-amber-900/30 border border-amber-700/50 rounded-xl px-5 py-3 flex items-center gap-3">
  <span className="text-amber-400 font-semibold text-sm">Overrides active:</span>
  {overrides.QUERY_EXPANSION_ENABLED && <span className="text-xs bg-amber-800/40 text-amber-300 border border-amber-700/40 px-2 py-0.5 rounded">HyDE forced ON</span>}
  {overrides.FEEDBACK_LEARNING_ENABLED && <span className="text-xs bg-amber-800/40 text-amber-300 border border-amber-700/40 px-2 py-0.5 rounded">Feedback forced ON</span>}
  <span className="text-xs text-amber-600 ml-auto">Global settings unchanged</span>
</div>
```
Show this banner whenever `overrides.QUERY_EXPANSION_ENABLED || overrides.FEEDBACK_LEARNING_ENABLED`.

**Diff mode toggle (shown after results load):**
Toggle button (default OFF) with purple active state. When ON, enables diff highlighting.

**Side-by-side column results:**
```tsx
<div className="overflow-x-auto">
  <div className="flex gap-4 min-w-max">
    {compareResult.columns.map(col => (
      <CompareColumnCard key={col.config} column={col} diffMode={diffMode} baselineColumn={compareResult.columns.find(c => c.config === 'baseline')} allColumns={compareResult.columns} />
    ))}
  </div>
</div>
```

**CompareColumnCard sub-component (module-level, NOT inside main component):**

Props: `{ column: CompareColumn; diffMode: boolean; baselineColumn: CompareColumn | undefined; allColumns: CompareColumn[] }`

Column header shows label + HyDE badge + Feedback badge. Max rank = `Math.max(...allColumns.map(c => c.experts.length))`. For each rank 1..maxRank:
- If expert found at that rank in this column: render expert row
- If not found: render ghost placeholder row

Expert row diff calculation (when `diffMode && baselineColumn && column.config !== 'baseline'`):
- `baselineRank = baselineColumn.experts.find(e => e.name === expert.name)?.rank ?? null`
- `isNew = baselineRank === null`
- `delta = isNew ? null : baselineRank - expert.rank` (positive = moved up, negative = moved down)

Row background in diff mode:
- `delta > 0`: `bg-amber-950/40 border-l-2 border-amber-600`
- `delta < 0`: `bg-blue-950/40 border-l-2 border-blue-700`
- `isNew`: `bg-emerald-950/30 border-l-2 border-emerald-700`
- no diff or no change: no highlight

Expert row content: rank number (muted mono), expert name (white truncated), title (slate-500 truncated), score (mono 3dp), delta badge (+N/-N in amber/blue), "new" badge (emerald) when isNew.

Ghost placeholder: rank number + gray bar, opacity-30.

**Style:** Dark slate aesthetic from existing SearchLabPage/IntelligenceDashboardPage. `bg-slate-800/60 border-slate-700/60 rounded-xl`. `text-white` headings, `text-slate-400`/`text-slate-500` secondary.

Run `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20` to verify TypeScript compilation.
  </action>
  <verify>
    Run: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run build 2>&1 | tail -20`
    Expect: Build succeeds with 0 TypeScript errors, 0 unused variable warnings.

    If dev server is running: navigate to http://localhost:5173/admin and go to Search Lab. The page should show query input + collapsible config panel with 4 checkboxes.
  </verify>
  <done>
    SearchLabPage.tsx builds without TypeScript errors. The page renders the query bar, collapsible config panel with 4 preset checkboxes, per-run override checkboxes, and Compare button. Results render as side-by-side columns when compare returns data.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify A/B comparison end-to-end in browser</name>
  <files>frontend/src/admin/pages/SearchLabPage.tsx</files>
  <action>
Human verification of the complete A/B comparison feature built in Plans 01 and 02:
- POST /api/admin/compare endpoint (Plan 01) running 4 configs in parallel
- TypeScript types (Plan 01): CompareResponse, CompareColumn, CompareExpert, LabConfigKey, LabOverrides
- SearchLabPage.tsx (Task 1): config panel, overrides banner, side-by-side columns, diff view
  </action>
  <verify>
    Start both servers if not running:
    - Backend: `cd /Users/sebastianhamers/Documents/TCS && uvicorn app.main:app --reload`
    - Frontend: `cd /Users/sebastianhamers/Documents/TCS/frontend && npm run dev`

    1. Navigate to http://localhost:5173/admin then go to Search Lab
    2. Verify the collapsible config panel shows 4 checkboxes: Baseline, HyDE Only, Feedback Only, Full Intelligence
    3. Enter a query: "I need help structuring a Series A fundraise for a SaaS company"
    4. Leave all 4 configs checked, click Compare
    5. Verify results appear as 4 labeled side-by-side columns, each with a ranked expert list
    6. Verify each row shows: rank number (subtle), expert name, job title, score
    7. Toggle Diff mode ON — verify rank changes show amber (moved up) or blue (moved down) row background + delta badge (e.g. "+2" or "-3")
    8. Verify experts absent from a config show a ghost/grayed placeholder row keeping columns aligned
    9. Check "Force HyDE ON" override checkbox — verify the amber "Overrides active: HyDE forced ON" banner appears
    10. Run the query again with HyDE override active — results should return without errors
    11. Navigate to Intelligence tab (http://localhost:5173/admin/intelligence) — verify the HyDE toggle still shows its pre-test state (DB not modified by compare runs)
    12. Deselect one config to leave 3 — verify Compare button still works
    13. Try deselecting configs until only 1 remains — verify Compare button becomes disabled or shows a message
  </verify>
  <done>
    Human has typed "approved". All 13 verification steps passed. Side-by-side columns render, diff mode works, overrides banner appears, global settings unchanged after compare runs.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes in frontend/ with no errors.
2. POST /api/admin/compare returns {"columns":[...], "query":"...", "overrides_applied":{}} for a 4-config run.
3. Side-by-side column layout renders with all columns visible (horizontal scroll on narrow screens).
4. Diff mode highlights rank changes with amber/blue row backgrounds and delta badges.
5. Ghost placeholder rows keep columns row-aligned when expert counts differ.
6. Overrides banner is visible whenever any per-run override is checked.
7. Intelligence tab settings unchanged after a compare run (global DB not modified).
8. Compare button disabled when fewer than 2 configs selected.
</verification>

<success_criteria>
- Admin can run a query across up to 4 preset configurations from the Search Lab page (LAB-01 — delivered by Plan 01 endpoint, invoked here).
- Results render as labeled side-by-side columns with rank, name, title, score per row (LAB-02).
- Diff view (toggle, default off) highlights experts that moved rank with directional colors and delta badges, marks absent experts as ghost rows, and marks new experts with a "new" badge (LAB-03).
- Per-run override checkboxes force-enable HyDE/feedback for the single run with a prominent banner; GET /api/admin/settings shows unchanged values after the run (LAB-04 UI side — backend verified in Plan 01).
- Human has verified all above in browser and typed "approved".
</success_criteria>

<output>
After completion, create `.planning/phases/13-search-lab-a-b-comparison/13-02-SUMMARY.md`
</output>
