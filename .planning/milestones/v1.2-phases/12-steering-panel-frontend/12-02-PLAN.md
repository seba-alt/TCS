---
phase: 12-steering-panel-frontend
plan: "02"
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - frontend/src/admin/pages/IntelligenceDashboardPage.tsx
autonomous: false
requirements: [PANEL-01, PANEL-02, PANEL-03, PANEL-04]

must_haves:
  truths:
    - "Admin opens Intelligence tab and sees two toggle switches labeled 'HyDE Query Expansion' and 'Feedback Re-ranking', each reflecting the current live state from GET /api/admin/settings"
    - "Admin flips a toggle; the UI optimistically updates, calls POST /api/admin/settings with the new boolean, and shows an inline error if the call fails (toggle reverts)"
    - "Admin sees three numeric inputs for similarity threshold (0.0-1.0), HyDE trigger sensitivity (1-10), and feedback boost cap (0-50) pre-filled with current values"
    - "A dirty state indicator (Save button highlighted in purple) appears when any threshold input differs from the fetched value"
    - "Admin clicks Save; UI calls POST /api/admin/settings for each changed threshold sequentially, shows inline success or error message, message fades after ~4 seconds"
    - "Each input and toggle shows a source badge (DB/env/default) so admin knows which overrides are active"
  artifacts:
    - path: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      provides: "Steering panel with toggles, threshold inputs, save flow, dirty tracking"
      min_lines: 150
  key_links:
    - from: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      to: "useAdminSettings"
      via: "import from hooks/useAdminData"
      pattern: "useAdminSettings"
    - from: "frontend/src/admin/pages/IntelligenceDashboardPage.tsx"
      to: "/api/admin/settings (POST)"
      via: "adminPost('/settings', { key, value })"
      pattern: "adminPost.*settings"
---

<objective>
Replace the read-only IntelligenceDashboardPage with a live steering panel: toggles for HyDE and feedback flags, numeric inputs for the three thresholds, dirty state tracking, and inline save confirmation.

Purpose: This is the primary user-facing deliverable of Phase 12. Admin can control all intelligence settings without leaving the page or redeploying.
Output: Fully functional IntelligenceDashboardPage.tsx replacing the existing read-only version.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-steering-panel-frontend/12-CONTEXT.md
@.planning/phases/12-steering-panel-frontend/12-01-SUMMARY.md
@frontend/src/admin/pages/IntelligenceDashboardPage.tsx
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite IntelligenceDashboardPage as live steering panel</name>
  <files>frontend/src/admin/pages/IntelligenceDashboardPage.tsx</files>
  <action>
Fully replace frontend/src/admin/pages/IntelligenceDashboardPage.tsx with a steering panel. Preserve the existing dark slate aesthetic (bg-slate-800/60, border-slate-700/60, rounded-xl, p-5 card pattern) consistent with all other admin pages.

## Import requirements

```typescript
import { useState, useEffect, useRef } from 'react'
import { useAdminSettings, adminPost } from '../hooks/useAdminData'
import type { AdminSetting } from '../types'
```

## SourceBadge component

Small badge showing where a value comes from. Inline, displayed next to toggle label or input label:

```typescript
function SourceBadge({ source }: { source: AdminSetting['source'] }) {
  if (source === 'db') return (
    <span className="text-xs font-mono bg-purple-900/50 text-purple-300 border border-purple-700/40 px-1.5 py-0.5 rounded">DB</span>
  )
  if (source === 'env') return (
    <span className="text-xs font-mono bg-slate-700/60 text-slate-400 border border-slate-600/40 px-1.5 py-0.5 rounded">env</span>
  )
  return (
    <span className="text-xs font-mono bg-slate-800/60 text-slate-600 border border-slate-700/40 px-1.5 py-0.5 rounded">default</span>
  )
}
```

## Toggle component (for boolean flags)

No loading/disabled state during save (per user decision — assume near-instant):

```typescript
function ToggleSwitch({
  checked,
  onChange,
}: {
  checked: boolean
  onChange: (val: boolean) => void
}) {
  return (
    <button
      role="switch"
      aria-checked={checked}
      onClick={() => onChange(!checked)}
      className={`relative inline-flex h-6 w-11 flex-shrink-0 rounded-full border-2 border-transparent transition-colors focus:outline-none ${
        checked ? 'bg-purple-600' : 'bg-slate-600'
      }`}
    >
      <span
        className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
          checked ? 'translate-x-5' : 'translate-x-0'
        }`}
      />
    </button>
  )
}
```

## TooltipIcon component (for threshold inputs)

Shows description text on hover via title attribute (simple, no library):

```typescript
function TooltipIcon({ text }: { text: string }) {
  return (
    <span
      title={text}
      className="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-700 text-slate-400 text-xs cursor-help hover:bg-slate-600 hover:text-slate-200 transition-colors flex-shrink-0"
      aria-label={text}
    >
      i
    </span>
  )
}
```

## Main component state

```typescript
export default function IntelligenceDashboardPage() {
  const { data, loading, error, refetch } = useAdminSettings()

  // Local threshold state — initialized from fetched data
  // Keys: SIMILARITY_THRESHOLD, HYDE_TRIGGER_SENSITIVITY, FEEDBACK_BOOST_CAP
  const [thresholds, setThresholds] = useState<Record<string, string>>({})
  // Track original fetched values to detect dirty state
  const [originalThresholds, setOriginalThresholds] = useState<Record<string, string>>({})

  // Inline save feedback
  const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle')
  const [saveMessage, setSaveMessage] = useState('')
  const fadeTimer = useRef<ReturnType<typeof setTimeout> | null>(null)

  // Initialize threshold state when data loads
  useEffect(() => {
    if (!data) return
    const vals: Record<string, string> = {}
    for (const s of data.settings) {
      if (s.type !== 'bool') {
        vals[s.key] = String(s.raw)
      }
    }
    setThresholds(vals)
    setOriginalThresholds(vals)
  }, [data])
  // ...
}
```

## Toggle handler (optimistic update)

Call POST then refetch — near-instant, no spinner per user decision:

```typescript
async function handleToggle(key: string, newValue: boolean) {
  try {
    await adminPost('/settings', { key, value: newValue })
    refetch()
  } catch (e) {
    // On error, refetch to restore original state (revert)
    refetch()
    showSaveResult('error', `Failed to update ${key}: ${e instanceof Error ? e.message : 'Unknown error'}`)
  }
}
```

## Dirty state detection

```typescript
const isDirty = Object.keys(thresholds).some(
  key => thresholds[key] !== originalThresholds[key]
)
```

## Save handler (thresholds)

Call POST /api/admin/settings once per changed threshold (sequential, not parallel — simpler error attribution):

```typescript
async function handleSave() {
  const changed = Object.keys(thresholds).filter(
    key => thresholds[key] !== originalThresholds[key]
  )
  if (changed.length === 0) return

  try {
    for (const key of changed) {
      const setting = data!.settings.find(s => s.key === key)!
      const numVal = setting.type === 'int'
        ? parseInt(thresholds[key], 10)
        : parseFloat(thresholds[key])
      if (isNaN(numVal)) throw new Error(`Invalid value for ${key}`)
      await adminPost('/settings', { key, value: numVal })
    }
    await refetch()
    showSaveResult('success', `${changed.length} setting${changed.length > 1 ? 's' : ''} saved`)
  } catch (e) {
    showSaveResult('error', e instanceof Error ? e.message : 'Save failed')
  }
}

function showSaveResult(status: 'success' | 'error', message: string) {
  if (fadeTimer.current) clearTimeout(fadeTimer.current)
  setSaveStatus(status)
  setSaveMessage(message)
  fadeTimer.current = setTimeout(() => setSaveStatus('idle'), 4000)
}

// Cleanup on unmount
useEffect(() => () => { if (fadeTimer.current) clearTimeout(fadeTimer.current) }, [])
```

## Page layout

```
<div className="p-8 space-y-8 max-w-2xl">
  <h1>Search Intelligence</h1>
  <p>Manage feature flags and retrieval thresholds in real time. Changes take effect on the next chat request without redeploying.</p>

  [loading / error states]

  {data && (
    <>
      {/* Feature Flags card */}
      <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5 space-y-4">
        <h2>Feature Flags</h2>
        <p className="text-xs text-slate-500">Changes apply immediately — no redeploy needed.</p>

        {/* HyDE toggle row */}
        <div className="flex items-center justify-between py-3 border-b border-slate-700/40">
          <div className="flex flex-col gap-0.5">
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-white">HyDE Query Expansion</span>
              <SourceBadge source={hydeSetting.source} />
            </div>
            <span className="text-xs text-slate-500">Generates a hypothetical expert bio for weak queries before re-searching FAISS</span>
          </div>
          <ToggleSwitch
            checked={hydeSetting.value as boolean}
            onChange={val => handleToggle(hydeSetting.key, val)}
          />
        </div>

        {/* Feedback toggle row */}
        <div className="flex items-center justify-between py-3">
          <div className="flex flex-col gap-0.5">
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-white">Feedback Re-ranking</span>
              <SourceBadge source={feedbackSetting.source} />
            </div>
            <span className="text-xs text-slate-500">Boosts experts with 10+ interactions and positive feedback ratio (up to cap)</span>
          </div>
          <ToggleSwitch
            checked={feedbackSetting.value as boolean}
            onChange={val => handleToggle(feedbackSetting.key, val)}
          />
        </div>
      </div>

      {/* Thresholds card */}
      <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5 space-y-5">
        <div>
          <h2>Thresholds</h2>
          <p className="text-xs text-slate-500 mt-1">Numeric tuning parameters for search intelligence.</p>
        </div>

        {/* One row per threshold setting */}
        {thresholdSettings.map(s => (
          <div key={s.key} className="flex items-center gap-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <label className="text-sm font-medium text-white">{friendlyLabel(s.key)}</label>
                <TooltipIcon text={s.description} />
                <SourceBadge source={s.source} />
              </div>
              <p className="text-xs text-slate-500">
                Range: {s.min} to {s.max}{s.key === 'FEEDBACK_BOOST_CAP' ? '%' : ''}
              </p>
            </div>
            <input
              type="number"
              value={thresholds[s.key] ?? ''}
              onChange={e => setThresholds(prev => ({ ...prev, [s.key]: e.target.value }))}
              min={s.min}
              max={s.max}
              step={s.type === 'float' ? 0.05 : 1}
              className="w-24 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white text-right font-mono focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent"
            />
          </div>
        ))}

        {/* Save row */}
        <div className="pt-3 border-t border-slate-700/40 flex items-center gap-4">
          <button
            onClick={handleSave}
            disabled={!isDirty}
            className={`px-5 py-2 text-sm font-semibold rounded-lg transition-all ${
              isDirty
                ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-500/25'
                : 'bg-slate-700 text-slate-500 cursor-not-allowed'
            }`}
          >
            Save Changes
          </button>
          {isDirty && (
            <span className="text-xs text-purple-400">Unsaved changes</span>
          )}
        </div>

        {/* Inline save feedback — fades after 4s */}
        {saveStatus !== 'idle' && (
          <div className={`rounded-lg px-4 py-3 text-sm ${
            saveStatus === 'success'
              ? 'bg-green-950/40 border border-green-800/50 text-green-300'
              : 'bg-red-950/40 border border-red-800/50 text-red-400'
          }`}>
            {saveMessage}
          </div>
        )}
      </div>
    </>
  )}
</div>
```

## friendlyLabel helper

```typescript
function friendlyLabel(key: string): string {
  switch (key) {
    case 'SIMILARITY_THRESHOLD': return 'Similarity Threshold'
    case 'HYDE_TRIGGER_SENSITIVITY': return 'HyDE Trigger Sensitivity'
    case 'FEEDBACK_BOOST_CAP': return 'Feedback Boost Cap'
    default: return key
  }
}
```

## Setting categorization

Derive from data.settings:
- Flag settings (type === 'bool'): QUERY_EXPANSION_ENABLED → hydeSetting, FEEDBACK_LEARNING_ENABLED → feedbackSetting
- Threshold settings (type !== 'bool') ordered: SIMILARITY_THRESHOLD, HYDE_TRIGGER_SENSITIVITY, FEEDBACK_BOOST_CAP → thresholdSettings array

Find hydeSetting with key === 'QUERY_EXPANSION_ENABLED' and feedbackSetting with key === 'FEEDBACK_LEARNING_ENABLED'. Map thresholdSettings by filtering type !== 'bool' and sorting by the above order.

## DO NOT include

- The old DailyTable, MetricCard, MiniBar, FlagPill components — the steering panel replaces the entire existing page
- Any loading spinner or disabled state on toggles (per user decision)
- Any animation library (no framer-motion etc.)
- Real-time threshold validation (validate on Save only)
  </action>
  <verify>
1. `npm run build` from frontend/ exits 0 with zero TypeScript errors
2. `grep -n "useAdminSettings\|adminPost\|ToggleSwitch\|handleToggle\|handleSave\|isDirty" frontend/src/admin/pages/IntelligenceDashboardPage.tsx` shows all names present
3. `grep -n "DailyTable\|MetricCard\|MiniBar\|FlagPill" frontend/src/admin/pages/IntelligenceDashboardPage.tsx` returns empty (old read-only components removed)
  </verify>
  <done>
IntelligenceDashboardPage.tsx is a steering panel with:
- Two toggle rows (HyDE Query Expansion, Feedback Re-ranking) with SourceBadge and optimistic toggle behavior
- Three threshold inputs (Similarity Threshold, HyDE Trigger Sensitivity, Feedback Boost Cap) with number inputs, min/max/step, TooltipIcon, and SourceBadge
- isDirty detection (Save button highlights purple when values differ from fetched originals)
- Save handler calling POST /api/admin/settings per changed setting, then refetch
- Inline success/error message fading after 4 seconds
- TypeScript build passes with zero errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify steering panel end-to-end in browser</name>
  <files></files>
  <action>Human verifies the complete steering panel UX using the frontend dev server started locally.</action>
  <what-built>
Full steering panel replacing the Intelligence tab read-only view. Toggles for HyDE and Feedback flags, three threshold inputs with tooltips and source badges, dirty-state Save button, and inline feedback messages.
  </what-built>
  <how-to-verify>
1. Start the frontend dev server: `cd frontend && npm run dev`
2. Navigate to http://localhost:5173/admin, log in, click "Intelligence" in sidebar
3. Verify toggle section:
   - Two rows appear: "HyDE Query Expansion" and "Feedback Re-ranking"
   - Each row has a SourceBadge (DB/env/default) next to the label
   - Each row has a toggle switch on the right
   - Flip a toggle — the switch state changes immediately without any spinner
4. Verify threshold section:
   - Three rows appear: Similarity Threshold, HyDE Trigger Sensitivity, Feedback Boost Cap
   - Each has a number input pre-filled with the current value from GET /api/admin/settings
   - Hover over the i icon (TooltipIcon) — tooltip appears with description text
   - Each row shows a SourceBadge
5. Verify dirty state:
   - Change any number input — Save Changes button turns purple, "Unsaved changes" text appears
   - Restore the original value — Save button returns to grey
6. Verify save flow:
   - Change a threshold, click Save — the input value is accepted by the API
   - A green success message appears inline and fades after ~4 seconds
   - Check Network tab: GET /api/admin/settings reflects the new value after save
7. Verify error handling (optional): send an out-of-range value (e.g., similarity_threshold = 99) and confirm a red error message appears and fades
  </how-to-verify>
  <verify>Human confirms all steps above pass visually and functionally.</verify>
  <done>Admin can view live flag state, flip toggles, edit thresholds, see dirty indicator, save changes, and see inline confirmation — all without page reload.</done>
  <resume-signal>Type "approved" if all checks pass, or describe which step failed</resume-signal>
</task>

</tasks>

<verification>
After human approval:
- `npm run build` exits 0
- IntelligenceDashboardPage.tsx uses useAdminSettings and adminPost
- Toggle and threshold controls reflect live API state
- Dirty tracking and 4-second fade confirmed by human
</verification>

<success_criteria>
1. Admin opens Intelligence tab — sees two labeled toggle switches reflecting live DB/env state (PANEL-01)
2. Admin flips toggle — UI calls POST /api/admin/settings and updates without page reload (PANEL-02)
3. Admin sees three pre-filled numeric inputs for all three thresholds (PANEL-03)
4. Admin saves threshold changes — inline confirmation appears/fades, GET /api/admin/settings reflects new value (PANEL-04)
</success_criteria>

<output>
After completion, create `.planning/phases/12-steering-panel-frontend/12-02-SUMMARY.md`
</output>
