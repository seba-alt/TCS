---
phase: 50.1-lead-click-tracking-data-reset-search-visibility
plan: 02
type: execute
wave: 2
depends_on:
  - 50.1-01
files_modified:
  - frontend/src/admin/pages/LeadsPage.tsx
  - frontend/src/admin/pages/ExpertsPage.tsx
  - frontend/src/admin/hooks/useAdminData.ts
  - app/routers/admin.py
  - frontend/src/admin/pages/AdminMarketplacePage.tsx
  - frontend/src/components/Header.tsx
  - frontend/src/admin/types.ts
autonomous: true
requirements:
  - 50.1-LEAD-TRACK
  - 50.1-SEARCH-BAR
  - 50.1-ADMIN-NAMES

must_haves:
  truths:
    - "Admin Leads tab shows click history per lead (expert name + timestamp + search query) in expanded row"
    - "Admin Experts page shows which leads clicked on each expert via expandable row"
    - "AdminMarketplacePage exposure table shows expert full name instead of username"
    - "Search bar has a visually prominent border that pops out on the page"
    - "Expert names are displayed as 'First Last' everywhere in admin (no raw usernames)"
  artifacts:
    - path: "frontend/src/admin/pages/LeadsPage.tsx"
      provides: "Click history section in expanded lead row"
      contains: "lead-clicks"
    - path: "frontend/src/admin/pages/ExpertsPage.tsx"
      provides: "Lead click panel in expandable expert row"
      contains: "lead-clicks"
    - path: "frontend/src/admin/pages/AdminMarketplacePage.tsx"
      provides: "Expert full name display in exposure table"
      contains: "expert_name"
    - path: "frontend/src/components/Header.tsx"
      provides: "Prominent search bar border"
      contains: "border-2"
    - path: "app/routers/admin.py"
      provides: "expert_name enrichment in exposure endpoint"
      contains: "expert_name"
  key_links:
    - from: "frontend/src/admin/pages/LeadsPage.tsx"
      to: "/api/admin/lead-clicks"
      via: "adminFetch on row expand"
      pattern: "adminFetch.*lead-clicks"
    - from: "frontend/src/admin/pages/ExpertsPage.tsx"
      to: "/api/admin/lead-clicks/by-expert"
      via: "adminFetch on row expand"
      pattern: "lead-clicks/by-expert"
    - from: "frontend/src/admin/pages/AdminMarketplacePage.tsx"
      to: "ExposureRow.expert_name"
      via: "Display expert_name with fallback to expert_id"
      pattern: "expert_name.*expert_id"
---

<objective>
Build the admin UI views for lead click data, fix expert name display in the marketplace admin page, and make the search bar more visually prominent.

Purpose: Give admins visibility into lead-expert click attribution, ensure full names appear everywhere in admin (no raw usernames), and make the search input easier to spot for public users.

Output: Lead click history in Leads tab expanded rows, lead click panel in Experts page, expert_name in exposure table, prominent search bar border.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/milestones/v4.0-phases/50.1-lead-click-tracking-data-reset-search-visibility/50.1-CONTEXT.md
@.planning/milestones/v4.0-phases/50.1-lead-click-tracking-data-reset-search-visibility/50.1-RESEARCH.md
@.planning/milestones/v4.0-phases/50.1-lead-click-tracking-data-reset-search-visibility/50.1-01-SUMMARY.md
@frontend/src/admin/pages/LeadsPage.tsx
@frontend/src/admin/pages/ExpertsPage.tsx
@frontend/src/admin/pages/AdminMarketplacePage.tsx
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/types.ts
@frontend/src/components/Header.tsx
@app/routers/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lead click history to Leads tab + lead click panel to Experts page</name>
  <files>frontend/src/admin/pages/LeadsPage.tsx, frontend/src/admin/pages/ExpertsPage.tsx, frontend/src/admin/hooks/useAdminData.ts, frontend/src/admin/types.ts</files>
  <action>
**1. Extend LeadsPage.tsx expanded row with click history:**

The expanded row in LeadsPage.tsx (around lines 241-262) currently shows "Recent queries". Add a second section below it: "Expert Clicks".

Implementation approach:
- When a lead row is expanded, also fetch `/api/admin/lead-clicks` (the full grouped-by-email response) — or better, fetch it once on page load and filter by email client-side (simpler, and the dataset is small at launch scale).
- Alternative (preferred): Lazily fetch click data on expand. Use the `LeadClicksResponse` type from 50.1-01.
- Show each click as: expert full name, search query (as a pill/tag), timestamp (use the existing `timeAgo` pattern from OverviewPage.tsx).
- If no clicks for this lead, show "No expert clicks recorded" in muted text.
- Order: newest first.
- Use `adminFetch` from `useAdminData.ts` for the API call.

```tsx
// In the expanded row section, after the existing "Recent queries" block:
// Fetch lead clicks lazily on expand:
const [leadClicks, setLeadClicks] = useState<Record<string, LeadClickEntry[]>>({})

// When row expands:
if (!leadClicks[lead.email]) {
  const data = await adminFetch<LeadClicksResponse>('/lead-clicks')
  const match = data.leads.find(l => l.email === lead.email)
  setLeadClicks(prev => ({ ...prev, [lead.email]: match?.clicks ?? [] }))
}

// Render section:
<div className="mt-4">
  <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Expert Clicks</h4>
  {clicks.length === 0 ? (
    <p className="text-sm text-gray-400">No expert clicks recorded</p>
  ) : (
    <div className="space-y-2">
      {clicks.map((click, i) => (
        <div key={i} className="flex items-center justify-between text-sm">
          <span className="font-medium">{click.expert_name}</span>
          {click.search_query && (
            <span className="px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-600">{click.search_query}</span>
          )}
          <span className="text-gray-400 text-xs">{timeAgo(click.created_at)}</span>
        </div>
      ))}
    </div>
  )}
</div>
```

Import `LeadClickEntry`, `LeadClicksResponse` from `../types`. Use or create a `timeAgo` helper (check if one already exists in the admin codebase — the OverviewPage has one). If not shared, extract or duplicate the helper.

**2. Add lead click panel to ExpertsPage.tsx:**

Add an expandable row pattern to ExpertsPage.tsx (same pattern as LeadsPage.tsx expanded rows). Each expert row gets an expand toggle that loads `/api/admin/lead-clicks/by-expert/{username}` on demand.

Implementation approach:
- Add `expandedUsername` state: `useState<string | null>(null)`
- Add `clickData` state: `useState<Record<string, LeadClicksByExpertResponse['clicks']>>({})`
- On expand toggle: if already expanded, collapse. Otherwise set expanded and fetch if not cached.
- Show below the expert row: list of leads who clicked, with email + search query + timestamp.
- If no clicks, show "No lead clicks recorded" in muted text.

```tsx
// State
const [expandedUsername, setExpandedUsername] = useState<string | null>(null)
const [clickData, setClickData] = useState<Record<string, {email: string; search_query: string; created_at: string}[]>>({})

// Handler
async function handleExpandExpert(username: string) {
  if (expandedUsername === username) {
    setExpandedUsername(null)
    return
  }
  setExpandedUsername(username)
  if (!clickData[username]) {
    const data = await adminFetch<LeadClicksByExpertResponse>(`/lead-clicks/by-expert/${username}`)
    setClickData(prev => ({ ...prev, [username]: data.clicks }))
  }
}

// In the table body, after each expert row, conditionally render:
{expandedUsername === expert.username && (
  <tr>
    <td colSpan={N} className="px-6 py-4 bg-gray-50">
      <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Lead Clicks</h4>
      {(clickData[expert.username] ?? []).length === 0 ? (
        <p className="text-sm text-gray-400">No lead clicks recorded</p>
      ) : (
        <div className="space-y-2">
          {(clickData[expert.username] ?? []).map((click, i) => (
            <div key={i} className="flex items-center justify-between text-sm">
              <span className="font-medium">{click.email}</span>
              {click.search_query && (
                <span className="px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-600">{click.search_query}</span>
              )}
              <span className="text-gray-400 text-xs">{timeAgo(click.created_at)}</span>
            </div>
          ))}
        </div>
      )}
    </td>
  </tr>
)}
```

Add a small expand/collapse button (chevron icon or "View clicks" text link) to each expert row.

Import `LeadClicksByExpertResponse` from `../types`.

**3. Add adminFetch helper or verify it works for these endpoints:**

Check `useAdminData.ts` — the `adminFetch` function should already handle GET requests with the admin auth header. If it only works as a hook, create a standalone `adminFetch` function that can be called from event handlers (not just from hooks). Follow the existing pattern in OverviewPage.tsx where `adminFetch` is called inside `useEffect`.

Import `LeadClickEntry`, `LeadClicksResponse`, `LeadClicksByExpertResponse` types where needed. Make sure these types were created in Plan 01 in `admin/types.ts`. If additional types are needed for the by-expert response, add them here.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify LeadsPage has "Expert Clicks" section in expanded row, ExpertsPage has expandable row with lead click data</manual>
  </verify>
  <done>LeadsPage expanded row shows click history per lead with expert name + query + timestamp. ExpertsPage has expandable rows showing which leads clicked each expert. Both use lazy-loading (fetch on expand, not on mount).</done>
</task>

<task type="auto">
  <name>Task 2: Enrich exposure endpoint with expert_name + fix AdminMarketplacePage + fix search bar border</name>
  <files>app/routers/admin.py, frontend/src/admin/pages/AdminMarketplacePage.tsx, frontend/src/admin/types.ts, frontend/src/components/Header.tsx</files>
  <action>
**1. Enrich the exposure endpoint in admin.py:**

Find the `get_exposure_data` endpoint (or however the `/api/admin/events/exposure` endpoint is named). It currently returns `ExposureRow` objects with `expert_id` (raw username). Add `expert_name` by batch-looking up the Expert table:

```python
# After the existing query that produces rows:
all_ids = {r.expert_id for r in rows if r.expert_id}
name_map = {
    e.username: f"{e.first_name} {e.last_name}"
    for e in db.scalars(select(Expert).where(Expert.username.in_(all_ids))).all()
} if all_ids else {}

# In the response dict for each row, add:
"expert_name": name_map.get(r.expert_id),  # None if expert deleted
```

Keep `expert_id` in the response — do NOT remove it. Add `expert_name` alongside it.

**2. Update ExposureRow type in frontend/src/admin/types.ts:**

Add `expert_name?: string | null` to the `ExposureRow` interface:

```typescript
export interface ExposureRow {
  expert_id: string
  expert_name?: string | null  // NEW — full "First Last" name
  total_clicks: number
  grid_clicks: number
  sage_clicks: number
}
```

**3. Update AdminMarketplacePage.tsx to display expert_name:**

Find where `row.expert_id` is rendered in the exposure table (around line 390 per research). Replace with:

```tsx
{row.expert_name ?? row.expert_id}
```

This shows the full name when available, falling back to the raw username for deleted experts.

**4. Fix the search bar border in Header.tsx:**

Find the search input className (around line 183 per research). The current border classes are `border border-slate-200`.

Replace with: `border-2 border-slate-300 shadow-sm`

This makes the border thicker (2px vs 1px), darker (slate-300 vs slate-200), and adds a subtle shadow — making it visually prominent without changing the color palette.

Do NOT change focus state classes — the user explicitly said "no focus state changes."

Before:
```
border border-slate-200
```

After:
```
border-2 border-slate-300 shadow-sm
```

Keep all other classes (pl-14, pr-8, py-2.5, rounded-xl, etc.) unchanged.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Check AdminMarketplacePage renders expert_name, Header.tsx has border-2 border-slate-300 shadow-sm on search input</manual>
  </verify>
  <done>Exposure endpoint returns expert_name alongside expert_id. AdminMarketplacePage shows full names in exposure table. Search bar has a prominent border-2 + shadow-sm treatment. No focus state changes made.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. LeadsPage.tsx contains a "Expert Clicks" or "lead-clicks" section in the expanded row
3. ExpertsPage.tsx has expandable rows with lead click data (lazy-loaded per expert)
4. AdminMarketplacePage.tsx renders `expert_name` instead of raw `expert_id`
5. Header.tsx search input has `border-2 border-slate-300 shadow-sm` classes
6. admin.py exposure endpoint includes `expert_name` in response
7. admin/types.ts ExposureRow has `expert_name` field
</verification>

<success_criteria>
- Leads tab expanded row shows click history per lead
- Experts page has expandable rows showing which leads clicked
- Both use lazy-loading (no 530+ API calls on mount)
- Exposure table shows "First Last" names, not raw usernames
- Search bar border is visually prominent (border-2 + shadow)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/milestones/v4.0-phases/50.1-lead-click-tracking-data-reset-search-visibility/50.1-02-SUMMARY.md`
</output>
