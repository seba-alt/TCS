---
phase: 50.1-lead-click-tracking-data-reset-search-visibility
plan: "01"
subsystem: lead-tracking
tags: [analytics, lead-capture, backend, frontend]
dependency_graph:
  requires: []
  provides: [lead-click-tracking, admin-lead-click-endpoints]
  affects: [admin-dashboard, expert-card, data-reset]
tech_stack:
  added: []
  patterns: [fire-and-forget-fetch, sqlalchemy-batch-lookup, zustand-getState]
key_files:
  created: []
  modified:
    - app/models.py
    - app/routers/admin.py
    - frontend/src/components/marketplace/ExpertCard.tsx
    - frontend/src/admin/types.ts
decisions:
  - "Public lead-click endpoint mounted on auth_router at /api/admin/lead-clicks (no auth required)"
  - "Used useNltrStore.getState() (static access) not the hook — same pattern as useExplorerStore.getState()"
  - "Lead-click fires on both desktop path and mobile second-tap path for complete coverage"
metrics:
  duration_seconds: 116
  completed_date: "2026-02-27"
  tasks_completed: 2
  tasks_total: 2
  files_modified: 4
---

# Phase 50.1 Plan 01: Lead Click Tracking Summary

**One-liner:** Full lead-click pipeline — LeadClick DB model, public capture endpoint at `/api/admin/lead-clicks`, admin query endpoints grouped by email/expert, and conditional frontend capture in ExpertCard for email-identified users.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Add LeadClick model + public capture endpoint + admin query endpoints | eb35d7d | app/models.py, app/routers/admin.py |
| 2 | Add frontend lead-click capture in ExpertCard + TypeScript types | c7d7d3e | frontend/src/components/marketplace/ExpertCard.tsx, frontend/src/admin/types.ts |

## What Was Built

### Backend (Task 1)

**LeadClick model** added to `app/models.py` after `UserEvent`:
- Table: `lead_clicks`
- Fields: `id`, `email` (indexed), `expert_username` (indexed), `search_query` (Text, nullable), `created_at`
- Auto-created at startup by `Base.metadata.create_all()` — no migration needed

**Public endpoint** `POST /api/admin/lead-clicks` (on `auth_router`, no auth required):
- Accepts `LeadClickRequest`: `email`, `expert_username`, `search_query`
- Returns `{"status": "accepted"}` with HTTP 202
- Fire-and-forget from frontend

**Admin endpoints** (on `router`, JWT required):
- `GET /api/admin/lead-clicks` — all clicks grouped by email, batch-resolves expert full names via single query (no N+1)
- `GET /api/admin/lead-clicks/by-expert/{username}` — clicks for one expert, newest-first

**Reset data** updated: `LeadClick` added to the wipe list in `POST /api/admin/reset-data`

### Frontend (Task 2)

**ExpertCard.tsx** updated:
- Imports `useNltrStore` from `../../store/nltrStore`
- `_fireLeadClick(searchQuery)` helper: reads `useNltrStore.getState().email` (static, no hook), fires `POST /api/admin/lead-clicks` with `keepalive: true` if email is set
- Called after `trackEvent` on both the desktop direct-click path and mobile second-tap path
- Anonymous users (email null) produce no lead-click traffic

**admin/types.ts** extended with:
- `LeadClickEntry` — single click row with expert_username, expert_name, search_query, created_at
- `LeadClicksByEmail` — email + clicks array
- `LeadClicksResponse` — grouped by email response shape
- `LeadClicksByExpertResponse` — by-expert response shape

## Decisions Made

1. **Public endpoint on `auth_router`** — mounted at `/api/admin/lead-clicks` because `auth_router` uses prefix `/api/admin` with no auth dependency. This matches the requirement for a public fire-and-forget endpoint without needing a separate router.

2. **`useNltrStore.getState()` pattern** — uses static Zustand access (not the hook) consistent with `useExplorerStore.getState()` already used in the same file. Correct for non-reactive reads inside event handlers.

3. **`_fireLeadClick` called on both desktop and mobile paths** — ensures complete coverage regardless of device. Both paths read `storeState.query` from `useExplorerStore.getState()` which is the active search query at click time.

## Deviations from Plan

None — plan executed exactly as written.

## Verification Results

1. `python3 -c "from app.models import LeadClick; print(LeadClick.__tablename__)"` → `lead_clicks` ✓
2. `cd frontend && npx tsc --noEmit` → no errors ✓
3. ExpertCard.tsx contains `useNltrStore.getState().email` and conditional fetch to `/api/admin/lead-clicks` ✓
4. admin.py contains `record_lead_click`, `get_lead_clicks`, `get_lead_clicks_by_expert` functions ✓
5. admin.py `reset_data` includes `LeadClick` in wipe list ✓
6. admin/types.ts contains `LeadClickEntry`, `LeadClicksResponse`, `LeadClicksByExpertResponse` ✓

## Self-Check: PASSED
