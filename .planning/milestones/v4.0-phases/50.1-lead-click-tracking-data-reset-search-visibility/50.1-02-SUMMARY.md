---
phase: 50.1-lead-click-tracking-data-reset-search-visibility
plan: "02"
subsystem: admin-ui
tags: [admin, lead-clicks, marketplace, search-bar, ux]
dependency_graph:
  requires: [50.1-01]
  provides: [lead-click-ui, expert-name-display, prominent-search-bar]
  affects: [LeadsPage, ExpertsPage, AdminMarketplacePage, Header]
tech_stack:
  added: []
  patterns: [lazy-fetch-on-expand, client-side-click-cache, batch-name-lookup]
key_files:
  created: []
  modified:
    - frontend/src/admin/pages/LeadsPage.tsx
    - frontend/src/admin/pages/ExpertsPage.tsx
    - frontend/src/admin/pages/AdminMarketplacePage.tsx
    - frontend/src/admin/types.ts
    - frontend/src/components/Header.tsx
    - app/routers/admin.py
decisions:
  - Lazy-load lead clicks on row expand with client-side cache (email/username -> clicks[]) to avoid fetching on mount
  - Inline timeAgo helper in both LeadsPage and ExpertsPage (no shared utility file needed at this scale)
  - expert_name field added alongside expert_id in exposure response (backwards-compatible, no breaking change)
  - border-2 border-slate-300 shadow-sm replaces border border-slate-200 on search input (no focus state changes per user requirement)
metrics:
  duration: "~4 minutes"
  completed: "2026-02-27"
  tasks_completed: 2
  files_modified: 6
---

# Phase 50.1 Plan 02: Admin UI Lead Click Views + Search Bar Visibility Summary

**One-liner:** Admin UI for lead click attribution (lazy-loaded per-email and per-expert), expert full names in exposure table, and a visually prominent search bar border.

## Tasks Completed

### Task 1: Lead click history in Leads tab + lead click panel in Experts page

**LeadsPage.tsx:**
- Added `leadClicks` state (Record<email, LeadClickEntry[]>) and `clicksLoading` state for per-row loading indicators
- `handleRowExpand` handler: toggles expanded row, lazy-fetches `/api/admin/lead-clicks` on first expand, client-side filters by email, caches result
- Expanded row now shows two sections: "Recent queries" (existing) and "Expert Clicks" (new) with expert name, search query pill, and `timeAgo` timestamp
- "No expert clicks recorded" shown in muted text when empty
- Clicks ordered newest-first (API returns desc order)

**ExpertsPage.tsx:**
- Added `expandedUsername` state and `clickData` cache (Record<username, clicks[]>)
- Chevron expand button added as first column in expert table header and rows
- `handleExpandExpert` handler: toggles expanded row, lazy-fetches `/api/admin/lead-clicks/by-expert/{username}` on first expand, caches result
- Expanded row shows "Lead Clicks" panel with email, search query pill, and `timeAgo` timestamp
- "No lead clicks recorded" shown when empty
- colSpan increased from 6 to 7 to account for new expand column

**Commits:** ff092d3

### Task 2: Enrich exposure endpoint + fix AdminMarketplacePage + fix search bar border

**app/routers/admin.py:**
- `get_exposure` endpoint: after SQL aggregation, batch-lookups all expert usernames in a single `select(Expert).where(Expert.username.in_(all_ids))` query, builds `name_map {username: "First Last"}`, adds `expert_name` field to each row in the response

**frontend/src/admin/types.ts:**
- Added `expert_name?: string | null` to `ExposureRow` interface (alongside existing `expert_id`)

**frontend/src/admin/pages/AdminMarketplacePage.tsx:**
- Column header changed from "Expert ID" to "Expert"
- Cell renders `{row.expert_name ?? row.expert_id}` — shows full name when available, falls back to raw username for deleted experts

**frontend/src/components/Header.tsx:**
- Search input className: replaced `border border-slate-200` with `border-2 border-slate-300 shadow-sm`
- No focus state changes made (per user requirement)

**Commits:** 7cd244d

## Verification

1. `cd frontend && npx tsc --noEmit` — PASSED (no errors)
2. LeadsPage.tsx contains "Expert Clicks" section and `/lead-clicks` fetch — CONFIRMED
3. ExpertsPage.tsx has expandable rows with `/lead-clicks/by-expert/{username}` lazy-load — CONFIRMED
4. AdminMarketplacePage.tsx renders `expert_name ?? expert_id` — CONFIRMED (line 390)
5. Header.tsx search input has `border-2 border-slate-300 shadow-sm` — CONFIRMED (line 183)
6. admin.py exposure endpoint includes `expert_name` in response — CONFIRMED (line 1805)
7. admin/types.ts ExposureRow has `expert_name` field — CONFIRMED

## Deviations from Plan

None - plan executed exactly as written.

## Self-Check: PASSED

Files confirmed:
- frontend/src/admin/pages/LeadsPage.tsx — EXISTS
- frontend/src/admin/pages/ExpertsPage.tsx — EXISTS
- frontend/src/admin/pages/AdminMarketplacePage.tsx — EXISTS
- frontend/src/admin/types.ts — EXISTS
- frontend/src/components/Header.tsx — EXISTS
- app/routers/admin.py — EXISTS

Commits confirmed:
- ff092d3 — feat(50.1-02): add lead click history to Leads tab and expert click panel to Experts page
- 7cd244d — feat(50.1-02): enrich exposure endpoint with expert_name, fix admin names, make search bar border prominent
