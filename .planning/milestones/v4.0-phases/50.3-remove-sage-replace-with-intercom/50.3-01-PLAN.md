---
phase: 50.3-remove-sage-replace-with-intercom
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/pilot.py
  - app/services/pilot_service.py
  - app/main.py
  - app/routers/admin.py
autonomous: true
requirements:
  - SAGE-REMOVE

must_haves:
  truths:
    - "Backend pilot endpoint /api/pilot no longer responds (404)"
    - "Admin intelligence endpoints (/intelligence, /intelligence-stats, /embedding-map, /events/trend, /export/demand.csv) no longer respond (404)"
    - "Backend starts without errors after pilot removal"
    - "Existing admin endpoints (events/demand, events/exposure, analytics-summary, search, gaps, etc.) still function"
  artifacts:
    - path: "app/main.py"
      provides: "FastAPI app without pilot router"
      contains: "No pilot import or include_router"
    - path: "app/routers/admin.py"
      provides: "Admin router without Sage-specific endpoints"
      contains: "No intelligence_stats, intelligence, embedding_map, trend, or demand.csv endpoint functions"
  key_links:
    - from: "app/main.py"
      to: "app/routers/admin.py"
      via: "include_router"
      pattern: "include_router.*admin"
---

<objective>
Remove all Sage-related backend code: delete the pilot router and service, remove pilot inclusion from main.py, and strip intelligence/embedding/trend endpoints from admin.py.

Purpose: Eliminate the Sage conversational AI backend layer while preserving FAISS-powered marketplace search and all non-Sage admin analytics.
Output: Clean backend with no pilot or Sage intelligence endpoints, all other endpoints intact.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-CONTEXT.md
@.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-RESEARCH.md
@app/main.py
@app/routers/admin.py
@app/routers/pilot.py
@app/services/pilot_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete pilot backend files and clean main.py</name>
  <files>app/routers/pilot.py, app/services/pilot_service.py, app/main.py</files>
  <action>
1. Delete `app/routers/pilot.py` entirely (the /api/pilot endpoint).
2. Delete `app/services/pilot_service.py` entirely (Gemini function calling logic for Sage).
3. Edit `app/main.py`:
   - Remove the `from app.routers import pilot` import (or however pilot is imported).
   - Remove the `app.include_router(pilot.router, ...)` line.
   - Leave all other router inclusions intact (admin, chat, auth_router, etc.).
4. Do NOT touch `app/routers/chat.py` or `app/services/llm.py` — those serve the legacy chat flow, not Sage.
5. Do NOT remove the `Conversation` model from `app/models.py` — it backs admin analytics.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.main import app; print('Backend imports OK')" && grep -c "pilot" app/main.py | xargs test 0 -eq && echo "No pilot references in main.py"</automated>
    <manual>Verify app/routers/pilot.py and app/services/pilot_service.py are deleted</manual>
  </verify>
  <done>pilot.py and pilot_service.py deleted. main.py has zero references to pilot router. Backend imports cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Remove Sage-specific admin endpoints from admin.py</name>
  <files>app/routers/admin.py</files>
  <action>
1. Open `app/routers/admin.py` and remove these endpoint functions entirely:
   - `get_intelligence_stats()` — the `/intelligence-stats` endpoint
   - `get_intelligence_metrics()` — the `/intelligence` endpoint
   - `get_embedding_map()` — the `/embedding-map` endpoint
   - `get_trend()` — the `/events/trend` endpoint (queries sage_query events for sparkline)
   - `export_demand_csv()` — the `/export/demand.csv` endpoint (queries sage_query events)
2. Remove any imports that become unused after deleting those endpoints (e.g., numpy, FAISS references if only used by embedding-map, any Gemini/LLM imports used only by intelligence endpoints).
3. KEEP these endpoints (they are NOT Sage-specific):
   - `/events/demand` — used by AdminMarketplacePage
   - `/events/exposure` — used by AdminMarketplacePage
   - `/analytics-summary` — used by OverviewPage (added in phase 50.2)
   - `/search` (conversations search) — used by SearchesPage
   - `/gaps` — used by GapsPage
   - `/export/leads.csv` — used by admin export
   - All expert CRUD endpoints
   - All auth endpoints
4. After removing endpoint functions, verify no dangling helper functions exist that were only used by the removed endpoints.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.admin import router; print('Admin router imports OK')" && ! grep -q "intelligence_stats\|intelligence_metrics\|embedding_map\|get_trend\|export_demand_csv" app/routers/admin.py && echo "Sage endpoints removed"</automated>
    <manual>Confirm /events/demand and /events/exposure endpoints still present in admin.py</manual>
  </verify>
  <done>Five Sage-specific admin endpoints removed. All non-Sage admin endpoints remain functional. No unused imports or helper functions left behind.</done>
</task>

</tasks>

<verification>
1. Backend starts without import errors: `python -c "from app.main import app; print('OK')"`
2. `pilot.py` and `pilot_service.py` no longer exist on disk
3. `grep -r "pilot" app/main.py` returns zero matches
4. `grep -c "intelligence\|embedding_map\|get_trend\|export_demand" app/routers/admin.py` returns zero (only admin endpoints that don't reference these Sage patterns remain)
5. `grep -c "events/demand\|events/exposure\|analytics-summary" app/routers/admin.py` returns >0 (these endpoints preserved)
</verification>

<success_criteria>
- Backend starts without errors after all Sage removals
- No /api/pilot route exists
- No /api/admin/intelligence, /intelligence-stats, /embedding-map, /events/trend, /export/demand.csv routes exist
- All other admin endpoints (/events/demand, /events/exposure, /analytics-summary, /search, /gaps, /export/leads.csv, expert CRUD) still present and functional
</success_criteria>

<output>
After completion, create `.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-01-SUMMARY.md`
</output>
