---
phase: 50.3-remove-sage-replace-with-intercom
plan: 01
subsystem: api
tags: [fastapi, sage, pilot, tsne, faiss, admin]

# Dependency graph
requires:
  - phase: 50.2-fix-search-tracking-analytics-admin
    provides: analytics-summary endpoint that we preserve intact
provides:
  - Clean backend with no /api/pilot route
  - admin.py without intelligence-stats, intelligence, embedding-map, events/trend, export/demand.csv endpoints
  - main.py without tsne background task and numpy dependency
affects:
  - 50.3-02 (frontend Sage removal — these backend endpoints are now gone)
  - 50.3-03 (Intercom integration — clean slate)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Delete-then-clean: remove files first, then strip all import/include_router references"
    - "Cascade cleanup: when removing a feature endpoint, also remove its supporting startup infrastructure (tsne background task)"

key-files:
  created: []
  modified:
    - app/main.py
    - app/routers/admin.py
  deleted:
    - app/routers/pilot.py
    - app/services/pilot_service.py

key-decisions:
  - "Also cleaned tsne background task from main.py (dead code once embedding-map removed)"
  - "Removed asyncio and numpy imports from main.py — both were only used by _compute_tsne_background"
  - "Removed tsne_cache/tsne_ready/embedding_map state initialization from lifespan (no consumers)"

patterns-established:
  - "When removing admin feature endpoint: also remove its app.state infrastructure in main.py"

requirements-completed:
  - SAGE-REMOVE

# Metrics
duration: 4min
completed: 2026-03-02
---

# Phase 50.3 Plan 01: Remove Sage Backend Summary

**Deleted Sage pilot router and service, stripped 5 Sage-specific admin endpoints, and removed tsne/embedding-map infrastructure from FastAPI startup**

## Performance

- **Duration:** 4 min
- **Started:** 2026-03-02T13:22:07Z
- **Completed:** 2026-03-02T13:25:54Z
- **Tasks:** 2
- **Files modified:** 2 (modified) + 2 (deleted)

## Accomplishments
- Deleted `app/routers/pilot.py` (POST /api/pilot Sage co-pilot endpoint) and `app/services/pilot_service.py` (Gemini function-calling proxy)
- Removed pilot import and `include_router` from `app/main.py`
- Removed 5 Sage-specific admin endpoints: `/intelligence-stats`, `/intelligence`, `/embedding-map`, `/events/trend`, `/export/demand.csv`
- Cleaned up dead tsne infrastructure from `main.py`: `_compute_tsne_background` function, tsne state initialization, `asyncio.create_task` call, `asyncio` and `numpy` imports
- All preserved admin endpoints (events/demand, events/exposure, analytics-summary, searches, gaps, experts CRUD, exports) remain functional

## Task Commits

Each task was committed atomically:

1. **Task 1: Delete pilot backend files and clean main.py** - `1144d0b` (feat)
2. **Task 2: Remove Sage-specific admin endpoints from admin.py** - `9b79db9` (feat)

**Plan metadata:** (docs commit below)

## Files Created/Modified
- `app/main.py` - Removed pilot import/router, removed `_compute_tsne_background`, removed tsne state, removed asyncio+numpy imports
- `app/routers/admin.py` - Removed 5 Sage endpoints, removed `JSONResponse` import, removed tsne_cache invalidation from ingest job
- `app/routers/pilot.py` - DELETED
- `app/services/pilot_service.py` - DELETED

## Decisions Made
- Cleaned up tsne background task and state initialization from `main.py` as a deviation Rule 2 auto-fix (dead code with no consumer once embedding-map was removed)
- Removed `asyncio` and `numpy` imports from `main.py` since both were exclusively used by the now-deleted `_compute_tsne_background` function
- Kept `faiss` import in `admin.py` — still used by `_run_ingest_job` and the `/compare` endpoint

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Cleaned up tsne background task and dead state from main.py**
- **Found during:** Task 2 (Remove admin endpoints)
- **Issue:** After removing `/embedding-map` endpoint, the `_compute_tsne_background` function, three `app.state` tsne assignments, the `asyncio.create_task` call, and `asyncio`/`numpy` imports all became unreachable dead code in `main.py`. Leaving them would waste startup CPU time (t-SNE is expensive) and maintain misleading code.
- **Fix:** Deleted `_compute_tsne_background`, removed tsne state initialization lines, removed the `asyncio.create_task` call, removed `import asyncio` and `import numpy as np`
- **Files modified:** `app/main.py`
- **Verification:** `python3 -c "from app.main import app; print('Backend imports OK')"` passes
- **Committed in:** `9b79db9` (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 2 - dead code removal)
**Impact on plan:** Essential cleanup — t-SNE runs on every startup and is computationally expensive (PCA + TSNE on 530+ vectors). Removing it saves meaningful startup time. No scope creep.

## Issues Encountered
None - both tasks executed cleanly. Backend imports OK after all changes.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Backend is clean: no /api/pilot, no Sage admin endpoints, no tsne computation at startup
- Ready for Phase 50.3-02: frontend Sage removal (SagePanel, pilot API calls, admin IntelligenceDashboardPage)
- Ready for Phase 50.3-03: Intercom integration

---
*Phase: 50.3-remove-sage-replace-with-intercom*
*Completed: 2026-03-02*
