---
phase: 50.3-remove-sage-replace-with-intercom
plan: 03
type: execute
wave: 2
depends_on:
  - "50.3-02"
files_modified:
  - frontend/src/main.tsx
  - frontend/src/layouts/RootLayout.tsx
  - frontend/src/components/IntercomIdentity.tsx
  - frontend/package.json
  - frontend/package-lock.json
  - frontend/.env.example
autonomous: true
requirements:
  - SAGE-REMOVE

must_haves:
  truths:
    - "Intercom floating bubble appears on public pages (marketplace)"
    - "Intercom bubble does NOT appear on admin pages"
    - "User email from email gate is passed to Intercom when available"
    - "Anonymous users see Intercom bubble without errors"
    - "vaul dependency is removed from package.json"
    - "Frontend builds and runs with Intercom provider"
  artifacts:
    - path: "frontend/src/main.tsx"
      provides: "Router with IntercomProvider wrapping public routes only"
      contains: "IntercomProvider"
    - path: "frontend/src/components/IntercomIdentity.tsx"
      provides: "Side-effect component that passes user email to Intercom"
      contains: "useIntercom"
    - path: "frontend/package.json"
      provides: "Dependencies with react-use-intercom, without vaul"
      contains: "react-use-intercom"
    - path: "frontend/.env.example"
      provides: "Environment variable documentation including Intercom app ID"
      contains: "VITE_INTERCOM_APP_ID"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "react-use-intercom"
      via: "IntercomProvider wrapping RootLayout"
      pattern: "IntercomProvider.*appId"
    - from: "frontend/src/components/IntercomIdentity.tsx"
      to: "frontend/src/store/nltrStore.ts"
      via: "useNltrStore email selector"
      pattern: "useNltrStore.*email"
    - from: "frontend/src/components/IntercomIdentity.tsx"
      to: "react-use-intercom"
      via: "useIntercom().update()"
      pattern: "update.*email"
---

<objective>
Add Intercom as the user-facing support channel: install react-use-intercom, wrap public routes with IntercomProvider, create IntercomIdentity component for email passing, and remove the now-unused vaul dependency.

Purpose: Replace Sage's chat support with Intercom's floating widget on all public pages, with user email identity linking.
Output: Working Intercom integration on public pages, vaul cleaned up, .env.example updated.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-CONTEXT.md
@.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-RESEARCH.md
@.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-02-SUMMARY.md
@frontend/src/main.tsx
@frontend/src/layouts/RootLayout.tsx
@frontend/src/store/nltrStore.ts
@frontend/package.json
@frontend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-use-intercom, uninstall vaul, add IntercomProvider</name>
  <files>frontend/package.json, frontend/package-lock.json, frontend/src/main.tsx, frontend/.env.example</files>
  <action>
**Step 1: Install and uninstall packages**
From the `frontend/` directory:
```bash
npm install react-use-intercom
npm uninstall vaul
```

Before uninstalling vaul, verify it has no remaining consumers: `grep -r "vaul" frontend/src/`. After Plan 02 deleted SageMobileSheet.tsx, there should be zero consumers. If any consumer remains, do NOT uninstall — leave it and note in the summary.

**Step 2: Add IntercomProvider to main.tsx**
In `frontend/src/main.tsx`, wrap ONLY the public route's `RootLayout` element with `IntercomProvider`:

```tsx
import { IntercomProvider } from 'react-use-intercom'

const INTERCOM_APP_ID = import.meta.env.VITE_INTERCOM_APP_ID ?? 'o9v3tocw'

// In the createBrowserRouter config, find the RootLayout element entry and wrap it:
{
  element: (
    <IntercomProvider appId={INTERCOM_APP_ID} autoBoot>
      <RootLayout />
    </IntercomProvider>
  ),
  children: [/* existing public route children */]
}
```

- `autoBoot` launches the floating bubble immediately — no manual `boot()` call needed.
- Do NOT wrap admin routes (`/admin/*`) with IntercomProvider — admin pages must NOT get the Intercom bubble.
- The Intercom app ID is `o9v3tocw` per user decision. It falls back to the hardcoded value if the env var is not set.

**Step 3: Update .env.example**
Add `VITE_INTERCOM_APP_ID=o9v3tocw` to `frontend/.env.example` so future developers know about the env var.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && grep -q "react-use-intercom" package.json && ! grep -q "vaul" package.json && grep -q "IntercomProvider" src/main.tsx && grep -q "VITE_INTERCOM_APP_ID" .env.example && echo "All checks passed"</automated>
    <manual>Verify IntercomProvider wraps only the public route element, not the admin route element</manual>
  </verify>
  <done>react-use-intercom installed, vaul uninstalled, IntercomProvider wraps public routes only in main.tsx, .env.example has VITE_INTERCOM_APP_ID.</done>
</task>

<task type="auto">
  <name>Task 2: Create IntercomIdentity component and wire into RootLayout</name>
  <files>frontend/src/components/IntercomIdentity.tsx, frontend/src/layouts/RootLayout.tsx</files>
  <action>
**Step 1: Create IntercomIdentity.tsx**
Create `frontend/src/components/IntercomIdentity.tsx`:

```tsx
import { useEffect } from 'react'
import { useIntercom } from 'react-use-intercom'
import { useNltrStore } from '../store/nltrStore'

export function IntercomIdentity() {
  const { update } = useIntercom()
  const email = useNltrStore((s) => s.email)

  useEffect(() => {
    if (email) {
      update({ email })
    }
  }, [email, update])

  return null  // side-effect only, renders nothing
}
```

This component:
- Reads the user's email from `useNltrStore` (populated after the email gate).
- Calls `update({ email })` to link the Intercom conversation to the user's email identity.
- Returns null — it's a pure side-effect component.
- Falls back gracefully: if no email is available, `update` is never called and the user chats anonymously.

**Step 2: Add IntercomIdentity to RootLayout.tsx**
In `frontend/src/layouts/RootLayout.tsx`, import and render `<IntercomIdentity />` inside the layout (it renders nothing visible):

```tsx
import { IntercomIdentity } from '../components/IntercomIdentity'

// Inside the RootLayout component's JSX, add:
<IntercomIdentity />
```

Place it anywhere in the JSX — it renders null so position doesn't matter. Putting it at the top of the returned JSX or inside a fragment is fine.

**Step 3: Verify the full build**
Run `npx tsc --noEmit` and `npm run build` from the `frontend/` directory to ensure zero errors and successful production build.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit && npm run build 2>&1 | tail -5</automated>
    <manual>Run `npm run dev` and verify: (1) Intercom bubble appears on the marketplace page, (2) No Intercom bubble on /admin pages, (3) After entering email in email gate, Intercom updates with user identity</manual>
  </verify>
  <done>IntercomIdentity component created and rendered in RootLayout. Email from email gate is passed to Intercom. Frontend builds cleanly with zero TypeScript errors. Production build succeeds.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds from `frontend/` directory — production build clean
2. `npx tsc --noEmit` passes — zero TypeScript errors
3. `grep -q "react-use-intercom" frontend/package.json` — package installed
4. `grep -q "vaul" frontend/package.json` returns no match — package removed
5. `grep -q "IntercomProvider" frontend/src/main.tsx` — provider present
6. `grep -q "IntercomIdentity" frontend/src/layouts/RootLayout.tsx` — identity component wired
7. `grep -q "VITE_INTERCOM_APP_ID" frontend/.env.example` — env var documented
8. Intercom bubble appears only on public pages, not admin pages (manual verification)
</verification>

<success_criteria>
- Intercom floating bubble renders on all public pages (marketplace, expert profiles)
- Intercom bubble does NOT render on any admin page
- User email is passed to Intercom after email gate completion
- Anonymous users see the bubble without errors
- vaul dependency fully removed from package.json
- react-use-intercom in package.json
- Frontend production build succeeds
- .env.example documents VITE_INTERCOM_APP_ID
</success_criteria>

<output>
After completion, create `.planning/milestones/v4.0-phases/50.3-remove-sage-replace-with-intercom/50.3-03-SUMMARY.md`
</output>
