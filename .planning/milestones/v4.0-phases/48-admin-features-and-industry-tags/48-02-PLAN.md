---
phase: 48-admin-features-and-industry-tags
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - frontend/src/admin/pages/OverviewPage.tsx
  - frontend/src/admin/hooks/useAdminData.ts
autonomous: true
requirements:
  - ADM-01

must_haves:
  truths:
    - "The admin overview page shows Total Leads and Expert Pool stat cards above the existing stats"
    - "Each new stat card displays a 7-day trend indicator (up/down arrow with delta)"
    - "Top Searches card shows the top 3-5 queries by frequency"
    - "Lead Rate card shows a meaningful proxy metric with tooltip explanation"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "Extended /stats endpoint with total_leads, expert_pool, leads_7d, leads_prior_7d"
      contains: "total_leads"
    - path: "frontend/src/admin/pages/OverviewPage.tsx"
      provides: "TrendStatCard component and new stat card row"
      contains: "TrendStatCard"
  key_links:
    - from: "frontend/src/admin/pages/OverviewPage.tsx"
      to: "/api/admin/stats"
      via: "useAdminStats hook"
      pattern: "stats\\.total_leads"
---

<objective>
Add overview stat cards (Total Leads, Expert Pool, Top Searches, Lead Rate) with 7-day trend indicators to the admin overview page.

Purpose: ADM-01 requires a one-snap overview with key stats. The existing overview has search/match/gap KPIs but lacks lead count, expert pool size, and trend data.
Output: Extended backend stats response + new TrendStatCard UI row on OverviewPage.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/routers/admin.py
@frontend/src/admin/pages/OverviewPage.tsx
@frontend/src/admin/hooks/useAdminData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend backend /stats endpoint with lead and expert pool data</name>
  <files>app/routers/admin.py</files>
  <action>
Extend the existing `GET /api/admin/stats` endpoint response to include new fields. Do NOT change or remove any existing response fields — the existing `total_searches`, `match_count`, `match_rate`, `gap_count`, `top_queries`, `top_feedback` must remain untouched.

Add these new fields to the response dict:
1. `total_leads`: `db.scalar(select(func.count(func.distinct(Conversation.email))).select_from(Conversation))` — count of distinct lead emails.
2. `expert_pool`: `db.scalar(select(func.count()).select_from(Expert).where(Expert.first_name != ""))` — count of active experts (non-empty first_name).
3. `leads_7d`: Count of distinct emails with `Conversation.created_at >= (datetime.utcnow() - timedelta(days=7))`.
4. `leads_prior_7d`: Count of distinct emails with `Conversation.created_at` between 8 and 14 days ago (for trend comparison).
5. `expert_pool_7d`: Count of experts added in last 7 days — `Expert.id` in range `(max_id - count_7d, max_id]` or use a created_at if available. If Expert has no timestamp, just set to 0 (no trend for expert pool).
6. `lead_rate`: Compute as `total_leads / max(total_searches, 1)` rounded to 3 decimal places — this is "% of searches made by a named lead." Label guidance for frontend: "Lead Rate" not "Conversion Rate."

Import `func, distinct` from `sqlalchemy` and `timedelta` from `datetime` if not already imported. Use the existing query patterns in the stats endpoint function.

IMPORTANT: Keep the existing response shape intact. Only ADD new keys to the returned dict.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "
import ast, inspect
from app.routers.admin import get_stats
src = inspect.getsource(get_stats)
assert 'total_leads' in src, 'Missing total_leads'
assert 'expert_pool' in src, 'Missing expert_pool'
assert 'leads_7d' in src, 'Missing leads_7d'
print('PASS: stats endpoint extended')
"</automated>
  </verify>
  <done>The /api/admin/stats endpoint returns total_leads, expert_pool, leads_7d, leads_prior_7d, and lead_rate alongside existing fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add TrendStatCard row to admin overview page</name>
  <files>frontend/src/admin/pages/OverviewPage.tsx, frontend/src/admin/hooks/useAdminData.ts</files>
  <action>
**Frontend — `frontend/src/admin/pages/OverviewPage.tsx`:**

1. Create a `TrendStatCard` component (alongside the existing `StatCard`):
   ```
   function TrendStatCard({ label, value, delta, deltaLabel }: {
     label: string; value: number | string; delta: number; deltaLabel: string
   }) {
     const isUp = delta > 0
     return (
       <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5">
         <p className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{label}</p>
         <p className="text-3xl font-bold text-white">{value}</p>
         <div className="flex items-center gap-1 mt-1">
           {delta !== 0 && (
             <span className={`text-xs font-medium ${isUp ? 'text-emerald-400' : 'text-red-400'}`}>
               {isUp ? '\u2191' : '\u2193'} {Math.abs(delta)}
             </span>
           )}
           <span className="text-xs text-slate-500">{deltaLabel}</span>
         </div>
       </div>
     )
   }
   ```

2. Add a new stat card row as Section 0 (ABOVE the existing health strip section) in the `OverviewPage` return JSX. Per user decision: "New stat cards placed in a top row above existing Sage volume stats."
   ```
   {/* Section 0: Key overview stat cards with 7-day trends */}
   <div className="grid grid-cols-2 xl:grid-cols-4 gap-4">
     <TrendStatCard
       label="Total Leads"
       value={stats.total_leads ?? 0}
       delta={(stats.leads_7d ?? 0) - (stats.leads_prior_7d ?? 0)}
       deltaLabel="vs prev 7d"
     />
     <TrendStatCard
       label="Expert Pool"
       value={stats.expert_pool ?? 0}
       delta={stats.expert_pool_7d ?? 0}
       deltaLabel="new this week"
     />
     <TrendStatCard
       label="Top Searches"
       value={stats.top_queries?.slice(0, 3).map(q => q.query).join(', ') || 'None yet'}
       delta={0}
       deltaLabel=""
     />
     <TrendStatCard
       label="Lead Rate"
       value={`${((stats.lead_rate ?? 0) * 100).toFixed(1)}%`}
       delta={0}
       deltaLabel="searches → leads"
     />
   </div>
   ```

3. For "Top Searches" card: since it shows text (not a number), use value as a string. Show top 3 queries joined with commas. If no queries, show "None yet".

4. For "Lead Rate" card: multiply by 100 and format with 1 decimal. Show "searches -> leads" as the delta label (tooltip-style context).

**Frontend — `frontend/src/admin/hooks/useAdminData.ts`:**

If the `AdminStats` type interface exists in this file or in a types file, extend it to include the new fields: `total_leads?: number`, `expert_pool?: number`, `leads_7d?: number`, `leads_prior_7d?: number`, `expert_pool_7d?: number`, `lead_rate?: number`. Use optional fields (`?`) for backwards compatibility — the UI handles missing fields with `?? 0` fallback.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && grep -q "TrendStatCard" frontend/src/admin/pages/OverviewPage.tsx && grep -q "total_leads" frontend/src/admin/pages/OverviewPage.tsx && echo "PASS"</automated>
    <manual>Visit admin overview page and verify 4 new stat cards appear above existing stats: Total Leads, Expert Pool, Top Searches, Lead Rate</manual>
  </verify>
  <done>Admin overview page shows Total Leads, Expert Pool, Top Searches, and Lead Rate stat cards with 7-day trend indicators in a new top row above existing Sage volume stats.</done>
</task>

</tasks>

<verification>
- Backend /stats returns total_leads, expert_pool, leads_7d, leads_prior_7d, lead_rate
- Frontend shows 4 new TrendStatCards above the health strip
- Existing OverviewPage stats remain unchanged
- Trend arrows show green up / red down based on 7-day delta
</verification>

<success_criteria>
The admin overview page shows Total Leads and Expert Pool stat cards with trend indicators alongside existing Sage volume stats, fulfilling ADM-01.
</success_criteria>

<output>
After completion, create `.planning/phases/48-admin-features-and-industry-tags/48-02-SUMMARY.md`
</output>
