---
phase: 48-admin-features-and-industry-tags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - frontend/src/admin/pages/LeadsPage.tsx
autonomous: true
requirements:
  - ADM-02

must_haves:
  truths:
    - "Admin can click an Export CSV button on the Leads page and receive a CSV file download"
    - "The CSV contains one row per lead (distinct email) with timestamped search queries"
    - "The CSV includes a card_clicks_timestamped column (empty with a note about session-to-email mapping limitation)"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "GET /api/admin/export/leads.csv endpoint"
      contains: "export_leads_csv"
    - path: "frontend/src/admin/pages/LeadsPage.tsx"
      provides: "Export CSV button triggering download"
      contains: "downloadLeadsCsv"
  key_links:
    - from: "frontend/src/admin/pages/LeadsPage.tsx"
      to: "/api/admin/export/leads.csv"
      via: "fetch with Bearer token"
      pattern: "api/admin/export/leads\\.csv"
---

<objective>
Add a lead export CSV endpoint and download button so admins can export all lead data with timestamped search queries.

Purpose: ADM-02 requires admins to export leads as CSV including search queries and card clicks. Card clicks lack email linkage (session_id only), so the first implementation exports queries-per-email with a documented limitation note.
Output: Backend endpoint + frontend button delivering a CSV download.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/routers/admin.py
@frontend/src/admin/pages/LeadsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lead export CSV endpoint and frontend download button</name>
  <files>app/routers/admin.py, frontend/src/admin/pages/LeadsPage.tsx</files>
  <action>
**Backend — `app/routers/admin.py`:**

Add a new `GET /api/admin/export/leads.csv` endpoint on the `router` (requires admin auth).

Implementation:
1. Query all `Conversation` rows ordered by `email` then `created_at` ascending.
2. Group by email into a `leads` dict: `{email: {email, queries: [], last_active}}`.
3. For each conversation row, append `"{created_at.isoformat()}|{query}"` to that lead's queries list.
4. Track `last_active` as the latest `created_at` per email.
5. For card clicks: since `user_events.card_click` is keyed by `session_id` (not email), leave the `card_clicks_timestamped` column empty. Add a CSV comment row: `"# Note: Card clicks not included — no session-to-email mapping in current schema (see LEAD-01 for v4.1)"`
6. Build CSV using `io.StringIO` + `csv.writer` (existing pattern from `export_newsletter_csv`).
7. CSV header row: `email, last_active, total_queries, queries_timestamped, card_clicks_timestamped`
8. Format queries as semicolon-separated `timestamp|query` pairs (per user decision: each query/click paired with its timestamp).
9. Add metadata rows at top: `# Export date`, `# Total leads`.
10. Return via `StreamingResponse(iter([buf.getvalue()]), media_type="text/csv")` with `Content-Disposition: attachment; filename=leads-{date}.csv`.

Use the existing `export_newsletter_csv` endpoint as the exact pattern reference — same imports, same structure.

**Frontend — `frontend/src/admin/pages/LeadsPage.tsx`:**

Add a "Export Leads CSV" download button in the page header area (next to the existing title).

Implementation:
1. Add a `downloadLeadsCsv()` function following the exact pattern of the existing `downloadNewsletterCsv()` function already in this file.
2. It should: fetch `/api/admin/export/leads.csv` with Bearer token from `sessionStorage.getItem('admin_token')`, convert response to blob, create an object URL, trigger download with filename `leads-{YYYY-MM-DD}.csv`.
3. Add a button with text "Export CSV" styled consistently with the existing newsletter export button. Place it in the header section of the Leads page alongside the title.
4. Button styling: use `bg-purple-600 hover:bg-purple-500 text-white text-sm px-4 py-2 rounded-lg` (consistent with admin UI pattern).
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python -c "from app.routers.admin import router; routes = [r.path for r in router.routes]; assert '/export/leads.csv' in routes, f'Missing route. Found: {routes}'" && grep -q "downloadLeadsCsv" frontend/src/admin/pages/LeadsPage.tsx && echo "PASS"</automated>
    <manual>Open admin Leads page, click Export CSV, verify CSV downloads with correct columns</manual>
  </verify>
  <done>GET /api/admin/export/leads.csv returns a CSV with one row per distinct email, timestamped queries as semicolon-separated pairs, and a note about card click limitation. Frontend Leads page has an Export CSV button that triggers the download.</done>
</task>

</tasks>

<verification>
- `GET /api/admin/export/leads.csv` endpoint exists and requires admin auth
- CSV contains header: email, last_active, total_queries, queries_timestamped, card_clicks_timestamped
- Frontend LeadsPage has Export CSV button using Bearer token auth
- Download filename follows `leads-YYYY-MM-DD.csv` pattern
</verification>

<success_criteria>
Admin can download a CSV of all leads with timestamped search queries from the Leads page.
</success_criteria>

<output>
After completion, create `.planning/phases/48-admin-features-and-industry-tags/48-01-SUMMARY.md`
</output>
