# Phase 50.2: Fix Search Tracking & Click Analytics Not Showing in Admin — Research

**Researched:** 2026-03-02
**Domain:** Frontend analytics display, backend event tracking, CORS configuration
**Confidence:** HIGH

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- Diagnose and fix why search tracking and click analytics are not visible in the admin overview
- Issue is on production (Vercel frontend + Railway backend)
- Show totals + recent activity on the dashboard
- Total searches counter and total clicks counter
- List of recent searches and recent clicks
- Capture search queries + result counts (what people searched for and how many results they got)
- Add search query logging if it doesn't exist yet (Phase 50.1 focused on lead-click tracking)
- Fix existing click tracking from 50.1
- Verify all tracking end-to-end

### Claude's Discretion
- Expert detail row click data presentation
- Time range filtering approach
- Which click interactions to track beyond card clicks
- Verification approach (user will test manually on production)

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 50.2 addresses a multi-layered problem: the admin overview simply does not display search or click analytics at all, and the underlying event tracking for searches is incomplete. There are three distinct failure modes that together explain why "nothing shows" in the admin overview.

**Failure 1 — OverviewPage has no analytics section:** The admin `OverviewPage.tsx` has no component that renders search query analytics or card click counts from the `user_events` table. The data exists in the backend (via `/api/admin/events/demand`, `/api/admin/events/exposure`, `/api/admin/events/trend`) but `OverviewPage.tsx` only calls `/api/admin/stats` (which reads from `conversations`) and renders leads/searches. The marketplace analytics live on a separate `AdminMarketplacePage.tsx` tab and never surface on the overview.

**Failure 2 — Search query tracking is not captured from the main search bar:** The header search bar (`useHeaderSearch.ts`) only fires `filter_change` events when the user presses Enter or selects a suggestion. These events go to the `user_events` table with `event_type = 'filter_change'` — they are NOT logged as `sage_query` and thus do NOT appear in the demand/trend endpoints. Only Sage queries (`useSage.ts`) are tracked as `sage_query`. The explore API (`/api/explore`) does NOT write to the `user_events` table or `conversations` table — there is zero server-side record of search queries made via the marketplace search bar.

**Failure 3 — CORS likely blocks event tracking in production:** The MEMORY.md notes `ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app` has not been set in Railway. The default value is `http://localhost:5173`, which means all `POST /api/events` and `POST /api/admin/lead-clicks` calls from the Vercel frontend are blocked by CORS — the events never reach the backend. This would explain why both search and click tracking show nothing.

**Primary recommendation:** Fix in three coordinated steps: (1) Fix CORS on Railway to allow the Vercel origin. (2) Add a `search_event` logging endpoint or reuse `user_events` with a new event type to capture explore-bar search queries + result counts server-side (in `/api/explore`). (3) Add a search + click analytics section to OverviewPage that surfaces recent activity and totals from the existing data tables.

---

## Architecture Patterns

### Current Tracking Architecture (What Exists)

```
Frontend action        → Where it goes               → Admin display
─────────────────────────────────────────────────────────────────────
Sage query             → user_events (sage_query)    → AdminMarketplacePage only
Card click (marketplace)→ user_events (card_click)   → AdminMarketplacePage only
Lead-card click        → lead_clicks                 → LeadsPage + ExpertsPage (lazy-load)
Header search Enter    → user_events (filter_change) → NOT displayed anywhere
Email gate chat search → conversations table         → OverviewPage stats, SearchesPage
```

### What the Overview Currently Shows

`OverviewPage.tsx` fetches:
- `GET /api/admin/stats` — reads from `conversations` table (email-gate chat searches only)
- `GET /api/admin/events/demand` (for `TopZeroResultsCard`) — reads `user_events` where `sage_query` + `zero_results=1`
- `GET /api/admin/events/trend` (for `SageSparklineCard`) — reads `user_events` where `sage_query`
- `GET /api/admin/leads` — reads `conversations` grouped by email

**Missing entirely:** total card clicks, recent card clicks, total marketplace search queries, recent search queries.

### Two Parallel "Search" Systems

**System A: Chat/email-gate searches**
- Written to `conversations` table by `/api/chat` and `/api/explore` (explore does NOT write to conversations — see below)
- Displayed via `/api/admin/stats` → `total_searches`, `top_queries`
- Actually, `/api/explore` does NOT write to conversations — this is a critical finding

**System B: Marketplace/Sage events (user_events)**
- Written by `POST /api/events` from frontend (`trackEvent()`)
- Event types: `card_click`, `sage_query`, `filter_change`
- The search bar fires `filter_change` (not a dedicated search event type)
- Displayed via `/api/admin/events/{demand,exposure,trend}` — but ONLY on `AdminMarketplacePage.tsx`

### The search query tracking gap

`useExplore.ts` does NOT call `trackEvent()` at all. The hook calls `/api/explore` and updates Zustand store, but never fires a tracking event. The explore backend (`/api/explore`) does NOT write to `conversations` or `user_events`.

So when a user types in the header search and presses Enter: `useHeaderSearch.ts` fires `filter_change` with `{filter: 'query', value: ...}`, then `useExplore` fetches `/api/explore` and updates the grid. No record exists in any table with the query + result count.

To add search query tracking, the options are:
1. **Frontend approach (simpler):** In `useExplore.ts`, after a successful fetch, fire `trackEvent('filter_change', { filter: 'query', value: query, result_count: total })` — or introduce a new `search` event type in `tracking.ts` + `events.py`.
2. **Backend approach (more complete):** Have `/api/explore` write a record to `user_events` or a new `search_events` table on each call.

Given the user wants "query text + result count" and there's already an `events` system, the cleanest approach is to add a new event type or repurpose `filter_change` to carry `result_count`. However, the event types in `events.py` are a Pydantic `Literal` — adding a new type requires a backend deploy. Alternatively, log it server-side in `explore.py` directly.

**Recommendation:** Log search queries server-side in `/api/explore` into a lightweight mechanism. The simplest path is to write to `user_events` with a new event type `search_query` (add to the Literal), carrying `{query_text, result_count, session_id}`. The session_id must be passed from the frontend as a query param.

### CORS Analysis

**Current state:** `ALLOWED_ORIGINS` defaults to `http://localhost:5173`. In Railway production this must be set to `https://tcs-three-sigma.vercel.app`.

**Impact:** If CORS is blocking, ALL `POST /api/events` calls fail silently (fire-and-forget via `fetch + keepalive: true` — errors are swallowed). All `POST /api/admin/lead-clicks` calls also fail. This would explain why `user_events` and `lead_clicks` tables are empty in production.

**Fix:** Set `ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app` as a Railway environment variable. This requires no code changes — just a Railway dashboard action. It should be verified FIRST before investing time in display fixes.

**Note on CORS verification:** The admin endpoints use `Authorization: Bearer` header. The CORS config currently allows `allow_headers=["Content-Type", "Authorization"]` — so admin calls should work. But `POST /api/events` (event tracking) sends only `Content-Type` and is also affected by the origin allowlist.

---

## Standard Stack

### Core (no changes needed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| FastAPI | 0.129.x | Backend API | Already in use |
| SQLAlchemy | 2.0.x | ORM | Already in use |
| React + Vite | project-standard | Frontend | Already in use |
| Recharts | project-standard | Charts in admin | Already in use (LineChart in OverviewPage) |
| Tailwind CSS | project-standard | Admin UI | Already in use |

### No new dependencies needed
This phase requires no npm or pip additions. Everything needed exists in the current stack.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Charting clicks over time | Custom SVG chart | Recharts (already used) | LineChart already used in OverviewPage for Sage volume sparkline |
| Aggregation queries | Python loops | SQLAlchemy `func.count()` + raw SQL | Backend already does this for exposure/demand |
| Admin data fetching | New fetch wrappers | `adminFetch()` from useAdminData.ts | Already handles auth, 401 redirect |

---

## Common Pitfalls

### Pitfall 1: Fixing the display without fixing CORS first
**What goes wrong:** Spend time building OverviewPage analytics sections, deploy, still empty. CORS was the root cause.
**Why it happens:** CORS failures are silent in `keepalive: true` fetches — no visible console error to the admin viewer.
**How to avoid:** Verify CORS fix FIRST by checking Railway env vars and testing with the browser network tab. Confirm `user_events` table has rows before building display.
**Warning signs:** `lead_clicks` is also empty despite Phase 50.1 being deployed.

### Pitfall 2: Confusing the two search systems
**What goes wrong:** "Adding search tracking" by only displaying `conversations.query` — but this misses explore searches entirely.
**Why it happens:** The `conversations` table records email-gate chat searches, NOT marketplace/explore searches.
**How to avoid:** Understand that `/api/explore` is a stateless search endpoint with no write side effects. Marketplace search queries need a new tracking mechanism.

### Pitfall 3: Adding a new Pydantic Literal without backend deploy
**What goes wrong:** Frontend fires `trackEvent('search_query', ...)` but backend still has old Literal — returns 422 Unprocessable Entity. Events are silently dropped (fire-and-forget).
**Why it happens:** `EVENT_TYPES = Literal["card_click", "sage_query", "filter_change"]` in `events.py` — Pydantic rejects unknown values.
**How to avoid:** Coordinate backend and frontend changes in the same plan. Backend deploys first (Railway auto-deploys on push to main), then frontend.

### Pitfall 4: N+1 on lead clicks overview
**What goes wrong:** Loading recent lead clicks on OverviewPage fetches all clicks then resolves expert names one by one.
**Why it happens:** Naive implementation.
**How to avoid:** The existing `GET /api/admin/lead-clicks` endpoint already does a batch name lookup (see admin.py line 1950-1955). Use it as-is.

### Pitfall 5: OverviewPage loading slowdown
**What goes wrong:** Adding 3-4 new data fetches to OverviewPage causes slow initial render.
**Why it happens:** Each `adminFetch` is sequential by default in React `useEffect`.
**How to avoid:** Use `Promise.all()` for parallel fetches, or add a dedicated `useAnalyticsSummary` hook that batches all overview calls.

### Pitfall 6: Session ID unavailable server-side for explore tracking
**What goes wrong:** Can't track session_id when logging from server-side `/api/explore`.
**Why it happens:** Session ID lives in `localStorage` — only accessible client-side.
**How to avoid:** Pass `session_id` as an optional query param in the explore request, or use a cookie. Simplest: frontend fires the tracking event AFTER the explore response returns (in `useExplore.ts`), carrying `result_count` from the response.

---

## Code Examples

### Pattern: Existing adminFetch usage for overview components
```typescript
// Source: frontend/src/admin/pages/OverviewPage.tsx (existing pattern)
// All new overview components should follow this exact pattern

function RecentClicksCard() {
  const [data, setData] = useState<ExposureResponse | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    adminFetch<ExposureResponse>('/events/exposure', { days: 30 })
      .then(setData)
      .catch(() => setData(null))
      .finally(() => setLoading(false))
  }, [])

  // ... render
}
```

### Pattern: Adding search query tracking in useExplore
```typescript
// Source: frontend/src/hooks/useExplore.ts (modification pattern)
// After setResults(data.experts, data.total, data.cursor):

.then((data) => {
  setResults(data.experts, data.total, data.cursor)
  setLoading(false)
  // Fire search tracking after results arrive (so result_count is known)
  if (query.trim().length > 0) {
    void trackEvent('search_query', {
      query_text: query,
      result_count: data.total ?? 0,
    })
  }
})
```

### Pattern: New event type in events.py
```python
# Source: app/routers/events.py (modification)
EVENT_TYPES = Literal["card_click", "sage_query", "filter_change", "search_query"]
```

### Pattern: Aggregation query for recent clicks (existing pattern)
```python
# Source: app/routers/admin.py, get_exposure() (lines 1771-1812)
# Already exists — returns expert_id, total_clicks, grid_clicks, sage_clicks
# New "recent clicks" endpoint would follow the same raw SQL pattern:

rows = db.execute(_text("""
    SELECT
        json_extract(payload, '$.expert_id') AS expert_id,
        MAX(created_at) AS last_click_at
    FROM user_events
    WHERE event_type = 'card_click'
    GROUP BY json_extract(payload, '$.expert_id')
    ORDER BY last_click_at DESC
    LIMIT :limit
"""), {"limit": 5}).all()
```

### Pattern: OverviewPage summary stats for clicks (new backend endpoint)
The cleanest approach is a new `GET /api/admin/analytics-summary` endpoint that returns everything the OverviewPage needs in one call:
```python
# New endpoint returns:
{
  "total_card_clicks": 42,        # all-time from user_events
  "total_search_queries": 128,    # all-time from user_events (search_query type)
  "recent_searches": [            # last 5 search_query events
    {"query_text": "...", "result_count": 12, "created_at": "..."},
  ],
  "recent_clicks": [              # last 5 card_click events
    {"expert_id": "...", "expert_name": "...", "created_at": "..."},
  ],
}
```
This avoids adding multiple round-trips from the OverviewPage and keeps aggregation logic server-side.

---

## Implementation Plan Recommendation

This phase should be structured as **2-3 focused plans**:

### Plan 1: CORS + Verify (backend env fix — no code changes)
- Set `ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app` in Railway dashboard
- Verify `user_events` table receives events after CORS fix (user tests manually on prod)
- No git changes, just Railway env var update

### Plan 2: Add search query tracking
- Add `search_query` to `EVENT_TYPES` Literal in `events.py` (backend)
- Fire `trackEvent('search_query', { query_text, result_count })` in `useExplore.ts` after successful fetch
- Add a backend summary endpoint (`GET /api/admin/analytics-summary`) that aggregates total clicks, total search queries, recent searches (with result_count), recent clicks (with expert name)
- Add TypeScript types for the new endpoint

### Plan 3: OverviewPage analytics section
- Add two new cards to OverviewPage: "Recent Searches" (showing query + result count + timestamp) and "Recent Card Clicks" (showing expert name + context + timestamp)
- Add total clicks and total search queries counters to the stat cards grid at the top
- Wire to the new `analytics-summary` endpoint

**Note on Plan 1:** CORS fix is technically a Railway env var change, not a code change. It can be done independently and verified before any code is written. The planner should make this the first task.

---

## Open Questions

1. **Is CORS actually the root cause on production?**
   - What we know: `ALLOWED_ORIGINS` is not set in Railway env vars (MEMORY.md pending todo)
   - What's unclear: Whether the Vercel deployment has set it via another mechanism (e.g., Railway config file)
   - Recommendation: Verify by checking Railway dashboard directly, or by the user checking `user_events` table row count via admin. If `user_events` has rows, CORS is fine and the issue is purely display-side.

2. **Does `/api/explore` need to write to conversations?**
   - What we know: Currently no write side effects from explore
   - What's unclear: Whether the user expects explore searches to count in `total_searches` stat card
   - Recommendation: Keep them separate. `total_searches` = email-gate chat sessions. New "total explore searches" = from `user_events` search_query events. Show both on overview with clear labels.

3. **Should search_query events be persisted even with empty queries?**
   - Recommendation: Only track when `query.trim().length > 0`. Filter-only browsing (no query text) is not a "search" for analytics purposes.

---

## Sources

### Primary (HIGH confidence)
- Direct code inspection of all relevant files — codebase read at research time

### Files Verified
- `app/routers/admin.py` — all admin endpoints, confirmed no analytics-summary endpoint exists
- `app/routers/events.py` — EVENT_TYPES Literal, record_event handler
- `app/main.py` — CORS config, ALLOWED_ORIGINS
- `app/models.py` — UserEvent, LeadClick, Conversation table schemas
- `frontend/src/admin/pages/OverviewPage.tsx` — confirmed: no click/search analytics displayed
- `frontend/src/admin/hooks/useAdminData.ts` — all data fetching hooks
- `frontend/src/admin/types.ts` — TypeScript interfaces, confirmed no analytics-summary type
- `frontend/src/tracking.ts` — trackEvent function, EVENT_TYPES
- `frontend/src/hooks/useExplore.ts` — confirmed: no trackEvent call, no write to any table
- `frontend/src/hooks/useHeaderSearch.ts` — fires filter_change only, not a dedicated search event
- `frontend/src/hooks/useSage.ts` — fires sage_query correctly
- `frontend/src/components/marketplace/ExpertCard.tsx` — fires card_click correctly
- `.planning/milestones/v4.0-phases/50.1-*/50.1-VERIFICATION.md` — Phase 50.1 delivery confirmed

---

## Metadata

**Confidence breakdown:**
- Root cause diagnosis: HIGH — verified by direct code inspection of all tracking paths
- CORS as a root cause: MEDIUM — inferred from MEMORY.md pending todo + code review; needs production verification
- Implementation approach: HIGH — follows established patterns in codebase
- Effort estimate: LOW-MEDIUM — no new libraries, mostly plumbing new connections between existing systems

**Research date:** 2026-03-02
**Valid until:** 2026-04-02 (stable stack, no fast-moving dependencies)
