---
phase: 50.2-fix-search-tracking-analytics-admin
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/events.py
  - app/routers/admin.py
  - frontend/src/tracking.ts
  - frontend/src/hooks/useExplore.ts
  - frontend/src/admin/types.ts
  - frontend/src/admin/hooks/useAdminData.ts
autonomous: false
requirements: []

must_haves:
  truths:
    - "Marketplace search queries are captured with query text and result count in user_events table"
    - "Card click events reach the backend from the Vercel frontend (CORS fixed)"
    - "Admin can fetch a single analytics-summary endpoint returning total clicks, total searches, recent searches, and recent clicks"
  artifacts:
    - path: "app/routers/events.py"
      provides: "search_query event type acceptance"
      contains: "search_query"
    - path: "frontend/src/tracking.ts"
      provides: "search_query in EventType union"
      contains: "search_query"
    - path: "frontend/src/hooks/useExplore.ts"
      provides: "Search query tracking after successful fetch"
      contains: "trackEvent"
    - path: "app/routers/admin.py"
      provides: "GET /api/admin/analytics-summary endpoint"
      contains: "analytics-summary"
    - path: "frontend/src/admin/types.ts"
      provides: "AnalyticsSummary TypeScript interface"
      contains: "AnalyticsSummary"
    - path: "frontend/src/admin/hooks/useAdminData.ts"
      provides: "useAnalyticsSummary hook"
      contains: "useAnalyticsSummary"
  key_links:
    - from: "frontend/src/hooks/useExplore.ts"
      to: "POST /api/events"
      via: "trackEvent('search_query', { query_text, result_count })"
      pattern: "trackEvent.*search_query"
    - from: "app/routers/admin.py"
      to: "user_events table"
      via: "SQL aggregation in analytics-summary endpoint"
      pattern: "analytics.summary|analytics-summary"
---

<objective>
Fix the tracking pipeline and build the backend analytics endpoint so search queries and card clicks are captured and queryable.

Purpose: The admin overview shows nothing because (1) CORS blocks all event POSTs from Vercel to Railway, (2) marketplace search queries are never tracked, and (3) no aggregation endpoint exists for the overview to consume. This plan fixes all three root causes.

Output: Working event pipeline (CORS + search_query tracking) and a new `GET /api/admin/analytics-summary` endpoint returning totals and recent activity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/milestones/v4.0-phases/50.2-fix-search-tracking-analytics-admin/50.2-RESEARCH.md

@app/routers/events.py
@app/routers/admin.py
@app/main.py
@frontend/src/tracking.ts
@frontend/src/hooks/useExplore.ts
@frontend/src/admin/types.ts
@frontend/src/admin/hooks/useAdminData.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/routers/events.py:
```python
EVENT_TYPES = Literal["card_click", "sage_query", "filter_change"]

class EventRequest(BaseModel):
    session_id: str = Field(..., min_length=1, max_length=64)
    event_type: EVENT_TYPES
    payload: dict[str, Any] = Field(default_factory=dict)
```

From frontend/src/tracking.ts:
```typescript
type EventType = 'card_click' | 'sage_query' | 'filter_change'
export function trackEvent(event_type: EventType, payload: TrackPayload = {}): void
```

From frontend/src/hooks/useExplore.ts:
```typescript
// After fetch success:
.then((data) => {
  setResults(data.experts, data.total, data.cursor)
  setLoading(false)
})
```

From frontend/src/admin/hooks/useAdminData.ts:
```typescript
export async function adminFetch<T>(
  path: string,
  params?: Record<string, string | number | boolean | undefined>,
): Promise<T>
```

From app/main.py:
```python
_raw_origins = os.getenv("ALLOWED_ORIGINS", "http://localhost:5173")
ALLOWED_ORIGINS = [o.strip() for o in _raw_origins.split(",") if o.strip()]
```
</interfaces>
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Set CORS ALLOWED_ORIGINS on Railway</name>
  <action>
    The CORS origin allowlist defaults to `http://localhost:5173`. In production, all `POST /api/events` calls from the Vercel frontend are silently blocked. This is the primary reason event tracking data is empty.

    **Action required:** Go to Railway dashboard -> TCS project -> Variables and set:
    ```
    ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app
    ```

    If there are additional origins needed (e.g., a staging URL), comma-separate them:
    ```
    ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app,http://localhost:5173
    ```

    Railway will auto-redeploy the service after the env var is saved.

    **Why this must be first:** Without this fix, all subsequent tracking code changes will still produce empty tables in production. The code change for CORS is zero — it is purely an environment variable.
  </action>
  <resume-signal>Type "done" after setting ALLOWED_ORIGINS in Railway. Optionally confirm by visiting the production site, clicking an expert card, and checking the browser Network tab for a 202 response from POST /api/events.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Add search_query event type + tracking in useExplore + analytics-summary endpoint + types</name>
  <files>
    app/routers/events.py,
    frontend/src/tracking.ts,
    frontend/src/hooks/useExplore.ts,
    app/routers/admin.py,
    frontend/src/admin/types.ts,
    frontend/src/admin/hooks/useAdminData.ts
  </files>
  <action>
    **Part A — Backend: Add `search_query` event type**

    In `app/routers/events.py`, update the EVENT_TYPES Literal:
    ```python
    EVENT_TYPES = Literal["card_click", "sage_query", "filter_change", "search_query"]
    ```
    No other changes needed in this file — the existing `record_event` handler and Pydantic model handle it automatically.

    **Part B — Frontend: Add `search_query` to tracking.ts EventType**

    In `frontend/src/tracking.ts`, update the type:
    ```typescript
    type EventType = 'card_click' | 'sage_query' | 'filter_change' | 'search_query'
    ```

    **Part C — Frontend: Fire search tracking in useExplore.ts**

    In `frontend/src/hooks/useExplore.ts`:
    1. Add import at top: `import { trackEvent } from '../tracking'`
    2. In the main `useEffect` fetch `.then((data) => { ... })` block, AFTER `setResults(data.experts, data.total, data.cursor)` and `setLoading(false)`, add:
    ```typescript
    // Track search query for analytics (only for non-empty queries)
    if (query.trim().length > 0) {
      void trackEvent('search_query', {
        query_text: query,
        result_count: data.total ?? 0,
      })
    }
    ```
    Do NOT track in `loadNextPage` (pagination is not a new search). Only track in the primary `useEffect` that fires on filter/query changes.

    **Part D — Backend: Create GET /api/admin/analytics-summary endpoint**

    In `app/routers/admin.py`, add a new endpoint on the `router` (JWT-protected). Place it near the other event endpoints (after `get_trend`). The endpoint should:

    1. Query `user_events` table for:
       - `total_card_clicks`: COUNT where `event_type = 'card_click'`
       - `total_search_queries`: COUNT where `event_type = 'search_query'`
       - `total_lead_clicks`: COUNT from `lead_clicks` table
       - `recent_searches`: Last 10 rows where `event_type = 'search_query'`, ordered by `created_at DESC`. Extract `query_text` and `result_count` from the JSON `payload` column using `json_extract()`. Return `[{ query_text, result_count, created_at }]`.
       - `recent_clicks`: Last 10 rows where `event_type = 'card_click'`, ordered by `created_at DESC`. Extract `expert_id` from JSON `payload`. Batch-resolve expert names via a single `SELECT` query on the experts table (same pattern as `get_exposure` in admin.py). Return `[{ expert_id, expert_name, source, created_at }]` where `source` is extracted from payload (will be "grid" or "sage").

    2. Use `_text()` (already imported in admin.py as `from sqlalchemy import text as _text`) for raw SQL queries — this follows the established pattern in `get_exposure` and `get_demand`.

    3. Return shape:
    ```python
    {
      "total_card_clicks": int,
      "total_search_queries": int,
      "total_lead_clicks": int,
      "recent_searches": [{"query_text": str, "result_count": int, "created_at": str}],
      "recent_clicks": [{"expert_id": str, "expert_name": str | None, "source": str, "created_at": str}]
    }
    ```

    4. Use `@router.get("/api/admin/analytics-summary")` with the `_require_admin` dependency (same as all other admin endpoints on `router`).

    **Part E — Frontend: Add AnalyticsSummary type + useAnalyticsSummary hook**

    In `frontend/src/admin/types.ts`, add at the end (before the closing):
    ```typescript
    // -- Analytics Summary (Phase 50.2) --

    export interface RecentSearchEntry {
      query_text: string
      result_count: number
      created_at: string
    }

    export interface RecentClickEntry {
      expert_id: string
      expert_name: string | null
      source: string
      created_at: string
    }

    export interface AnalyticsSummary {
      total_card_clicks: number
      total_search_queries: number
      total_lead_clicks: number
      recent_searches: RecentSearchEntry[]
      recent_clicks: RecentClickEntry[]
    }
    ```

    In `frontend/src/admin/hooks/useAdminData.ts`, add a new hook at the end:
    ```typescript
    export function useAnalyticsSummary() {
      const [data, setData] = useState<AnalyticsSummary | null>(null)
      const [loading, setLoading] = useState(true)
      const [error, setError] = useState<string | null>(null)

      useEffect(() => {
        adminFetch<AnalyticsSummary>('/analytics-summary')
          .then(setData)
          .catch((e: Error) => setError(e.message))
          .finally(() => setLoading(false))
      }, [])

      return { data, loading, error }
    }
    ```
    Add the import for `AnalyticsSummary` from `../types` at the top of the file.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS && python3 -c "from app.routers.events import EVENT_TYPES; print('search_query' in EVENT_TYPES.__args__)" && cd frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    - `search_query` accepted by backend Pydantic validation (no 422)
    - `trackEvent('search_query', ...)` fires in useExplore after successful non-empty search
    - `GET /api/admin/analytics-summary` returns totals and recent activity arrays
    - TypeScript compiles with no errors
    - `useAnalyticsSummary` hook available for OverviewPage to consume
  </done>
</task>

</tasks>

<verification>
1. Backend: `python3 -c "from app.routers.events import EVENT_TYPES; print(EVENT_TYPES)"` shows `search_query` in the Literal
2. Frontend: `cd frontend && npx tsc --noEmit` passes with no errors
3. Grep: `grep -n 'trackEvent' frontend/src/hooks/useExplore.ts` shows trackEvent call
4. Grep: `grep -n 'analytics-summary' app/routers/admin.py` shows endpoint
5. Grep: `grep -n 'AnalyticsSummary' frontend/src/admin/types.ts` shows interface
6. Grep: `grep -n 'useAnalyticsSummary' frontend/src/admin/hooks/useAdminData.ts` shows hook
</verification>

<success_criteria>
- CORS env var set on Railway (checkpoint confirmed)
- search_query event type accepted by both backend and frontend
- useExplore fires search tracking after successful non-empty queries
- analytics-summary endpoint returns aggregated data from user_events and lead_clicks
- TypeScript types and hook ready for Plan 02 to consume
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/milestones/v4.0-phases/50.2-fix-search-tracking-analytics-admin/50.2-01-SUMMARY.md`
</output>
