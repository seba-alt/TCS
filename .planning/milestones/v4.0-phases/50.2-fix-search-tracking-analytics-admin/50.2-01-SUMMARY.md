---
phase: 50.2-fix-search-tracking-analytics-admin
plan: "01"
subsystem: api, tracking
tags: [fastapi, events, cors, analytics, react-hooks]

requires:
  - phase: 50.1-lead-click-tracking-data-reset-search-visibility
    provides: lead_clicks table and LeadClick model
provides:
  - search_query event type accepted by backend and frontend
  - GET /api/admin/analytics-summary aggregation endpoint
  - useAnalyticsSummary React hook for admin dashboard
  - AnalyticsSummary TypeScript types
affects: [50.2-02 OverviewPage cards]

tech-stack:
  added: []
  patterns: [json_extract SQL for payload parsing, batch expert name resolution]

key-files:
  created: []
  modified:
    - app/routers/events.py
    - app/routers/admin.py
    - frontend/src/tracking.ts
    - frontend/src/hooks/useExplore.ts
    - frontend/src/admin/types.ts
    - frontend/src/admin/hooks/useAdminData.ts

key-decisions:
  - "CORS fix is env-var only (ALLOWED_ORIGINS on Railway) — no code change needed"
  - "Track search_query only for non-empty queries to avoid noise from blank page loads"
  - "analytics-summary uses json_extract for payload parsing — matches existing demand/exposure pattern"

requirements-completed: []

duration: 5min
completed: 2026-03-02
---

# Phase 50.2 Plan 01: CORS fix + search query tracking + analytics-summary endpoint Summary

**search_query event tracking pipeline + GET /api/admin/analytics-summary endpoint returning totals and recent activity for card clicks, search queries, and lead clicks**

## Performance

- **Duration:** 5 min
- **Started:** 2026-03-02T00:00:00Z
- **Completed:** 2026-03-02T00:05:00Z
- **Tasks:** 2 (1 checkpoint + 1 auto)
- **Files modified:** 6

## Accomplishments
- Added `search_query` to EVENT_TYPES Literal (backend) and EventType union (frontend)
- Wired trackEvent('search_query') in useExplore after successful non-empty marketplace searches
- Created GET /api/admin/analytics-summary endpoint with totals + last-10 recent activity
- Added AnalyticsSummary TypeScript interface and useAnalyticsSummary hook for Plan 02 consumption
- CORS fix documented as checkpoint (ALLOWED_ORIGINS env var on Railway)

## Task Commits

1. **Task 1: Set CORS ALLOWED_ORIGINS on Railway** — checkpoint:human-action (env var, no code commit)
2. **Task 2: Add search_query + analytics-summary + types** — `314eba0` (feat)

## Files Created/Modified
- `app/routers/events.py` — Added search_query to EVENT_TYPES Literal
- `frontend/src/tracking.ts` — Added search_query to EventType union
- `frontend/src/hooks/useExplore.ts` — Fire trackEvent after successful non-empty search
- `app/routers/admin.py` — New GET /api/admin/analytics-summary endpoint
- `frontend/src/admin/types.ts` — RecentSearchEntry, RecentClickEntry, AnalyticsSummary interfaces
- `frontend/src/admin/hooks/useAdminData.ts` — useAnalyticsSummary hook

## Decisions Made
- CORS fix is purely an environment variable change (ALLOWED_ORIGINS on Railway) — no code changes
- search_query tracking only fires for non-empty queries to avoid polluting analytics with empty page loads
- analytics-summary uses json_extract() for payload parsing, consistent with existing demand/exposure endpoints

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
**CORS environment variable must be set on Railway:**
- Set `ALLOWED_ORIGINS=https://tcs-three-sigma.vercel.app` in Railway dashboard variables
- Railway auto-redeploys after env var is saved

## Next Phase Readiness
- useAnalyticsSummary hook and AnalyticsSummary types ready for Plan 02 to wire into OverviewPage
- analytics-summary endpoint will return data as soon as CORS is fixed and events start flowing

---
*Phase: 50.2-fix-search-tracking-analytics-admin*
*Completed: 2026-03-02*
