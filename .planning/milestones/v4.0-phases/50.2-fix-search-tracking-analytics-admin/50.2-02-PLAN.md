---
phase: 50.2-fix-search-tracking-analytics-admin
plan: "02"
type: execute
wave: 2
depends_on: ["50.2-01"]
files_modified:
  - frontend/src/admin/pages/OverviewPage.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Admin overview shows total card clicks and total search queries as stat counters"
    - "Admin overview shows a list of recent search queries with query text, result count, and timestamp"
    - "Admin overview shows a list of recent card clicks with expert name, source, and timestamp"
    - "Admin overview shows total lead clicks counter"
    - "Overview handles empty/cold-start state gracefully (no crashes, helpful message)"
  artifacts:
    - path: "frontend/src/admin/pages/OverviewPage.tsx"
      provides: "Analytics cards for clicks and searches"
      contains: "useAnalyticsSummary"
  key_links:
    - from: "frontend/src/admin/pages/OverviewPage.tsx"
      to: "GET /api/admin/analytics-summary"
      via: "useAnalyticsSummary hook"
      pattern: "useAnalyticsSummary"
---

<objective>
Add search and click analytics cards to the admin OverviewPage, wiring them to the analytics-summary endpoint created in Plan 01.

Purpose: The admin overview currently shows chat-based search stats and leads but has zero visibility into marketplace search queries and expert card clicks. This plan surfaces that data prominently on the overview dashboard.

Output: OverviewPage with new analytics section showing totals + recent activity for both searches and clicks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/milestones/v4.0-phases/50.2-fix-search-tracking-analytics-admin/50.2-01-SUMMARY.md

@frontend/src/admin/pages/OverviewPage.tsx
@frontend/src/admin/hooks/useAdminData.ts
@frontend/src/admin/types.ts

<interfaces>
<!-- Types and hooks created in Plan 01 that this plan consumes. -->

From frontend/src/admin/types.ts (created in Plan 01):
```typescript
export interface RecentSearchEntry {
  query_text: string
  result_count: number
  created_at: string
}

export interface RecentClickEntry {
  expert_id: string
  expert_name: string | null
  source: string
  created_at: string
}

export interface AnalyticsSummary {
  total_card_clicks: number
  total_search_queries: number
  total_lead_clicks: number
  recent_searches: RecentSearchEntry[]
  recent_clicks: RecentClickEntry[]
}
```

From frontend/src/admin/hooks/useAdminData.ts (created in Plan 01):
```typescript
export function useAnalyticsSummary(): {
  data: AnalyticsSummary | null
  loading: boolean
  error: string | null
}
```

Existing OverviewPage components to reference for style consistency:
- `StatCard` — simple label/value/sub card with optional accent border
- `TrendStatCard` — label/value with delta indicator
- `RecentLeadsCard` — list card with "See all" link, loading/empty states
- `RecentSearchesCard` — list card with source badges and timeAgo
- `timeAgo(iso: string)` — already defined at top of OverviewPage.tsx
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics stat counters to the overview grid</name>
  <files>frontend/src/admin/pages/OverviewPage.tsx</files>
  <action>
    In `OverviewPage.tsx`:

    1. Add import at top: `import { useAnalyticsSummary } from '../hooks/useAdminData'` (add to the existing import from that module — it already imports `useAdminStats`, `adminFetch`, `useMarketplaceTrend`).

    2. Inside the `OverviewPage` component function, add after the existing hooks:
    ```typescript
    const { data: analytics, loading: analyticsLoading } = useAnalyticsSummary()
    ```

    3. Add a new section between "Section 1: Health strip" and "Section 2: Two-column insight cards". This section shows three analytics counters in a row using the existing `StatCard` component:

    ```tsx
    {/* Section 1.5: Marketplace Analytics Counters */}
    <div className="grid grid-cols-2 xl:grid-cols-3 gap-4">
      <StatCard
        label="Expert Card Clicks"
        value={analyticsLoading ? '...' : (analytics?.total_card_clicks ?? 0)}
        sub="all-time marketplace clicks"
      />
      <StatCard
        label="Explore Searches"
        value={analyticsLoading ? '...' : (analytics?.total_search_queries ?? 0)}
        sub="marketplace search queries"
      />
      <StatCard
        label="Lead Clicks"
        value={analyticsLoading ? '...' : (analytics?.total_lead_clicks ?? 0)}
        sub="clicks by identified leads"
        accent
      />
    </div>
    ```

    Use `StatCard` (NOT `TrendStatCard`) since we don't have 7-day delta data for these metrics yet. The accent flag on Lead Clicks highlights the most valuable metric.
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    - OverviewPage renders 3 new stat cards for card clicks, search queries, and lead clicks
    - Loading state shows "..." while fetching
    - TypeScript compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Recent Searches and Recent Clicks cards to overview</name>
  <files>frontend/src/admin/pages/OverviewPage.tsx</files>
  <action>
    In `OverviewPage.tsx`, add two new card components INSIDE the file (following the same pattern as `RecentLeadsCard` and `RecentSearchesCard` which are already defined as local components in this file):

    **Component 1: `RecentExploreSearchesCard`**

    Add this component definition before the `OverviewPage` default export:

    ```tsx
    function RecentExploreSearchesCard({ searches, loading }: { searches: RecentSearchEntry[]; loading: boolean }) {
      return (
        <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-sm font-semibold text-white">Recent Explore Searches</h2>
            <span className="text-xs text-slate-500">from marketplace search bar</span>
          </div>
          {loading ? (
            <p className="text-slate-500 text-sm animate-pulse">Loading...</p>
          ) : searches.length === 0 ? (
            <p className="text-slate-500 text-sm">No explore searches tracked yet — data appears after users search the marketplace</p>
          ) : (
            <div className="space-y-2">
              {searches.map((row, i) => (
                <div key={i} className="flex items-center justify-between">
                  <span className="text-sm text-slate-300 truncate max-w-[55%]" title={row.query_text}>
                    {row.query_text}
                  </span>
                  <div className="flex items-center gap-3 flex-shrink-0 ml-2">
                    <span className="text-xs px-1.5 py-0.5 rounded bg-emerald-900/50 text-emerald-400 font-medium">
                      {row.result_count} results
                    </span>
                    <span className="text-xs text-slate-500">{timeAgo(row.created_at)}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )
    }
    ```

    Import `RecentSearchEntry` and `RecentClickEntry` from `'../types'` at the top (add to existing import).

    **Component 2: `RecentCardClicksCard`**

    ```tsx
    function RecentCardClicksCard({ clicks, loading }: { clicks: RecentClickEntry[]; loading: boolean }) {
      return (
        <div className="bg-slate-800/60 border border-slate-700/60 rounded-xl p-5">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-sm font-semibold text-white">Recent Card Clicks</h2>
            <Link to="/admin/marketplace" className="text-xs text-purple-400 hover:text-purple-300 transition-colors">
              Exposure details ->
            </Link>
          </div>
          {loading ? (
            <p className="text-slate-500 text-sm animate-pulse">Loading...</p>
          ) : clicks.length === 0 ? (
            <p className="text-slate-500 text-sm">No card clicks tracked yet — data appears after users click expert cards</p>
          ) : (
            <div className="space-y-2">
              {clicks.map((row, i) => (
                <div key={i} className="flex items-center justify-between">
                  <span className="text-sm text-slate-300 truncate max-w-[55%]" title={row.expert_name ?? row.expert_id}>
                    {row.expert_name ?? row.expert_id}
                  </span>
                  <div className="flex items-center gap-3 flex-shrink-0 ml-2">
                    <span className={`text-xs px-1.5 py-0.5 rounded font-medium ${
                      row.source === 'sage' ? 'bg-cyan-900/50 text-cyan-400' : 'bg-indigo-900/50 text-indigo-400'
                    }`}>
                      {row.source}
                    </span>
                    <span className="text-xs text-slate-500">{timeAgo(row.created_at)}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )
    }
    ```

    **Wire into OverviewPage JSX:**

    Add a new two-column grid section AFTER the "Section 2.5: Recent activity" div (after RecentLeadsCard + RecentSearchesCard) and BEFORE "Section 3: Top Queries + Top Feedback":

    ```tsx
    {/* Section 2.7: Marketplace analytics — explore searches + card clicks */}
    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
      <RecentExploreSearchesCard
        searches={analytics?.recent_searches ?? []}
        loading={analyticsLoading}
      />
      <RecentCardClicksCard
        clicks={analytics?.recent_clicks ?? []}
        loading={analyticsLoading}
      />
    </div>
    ```

    The `analytics` and `analyticsLoading` variables are already available from Task 1's `useAnalyticsSummary()` call.

    **Style notes:**
    - Use the same card structure as existing `RecentLeadsCard` and `RecentSearchesCard` (bg-slate-800/60, border-slate-700/60, rounded-xl, p-5)
    - Source badges use same colors as existing `RecentSearchesCard` (cyan for sage, indigo for grid)
    - Result count badge uses emerald (green) to visually distinguish from source badges
    - Empty state messages are specific and helpful (tell the user when data will appear)
  </action>
  <verify>
    <automated>cd /Users/sebastianhamers/Documents/TCS/frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    - Two new card components render in OverviewPage
    - RecentExploreSearchesCard shows query text, result count badge, and relative timestamp
    - RecentCardClicksCard shows expert name (fallback to ID), source badge, and relative timestamp
    - Empty state handled gracefully with helpful messages
    - Loading state shows animated pulse text
    - TypeScript compiles with no errors
    - Visual style matches existing OverviewPage cards
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — passes with no errors
2. `grep -n 'useAnalyticsSummary' frontend/src/admin/pages/OverviewPage.tsx` — hook is called
3. `grep -n 'RecentExploreSearchesCard\|RecentCardClicksCard' frontend/src/admin/pages/OverviewPage.tsx` — both components exist and are rendered
4. `grep -c 'StatCard' frontend/src/admin/pages/OverviewPage.tsx` — count increased (3 new StatCards added)
5. `grep -n 'total_card_clicks\|total_search_queries\|total_lead_clicks' frontend/src/admin/pages/OverviewPage.tsx` — all three counters referenced
</verification>

<success_criteria>
- OverviewPage renders 3 analytics counter cards (card clicks, search queries, lead clicks)
- OverviewPage renders Recent Explore Searches card with query + result count + time
- OverviewPage renders Recent Card Clicks card with expert name + source + time
- All cards handle loading and empty states
- TypeScript compiles with no errors
- Visual style is consistent with existing OverviewPage cards
</success_criteria>

<output>
After completion, create `.planning/milestones/v4.0-phases/50.2-fix-search-tracking-analytics-admin/50.2-02-SUMMARY.md`
</output>
