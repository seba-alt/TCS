---
phase: 16-marketplace-page-sidebar
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - frontend/src/components/sidebar/FilterSidebar.tsx
  - frontend/src/components/marketplace/FilterChips.tsx
  - frontend/src/components/marketplace/SkeletonGrid.tsx
  - frontend/src/components/sidebar/MobileFilterSheet.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: [MARKET-01, MARKET-06]

must_haves:
  truths:
    - "Desktop sidebar is sticky, collapsible, and shows an icon strip when collapsed (Search, DollarSign, Tag icons from lucide-react)"
    - "Filter chips appear above the grid for every active filter with individual dismiss buttons and a 'Clear all' link"
    - "SkeletonGrid renders 9 animated pulse cards when loading is true"
    - "Mobile bottom-sheet opens via a toolbar button (md:hidden), has half/full snap points, and commits filters only on Apply tap"
    - "MarketplacePage calls useExplore() at the top level and renders the full layout: sticky sidebar + chip strip + results area"
  artifacts:
    - path: "frontend/src/components/sidebar/FilterSidebar.tsx"
      provides: "Sticky collapsible sidebar with icon strip; hidden on mobile"
      exports: ["FilterSidebar"]
    - path: "frontend/src/components/marketplace/FilterChips.tsx"
      provides: "Active filter chip strip with count and clear-all"
      exports: ["FilterChips"]
    - path: "frontend/src/components/marketplace/SkeletonGrid.tsx"
      provides: "Animated skeleton grid shown while loading"
      exports: ["SkeletonGrid"]
    - path: "frontend/src/components/sidebar/MobileFilterSheet.tsx"
      provides: "Vaul bottom-sheet with staged draft filters and Apply button"
      exports: ["MobileFilterSheet"]
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Full marketplace layout: calls useExplore, renders sidebar + FilterChips + results area with SkeletonGrid"
      min_lines: 50
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/hooks/useExplore.ts"
      via: "useExplore() called at component top level"
      pattern: "useExplore\\(\\)"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/components/sidebar/FilterSidebar.tsx"
      via: "import and render in flex layout without overflow wrapper"
      pattern: "FilterSidebar"
    - from: "frontend/src/components/marketplace/FilterChips.tsx"
      to: "frontend/src/store/index.ts"
      via: "useFilterSlice + useResultsSlice (total for expert count)"
      pattern: "useResultsSlice.*total|total.*useResultsSlice"
    - from: "frontend/src/components/sidebar/MobileFilterSheet.tsx"
      to: "frontend/src/store/filterSlice.ts"
      via: "draft state committed to store only via handleApply"
      pattern: "handleApply"
---

<objective>
Assemble the sidebar shell, marketplace utility components, mobile bottom-sheet, and wire the full MarketplacePage layout. This plan produces the complete visible frame of the marketplace.

Purpose: Connect all leaf components into a functional layout where sidebar filters drive fetches, chips reflect active state, skeletons appear on load, and mobile users access filters via bottom-sheet.
Output: FilterSidebar, FilterChips, SkeletonGrid, MobileFilterSheet, and a fully wired MarketplacePage.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-marketplace-page-sidebar/16-RESEARCH.md
@.planning/phases/16-marketplace-page-sidebar/16-01-SUMMARY.md
@frontend/src/store/index.ts
@frontend/src/store/filterSlice.ts
@frontend/src/store/resultsSlice.ts
@frontend/src/pages/MarketplacePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build FilterSidebar, FilterChips, and SkeletonGrid</name>
  <files>
    frontend/src/components/sidebar/FilterSidebar.tsx
    frontend/src/components/marketplace/FilterChips.tsx
    frontend/src/components/marketplace/SkeletonGrid.tsx
  </files>
  <action>
    Create `frontend/src/components/marketplace/` directory (mkdir -p if needed).

    **FilterSidebar.tsx** — implement per RESEARCH.md Pattern 1 and CONTEXT.md locked decisions:
    - Local `collapsed` state (useState, default false)
    - `className` on `<aside>`: `hidden md:flex flex-col sticky top-0 h-screen bg-gray-50 border-r border-gray-200 transition-all duration-200` + conditional `w-16` (collapsed) or `w-64` (expanded)
    - CRITICAL: Do NOT add `overflow` to any parent of this `<aside>` — sticky fails with ancestor overflow (see RESEARCH.md Pitfall 1). The sidebar's own scrollable area uses `overflow-y-auto` on its inner content div.
    - Toggle button at top: `h-10 w-full border-b border-gray-200 flex items-center justify-center`; icon = `PanelLeftClose` (expanded) / `PanelRightOpen` (collapsed) from `lucide-react`, size 18
    - When collapsed (`collapsed === true`): show `<IconStrip />` — a vertical stack of three icons from lucide-react: `Search` (text search), `DollarSign` (rate range), `Tag` (domain tags), each in a `flex items-center justify-center h-10 w-full text-gray-400` div
    - When expanded: show `<FilterControls />` — a scrollable `flex flex-col gap-4 overflow-y-auto flex-1 py-3` div containing:
      - Section label `"Search"` (text-xs font-medium text-gray-500 uppercase px-4) above `<SearchInput />`
      - Section label `"Hourly Rate"` above `<RateSlider />`
      - Section label `"Domain Tags"` above `<TagMultiSelect />`
    - Import `SearchInput`, `RateSlider`, `TagMultiSelect` from their files
    - Import icons: `{ PanelLeftClose, PanelRightOpen, Search, DollarSign, Tag }` from `'lucide-react'`
    - Export: `export function FilterSidebar()`

    **FilterChips.tsx** — implement exactly as RESEARCH.md Pattern 5:
    - Import `{ useFilterSlice }` and `{ useResultsSlice }` from `'../../store'`
    - `defaultRateMin = 0`, `defaultRateMax = 2000` (slider visual bounds — chips should only show rate chip when values differ from these slider defaults; the store default is 5000 but the slider is capped at 2000, so use 0/2000 as chip comparison baseline)
    - Build `chips` array from active filters:
      - query chip: `{ label: \`"${query}"\`, onDismiss: () => setQuery('') }` if query is non-empty
      - rate chip: `{ label: \`EUR ${rateMin}–${rateMax}\`, onDismiss: () => setRateRange(defaultRateMin, defaultRateMax) }` if `rateMin !== defaultRateMin || rateMax !== defaultRateMax`
      - tag chips: one per tag in `tags` array: `{ label: tag, onDismiss: () => toggleTag(tag) }`
    - If no filters AND total is 0: return null
    - Otherwise always render the strip (even with 0 chips, show expert count if total > 0)
    - Layout: `flex items-center gap-2 flex-wrap px-4 py-2 border-b border-gray-100`
    - Count: `<span className="text-sm text-gray-500 shrink-0">{total} experts found</span>`
    - Each chip: `inline-flex items-center gap-1 text-xs bg-gray-100 text-gray-700 rounded-full px-2.5 py-0.5`
    - Dismiss button inside chip: `×` character, `aria-label="Remove {label} filter"`, `hover:text-gray-900 ml-0.5`
    - "Clear all": `text-xs text-brand-purple hover:underline ml-1` — only rendered when `chips.length > 0`
    - Export: `export function FilterChips()`

    **SkeletonGrid.tsx** — implement exactly as RESEARCH.md Pattern 8:
    - `SkeletonCard`: `animate-pulse rounded-xl border border-gray-100 p-4 space-y-3` div containing avatar circle, two text lines, three tag pill placeholders, two body text lines
    - `SkeletonGrid`: `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4` with 9 `<SkeletonCard>` instances (Array.from({ length: 9 }).map)
    - Export: `export function SkeletonGrid()`
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — zero errors across all three files.
    Confirm files exist: `frontend/src/components/sidebar/FilterSidebar.tsx`, `frontend/src/components/marketplace/FilterChips.tsx`, `frontend/src/components/marketplace/SkeletonGrid.tsx`.
  </verify>
  <done>FilterSidebar, FilterChips, and SkeletonGrid all compile and are ready for import. FilterSidebar is sticky, collapsible, and shows icon strip when collapsed.</done>
</task>

<task type="auto">
  <name>Task 2: Build MobileFilterSheet and wire MarketplacePage</name>
  <files>
    frontend/src/components/sidebar/MobileFilterSheet.tsx
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
    **MobileFilterSheet.tsx** — implement per RESEARCH.md Pattern 7 and CONTEXT.md locked decisions:

    Import: `{ Drawer } from 'vaul'`, `{ useState, useEffect }` from `'react'`, `{ useExplorerStore }` from `'../../store'`
    Also import `SearchInput`, `RateSlider`, `TagMultiSelect` — but these are wired to GLOBAL store actions, so for the mobile sheet's staged draft pattern, the sheet must NOT render them directly (they would write to the store immediately). Instead, implement inline controlled inputs for the draft state inside the sheet, mirroring the same UI as the sidebar components but wired to local draft state.

    Props: `{ open: boolean; onClose: () => void }`

    State:
    - `snap` state for active snap point: `useState<number | string | null>(0.5)`
    - `draft` state: `useState({ query: '', rateMin: 0, rateMax: 2000, tags: [] as string[] })` — initialized from store on open

    Initialize draft from store when sheet opens: use `useEffect([open])` — when `open` becomes true, read current store state via `useExplorerStore.getState()` and set draft.

    handleApply:
    - Reads `setQuery`, `setRateRange`, `resetFilters` from `useExplorerStore.getState()` (direct store access, no hook — avoids double render)
    - Calls `setQuery(draft.query)`, `setRateRange(draft.rateMin, draft.rateMax)`
    - For tags: call `resetFilters()` first is too aggressive (resets all). Instead, use `useExplorerStore.getState()` to get the `toggleTag` action and compute the diff: for each tag in draft.tags not in current store tags → call toggleTag to add; for each tag in current store tags not in draft.tags → call toggleTag to remove.
    - Then calls `onClose()`

    Drawer.Root props: `open={open}`, `onOpenChange={(o) => { if (!o) onClose() }}`, `snapPoints={[0.5, 1]}`, `activeSnapPoint={snap}`, `setActiveSnapPoint={setSnap}`, `snapToSequentialPoint` (prevents snap skip on high velocity — see RESEARCH.md Pitfall 6)

    Layout inside Drawer.Content (`fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl flex flex-col`):
    - Drag handle: `mx-auto w-10 h-1 rounded-full bg-gray-300 mt-3 mb-2`
    - Header row: `px-4 py-2 flex items-center justify-between border-b border-gray-100` with `<span>Filters</span>` and `<button onClick={handleApply}>Apply</button>` (brand-purple, font-medium, text-sm)
    - Scrollable body: `flex-1 overflow-y-auto px-4 py-3 space-y-4` with three inline filter sections:
      - Text search: `<input type="search" value={draft.query} onChange={(e) => setDraft(d => ({ ...d, query: e.target.value }))} placeholder="Search experts..." className="w-full px-3 py-2 text-sm border border-gray-300 rounded-md" />`
      - Rate display + a note that slider is desktop only (mobile uses two number inputs for rate bounds): `<div className="flex gap-2"><input type="number" min={0} max={2000} value={draft.rateMin} onChange={(e) => setDraft(d => ({ ...d, rateMin: Number(e.target.value) }))} className="w-full text-sm border border-gray-300 rounded-md px-2 py-1.5" placeholder="Min EUR" /><input type="number" min={0} max={2000} value={draft.rateMax} onChange={(e) => setDraft(d => ({ ...d, rateMax: Number(e.target.value) }))} className="w-full text-sm border border-gray-300 rounded-md px-2 py-1.5" placeholder="Max EUR" /></div>` — this is a pragmatic choice for mobile (numeric keyboard is better than a slider in a sheet)
      - Tags: render the same TOP_TAGS pill list as TagMultiSelect but toggling `draft.tags` (local set/unset, same pill styling)

    Export: `export function MobileFilterSheet({ open, onClose }: { open: boolean; onClose: () => void })`

    ---

    **MarketplacePage.tsx** — replace the Phase 15 shell with the full layout:

    Imports:
    - `{ useEffect, useState }` from `'react'`
    - `{ useExplorerStore }` from `'../store'`
    - `{ useExplore }` from `'../hooks/useExplore'`
    - `{ FilterSidebar }` from `'../components/sidebar/FilterSidebar'`
    - `{ FilterChips }` from `'../components/marketplace/FilterChips'`
    - `{ SkeletonGrid }` from `'../components/marketplace/SkeletonGrid'`
    - `{ MobileFilterSheet }` from `'../components/sidebar/MobileFilterSheet'`
    - `{ SlidersHorizontal }` from `'lucide-react'` (for mobile filter toolbar button)

    Component body:
    1. `useExplore()` — called at top level; self-manages via filter state subscription
    2. `const resetPilot = useExplorerStore((s) => s.resetPilot)` + `useEffect(() => { resetPilot() }, [resetPilot])` — preserve Phase 15 reset behavior
    3. `const loading = useExplorerStore((s) => s.loading)` — for SkeletonGrid
    4. `const experts = useExplorerStore((s) => s.experts)` — for results placeholder (Phase 17 will replace with Virtuoso grid)
    5. `const [sheetOpen, setSheetOpen] = useState(false)` — mobile bottom-sheet state
    6. `const { tags, query } = useFilterSlice()` — for mobile toolbar badge count

    Layout (CRITICAL — no overflow wrapper around FilterSidebar):
    ```tsx
    return (
      <div className="flex min-h-screen bg-white">
        {/* Desktop sticky sidebar — hidden on mobile */}
        <FilterSidebar />

        {/* Main content area */}
        <main className="flex-1 min-h-screen flex flex-col">
          {/* Mobile toolbar — visible only on mobile */}
          <div className="md:hidden flex items-center justify-between px-4 py-3 border-b border-gray-100">
            <h1 className="text-lg font-semibold text-gray-900">Experts</h1>
            <button
              onClick={() => setSheetOpen(true)}
              className="flex items-center gap-1.5 text-sm border border-gray-300 rounded-md px-3 py-1.5"
            >
              <SlidersHorizontal size={16} />
              Filters
              {(tags.length + (query ? 1 : 0)) > 0 && (
                <span className="bg-brand-purple text-white text-xs rounded-full px-1.5 py-0.5 leading-none">
                  {tags.length + (query ? 1 : 0)}
                </span>
              )}
            </button>
          </div>

          {/* Desktop header — visible only on desktop */}
          <div className="hidden md:flex items-center px-6 py-4 border-b border-gray-100">
            <h1 className="text-xl font-semibold text-gray-900">Find an Expert</h1>
          </div>

          {/* Active filter chips */}
          <FilterChips />

          {/* Results area — Phase 17 replaces this placeholder with Virtuoso grid */}
          <div className="flex-1">
            {loading ? (
              <SkeletonGrid />
            ) : (
              <div className="p-4 text-sm text-gray-400">
                {experts.length > 0
                  ? `${experts.length} experts loaded — grid coming in Phase 17`
                  : 'No results — grid coming in Phase 17'}
              </div>
            )}
          </div>
        </main>

        {/* Mobile filter bottom-sheet */}
        <MobileFilterSheet open={sheetOpen} onClose={() => setSheetOpen(false)} />
      </div>
    )
    ```

    Import `{ useFilterSlice }` from `'../store'` for the tags/query badge in the mobile toolbar.
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — zero TypeScript errors.
    Run `cd frontend && npm run build` — build must succeed with no errors.
    Confirm both files exist: `frontend/src/components/sidebar/MobileFilterSheet.tsx` and `frontend/src/pages/MarketplacePage.tsx`.
  </verify>
  <done>MobileFilterSheet uses staged draft state (Apply-only commit). MarketplacePage calls useExplore(), renders FilterSidebar (sticky, no overflow ancestor), FilterChips, SkeletonGrid on load, and MobileFilterSheet. npm run build succeeds.</done>
</task>

</tasks>

<verification>
- `cd frontend && npm run build` succeeds with no errors
- `cd frontend && npx tsc --noEmit` passes with zero errors
- Desktop layout: `div.flex.min-h-screen` at top — no overflow wrapper around FilterSidebar
- FilterSidebar has `sticky top-0 h-screen` classes
- MobileFilterSheet: Drawer.Root has `snapToSequentialPoint` prop
- Mobile toolbar button has `md:hidden` class (hidden on desktop)
- Desktop FilterSidebar has `hidden md:flex` class (hidden on mobile)
- FilterChips renders "X experts found" count from `useResultsSlice().total`
- RateSlider uses `onValueCommit` (not `onValueChange`) to write to store
- useExplore called once at MarketplacePage top level
</verification>

<success_criteria>
The marketplace page renders a professional layout: sticky collapsible sidebar on desktop with SearchInput/RateSlider/TagMultiSelect; FilterChips strip with active filter chips and count; SkeletonGrid appears while fetch is in-flight; mobile users see a toolbar Filter button that opens a vaul bottom-sheet with staged Apply behavior. Build succeeds.
</success_criteria>

<output>
After completion, create `.planning/phases/16-marketplace-page-sidebar/16-02-SUMMARY.md` following the summary template.
</output>
