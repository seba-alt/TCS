---
phase: 18-floating-ai-co-pilot
plan: "02"
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - frontend/src/store/filterSlice.ts
  - frontend/src/hooks/useSage.ts
  - frontend/src/components/pilot/SageFAB.tsx
  - frontend/src/components/pilot/SagePanel.tsx
  - frontend/src/components/pilot/SageMessage.tsx
  - frontend/src/components/pilot/SageInput.tsx
autonomous: true
requirements: [PILOT-01, PILOT-02, PILOT-03]

must_haves:
  truths:
    - "filterSlice has a setTags(tags: string[]) action that replaces the tags array entirely"
    - "useSage hook sends message to /api/pilot, applies returned filters to Zustand store, adds Sage's confirmation to messages"
    - "SageFAB is a fixed bottom-right button that calls setOpen(true) when clicked"
    - "SagePanel is a 380px right-side slide-in panel (full-screen on mobile) showing conversation + input"
    - "Filters are validated before dispatch: query must be string, rate_min/max must be numbers, tags must be array, reset clears all"
  artifacts:
    - path: "frontend/src/store/filterSlice.ts"
      provides: "setTags action added"
      contains: "setTags"
    - path: "frontend/src/hooks/useSage.ts"
      provides: "useSage hook with handleSend, validates and dispatches filters"
      contains: "handleSend"
    - path: "frontend/src/components/pilot/SageFAB.tsx"
      provides: "Floating action button â€” fixed bottom-right"
      min_lines: 20
    - path: "frontend/src/components/pilot/SagePanel.tsx"
      provides: "380px slide-in panel with conversation + input"
      min_lines: 60
    - path: "frontend/src/components/pilot/SageMessage.tsx"
      provides: "Individual message bubble (user vs Sage visual distinction)"
      min_lines: 15
    - path: "frontend/src/components/pilot/SageInput.tsx"
      provides: "Auto-growing textarea with Enter-to-submit"
      min_lines: 30
  key_links:
    - from: "frontend/src/hooks/useSage.ts"
      to: "/api/pilot"
      via: "fetch POST"
      pattern: "api/pilot"
    - from: "frontend/src/hooks/useSage.ts"
      to: "frontend/src/store/filterSlice.ts"
      via: "validateAndApplyFilters dispatching setQuery, setRateRange, setTags, resetFilters"
      pattern: "setTags|setQuery|setRateRange|resetFilters"
    - from: "frontend/src/components/pilot/SagePanel.tsx"
      to: "frontend/src/hooks/useSage.ts"
      via: "useSage() hook call"
      pattern: "useSage"
    - from: "frontend/src/components/pilot/SageFAB.tsx"
      to: "frontend/src/store/pilotSlice.ts"
      via: "setOpen(true)"
      pattern: "setOpen"
---

<objective>
Build the frontend data layer (filterSlice setTags + useSage hook) and all four Sage UI components (FAB, panel, message bubble, input).

Purpose: This plan builds everything the co-pilot needs: the store extension (setTags for programmatic tag replacement), the hook that communicates with /api/pilot and dispatches validated filter updates, and the four visual components for the floating button + conversation panel. MarketplacePage wiring comes in Plan 03.

Output: filterSlice.ts extended, useSage.ts created, and four pilot components in frontend/src/components/pilot/.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/18-floating-ai-co-pilot/18-RESEARCH.md
@.planning/phases/18-floating-ai-co-pilot/18-01-SUMMARY.md
@frontend/src/store/filterSlice.ts
@frontend/src/store/pilotSlice.ts
@frontend/src/store/index.ts
@frontend/src/components/marketplace/ExpertCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setTags to filterSlice + create useSage hook</name>
  <files>
    frontend/src/store/filterSlice.ts
    frontend/src/hooks/useSage.ts
  </files>
  <action>
**Part A: Extend filterSlice.ts**

Add `setTags(tags: string[])` to the FilterSlice interface and implementation. This replaces the tags array entirely â€” needed for Sage to programmatically set tags without toggling one at a time.

```typescript
// Add to FilterSlice interface:
setTags: (tags: string[]) => void

// Add to createFilterSlice implementation:
setTags: (tags) => set({ tags }),
```

IMPORTANT: Do NOT modify existing actions (toggleTag, setQuery, setRateRange, resetFilters). Only ADD setTags.

Also update `useFilterSlice` in index.ts to expose `setTags` alongside the existing actions.

**Part B: Create frontend/src/hooks/useSage.ts**

This hook handles all co-pilot communication:
- Reads conversation state from pilotSlice (individual Zustand selectors â€” NOT useShallow, per Phase 16 pattern)
- Sends user message to POST /api/pilot
- Validates and dispatches filter updates to the store
- Adds both user message and Sage's response to pilotSlice messages

```typescript
import { useCallback } from 'react'
import { useExplorerStore } from '../store'

const API_BASE = import.meta.env.VITE_API_URL ?? ''

// Role mapping: pilotSlice uses 'user'/'assistant', Gemini needs 'user'/'model'
function toGeminiRole(role: 'user' | 'assistant'): 'user' | 'model' {
  return role === 'assistant' ? 'model' : 'user'
}

function validateAndApplyFilters(filters: Record<string, unknown>) {
  const store = useExplorerStore.getState()

  if (filters.reset === true) {
    store.resetFilters()
    return
  }
  if (typeof filters.query === 'string') {
    store.setQuery(filters.query)
  }
  if (typeof filters.rate_min === 'number' && typeof filters.rate_max === 'number') {
    store.setRateRange(filters.rate_min, filters.rate_max)
  } else if (typeof filters.rate_min === 'number') {
    const current = store.rateMax
    store.setRateRange(filters.rate_min, current)
  } else if (typeof filters.rate_max === 'number') {
    const current = store.rateMin
    store.setRateRange(current, filters.rate_max)
  }
  if (Array.isArray(filters.tags) && filters.tags.every(t => typeof t === 'string')) {
    store.setTags(filters.tags)
  }
}

export function useSage() {
  // Individual Zustand selectors (Phase 16 pattern â€” NOT useShallow)
  const messages = useExplorerStore((s) => s.messages)
  const isStreaming = useExplorerStore((s) => s.isStreaming)
  const addMessage = useExplorerStore((s) => s.addMessage)
  const setStreaming = useExplorerStore((s) => s.setStreaming)

  const handleSend = useCallback(async (text: string) => {
    if (!text.trim() || isStreaming) return

    // Add user message immediately
    addMessage({
      id: `${Date.now()}-user`,
      role: 'user',
      content: text.trim(),
      timestamp: Date.now(),
    })
    setStreaming(true)

    try {
      // Get current state snapshot (not reactive â€” snapshot for async handler)
      const storeState = useExplorerStore.getState()
      const history = storeState.messages
        .slice(-10) // Last 10 messages for context window
        .map(m => ({ role: toGeminiRole(m.role), content: m.content }))

      const currentFilters = {
        query: storeState.query,
        rate_min: storeState.rateMin,
        rate_max: storeState.rateMax,
        tags: storeState.tags,
      }

      const res = await fetch(`${API_BASE}/api/pilot`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: text.trim(),
          history,
          current_filters: currentFilters,
        }),
      })

      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      const data = await res.json()

      // Dispatch validated filter updates to store (triggers useExplore re-fetch)
      if (data.filters && typeof data.filters === 'object') {
        validateAndApplyFilters(data.filters)
      }

      // Add Sage's confirmation message
      addMessage({
        id: `${Date.now()}-assistant`,
        role: 'assistant',
        content: data.message ?? "I've updated your search. Check the results!",
        timestamp: Date.now(),
      })
    } catch {
      addMessage({
        id: `${Date.now()}-error`,
        role: 'assistant',
        content: "Sorry, I had trouble connecting. Please try again.",
        timestamp: Date.now(),
      })
    } finally {
      setStreaming(false)
    }
  }, [isStreaming, addMessage, setStreaming])

  return { messages, isStreaming, handleSend }
}
```

After editing both files, run from frontend/: npm run build â€” fix any TypeScript errors.
  </action>
  <verify>
    npm run build from frontend/ â€” must exit 0.
    grep -n "setTags" frontend/src/store/filterSlice.ts â€” returns the interface and implementation lines.
    grep -n "validateAndApplyFilters\|api/pilot\|handleSend" frontend/src/hooks/useSage.ts â€” all three appear.
    grep -n "setTags" frontend/src/store/index.ts â€” appears in useFilterSlice.
  </verify>
  <done>
    filterSlice has setTags action (replaces tags array entirely).
    useSage hook exports { messages, isStreaming, handleSend }.
    handleSend sends to /api/pilot, validates filters, dispatches to store, adds both messages.
    Role mapping: 'assistant' â†’ 'model' for Gemini history.
    npm run build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SageMessage, SageInput, SagePanel, SageFAB components</name>
  <files>
    frontend/src/components/pilot/SageMessage.tsx
    frontend/src/components/pilot/SageInput.tsx
    frontend/src/components/pilot/SagePanel.tsx
    frontend/src/components/pilot/SageFAB.tsx
  </files>
  <action>
Create the frontend/src/components/pilot/ directory and four components.

**SageMessage.tsx** â€” Individual message bubble with visual distinction between user and Sage:
```tsx
interface SageMessageProps {
  role: 'user' | 'assistant'
  content: string
}

export function SageMessage({ role, content }: SageMessageProps) {
  const isUser = role === 'user'
  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-3`}>
      {!isUser && (
        <div className="w-6 h-6 rounded-full bg-brand-purple flex items-center justify-center mr-2 shrink-0 mt-0.5">
          <span className="text-white text-xs font-bold">S</span>
        </div>
      )}
      <div
        className={`max-w-[80%] rounded-2xl px-3.5 py-2 text-sm leading-relaxed ${
          isUser
            ? 'bg-brand-purple text-white rounded-tr-sm'
            : 'bg-gray-100 text-gray-800 rounded-tl-sm'
        }`}
      >
        {content}
      </div>
    </div>
  )
}
```

**SageInput.tsx** â€” Auto-growing textarea, Enter to submit (Shift+Enter for newline), disabled while streaming:
```tsx
import { useRef, useEffect } from 'react'
import { ArrowUp } from 'lucide-react'

interface SageInputProps {
  onSend: (text: string) => void
  disabled?: boolean
}

export function SageInput({ onSend, disabled = false }: SageInputProps) {
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSubmit()
    }
  }

  const handleSubmit = () => {
    const val = textareaRef.current?.value.trim()
    if (!val || disabled) return
    onSend(val)
    if (textareaRef.current) {
      textareaRef.current.value = ''
      // Reset height after clear
      textareaRef.current.style.height = 'auto'
    }
  }

  const handleInput = () => {
    const el = textareaRef.current
    if (!el) return
    el.style.height = 'auto'
    el.style.height = `${el.scrollHeight}px`
  }

  return (
    <div className="flex items-end gap-2 border-t border-gray-100 p-3">
      <textarea
        ref={textareaRef}
        rows={1}
        onKeyDown={handleKeyDown}
        onInput={handleInput}
        disabled={disabled}
        placeholder="Ask Sage..."
        className="flex-1 resize-none rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:border-brand-purple transition-colors max-h-32 overflow-y-auto disabled:opacity-50"
        style={{ height: 'auto' }}
      />
      <button
        onClick={handleSubmit}
        disabled={disabled}
        className="w-8 h-8 rounded-full bg-brand-purple text-white flex items-center justify-center shrink-0 disabled:opacity-40 hover:bg-purple-700 transition-colors"
      >
        <ArrowUp size={16} />
      </button>
    </div>
  )
}
```

**SagePanel.tsx** â€” 380px right-edge slide-in panel (full-screen on mobile). AnimatePresence is NOT used here â€” handled by the parent (MarketplacePage). This component uses motion.div for its own entry animation.

Per CONTEXT.md decisions:
- First open: Short greeting from Sage + empty input (no example prompts)
- Dismiss: Clicking outside closes it (backdrop in parent)
- Session persistence: messages come from pilotSlice (session-persistent, not localStorage)
- Mobile: full-screen (w-full on mobile, w-[380px] on md+)

```tsx
import { useEffect, useRef } from 'react'
import { motion } from 'motion/react'
import { X } from 'lucide-react'
import { useExplorerStore } from '../../store'
import { useSage } from '../../hooks/useSage'
import { SageMessage } from './SageMessage'
import { SageInput } from './SageInput'

// Greeting shown when conversation is empty (first open)
const SAGE_GREETING = "Hi! I'm Sage ðŸ‘‹ Tell me what kind of expert you're looking for and I'll update the results for you."

export function SagePanel() {
  const setOpen = useExplorerStore((s) => s.setOpen)
  const { messages, isStreaming, handleSend } = useSage()
  const scrollRef = useRef<HTMLDivElement>(null)

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight
    }
  }, [messages, isStreaming])

  return (
    <motion.div
      initial={{ x: '100%' }}
      animate={{ x: 0 }}
      exit={{ x: '100%' }}
      transition={{ type: 'spring', stiffness: 300, damping: 30 }}
      className="fixed bottom-0 right-0 z-40 h-full w-full md:w-[380px] bg-white shadow-2xl flex flex-col"
    >
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 shrink-0">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-full bg-brand-purple flex items-center justify-center">
            <span className="text-white text-xs font-bold">S</span>
          </div>
          <span className="font-semibold text-gray-900 text-sm">Sage</span>
          <span className="text-xs text-gray-400">AI assistant</span>
        </div>
        <button
          onClick={() => setOpen(false)}
          className="w-7 h-7 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors"
        >
          <X size={16} />
        </button>
      </div>

      {/* Messages */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto px-4 py-4">
        {/* Greeting shown when conversation is empty */}
        {messages.length === 0 && (
          <SageMessage role="assistant" content={SAGE_GREETING} />
        )}
        {messages.map((msg) => (
          <SageMessage key={msg.id} role={msg.role} content={msg.content} />
        ))}
        {/* Typing indicator while Gemini processes */}
        {isStreaming && (
          <div className="flex justify-start mb-3">
            <div className="w-6 h-6 rounded-full bg-brand-purple flex items-center justify-center mr-2 shrink-0">
              <span className="text-white text-xs font-bold">S</span>
            </div>
            <div className="bg-gray-100 rounded-2xl rounded-tl-sm px-3.5 py-2.5 flex items-center gap-1">
              <span className="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce" style={{ animationDelay: '0ms' }} />
              <span className="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce" style={{ animationDelay: '150ms' }} />
              <span className="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce" style={{ animationDelay: '300ms' }} />
            </div>
          </div>
        )}
      </div>

      {/* Input */}
      <div className="shrink-0">
        <SageInput onSend={handleSend} disabled={isStreaming} />
      </div>
    </motion.div>
  )
}
```

**SageFAB.tsx** â€” Fixed bottom-right floating action button. Icon is brand-purple circle with "S" (TCS branding mark per CONTEXT.md â€” no generic chat bubble). First-visit tooltip (Claude's discretion: check localStorage, show for 4s, dismiss on click).

Per CONTEXT.md: FAB hides when panel is open (handled by parent via conditional render).

```tsx
import { useEffect, useState } from 'react'
import { motion } from 'motion/react'
import { useExplorerStore } from '../../store'

const TOOLTIP_KEY = 'sage-tooltip-shown'

export function SageFAB() {
  const setOpen = useExplorerStore((s) => s.setOpen)
  const [showTooltip, setShowTooltip] = useState(false)

  // First-visit tooltip â€” check localStorage after mount (Phase 16 email gate pattern)
  useEffect(() => {
    if (!localStorage.getItem(TOOLTIP_KEY)) {
      setShowTooltip(true)
      // Auto-dismiss after 4 seconds
      const timer = setTimeout(() => {
        setShowTooltip(false)
        localStorage.setItem(TOOLTIP_KEY, '1')
      }, 4000)
      return () => clearTimeout(timer)
    }
  }, [])

  const handleClick = () => {
    setShowTooltip(false)
    localStorage.setItem(TOOLTIP_KEY, '1')
    setOpen(true)
  }

  return (
    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-2">
      {/* Tooltip â€” first visit only */}
      {showTooltip && (
        <motion.div
          initial={{ opacity: 0, y: 4 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-gray-900 text-white text-xs rounded-lg px-3 py-2 whitespace-nowrap shadow-lg"
        >
          Try the AI assistant
          <div className="absolute -bottom-1.5 right-5 w-3 h-3 bg-gray-900 rotate-45" />
        </motion.div>
      )}

      {/* FAB button â€” TCS branding mark (S in brand purple circle) */}
      <motion.button
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        onClick={handleClick}
        className="w-14 h-14 rounded-full bg-brand-purple text-white shadow-lg flex items-center justify-center hover:bg-purple-700 transition-colors"
        aria-label="Open Sage AI assistant"
      >
        <span className="text-xl font-bold tracking-tight">S</span>
      </motion.button>
    </div>
  )
}
```

After creating all four files, run from frontend/: npm run build â€” fix any TypeScript errors.
  </action>
  <verify>
    npm run build from frontend/ â€” must exit 0 with no TypeScript errors.
    ls frontend/src/components/pilot/ â€” shows SageMessage.tsx, SageInput.tsx, SagePanel.tsx, SageFAB.tsx.
    grep -n "motion/react\|motion.div\|motion.button" frontend/src/components/pilot/SagePanel.tsx frontend/src/components/pilot/SageFAB.tsx â€” motion imports present in both.
    grep -n "setOpen\|setStreaming" frontend/src/components/pilot/SagePanel.tsx â€” pilotSlice actions referenced.
    grep -n "useSage" frontend/src/components/pilot/SagePanel.tsx â€” hook is imported and used.
    grep -n "w-full md:w-\[380px\]" frontend/src/components/pilot/SagePanel.tsx â€” mobile full-screen + desktop 380px.
  </verify>
  <done>
    All four pilot components created in frontend/src/components/pilot/.
    SageFAB: fixed bottom-right, brand-purple "S" mark, first-visit tooltip (4s, localStorage gated).
    SagePanel: motion/react slide-in from right (x: 100%â†’0), full-screen mobile / 380px desktop, greeting when empty, typing indicator dots, auto-scroll.
    SageMessage: user (purple bubble right) vs Sage (gray bubble left with "S" avatar) visual distinction.
    SageInput: auto-growing textarea, Enter to submit, Shift+Enter for newline, disabled while streaming.
    npm run build passes.
  </done>
</task>

</tasks>

<verification>
npm run build from frontend/ â€” must exit 0.
ls frontend/src/components/pilot/ â€” shows all 4 component files.
grep -n "setTags" frontend/src/store/filterSlice.ts frontend/src/store/index.ts â€” appears in both.
grep -n "api/pilot" frontend/src/hooks/useSage.ts â€” fetch URL confirmed.
grep -n "validateAndApplyFilters" frontend/src/hooks/useSage.ts â€” filter validation present.
grep -n "toGeminiRole\|model.*assistant" frontend/src/hooks/useSage.ts â€” role mapping present.
</verification>

<success_criteria>
- filterSlice.ts has setTags(tags: string[]) action
- index.ts useFilterSlice exposes setTags
- useSage hook: sends to /api/pilot, validates filters, dispatches to store, adds messages
- Role mapping: 'assistant' â†’ 'model' before sending to backend
- SageFAB: fixed bottom-6 right-6 z-50, brand-purple "S" mark, first-visit tooltip
- SagePanel: w-full md:w-[380px], motion slide-in from right, greeting when empty, typing indicator
- SageMessage: user vs Sage visual distinction (purple right / gray left)
- SageInput: auto-grow textarea, Enter submit, disabled during streaming
- npm run build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-floating-ai-co-pilot/18-02-SUMMARY.md`
</output>
