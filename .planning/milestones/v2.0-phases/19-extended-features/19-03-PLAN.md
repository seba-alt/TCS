---
phase: 19-extended-features
plan: "03"
type: execute
wave: 2
depends_on: []
files_modified:
  - frontend/src/components/marketplace/ExpertCard.tsx
  - frontend/src/components/marketplace/ExpertGrid.tsx
  - frontend/src/components/marketplace/ProfileGateModal.tsx
  - frontend/src/pages/MarketplacePage.tsx
autonomous: true
requirements: [LEAD-01, LEAD-02, LEAD-04]

must_haves:
  truths:
    - "ExpertCard has a 'View Full Profile' button that triggers the email gate or opens the profile URL"
    - "Email gate modal is rendered at MarketplacePage level — NOT inside ExpertCard (overflow-hidden constraint)"
    - "Users with email already in localStorage bypass the modal entirely and go straight to the profile"
    - "After email submission the blocked profile URL auto-opens in a new tab"
    - "Dismissing the modal closes it cleanly — re-appears on next profile click without email"
    - "useEmailGate STORAGE_KEY 'tcs_gate_email' reused from v1.0 — existing v1 users already unlocked"
  artifacts:
    - path: "frontend/src/components/marketplace/ProfileGateModal.tsx"
      provides: "Email gate modal overlay using v1.0 EmailGate component"
      contains: "ProfileGateModal"
    - path: "frontend/src/components/marketplace/ExpertCard.tsx"
      provides: "View Full Profile button with onViewProfile prop"
      contains: "onViewProfile"
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "pendingProfileUrl state + ProfileGateModal rendered at page level"
      contains: "pendingProfileUrl"
  key_links:
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/hooks/useEmailGate.ts"
      via: "useEmailGate() — isUnlocked, submitEmail"
      pattern: "useEmailGate"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/components/marketplace/ProfileGateModal.tsx"
      via: "AnimatePresence + conditional render on pendingProfileUrl"
      pattern: "ProfileGateModal"
    - from: "frontend/src/components/marketplace/ExpertCard.tsx"
      to: "frontend/src/pages/MarketplacePage.tsx"
      via: "onViewProfile callback prop"
      pattern: "onViewProfile"
---

<objective>
Implement the email gate for "View Full Profile" on expert cards.

Purpose: LEAD-01/02/04 — users browse freely but must provide email before clicking through to a profile. The gate is hard (no bypass). Returning visitors are unlocked via localStorage. The modal is rendered at MarketplacePage level (not inside ExpertCard) to avoid the h-[180px] overflow-hidden constraint.

Output: `ProfileGateModal.tsx` (new), `ExpertCard.tsx` updated with button + prop, `ExpertGrid.tsx` passes callback, `MarketplacePage.tsx` manages gate state.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/19-extended-features/19-RESEARCH.md
@frontend/src/components/marketplace/ExpertCard.tsx
@frontend/src/components/marketplace/ExpertGrid.tsx
@frontend/src/pages/MarketplacePage.tsx
@frontend/src/hooks/useEmailGate.ts
@frontend/src/components/EmailGate.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileGateModal component</name>
  <files>frontend/src/components/marketplace/ProfileGateModal.tsx</files>
  <action>
Create `frontend/src/components/marketplace/ProfileGateModal.tsx`.

This component wraps the v1.0 `EmailGate` in a centered modal overlay.

```tsx
import { AnimatePresence, motion } from 'motion/react'
import EmailGate from '../EmailGate'

interface ProfileGateModalProps {
  onSubmit: (email: string) => Promise<void>
  onDismiss: () => void
}

export function ProfileGateModal({ onSubmit, onDismiss }: ProfileGateModalProps) {
  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40"
        onClick={onDismiss}
      >
        <motion.div
          initial={{ scale: 0.95, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          exit={{ scale: 0.95, opacity: 0 }}
          transition={{ duration: 0.15 }}
          className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="flex items-center justify-between mb-1">
            <h2 className="font-semibold text-gray-900 text-base">Unlock full profile</h2>
            <button
              onClick={onDismiss}
              className="text-gray-400 hover:text-gray-600 text-xl leading-none"
              aria-label="Close"
            >
              ×
            </button>
          </div>
          <p className="text-sm text-gray-500 mb-4">
            Enter your email to view this expert's full profile on Tinrate.
          </p>
          <EmailGate onSubmit={onSubmit} />
        </motion.div>
      </motion.div>
    </AnimatePresence>
  )
}
```

Note: The `AnimatePresence` here handles the modal's own enter/exit. The parent (MarketplacePage) wraps with its own AnimatePresence for mount/unmount of this component.

After creating, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "ProfileGateModal\|EmailGate\|onDismiss" frontend/src/components/marketplace/ProfileGateModal.tsx — all present.
  </verify>
  <done>
    ProfileGateModal created using v1.0 EmailGate component.
    Backdrop click dismisses. X button dismisses.
    motion/react enter/exit animations.
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "View Full Profile" button to ExpertCard + onViewProfile prop</name>
  <files>frontend/src/components/marketplace/ExpertCard.tsx</files>
  <action>
Read `frontend/src/components/marketplace/ExpertCard.tsx`. Add a "View Full Profile" button and `onViewProfile` prop.

Changes:
1. Add `onViewProfile: (url: string) => void` to `ExpertCardProps` interface
2. Add an `ExternalLink` import from lucide-react (or use existing icons)
3. Add a "View Full Profile" button at the bottom of the card

The card has `h-[180px]` and content sections. Add the button as the last item. Since the card is space-constrained, use a compact button style.

Updated `ExpertCardProps`:
```typescript
interface ExpertCardProps {
  expert: Expert
  index: number
  onViewProfile: (url: string) => void
}
```

Add button at the bottom of the card (inside the motion.div, after match_reason):
```tsx
{/* View Full Profile — triggers email gate or direct open */}
<button
  onClick={(e) => {
    e.stopPropagation()
    onViewProfile(expert.profile_url)
  }}
  className="mt-auto text-xs text-brand-purple font-medium hover:underline self-start"
>
  View Full Profile →
</button>
```

CRITICAL: Preserve the existing h-[180px] constraint and all existing card content exactly. The new button fits in the remaining space. The `mt-auto` pushes it to the bottom if there's room. Since cards use `flex flex-col gap-2`, the button naturally sits at the bottom.

After editing, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "onViewProfile" frontend/src/components/marketplace/ExpertCard.tsx — prop defined and used.
    grep -n "View Full Profile" frontend/src/components/marketplace/ExpertCard.tsx — button text present.
  </verify>
  <done>
    ExpertCard has onViewProfile prop.
    "View Full Profile →" button added to card.
    e.stopPropagation() prevents tag pill click conflicts.
    Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Pass onViewProfile through ExpertGrid + wire modal in MarketplacePage</name>
  <files>
    frontend/src/components/marketplace/ExpertGrid.tsx
    frontend/src/pages/MarketplacePage.tsx
  </files>
  <action>
**Part A: Update ExpertGrid.tsx**

Read `frontend/src/components/marketplace/ExpertGrid.tsx`. Add `onViewProfile` to `ExpertGridProps` and pass it to each `ExpertCard`.

```typescript
interface ExpertGridProps {
  experts: Expert[]
  loading: boolean
  isFetchingMore: boolean
  onEndReached: () => void
  onViewProfile: (url: string) => void  // ADD THIS
}
```

Pass to ExpertCard in itemContent:
```tsx
itemContent={(index, expert) => (
  <ExpertCard expert={expert} index={index} onViewProfile={onViewProfile} />
)}
```

**Part B: Update MarketplacePage.tsx**

Read `frontend/src/pages/MarketplacePage.tsx`. Add email gate state and modal.

1. Add imports:
```tsx
import { AnimatePresence } from 'motion/react'  // already imported — AnimatePresence is already used
import { useEmailGate } from '../hooks/useEmailGate'
import { ProfileGateModal } from '../components/marketplace/ProfileGateModal'
```

2. Inside `MarketplacePage` function:
```typescript
// Email gate state — LEAD-01/02/04
const { isUnlocked, submitEmail } = useEmailGate()
const [pendingProfileUrl, setPendingProfileUrl] = useState<string | null>(null)

function handleViewProfile(url: string) {
  if (isUnlocked) {
    window.open(url, '_blank', 'noopener,noreferrer')
  } else {
    setPendingProfileUrl(url)
  }
}

async function handleEmailSubmit(email: string) {
  await submitEmail(email)
  if (pendingProfileUrl) {
    window.open(pendingProfileUrl, '_blank', 'noopener,noreferrer')
    setPendingProfileUrl(null)
  }
}
```

3. Pass `handleViewProfile` to ExpertGrid:
```tsx
<ExpertGrid
  experts={experts}
  loading={loading}
  isFetchingMore={isFetchingMore}
  onEndReached={loadNextPage}
  onViewProfile={handleViewProfile}
/>
```

4. Add ProfileGateModal at the bottom of the JSX (before the final closing div, after the Sage AnimatePresence blocks):
```tsx
{/* Email gate modal — rendered at page level to avoid ExpertCard overflow-hidden constraint */}
<AnimatePresence>
  {pendingProfileUrl && (
    <ProfileGateModal
      key="profile-gate"
      onSubmit={handleEmailSubmit}
      onDismiss={() => setPendingProfileUrl(null)}
    />
  )}
</AnimatePresence>
```

After editing, run `npm run build` from `frontend/` — must pass.
  </action>
  <verify>
    npm run build from frontend/ — exits 0.
    grep -n "onViewProfile" frontend/src/components/marketplace/ExpertGrid.tsx — prop passed through.
    grep -n "pendingProfileUrl\|useEmailGate\|ProfileGateModal" frontend/src/pages/MarketplacePage.tsx — all three present.
    grep -n "AnimatePresence" frontend/src/pages/MarketplacePage.tsx — already imported and used for Sage, now also wraps ProfileGateModal.
  </verify>
  <done>
    ExpertGrid passes onViewProfile to ExpertCard.
    MarketplacePage manages pendingProfileUrl state.
    useEmailGate integrated — isUnlocked from localStorage.
    ProfileGateModal rendered inside AnimatePresence at page level.
    After email submit: profile URL opens in new tab, modal closes.
    Build passes.
  </done>
</task>

</tasks>

<verification>
npm run build from frontend/ — must exit 0 with no TypeScript errors.
grep -n "onViewProfile" frontend/src/components/marketplace/ExpertCard.tsx frontend/src/components/marketplace/ExpertGrid.tsx frontend/src/pages/MarketplacePage.tsx — prop flows through all three.
grep -n "pendingProfileUrl" frontend/src/pages/MarketplacePage.tsx — gate state managed.
grep -n "ProfileGateModal" frontend/src/pages/MarketplacePage.tsx — modal wired.
</verification>

<success_criteria>
- ExpertCard has "View Full Profile →" button + onViewProfile prop
- ExpertGrid passes onViewProfile through to ExpertCard
- ProfileGateModal uses v1.0 EmailGate component, rendered at MarketplacePage level
- MarketplacePage manages pendingProfileUrl — gate state never in ExpertCard
- Returning visitors (email in localStorage) bypass modal and go direct to profile
- After email submit: profile opens in new tab, modal closes
- Dismissing modal: closes cleanly, re-appears on next profile click
- useEmailGate STORAGE_KEY 'tcs_gate_email' reused (existing v1 users unlocked)
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/19-extended-features/19-03-SUMMARY.md`
</output>
