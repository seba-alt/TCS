---
phase: 15-zustand-state-and-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/store/filterSlice.ts
  - frontend/src/store/resultsSlice.ts
  - frontend/src/store/pilotSlice.ts
  - frontend/src/store/index.ts
  - frontend/src/pages/MarketplacePage.tsx
  - frontend/src/main.tsx
autonomous: true
requirements:
  - STATE-01
  - STATE-02
  - STATE-03

must_haves:
  truths:
    - "import { useExplorerStore } from '@/store' works from any component with no Provider wrapper"
    - "Filter fields (query, rateMin, rateMax, tags, sortBy, sortOrder) survive a full browser reload via localStorage"
    - "Results slice (experts, total, cursor, loading, error) and pilot slice (messages, isOpen, isStreaming, sessionId) are NOT present in localStorage after reload"
    - "Navigating to '/' renders MarketplacePage, not App — the old chat interface is no longer the homepage"
    - "Calling setQuery() or toggleTag() in one component is immediately reflected in all other components subscribing to that state"
  artifacts:
    - path: "frontend/src/store/filterSlice.ts"
      provides: "FilterSlice type + createFilterSlice StateCreator"
      contains: "FilterSlice"
    - path: "frontend/src/store/resultsSlice.ts"
      provides: "ResultsSlice type + createResultsSlice StateCreator"
      contains: "ResultsSlice"
    - path: "frontend/src/store/pilotSlice.ts"
      provides: "PilotSlice type + createPilotSlice StateCreator"
      contains: "PilotSlice"
    - path: "frontend/src/store/index.ts"
      provides: "Combined useExplorerStore with persist middleware"
      exports: ["useExplorerStore", "useFilterSlice", "useResultsSlice", "usePilotSlice", "ExplorerStore"]
    - path: "frontend/src/pages/MarketplacePage.tsx"
      provides: "Shell MarketplacePage with pilot reset on mount"
      contains: "resetPilot"
    - path: "frontend/src/main.tsx"
      provides: "Updated router: '/' -> MarketplacePage, '/chat' -> App"
      contains: "MarketplacePage"
  key_links:
    - from: "frontend/src/store/index.ts"
      to: "localStorage"
      via: "persist middleware with partialize"
      pattern: "partialize.*query.*rateMin.*rateMax.*tags.*sortBy.*sortOrder"
    - from: "frontend/src/pages/MarketplacePage.tsx"
      to: "frontend/src/store/index.ts"
      via: "useExplorerStore((s) => s.resetPilot)"
      pattern: "resetPilot"
    - from: "frontend/src/main.tsx"
      to: "frontend/src/pages/MarketplacePage.tsx"
      via: "createBrowserRouter path '/'"
      pattern: "path.*'/'.*MarketplacePage"
---

<objective>
Install Zustand, create the three-slice `useExplorerStore` with localStorage persistence scoped to the filter slice, and swap the homepage route from `<App />` to a shell `<MarketplacePage />`.

Purpose: Establish the shared state data contract and routing foundation that every subsequent marketplace UI phase (16-19) will build on. This phase is store shape only — no API calls are wired; real fetching comes in Phase 16.

Output: `frontend/src/store/` directory with four files (three slice creators + combined store), `frontend/src/pages/MarketplacePage.tsx` shell, and updated `frontend/src/main.tsx` routing.
</objective>

<execution_context>
@/Users/sebastianhamers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-zustand-state-and-routing/15-CONTEXT.md
@.planning/phases/15-zustand-state-and-routing/15-RESEARCH.md
@frontend/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zustand and create the three-slice store</name>
  <files>
    frontend/src/store/filterSlice.ts
    frontend/src/store/resultsSlice.ts
    frontend/src/store/pilotSlice.ts
    frontend/src/store/index.ts
  </files>
  <action>
    Run `npm install zustand` from the `frontend/` directory (zustand is not in package.json yet).

    Create `frontend/src/store/` directory with four files:

    **filterSlice.ts** — FilterSlice type and StateCreator:
    - Fields: `query: string` (default ''), `rateMin: number` (default 0), `rateMax: number` (default 5000), `tags: string[]` (default []), `sortBy: 'relevance' | 'rate_asc' | 'rate_desc'` (default 'relevance'), `sortOrder: 'asc' | 'desc'` (default 'desc')
    - Actions: `setQuery(q: string)`, `setRateRange(min: number, max: number)`, `toggleTag(tag: string)` (adds if absent, removes if present), `setSortBy(sortBy: FilterSlice['sortBy'])`, `resetFilters()` (resets all fields to defaults including sortBy/sortOrder)
    - Type the StateCreator as `StateCreator<ExplorerStore, [['zustand/persist', unknown]], [], FilterSlice>` — use `unknown` for the persist type parameter to avoid circular reference; the combined store in index.ts will carry the full type

    **resultsSlice.ts** — ResultsSlice type and StateCreator:
    - Fields: `experts: Expert[]` (default []), `total: number` (default 0), `cursor: number | null` (default null), `loading: boolean` (default false), `error: string | null` (default null)
    - Define the `Expert` interface in this file (matches `/api/explore` response contract from Phase 14): `{ username: string, firstName: string, lastName: string, jobTitle: string, company: string, hourlyRate: number, tags: string[], findabilityScore: number, matchReason: string | null }`
    - Actions: `setResults(experts: Expert[], total: number, cursor: number | null)`, `setLoading(loading: boolean)`, `setError(error: string | null)`, `resetResults()` (clears experts to [], total to 0, cursor to null, loading to false, error to null)

    **pilotSlice.ts** — PilotSlice type and StateCreator:
    - Define `PilotMessage` interface: `{ id: string, role: 'user' | 'assistant', content: string, timestamp: number }`
    - Fields: `messages: PilotMessage[]` (default []), `isOpen: boolean` (default false), `isStreaming: boolean` (default false), `sessionId: string | null` (default null)
    - Actions: `addMessage(msg: PilotMessage)`, `setOpen(open: boolean)`, `setStreaming(streaming: boolean)`, `setSessionId(id: string | null)`, `resetPilot()` (clears messages to [], sets isOpen false, isStreaming false, sessionId null)
    - The pilot slice can read filter state via `get()` (StateCreator receives get as third argument): document this with a comment `// Access filter state: get().query, get().tags, etc.`

    **index.ts** — combined store:
    - Import all three slice creators and their types
    - Define `ExplorerStore = FilterSlice & ResultsSlice & PilotSlice`
    - Export `Expert` and `PilotMessage` types (re-export from their slice files)
    - Create the store with `create<ExplorerStore>()(persist(...))` — the correct v5 pattern where the type goes on `persist`, not `create`:
      ```typescript
      export const useExplorerStore = create<ExplorerStore>()(
        persist(
          (...a) => ({
            ...createFilterSlice(...a),
            ...createResultsSlice(...a),
            ...createPilotSlice(...a),
          }),
          {
            name: 'explorer-filters',
            storage: createJSONStorage(() => localStorage),
            version: 1,
            // Only persist filter DATA fields — never actions, never results, never pilot
            partialize: (state) => ({
              query:     state.query,
              rateMin:   state.rateMin,
              rateMax:   state.rateMax,
              tags:      state.tags,
              sortBy:    state.sortBy,
              sortOrder: state.sortOrder,
            }),
            // Hook point for Phase 16 auto-search on rehydration
            onRehydrateStorage: () => (_state) => {
              // Phase 16+ wires: _state?.triggerSearch()
            },
          }
        )
      )
      ```
    - Export three custom slice hooks using `useShallow` from `'zustand/react/shallow'` (v5 import path — NOT `'zustand/shallow'`):
      - `useFilterSlice()` — selects all filter fields and actions via `useShallow`
      - `useResultsSlice()` — selects all results fields and actions via `useShallow`
      - `usePilotSlice()` — selects all pilot fields and actions via `useShallow`

    **Anti-patterns to avoid:**
    - Do NOT include actions in `partialize` — functions are not JSON-serializable and will serialize as `undefined`
    - Do NOT use `from 'zustand/shallow'` — the v5 path is `from 'zustand/react/shallow'`
    - Do NOT call `useExplorerStore()` with an object selector without `useShallow` — causes infinite re-renders in Zustand v5
    - Do NOT persist results or pilot state — only the six filter fields are persisted

    After creating files, verify TypeScript compiles: run `npm run build` from `frontend/` — fix any type errors before proceeding to Task 2.
  </action>
  <verify>
    From `frontend/` directory:
    1. `cat package.json | grep zustand` — confirms zustand is listed in dependencies
    2. `ls src/store/` — shows filterSlice.ts, resultsSlice.ts, pilotSlice.ts, index.ts
    3. `npm run build` — exits 0 with no TypeScript errors
  </verify>
  <done>
    zustand is in package.json dependencies; store/ directory has four files; `npm run build` exits 0 with no type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MarketplacePage shell and update routing</name>
  <files>
    frontend/src/pages/MarketplacePage.tsx
    frontend/src/main.tsx
  </files>
  <action>
    Create `frontend/src/pages/` directory and `MarketplacePage.tsx`:
    ```typescript
    import { useEffect } from 'react'
    import { useExplorerStore } from '../store'

    export default function MarketplacePage() {
      const resetPilot = useExplorerStore((s) => s.resetPilot)

      // Reset pilot conversation state when user navigates to marketplace
      // (pilot state is not persisted — only in-memory reset needed on navigation)
      useEffect(() => {
        resetPilot()
      }, [resetPilot])

      return (
        <div className="min-h-screen bg-white">
          <p className="p-8 text-gray-400">Marketplace — coming in Phase 16</p>
        </div>
      )
    }
    ```

    Update `frontend/src/main.tsx` — change the `'/'` route and add `'/chat'` route:
    - Add import: `import MarketplacePage from './pages/MarketplacePage.tsx'`
    - Change: `{ path: '/', element: <App /> }` → `{ path: '/', element: <MarketplacePage /> }`
    - Add after the `'/'` route: `{ path: '/chat', element: <App /> }` — preserves the old interface at `/chat` but it is not linked from anywhere in the new UI (per user decision: "no explicit links from the new UI to the old interface")
    - All admin routes remain unchanged

    After editing, run `npm run build` from `frontend/` to confirm no errors.
  </action>
  <verify>
    From `frontend/` directory:
    1. `cat src/pages/MarketplacePage.tsx` — file exists and contains `resetPilot` and `useExplorerStore`
    2. `grep "MarketplacePage" src/main.tsx` — shows the import and `path: '/'` using MarketplacePage
    3. `grep "path: '/chat'" src/main.tsx` — old interface preserved at `/chat`
    4. `npm run build` — exits 0 with no errors
  </verify>
  <done>
    MarketplacePage.tsx exists with pilot reset; main.tsx routes '/' to MarketplacePage and '/chat' to App; `npm run build` exits 0.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase:

1. **Store exports:** From `frontend/src/store/index.ts`, the following are exported: `useExplorerStore`, `useFilterSlice`, `useResultsSlice`, `usePilotSlice`, `ExplorerStore` type, `Expert` type, `PilotMessage` type
2. **localStorage scope:** Inspect `partialize` in `store/index.ts` — confirms only `query, rateMin, rateMax, tags, sortBy, sortOrder` are returned (no experts, messages, loading, etc.)
3. **Routing:** `main.tsx` has `path: '/'` pointing to `<MarketplacePage />` and `path: '/chat'` pointing to `<App />`
4. **Build:** `npm run build` exits 0 with no TypeScript errors
5. **No Provider:** No `StoreProvider` wrapper exists in `main.tsx` — Zustand requires none
</verification>

<success_criteria>
- `frontend/src/store/` contains filterSlice.ts, resultsSlice.ts, pilotSlice.ts, index.ts
- `frontend/src/pages/MarketplacePage.tsx` exists with resetPilot() called on mount
- `frontend/src/main.tsx` routes '/' to MarketplacePage, '/chat' to App
- `npm run build` exits 0 with no TypeScript errors
- STATE-01: useExplorerStore manages filter, results, and pilot slices — confirmed by store/index.ts
- STATE-02: persist middleware with partialize scopes localStorage to filter fields only — confirmed by store/index.ts
- STATE-03: '/' renders MarketplacePage — confirmed by main.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/15-zustand-state-and-routing/15-01-SUMMARY.md` using the summary template at `/Users/sebastianhamers/.claude/get-shit-done/templates/summary.md`.
</output>
